{% extends "components/layout.html" %}
{% block title %} Sistema de Gesti√≥n Integral {% endblock %}

{% block head %}
    <!-- Incluyendo los estilos de Bootstrap y Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Ultra Grid Optimizer para rendimiento avanzado -->
    <script src="/static/js/optimizacion_grilla_ultra.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid bg-white shadow-md rounded-lg mt-0 mb-3">
    <!-- Titulo y Botones Iniciales -->
    <div class="row justify-content-between align-items-center mb-4">
        <h1 class="col-auto" style="font-size: 24px; font-family: 'Century Gothic', sans-serif;">Sistema de Gesti√≥n Integral</h1>
        <h1 class="col-auto" style="font-size: 14px; font-family: 'Century Gothic', sans-serif;">¬°Hola, {{ user_session.nombres }} {{ user_session.apellidos }}!</h1>
        <img src="/static/Consorcio.png" alt="Consorcio Icon" style="max-width: 120px; height: auto;">
    </div>

    <!-- Pesta√±as principales -->
    <ul class="nav nav-tabs justify-content-center" id="sgiTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pendientes-tab" data-bs-toggle="tab" data-bs-target="#pendientes" type="button" role="tab"
                style="font-size:14px; font-family: 'Century Gothic', sans-serif;">üìã Pendientes</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="indicadores-tab" data-bs-toggle="tab" data-bs-target="#indicadores" type="button" role="tab"
                style="font-size:14px; font-family: 'Century Gothic', sans-serif;">Indicadores</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="auditoria-tab" data-bs-toggle="tab" data-bs-target="#auditoria" type="button" role="tab"
                style="font-size:14px; font-family: 'Century Gothic', sans-serif;">üîç Auditor√≠a</button>
        </li>
    </ul>

    <!-- Contenido de las pesta√±as -->
    <div class="tab-content mt-4" id="sgiTabsContent">

        <!-- Pesta√±a Pendientes -->
        <div class="tab-pane fade show active" id="pendientes" role="tabpanel">
            <div class="container-fluid">
                <!-- Estilos espec√≠ficos para filtros pendientes -->
                <style>
                  .pendientes-filters-container {
                    --line: #e2e8f0;
                    --ink-2: #475569;
                    --focus: #94c5ff;
                  }
                  .pendientes-filters {
                    display: grid;
                    grid-template-columns: repeat(7, minmax(120px, 1fr));
                    gap: 12px;
                    padding: 16px;
                    background: #ffffff;
                    border: 1px solid var(--line);
                    border-radius: 12px;
                    margin-bottom: 20px;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
                  }
                  .pendientes-filters label {
                    font-size: 12px;
                    color: var(--ink-2);
                    font-weight: 600;
                    display: block;
                    margin-bottom: 6px;
                  }
                  .pendientes-filters select,
                  .pendientes-filters input[type="text"],
                  .pendientes-filters input[type="date"] {
                    width: 100%;
                    padding: 8px 10px;
                    border: 1px solid var(--line);
                    border-radius: 8px;
                    background: #fff;
                    color: #1e293b;
                    font-size: 13px;
                    transition: all 0.2s ease;
                  }
                  .pendientes-filters select:focus,
                  .pendientes-filters input:focus {
                    outline: 3px solid var(--focus);
                    border-color: transparent;
                  }
                  @media (max-width: 1200px) {
                    .pendientes-filters {
                      grid-template-columns: repeat(4, 1fr);
                    }
                  }
                  @media (max-width: 768px) {
                    .pendientes-filters {
                      grid-template-columns: repeat(2, 1fr);
                    }
                  }

                  /* Estilos para banderas de alerta */
                  .bandera-alerta {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    font-size: 18px;
                    padding: 4px;
                    border-radius: 50%;
                    width: 32px;
                    height: 32px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    user-select: none;
                  }

                  .bandera-alerta .bandera-icono {
                    font-size: 0.9em;
                    line-height: 1;
                  }

                  .bandera-alerta:hover {
                    transform: scale(1.1);
                    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
                  }

                  /* SISTEMA SEM√ÅFORO - 3 COLORES */

                  /* ROJO - Vencido (fecha superada) */
                  .alerta-vencido {
                    background: linear-gradient(135deg, #dc2626, #b91c1c);
                    color: white;
                    animation: pulse 2s infinite;
                  }

                  /* AMARILLO - Pr√≥ximo a vencer (10 d√≠as o menos) */
                  .alerta-proximo {
                    background: linear-gradient(135deg, #f59e0b, #d97706);
                    color: white;
                  }

                  /* VERDE - En plazo (m√°s de 10 d√≠as) */
                  .alerta-ok {
                    background: linear-gradient(135deg, #10b981, #059669);
                    color: white;
                  }

                  /* Animaciones */
                  @keyframes pulse {
                    0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); }
                    70% { box-shadow: 0 0 0 10px rgba(220, 38, 38, 0); }
                    100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); }
                  }

                  /* ===== ESTILOS PARA CAMPANA DE NOTIFICACIONES ===== */
                  .contenedor-alerta-notificacion {
                    position: relative;
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    gap: 4px;
                  }

                  .campana-notificaciones {
                    position: absolute;
                    top: -2px;
                    right: -6px;
                    width: 18px;
                    height: 18px;
                    background: rgba(255, 255, 255, 0.95);
                    border-radius: 50%;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.15);
                    z-index: 10;
                  }

                  .campana-notificaciones:hover {
                    transform: scale(1.15);
                    background: #fff;
                    box-shadow: 0 3px 8px rgba(0,0,0,0.25);
                  }

                  .campana-notificaciones i {
                    font-size: 11px;
                    color: #3b82f6;
                    animation: campana-ring 2s infinite ease-in-out;
                  }

                  .campana-notificaciones:hover i {
                    color: #2563eb;
                  }

                  .badge-notificaciones {
                    position: absolute;
                    top: -4px;
                    right: -4px;
                    background: #ef4444;
                    color: white;
                    font-size: 8px;
                    font-weight: bold;
                    min-width: 14px;
                    height: 14px;
                    border-radius: 7px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 0 3px;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.3);
                    z-index: 11;
                  }

                  @keyframes campana-ring {
                    0%, 100% { transform: rotate(0deg); }
                    10%, 30% { transform: rotate(-10deg); }
                    20%, 40% { transform: rotate(10deg); }
                    50% { transform: rotate(0deg); }
                  }

                  /* ===== ESTILOS PARA MODAL DE NOTIFICACIONES ===== */
                  .notificacion-item {
                    padding: 12px 16px;
                    border-left: 4px solid transparent;
                    background: #f8fafc;
                    margin-bottom: 8px;
                    border-radius: 6px;
                    cursor: pointer;
                    transition: all 0.2s ease;
                  }

                  .notificacion-item:hover {
                    background: #f1f5f9;
                    transform: translateX(4px);
                  }

                  .notificacion-item.no-leida {
                    background: #eff6ff;
                    border-left-color: #3b82f6;
                    font-weight: 500;
                  }

                  .notificacion-item.leida {
                    border-left-color: #cbd5e1;
                    opacity: 0.7;
                  }

                  .notificacion-tipo-APROBACION {
                    border-left-color: #10b981 !important;
                  }

                  .notificacion-tipo-RECHAZO {
                    border-left-color: #ef4444 !important;
                  }

                  .notificacion-tipo-CIERRE {
                    border-left-color: #8b5cf6 !important;
                  }

                  .notificacion-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: start;
                    margin-bottom: 6px;
                  }

                  .notificacion-titulo {
                    font-size: 14px;
                    font-weight: 600;
                    color: #1e293b;
                    margin: 0;
                  }

                  .notificacion-fecha {
                    font-size: 11px;
                    color: #64748b;
                  }

                  .notificacion-mensaje {
                    font-size: 13px;
                    color: #475569;
                    margin: 0;
                  }

                  .notificacion-codigo {
                    font-size: 11px;
                    color: #3b82f6;
                    font-weight: 600;
                    margin-top: 4px;
                  }

                  .badge-tipo-notif {
                    display: inline-flex;
                    align-items: center;
                    gap: 4px;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-size: 10px;
                    font-weight: 600;
                    text-transform: uppercase;
                  }

                  .badge-APROBACION {
                    background: #d1fae5;
                    color: #065f46;
                  }

                  .badge-RECHAZO {
                    background: #fee2e2;
                    color: #991b1b;
                  }

                  .badge-CIERRE {
                    background: #ede9fe;
                    color: #5b21b6;
                  }

                  /* ESTILOS PARA FILTROS CLICKEABLES EN LEYENDA */
                  .filtro-leyenda {
                    cursor: pointer !important;
                    position: relative;
                    transition: all 0.3s ease;
                  }

                  .filtro-leyenda:hover {
                    transform: scale(1.15);
                    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
                  }

                  /* Estado activo del filtro */
                  .filtro-leyenda.activo {
                    transform: scale(1.1);
                    box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.8), 0 0 0 5px currentColor;
                    z-index: 10;
                  }

                  .filtro-leyenda.activo:hover {
                    transform: scale(1.2);
                  }

                  /* Estilos para labels de filtros */
                  .filtro-label {
                    cursor: pointer;
                    transition: all 0.2s ease;
                    user-select: none;
                  }

                  .filtro-label:hover {
                    color: #495057 !important;
                    font-weight: 600;
                  }

                  .filtro-label.activo {
                    color: #495057 !important;
                    font-weight: 700;
                    text-decoration: underline;
                  }

                  /* Responsive para banderas */
                  @media (max-width: 768px) {
                    .bandera-alerta {
                      font-size: 14px;
                      width: 24px;
                      height: 24px;
                      line-height: 16px;
                    }

                    /* Ocultar leyenda en pantallas muy peque√±as */
                    .col-md-6:last-child {
                      margin-top: 10px;
                    }
                  }

                  @media (max-width: 480px) {
                    .col-md-6:last-child .d-flex {
                      justify-content: center !important;
                    }
                  }

                  /* Estilos para botones de acci√≥n - Sobrescribir Bootstrap */
                  #tablaProcesos button {
                    border: none !important;
                    outline: none !important;
                    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06) !important;
                  }

                  #tablaProcesos button:hover {
                    transform: translateY(-1px);
                    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06) !important;
                  }

                  #tablaProcesos button:focus {
                    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.5) !important;
                  }


                  #tablaProcesos thead th {
                    white-space: nowrap;
                    text-align: center;
                    position: sticky;
                    top: 0;
                    z-index: 10;
                    background-color: #374151 !important;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                  }

                  #tablaProcesos .estado-chip {
                    display: inline-flex;
                    align-items: center;
                    justify-content: center;
                    max-width: 100%;
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    box-sizing: border-box;
                    padding: 0.2rem 0.4rem;
                    font-size: 11px;
                    line-height: 1.1;
                  }

                  #tablaProcesos {
                    width: 100%;
                    table-layout: fixed;
                    max-width: 100%;
                  }

                  /* Contenedor con scroll para tabla de Pendientes */
                  .table-responsive {
                    max-height: calc(100vh - 400px);
                    overflow-y: auto;
                    position: relative;
                  }

                  /* Scroll suave */
                  .table-responsive::-webkit-scrollbar {
                    width: 8px;
                    height: 8px;
                  }

                  .table-responsive::-webkit-scrollbar-track {
                    background: #f1f5f9;
                    border-radius: 4px;
                  }

                  .table-responsive::-webkit-scrollbar-thumb {
                    background: #94a3b8;
                    border-radius: 4px;
                  }

                  .table-responsive::-webkit-scrollbar-thumb:hover {
                    background: #64748b;
                  }

                  #tablaProcesos th,
                  #tablaProcesos td {
                    padding: 0.4rem 0.35rem !important;
                    font-size: 12px;
                    line-height: 1.2;
                    vertical-align: middle;
                  }

                  #tablaProcesos th {
                    font-size: 12px;
                    font-weight: 600;
                  }

                  #tablaProcesos td {
                    word-break: break-word;
                  }

                  #tablaProcesos th:nth-child(1),
                  #tablaProcesos td:nth-child(1) { width: 4%; min-width: 60px; }
                  #tablaProcesos th:nth-child(2),
                  #tablaProcesos td:nth-child(2) { width: 11%; min-width: 120px; }
                  #tablaProcesos th:nth-child(3),
                  #tablaProcesos td:nth-child(3) { width: 5%; min-width: 50px; }
                  #tablaProcesos th:nth-child(4),
                  #tablaProcesos td:nth-child(4) { width: 7%; min-width: 80px; }
                  #tablaProcesos th:nth-child(5),
                  #tablaProcesos td:nth-child(5) { width: 8%; min-width: 90px; max-width: 120px; }
                  #tablaProcesos th:nth-child(6),
                  #tablaProcesos td:nth-child(6) { width: 15%; min-width: 120px; }
                  #tablaProcesos th:nth-child(7),
                  #tablaProcesos td:nth-child(7) { width: 9%; min-width: 95px; }
                  #tablaProcesos th:nth-child(8),
                  #tablaProcesos td:nth-child(8) { width: 9%; min-width: 95px; }
                  #tablaProcesos th:nth-child(9),
                  #tablaProcesos td:nth-child(9) { width: 9%; min-width: 90px; }
                  #tablaProcesos th:nth-child(10),
                  #tablaProcesos td:nth-child(10) { width: 11%; min-width: 100px; }
                  #tablaProcesos th:nth-child(11),
                  #tablaProcesos td:nth-child(11) { width: 10%; min-width: 90px; }

                  #tablaProcesos td:nth-child(7),
                  #tablaProcesos td:nth-child(8),
                  #tablaProcesos td:nth-child(9),
                  #tablaProcesos td:nth-child(11) {
                    white-space: nowrap;
                  }

                  #tablaProcesos td:nth-child(5) {
                    white-space: nowrap;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    word-break: normal;
                  }

                  #tablaProcesos .celda-subproceso {
                    display: block;
                    width: 100%;
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                  }

                  #tablaProcesos td:nth-child(3) {
                    white-space: nowrap;
                    word-break: normal;
                    text-align: center;
                  }

                  #tablaProcesos td:nth-child(9) {
                    text-align: center;
                  }

                  /* Asegurar que la tabla no se desborde */
                  .table-responsive {
                    overflow-x: auto;
                    max-width: 100%;
                  }

                  /* Hacer que las celdas de texto largo muestren ellipsis */
                  #tablaProcesos td:nth-child(4),
                  #tablaProcesos td:nth-child(6),
                  #tablaProcesos td:nth-child(10) {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                  }

                  /* Estilos para tabla de Auditor√≠a - homog√©neos con Pendientes */
                  #tablaAuditoria {
                    width: 100%;
                    table-layout: fixed;
                    max-width: 100%;
                  }

                  #tablaAuditoria th,
                  #tablaAuditoria td {
                    padding: 0.5rem 0.4rem !important;
                    font-size: 12px;
                    line-height: 1.3;
                    vertical-align: middle;
                  }

                  #tablaAuditoria th {
                    font-size: 12px;
                    font-weight: 600;
                    background-color: #374151 !important;
                    text-align: center !important;
                    position: sticky;
                    top: 0;
                    z-index: 10;
                    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                  }

                  #tablaAuditoria td {
                    word-break: break-word;
                  }

                  /* Centrar columnas espec√≠ficas */
                  #tablaAuditoria td:nth-child(1),
                  #tablaAuditoria td:nth-child(4),
                  #tablaAuditoria td:nth-child(5),
                  #tablaAuditoria td:nth-child(6),
                  #tablaAuditoria td:nth-child(8),
                  #tablaAuditoria td:nth-child(9) {
                    text-align: center;
                  }

                  /* Columnas con ellipsis para texto largo en Auditor√≠a */
                  #tablaAuditoria td:nth-child(3),
                  #tablaAuditoria td:nth-child(6),
                  #tablaAuditoria td:nth-child(7) {
                    overflow: hidden;
                    text-overflow: ellipsis;
                    white-space: nowrap;
                  }

                  /* Duraci√≥n sin salto de l√≠nea */
                  #tablaAuditoria td:nth-child(9) {
                    white-space: nowrap;
                    font-size: 11px;
                    color: #94a3b8;
                  }

                  /* Hover effect en filas */
                  #tablaAuditoria tbody tr:hover {
                    background-color: #f8fafc !important;
                    cursor: pointer;
                  }

/* Eliminar estilos predeterminados de Bootstrap en la tabla */
                  #tablaProcesos .btn {
                    border: none !important;
                    padding: 0.375rem 0.75rem !important;
                  }

                  #modalEvidenciasActividades .preview-evidencia-item {
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    padding: 8px 10px;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    background: #f8fafc;
                    margin-bottom: 8px;
                  }

                  #modalEvidenciasActividades .preview-evidencia-thumb {
                    width: 48px;
                    height: 48px;
                    object-fit: cover;
                    border-radius: 6px;
                    border: 1px solid #e2e8f0;
                    background: #fff;
                  }

                  #modalEvidenciasActividades .preview-evidencia-meta {
                    display: flex;
                    flex-direction: column;
                    gap: 2px;
                    font-size: 12px;
                    color: #475569;
                  }

                  #modalEvidenciasActividades .actividad-selected {
                    background-color: #e0f2fe;
                  }

                  #modalEvidenciasActividades .evidencia-item-selected {
                    border-color: #3b82f6;
                    background: #e0f2fe;
                  }

                  #modalEvidenciasActividades .evidencia-visor {
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    background: #ffffff;
                    padding: 10px;
                    min-height: 220px;
                    max-height: 55vh;
                    overflow: auto;
                  }

                  #modalEvidenciasActividades .evidencia-visor iframe,
                  #modalEvidenciasActividades .evidencia-visor video {
                    width: 100%;
                    height: 52vh;
                    border: none;
                    border-radius: 6px;
                  }

                  #modalEvidenciasActividades .evidencia-visor img {
                    width: 100%;
                    height: auto;
                    max-height: 52vh;
                    object-fit: contain;
                    border-radius: 6px;
                  }

                  #modalEvidenciasActividades .evidencia-texto {
                    white-space: pre-wrap;
                    font-family: Consolas, "Courier New", monospace;
                    font-size: 12px;
                    color: #1e293b;
                  }

                  #modalEvidenciasActividades #linkAbrirEvidencia.disabled {
                    pointer-events: none;
                    color: #94a3b8;
                  }

                  #modalEvidenciasActividades #linkAbrirAdjuntoCausa.disabled {
                    pointer-events: none;
                    color: #94a3b8;
                  }

                  #descargaEvidenciasProgress .progress {
                    background-color: #e2e8f0;
                  }

                  #descargaEvidenciasProgress .progress-bar {
                    background-color: #2563eb;
                    transition: width 0.2s ease;
                  }

                  /* ==================== LOADING STATES ==================== */

                  /* Overlay de carga para tabla */
                  .table-loading-overlay {
                    position: absolute;
                    top: 0;
                    left: 0;
                    right: 0;
                    bottom: 0;
                    background: rgba(255, 255, 255, 0.95);
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    z-index: 1000;
                    backdrop-filter: blur(2px);
                  }

                  /* Spinner moderno */
                  .spinner-modern {
                    width: 48px;
                    height: 48px;
                    border: 4px solid #e2e8f0;
                    border-top-color: #3b82f6;
                    border-radius: 50%;
                    animation: spin 0.8s linear infinite;
                  }

                  @keyframes spin {
                    to { transform: rotate(360deg); }
                  }

                  /* Texto de carga */
                  .loading-text {
                    margin-top: 16px;
                    color: #64748b;
                    font-size: 14px;
                    font-weight: 500;
                  }

                  /* Skeleton loader para filas de tabla */
                  .skeleton-row {
                    background: linear-gradient(
                      90deg,
                      #f1f5f9 25%,
                      #e2e8f0 50%,
                      #f1f5f9 75%
                    );
                    background-size: 200% 100%;
                    animation: skeleton-loading 1.5s ease-in-out infinite;
                    height: 20px;
                    border-radius: 4px;
                  }

                  @keyframes skeleton-loading {
                    0% { background-position: 200% 0; }
                    100% { background-position: -200% 0; }
                  }

                  /* Bot√≥n en estado de carga */
                  .btn-loading {
                    position: relative;
                    pointer-events: none;
                    opacity: 0.7;
                  }

                  .btn-loading::after {
                    content: "";
                    position: absolute;
                    width: 16px;
                    height: 16px;
                    top: 50%;
                    left: 50%;
                    margin-left: -8px;
                    margin-top: -8px;
                    border: 2px solid transparent;
                    border-top-color: currentColor;
                    border-radius: 50%;
                    animation: spin 0.6s linear infinite;
                  }

                  /* Pulse animation para indicar actividad */
                  .loading-pulse {
                    animation: pulse-animation 1.5s ease-in-out infinite;
                  }

                  @keyframes pulse-animation {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                  }

                  /* Badge de "Cargando..." */
                  .loading-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 6px 12px;
                    background: #eff6ff;
                    border: 1px solid #bfdbfe;
                    border-radius: 8px;
                    color: #1e40af;
                    font-size: 13px;
                    font-weight: 500;
                  }

                  .loading-badge .spinner-small {
                    width: 14px;
                    height: 14px;
                    border: 2px solid #bfdbfe;
                    border-top-color: #3b82f6;
                    border-radius: 50%;
                    animation: spin 0.6s linear infinite;
                  }

                  /* ==================== FILTROS ACTIVOS BADGE ==================== */

                  .filtros-activos-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 6px;
                    padding: 6px 12px;
                    background: linear-gradient(135deg, #3b82f6, #2563eb);
                    border: 1px solid #1d4ed8;
                    border-radius: 20px;
                    color: white;
                    font-size: 12px;
                    font-weight: 600;
                    box-shadow: 0 2px 6px rgba(37, 99, 235, 0.3);
                    transition: all 0.3s ease;
                    animation: fadeInBounce 0.4s ease-out;
                  }

                  .filtros-activos-badge:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
                  }

                  .filtros-activos-badge .count {
                    background: rgba(255, 255, 255, 0.25);
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-weight: 700;
                    min-width: 24px;
                    text-align: center;
                  }

                  .filtros-activos-badge .bi-funnel-fill {
                    font-size: 13px;
                  }

                  @keyframes fadeInBounce {
                    0% {
                      opacity: 0;
                      transform: scale(0.8);
                    }
                    50% {
                      transform: scale(1.05);
                    }
                    100% {
                      opacity: 1;
                      transform: scale(1);
                    }
                  }

                  /* Badge para limpiar filtros */
                  .filtros-clear-badge {
                    display: inline-flex;
                    align-items: center;
                    gap: 4px;
                    padding: 4px 10px;
                    background: #f1f5f9;
                    border: 1px solid #cbd5e1;
                    border-radius: 16px;
                    color: #475569;
                    font-size: 11px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                  }

                  .filtros-clear-badge:hover {
                    background: #fee2e2;
                    border-color: #fca5a5;
                    color: #dc2626;
                  }

                  #modalEvidenciasActividades .estado-evidencia,
                  #modalAdminRegistroSgi .estado-evidencia {
                    display: inline-flex;
                    align-items: center;
                    padding: 2px 8px;
                    border-radius: 999px;
                    font-size: 11px;
                    font-weight: 600;
                  }

                  #modalEvidenciasActividades .estado-evidencia.pendiente,
                  #modalAdminRegistroSgi .estado-evidencia.pendiente {
                    background: #fef3c7;
                    color: #92400e;
                  }

                  #modalEvidenciasActividades .estado-evidencia.aprobada,
                  #modalAdminRegistroSgi .estado-evidencia.aprobada {
                    background: #dcfce7;
                    color: #166534;
                  }

                  #modalEvidenciasActividades .estado-evidencia.rechazada,
                  #modalAdminRegistroSgi .estado-evidencia.rechazada {
                    background: #fee2e2;
                    color: #991b1b;
                  }

                  #modalCerrarRegistro .historial-cambio,
                  #modalAdminRegistroSgi .historial-cambio {
                    background: #fff7ed;
                    border-left: 3px solid #fb923c;
                  }

                  #modalCerrarRegistro .historial-cambio .fw-semibold,
                  #modalAdminRegistroSgi .historial-cambio .fw-semibold {
                    color: #9a3412;
                  }
                </style>

                <!-- Filtros -->
                <div class="pendientes-filters-container">
                    <div class="pendientes-filters" role="region" aria-label="Filtros">
                        <div>
                            <label>Tipo de gesti√≥n</label>
                            <select id="filtroTipoGestion">
                                <option value="" selected>üìä Todos (PA + GC + RVD)</option>
                                <option value="PA">üìã PA - Plan de Acci√≥n</option>
                                <option value="GC">üîÑ GC - Gesti√≥n del Cambio</option>
                                <option value="RVD">üìù RVD - Revisi√≥n por Direcci√≥n</option>
                            </select>
                        </div>
                        <div>
                            <label>C√≥digo</label>
                            <select id="filtroUsuario">
                                <option value="">‚Äî Todos los c√≥digos ‚Äî</option>
                            </select>
                        </div>
                        <div>
                            <label>Proceso</label>
                            <select id="filtroProceso">
                                <option value="">‚Äî Todos los Procesos ‚Äî</option>
                            </select>
                        </div>
                        <div>
                            <label>Subproceso</label>
                            <select id="filtroSubproceso">
                                <option value="">‚Äî Todos los Subprocesos ‚Äî</option>
                            </select>
                        </div>
                        <div>
                            <label>Estado</label>
                            <select id="filtroEstado">
                                <option value="">(Todos)</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="En proceso">En proceso</option>
                                <option value="Abierta">Abierta</option>
                                <option value="Cerrado">Cerrado</option>
                            </select>
                        </div>
                        <div>
                            <label>Desde</label>
                            <input type="date" id="filtroDesde">
                        </div>
                        <div>
                            <label>Hasta</label>
                            <input type="date" id="filtroHasta">
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-secondary me-2" onclick="limpiarFiltros()">Limpiar</button>

                            <!-- Bot√≥n desplegable para descarga -->
                            <div class="btn-group me-2" role="group">
                                <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                    üì• Descargar
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="descargarDatos('xlsx')">
                                        <i class="fas fa-file-excel text-success me-2"></i>Descargar XLSX
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="descargarDatos('csv')">
                                        <i class="fas fa-file-csv text-warning me-2"></i>Descargar CSV
                                    </a></li>
                                </ul>
                            </div>

                            <!-- Badge de Filtros Activos -->
                            <div id="badgeFiltrosActivosPendientes" class="filtros-activos-badge" style="display: none;">
                                <i class="bi bi-funnel-fill"></i>
                                <span class="count">0</span>
                                <span>filtros activos</span>
                            </div>

                            <small class="text-muted">Los filtros se aplican autom√°ticamente.</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn-crear-modern btn-crear-blue"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalCrearPA"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="Crear nuevo Plan de Acci√≥n">
                                <i class="bi bi-plus-circle-fill icon-modern"></i>
                                <span class="text-modern">Crear PA</span>
                            </button>
                            <button class="btn-crear-modern btn-crear-green"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalGestionCambio"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="Gesti√≥n del Cambio">
                                <i class="bi bi-arrow-repeat icon-modern"></i>
                                <span class="text-modern">Crear GC</span>
                            </button>
                            <button class="btn-crear-modern btn-crear-orange"
                                    data-bs-toggle="modal"
                                    data-bs-target="#modalCrearRVD"
                                    data-bs-toggle="tooltip"
                                    data-bs-placement="top"
                                    title="Revisi√≥n y Validaci√≥n de Documentos">
                                <i class="bi bi-file-text icon-modern"></i>
                                <span class="text-modern">Crear RVD</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Resumen y Leyenda -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="d-flex align-items-center justify-content-center flex-wrap gap-3">
                            <small class="me-2"><strong>Filtrar por:</strong></small>

                            <div class="d-flex align-items-center">
                                <span class="bandera-alerta alerta-vencido me-2 filtro-leyenda"
                                      data-filtro="vencido"
                                      title="Click para filtrar solo vencidos"><i class="fas fa-exclamation-triangle"></i></span>
                                <small class="text-muted filtro-label" data-filtro="vencido">Vencidas: <span id="contadorVencidas" class="fw-bold">0</span></small>
                            </div>

                            <div class="d-flex align-items-center">
                                <span class="bandera-alerta alerta-proximo me-2 filtro-leyenda"
                                      data-filtro="proximo"
                                      title="Click para filtrar pr√≥ximos a vencer (‚â§10 d√≠as)"><i class="fas fa-clock"></i></span>
                                <small class="text-muted filtro-label" data-filtro="proximo">‚â§10 d√≠as: <span id="contadorProximoVencer" class="fw-bold">1</span></small>
                            </div>

                            <div class="d-flex align-items-center">
                                <span class="bandera-alerta alerta-ok me-2 filtro-leyenda"
                                      data-filtro="ok"
                                      title="Click para filtrar en plazo (+10 d√≠as)"><i class="fas fa-check-circle"></i></span>
                                <small class="text-muted filtro-label" data-filtro="ok">+10 d√≠as: <span id="contadorEnProceso" class="fw-bold">2</span></small>
                            </div>

                            <div class="d-flex align-items-center ms-3">
                                <small class="fw-bold">Total: <span id="contadorTotal" class="fw-bold text-primary">5</span></small>
                            </div>

                            <!-- Bot√≥n para limpiar filtros de vencimiento -->
                            <div class="d-flex align-items-center ms-3">
                                <button id="btnLimpiarFiltroVencimiento"
                                        class="btn btn-sm btn-outline-secondary"
                                        onclick="limpiarFiltroVencimiento()"
                                        style="display: none;">
                                    <i class="fas fa-times-circle me-1"></i> Quitar filtro
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Banner de advertencia de filtro activo -->
                <div id="bannerFiltroActivo" class="alert alert-warning mb-3" style="display: none;">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Filtro activo:</strong>
                            <span id="mensajeFiltroActivo"></span>
                        </div>
                        <button class="btn btn-sm btn-light" onclick="limpiarFiltroVencimiento()">
                            <i class="fas fa-times-circle me-1"></i> Ver todos los registros
                        </button>
                    </div>
                </div>

                <!-- Tabla de procesos -->
                <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden" style="position: relative;">
                    <!-- Loading Overlay -->
                    <div id="loadingOverlayPendientes" class="table-loading-overlay" style="display: none;">
                        <div class="spinner-modern"></div>
                        <div class="loading-text">Cargando datos...</div>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-striped table-hover w-full" id="tablaProcesos">
                            <thead class="bg-gray-800 text-white sticky top-0 z-10">
                                <tr>
                                    <th style="width: 80px;" class="px-4 py-3 text-left text-sm font-semibold">Alerta</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">C√≥digo</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Tipo</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Proceso</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Subproceso</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Actividad</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Fecha apertura</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Fecha cierre</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Estado</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Responsable</th>
                                    <th class="px-4 py-3 text-left text-sm font-semibold">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Los datos se cargar√°n din√°micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Paginaci√≥n -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div>
                        <small class="text-muted">Mostrando 1‚Äì5 de 5</small>
                    </div>
                    <div>
                        <nav>
                            <ul class="pagination pagination-sm mb-0">
                                <li class="page-item disabled">
                                    <span class="page-link">Anterior</span>
                                </li>
                                <li class="page-item active">
                                    <span class="page-link">1</span>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="#" onclick="cambiarPagina(2)">Siguiente</a>
                                </li>
                            </ul>
                        </nav>
                    </div>
                    <div>
                        <select class="form-select form-select-sm" style="width: auto;" id="registrosPorPagina">
                            <option value="25" selected>25</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>







        <!-- Pesta√±a Indicadores -->
        <div class="tab-pane fade" id="indicadores" role="tabpanel">
            <div class="container-fluid">
                <!-- Estilos espec√≠ficos para indicadores -->
                <style>
                  .indicadores-container {
                    --bg:#f5f6f8;
                    --card:#ffffff;
                    --ink:#1e293b;
                    --ink-2:#475569;
                    --muted:#94a3b8;
                    --line:#e2e8f0;
                    --brand:#173a64;
                    --brand-2:#0ea5e9;
                    --ok:#16a34a;
                    --bad:#dc2626;
                    --warn:#ca8a04;
                    --chip:#e9eef7;
                    --focus:#94c5ff;
                    --row-dark:#042241;
                    --row-light:#0c335d;
                    --row-alt:#0b2e53;
                    --btn:#e5e7eb;
                    --shadow:0 8px 24px rgba(2,6,23,.08);
                  }
                  .indicadores-container .shell{
                    background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow)
                  }
                  .indicadores-container .shell .topbar{
                    display:flex;align-items:center;justify-content:space-between;
                    padding:14px 16px;border-bottom:1px solid var(--line)
                  }
                  .indicadores-container .user-hello{display:flex;gap:10px;align-items:center;font-weight:700}
                  .indicadores-container .user-hello .avatar{
                    width:36px;height:36px;border-radius:999px;border:2px solid var(--line);
                    display:grid;place-items:center;color:var(--brand);font-size:18px
                  }
                  .indicadores-container .title{
                    padding:10px 16px 0 16px;font-weight:800;font-size:18px
                  }
                  .indicadores-container .actions{
                    display:flex;flex-direction:row;gap:12px;align-items:center;justify-content:flex-end;flex-wrap:wrap
                  }
                  .indicadores-container .action{
                    display:flex;gap:10px;align-items:center;text-decoration:none;color:var(--ink);
                    padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#fff;box-shadow:0 1px 0 rgba(0,0,0,.02)
                  }
                  .indicadores-container .action:hover{border-color:#dbe3ef}
                  .indicadores-container .action .ico{width:18px;height:18px;display:inline-grid;place-items:center}
                  .indicadores-container .filters{
                    display:grid;grid-template-columns:repeat(6,minmax(120px,1fr)) auto;
                    gap:10px;padding:12px 16px;border-bottom:1px solid var(--line)
                  }
                  .indicadores-container label.small{font-size:12px;color:var(--ink-2);display:block;margin-bottom:6px}
                  .indicadores-container select, .indicadores-container input[type="text"]{
                    width:100%;padding:8px 10px;border:1px solid var(--line);border-radius:8px;background:#fff;color:var(--ink)
                  }
                  .indicadores-container select:focus,.indicadores-container input:focus,.indicadores-container textarea:focus{outline:3px solid var(--focus);border-color:transparent}
                  .indicadores-container .btn-ind{
                    display:inline-flex;gap:8px;align-items:center;justify-content:center;border:1px solid var(--line);
                    background:var(--btn);padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600
                  }
                  .indicadores-container .btn-ind:hover{background:#dfe2e7}
                  .indicadores-container .btn-ind.primary{background:var(--brand-2);border-color:var(--brand-2);color:#fff}
                  .indicadores-container .btn-ind.danger{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
                  .indicadores-container .btn-ind.ghost{background:#fff}
                  .indicadores-container .btn-ind.icon{padding:8px}
                  .indicadores-container .table-wrap{padding:12px 16px 18px 16px}
                  .indicadores-container table{width:100%;border-collapse:collapse;border:1px solid #e5e7eb;}
                  .indicadores-container table td{padding:12px 8px;vertical-align:middle;border:1px solid #e5e7eb;}
                  .indicadores-container table th{padding:12px 8px;vertical-align:middle;white-space:nowrap;border:1px solid #e5e7eb;}
                  .indicadores-container td:last-child, .indicadores-container th:last-child{border-right:1px solid #e5e7eb;}
                  .indicadores-container .text-right{text-align:right;}
                  .indicadores-container .text-center{text-align:center;}
                  .indicadores-container .text-nowrap{white-space:nowrap;}
                  .indicadores-container .col-nombre{font-weight:500;color:#1e293b;}
                  .indicadores-container .col-resultado{font-weight:600;color:#0c4a6e;}
                  .indicadores-container .col-acciones{width:132px;text-align:center;}
                  .indicadores-container .btn-ic{
                    display:inline-flex;align-items:center;justify-content:center;
                    width:32px;height:32px;border:1px solid #d1d5db;border-radius:8px;
                    background:#f8fafc;cursor:pointer;transition:all 0.2s ease;
                  }
                  .indicadores-container .btn-ic:hover{background:#e2e8f0;border-color:#94a3b8;}
                  .indicadores-container .btn-ic:disabled{
                    opacity:0.5;cursor:not-allowed;background:#f1f5f9;border-color:#e2e8f0;
                  }
                  .indicadores-container .btn-ic:disabled:hover{background:#f1f5f9;border-color:#e2e8f0;}
                  .indicadores-container .actions-container{
                    display:flex;align-items:center;justify-content:center;gap:8px;margin:0 auto;
                  }
                  .indicadores-container .chip{
                    display:inline-flex;align-items:center;justify-content:center;
                    padding:6px 12px;border-radius:20px;font-size:11px;font-weight:600;
                    min-width:80px;height:28px;text-align:center;
                  }
                  .indicadores-container .chip.ok{background:#dcfce7;color:#166534;border:1px solid #bbf7d0;}
                  .indicadores-container .chip.bad{background:#fef2f2;color:#dc2626;border:1px solid #fecaca;}
                  .indicadores-container tbody tr:hover{background-color:#f8fafc !important;}
                  .indicadores-container .modal{
                    position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;align-items:center;justify-content:center;padding:20px;z-index:50
                  }
                  .indicadores-container .modal.open{display:flex}
                  .indicadores-container .dialog{
                    width:min(820px,96vw);background:#fff;border-radius:16px;border:1px solid var(--line);box-shadow:var(--shadow);
                    overflow:hidden;animation:pop .18s ease-out
                  }
                  @keyframes pop{from{transform:translateY(8px);opacity:0}to{transform:none;opacity:1}}
                  .indicadores-container .dialog header{
                    padding:14px 16px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center;font-weight:800
                  }
                  .indicadores-container .dialog .body{padding:14px 16px 18px 16px}
                  .indicadores-container .form-grid{
                    display:grid;grid-template-columns:1fr 1fr;gap:14px
                  }
                  .indicadores-container .row-2{grid-column:1 / span 2}
                  .indicadores-container .field label{font-size:12px;color:var(--ink-2);display:block;margin-bottom:6px}
                  .indicadores-container .field input,.indicadores-container .field select,.indicadores-container .field textarea{
                    width:100%;padding:10px;border:1px solid var(--line);border-radius:10px;background:#fff
                  }
                  .indicadores-container .field textarea{min-height:90px;resize:vertical}
                  .indicadores-container .req::after{content:" *";color:var(--bad);font-weight:800}
                  .indicadores-container .dialog footer{
                    padding:12px 16px;border-top:1px solid var(--line);display:flex;justify-content:space-between;align-items:center
                  }
                  .indicadores-container .badge-tip{font-size:12px;color:var(--ink-2)}
                  .indicadores-container .splash{
                    text-align:center;padding:24px
                  }
                  .indicadores-container .splash .big{
                    width:160px;height:160px;border-radius:999px;margin:0 auto 10px auto;display:grid;place-items:center;color:#fff;font-size:86px;font-weight:800
                  }
                  .indicadores-container .big.ok{background:linear-gradient(135deg,#22c55e,#16a34a)}
                  .indicadores-container .big.bad{background:linear-gradient(135deg,#ef4444,#b91c1c)}
                  .indicadores-container .splash h3{margin:0 0 4px 0}
                  .indicadores-container .splash p{margin:0;color:var(--ink-2)}
                  .indicadores-container .chart{width:min(960px,96vw);background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:12px 16px}
                  .indicadores-container canvas{display:block;width:100%;height:260px}
                  @media (max-width:860px){
                    .indicadores-container .filters{grid-template-columns:repeat(2,1fr);grid-auto-rows:auto}
                    .indicadores-container .actions{flex-direction:column;align-items:flex-end}
                    .indicadores-container .form-grid{grid-template-columns:1fr}
                    .indicadores-container .row-2{grid-column:auto}
                  }
                </style>

                <div class="indicadores-container">
                    <div class="shell">
                      <div class="topbar">
                        <div class="actions">
                          <button class="action" id="btnAdd">
                            <span class="ico">‚ûï</span><span>Reporte indicadores</span>
                          </button>
                          <button class="action" id="btnDownload">
                            <span class="ico">üì•</span><span>Descargar base</span>
                          </button>
                          <button class="action" id="btnCharts">
                            <span class="ico">üìä</span><span>Visualizar gr√°ficas</span>
                          </button>
                          <button class="action" id="btnEditToggle" title="Modo edici√≥n">
                            <span class="ico">‚úèÔ∏è</span><span>Editar reporte</span>
                          </button>
                        </div>
                      </div>

                      <!-- Filtros -->
                      <div class="filters" role="region" aria-label="Filtros">
                        <div>
                          <label class="small">Proceso</label>
                          <select id="fProceso"><option value="">Seleccionar</option></select>
                        </div>
                        <div>
                          <label class="small">Subproceso</label>
                          <select id="fSubproceso"><option value="">Seleccionar</option></select>
                        </div>
                        <div>
                          <label class="small">C√≥digo</label>
                          <select id="fCodigo"><option value="">Seleccionar</option></select>
                        </div>
                        <div>
                          <label class="small">A√±o</label>
                          <select id="fAnio"><option value="">Seleccionar</option></select>
                        </div>
                        <div>
                          <label class="small">Mes</label>
                          <select id="fMes"><option value="">Seleccionar</option></select>
                        </div>
                        <div>
                          <label class="small">¬øCumple?</label>
                          <select id="fCumple">
                            <option value="">Seleccionar</option>
                            <option value="Cumple">Cumple</option>
                            <option value="No cumple">No cumple</option>
                          </select>
                        </div>
                        <div style="display:grid;align-items:end">
                          <button class="btn-ind" id="btnClear">Borrar filtros</button>
                        </div>
                      </div>

                      <!-- Tabla -->
                      <div class="table-wrap">
                        <div class="table-responsive">
                          <table class="table table-striped table-hover" id="grid">
                            <thead class="table-dark">
                              <tr>
                                <th scope="col" style="min-width:120px">Proceso</th>
                                <th scope="col" style="min-width:120px">Subproceso</th>
                                <th scope="col" style="min-width:120px">C√≥digo</th>
                                <th scope="col" style="min-width:200px">Nombre</th>
                                <th scope="col" style="width:90px">U. medida</th>
                                <th scope="col" style="width:80px" class="text-center">Meta</th>
                                <th scope="col" style="width:100px">Frecuencia</th>
                                <th scope="col" style="width:70px" class="text-center">A√±o</th>
                                <th scope="col" style="width:80px" class="text-center">Mes</th>
                                <th scope="col" style="width:100px" class="text-center">Fecha reporte</th>
                                <th scope="col" style="width:90px" class="text-center">Resultado</th>
                                <th scope="col" style="width:100px" class="text-center">¬øCumple?</th>
                                <th scope="col" style="width:70px" class="text-center">Editado</th>
                                <th scope="col" class="text-center col-acciones">Acciones</th>
                              </tr>
                            </thead>
                            <tbody id="tbody"></tbody>
                          </table>
                        </div>
                      </div>
                    </div>

                    <!-- Modal de formulario -->
                    <div class="modal" id="modalForm" aria-hidden="true">
                      <div class="dialog" role="dialog" aria-modal="true" aria-labelledby="dlgTitle">
                        <header>
                          <div id="dlgTitle">REPORTE DE INDICADORES</div>
                          <button class="btn-ind icon" id="xForm" aria-label="Cerrar">‚úñ</button>
                        </header>
                        <div class="body">
                          <div class="badge-tip">Lea muy bien los datos antes de registrar el indicador</div>
                          <form id="formInd">
                            <div class="form-grid">
                              <div class="field">
                                <label class="req">C√≥digo</label>
                                <select id="iCodigo"></select>
                              </div>
                              <div class="field">
                                <label>Nombre</label>
                                <input id="iNombre" type="text" placeholder="Nombre por defecto" readonly />
                              </div>
                              <div class="field">
                                <label>Meta</label>
                                <input id="iMeta" type="number" step="any" readonly />
                              </div>
                              <div class="field">
                                <label>Unidad de medida</label>
                                <input id="iUnidad" type="text" readonly />
                              </div>

                              <div class="field">
                                <label class="req">A√±o reporte</label>
                                <select id="iAnio"></select>
                              </div>
                              <div class="field">
                                <label class="req">Mes reporte</label>
                                <select id="iMes"></select>
                              </div>

                              <div class="row-2">
                                <label>Reporte de indicador</label>
                                <div style="font-size:12px;color:var(--ink-2);margin-bottom:6px">Por defecto de acuerdo a la f√≥rmula e interacci√≥n de las variables</div>
                              </div>

                              <!-- Variables (hasta 4) -->
                              <div class="field">
                                <label class="req">Variable 1</label>
                                <input id="v1" type="number" step="any" placeholder="De acuerdo a la f√≥rmula" required />
                              </div>
                              <div class="field">
                                <label class="req">Variable 2</label>
                                <input id="v2" type="number" step="any" placeholder="De acuerdo a la f√≥rmula" required />
                              </div>
                              <div class="field">
                                <label>Variable 3</label>
                                <input id="v3" type="number" step="any" placeholder="Opcional" />
                              </div>
                              <div class="field">
                                <label>Variable 4</label>
                                <input id="v4" type="number" step="any" placeholder="Opcional" />
                              </div>

                              <div class="field row-2">
                                <label class="req">An√°lisis del indicador</label>
                                <textarea id="iAnalisis" placeholder="Describa caracter√≠sticas y observaciones que llevaron al resultado" required></textarea>
                              </div>
                            </div>
                            <footer>
                              <div class="badge-tip" id="lblFormula">F√≥rmula:</div>
                              <div style="display:flex;gap:8px">
                                <button type="button" class="btn-ind danger" id="btnCancelForm">Cancelar reporte ‚úñ</button>
                                <button type="submit" class="btn-ind primary">Enviar reporte ‚úì</button>
                              </div>
                            </footer>
                          </form>
                        </div>
                      </div>
                    </div>

                    <!-- Modal splash de resultado -->
                    <div class="modal" id="modalSplash" aria-hidden="true">
                      <div class="dialog" role="dialog" aria-modal="true">
                        <header>
                          <div>REPORTE DE INDICADORES</div>
                          <button class="btn-ind icon" id="xSplash">‚úñ</button>
                        </header>
                        <div class="body">
                          <div class="splash" id="splashOk" hidden>
                            <div class="big ok">‚úî</div>
                            <h3>Su registro se ha realizado con √©xito</h3>
                            <p>El resultado fue menor o igual a la meta establecida</p>
                          </div>
                          <div class="splash" id="splashBad" hidden>
                            <div class="big bad">‚úñ</div>
                            <h3>No realiza reporte</h3>
                            <p>El resultado no cumple con la meta establecida</p>
                          </div>
                        </div>
                        <footer style="display:flex;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--line)">
                          <button class="btn-ind primary" id="okSplash">Entendido</button>
                        </footer>
                      </div>
                    </div>

                    <!-- Modal de gr√°ficos -->
                    <div class="modal" id="modalCharts" aria-hidden="true">
                      <div class="chart" role="dialog" aria-modal="true" aria-labelledby="chartTitle">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                          <strong id="chartTitle">Gr√°fico de tendencia ‚Äî Resultado vs Meta</strong>
                          <button class="btn-ind icon" id="xChart">‚úñ</button>
                        </div>
                        <div style="display:grid;grid-template-columns:1fr 220px;gap:12px">
                          <canvas id="chartCanvas" height="260"></canvas>
                          <div style="border:1px solid var(--line);border-radius:12px;padding:10px">
                            <label class="small">C√≥digo</label>
                            <select id="chartCodigo"></select>
                            <div style="margin-top:10px;font-size:12px;color:var(--ink-2)">
                              El gr√°fico es renderizado con Canvas puro (sin librer√≠as) para mantener el archivo aut√≥nomo.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>

                <script>
                /* ==========================
                   Datos simulados (mock) - Indicadores
                   ========================== */
                const indicatorsCatalog = [
                  {
                    proceso: "HSEQ",
                    subproceso: "SST",
                    codigo: "IN-HSEQ-01",
                    nombre: "Frecuencia de accidentalidad",
                    unidad: "Unidad",
                    meta: 1.04,
                    frecuencia: "Mensual",
                    formula: "(v1 / v2) * 1",
                    variables: ["# incidentes", "# trabajadores", "", ""]
                  },
                  {
                    proceso: "HSEQ",
                    subproceso: "Calidad",
                    codigo: "IN-HSEQ-02",
                    nombre: "Porcentaje de PQRS respondidas a tiempo",
                    unidad: "%",
                    meta: 95,
                    frecuencia: "Mensual",
                    formula: "(v1 / v2) * 100",
                    variables: ["Atendidas a tiempo", "Recibidas", "", ""]
                  },
                  {
                    proceso: "HSEQ",
                    subproceso: "Ambiental",
                    codigo: "IN-HSEQ-03",
                    nombre: "Consumo de agua por 1000 km",
                    unidad: "m¬≥/1000km",
                    meta: 2.5,
                    frecuencia: "Mensual",
                    formula: "v1 / v2",
                    variables: ["m¬≥ consumidos", "km/1000", "", ""]
                  }
                ];

                // Registros iniciales
                const seedRows = [
                  {
                    proceso:"HSEQ", subproceso:"SST", codigo:"IN-HSEQ-01", nombre:"Frecuencia de accidentalidad", unidad:"Unidad",
                    meta:1.04, frecuencia:"Mensual", anio:2025, mes:"Enero", fecha:"10/02/2025",
                    resultado:0.85, cumple:"Cumple", editado:0, analisis:"Sin novedades durante el per√≠odo evaluado."
                  },
                  {
                    proceso:"HSEQ", subproceso:"SST", codigo:"IN-HSEQ-01", nombre:"Frecuencia de accidentalidad", unidad:"Unidad",
                    meta:1.04, frecuencia:"Mensual", anio:2025, mes:"Febrero", fecha:"09/03/2025",
                    resultado:1.10, cumple:"No cumple", editado:1, analisis:"Aumento por incidente en patio de maniobras."
                  },
                  {
                    proceso:"HSEQ", subproceso:"Calidad", codigo:"IN-HSEQ-02", nombre:"Porcentaje de PQRS respondidas a tiempo", unidad:"%",
                    meta:95.00, frecuencia:"Mensual", anio:2025, mes:"Enero", fecha:"15/02/2025",
                    resultado:97.50, cumple:"Cumple", editado:0, analisis:"Excelente gesti√≥n del equipo de atenci√≥n al cliente."
                  }
                ];

                const months = ["Enero","Febrero","Marzo","Abril","Mayo","Junio","Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"];
                const years = [2025,2026,2027];

                let rowsIndicadores = [...seedRows];
                let editModeIndicadores = false;

                /* ==========================
                   Utilidades - Indicadores
                   ========================== */
                const $ind = s => document.querySelector(s);

                function toCsvIndicadores(items){
                  const head = ["Proceso","Subproceso","C√≥digo","Nombre","Unidad de medida","Meta","Frecuencia","A√±o","Mes","Fecha reporte","Resultado","¬øCumple?","Editado","An√°lisis"];
                  const lines = [head.join(";")].concat(items.map(r => [
                    r.proceso, r.subproceso, r.codigo, r.nombre, r.unidad, r.meta, r.frecuencia, r.anio, r.mes, r.fecha, r.resultado, r.cumple, r.editado, (r.analisis||"")
                  ].map(v => String(v).replaceAll(";",",")).join(";")));
                  return lines.join("\n");
                }

                function downloadFileIndicadores(filename, text){
                  const blob = new Blob([text], {type: "text/csv;charset=utf-8"});
                  const a = document.createElement("a");
                  a.href = URL.createObjectURL(blob);
                  a.download = filename;
                  a.click();
                  URL.revokeObjectURL(a.href);
                }

                function formatDateIndicadores(d){
                  const dd = String(d.getDate()).padStart(2,"0");
                  const mm = String(d.getMonth()+1).padStart(2,"0");
                  const yyyy = d.getFullYear();
                  return `${dd}/${mm}/${yyyy}`;
                }

                /* ==========================
                   Poblado de combos filtros - Indicadores
                   ========================== */
                function fillFilterOptionsIndicadores(){
                  const unique = (arr, key) => [...new Set(arr.map(o => o[key]))];
                  const byMes = unique(rowsIndicadores, "mes");
                  const byAnio = unique(rowsIndicadores, "anio").sort((a,b)=>a-b);
                  const byCod = unique(rowsIndicadores, "codigo");

                  $ind("#fMes").innerHTML = `<option value="">Seleccionar</option>` + months.map(m=>`<option>${m}</option>`).join("");
                  $ind("#fAnio").innerHTML = `<option value="">Seleccionar</option>` + years.map(y=>`<option>${y}</option>`).join("");
                  $ind("#fCodigo").innerHTML = `<option value="">Seleccionar</option>` + byCod.map(c=>`<option>${c}</option>`).join("");

                  // Los dropdowns de Proceso y Subproceso se llenan desde la base de datos
                  // mediante la funci√≥n llenarSelectProcesos() que ya est√° configurada
                }

                /* ==========================
                   Tabla - Indicadores
                   ========================== */
                function paintTableIndicadores(){
                  const tb = $ind("#tbody");
                  const f = {
                    proc: $ind("#fProceso").value,
                    sub: $ind("#fSubproceso").value,
                    cod: $ind("#fCodigo").value,
                    anio: $ind("#fAnio").value,
                    mes: $ind("#fMes").value,
                    cmp: $ind("#fCumple").value
                  };
                  const filtered = rowsIndicadores.filter(r =>
                    (!f.proc || r.proceso===f.proc) &&
                    (!f.sub || r.subproceso===f.sub) &&
                    (!f.cod || r.codigo===f.cod) &&
                    (!f.anio || String(r.anio)===f.anio) &&
                    (!f.mes || r.mes===f.mes) &&
                    (!f.cmp || r.cumple===f.cmp)
                  );

                  tb.innerHTML = "";
                  for(const r of filtered){
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                      <td>${r.proceso}</td>
                      <td>${r.subproceso}</td>
                      <td class="text-nowrap">${r.codigo}</td>
                      <td class="col-nombre">${r.nombre}</td>
                      <td class="text-center">${r.unidad}</td>
                      <td class="text-right">${Number(r.meta).toFixed(2)}</td>
                      <td>${r.frecuencia}</td>
                      <td class="text-center">${r.anio}</td>
                      <td class="text-center">${r.mes}</td>
                      <td class="text-center text-nowrap">${r.fecha}</td>
                      <td class="text-right col-resultado">${Number(r.resultado).toFixed(2)}</td>
                      <td class="text-center">${r.cumple === "Cumple"
                          ? `<span class="chip ok">Cumple</span>`
                          : `<span class="chip bad">No cumple</span>`}</td>
                      <td class="text-center">${r.editado}</td>
                      <td class="col-acciones">
                        <div class="actions-container">
                          <button class="btn-ic" title="Ver an√°lisis del indicador" aria-label="Ver an√°lisis" data-act="view">
                            <span aria-hidden="true">üëÅÔ∏è</span>
                          </button>
                          <button class="btn-ic" title="${editModeIndicadores?'Editar indicador':'Modo edici√≥n desactivado'}" aria-label="${editModeIndicadores?'Editar':'Bloqueado'}" data-act="edit" ${!editModeIndicadores?'disabled':''}>
                            <span aria-hidden="true">‚úèÔ∏è</span>
                          </button>
                          <button class="btn-ic" title="${editModeIndicadores?'Eliminar indicador':'Modo edici√≥n desactivado'}" aria-label="${editModeIndicadores?'Eliminar':'Bloqueado'}" data-act="del" ${!editModeIndicadores?'disabled':''}>
                            <span aria-hidden="true">üóëÔ∏è</span>
                          </button>
                        </div>
                      </td>
                    `;
                    tr.querySelector("[data-act=view]").onclick = () => alert(`AN√ÅLISIS:\n\n${r.analisis || 'Sin an√°lisis'}`);
                    tr.querySelector("[data-act=edit]").onclick = () => editRowIndicadores(r);
                    tr.querySelector("[data-act=del]").onclick = () => deleteRowIndicadores(r);
                    tb.appendChild(tr);
                  }
                }

                /* ==========================
                   Form Modal - Indicadores
                   ========================== */
                const dlgFormIndicadores = $ind("#modalForm");
                const dlgSplashIndicadores = $ind("#modalSplash");
                const splashOkIndicadores = $ind("#splashOk");
                const splashBadIndicadores = $ind("#splashBad");

                function openFormIndicadores(presetCode=""){
                  $ind("#iCodigo").innerHTML = indicatorsCatalog.map(o => `<option value="${o.codigo}">${o.codigo}</option>`).join("");
                  $ind("#iAnio").innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join("");
                  $ind("#iMes").innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join("");

                  if(presetCode){
                    $ind("#iCodigo").value = presetCode;
                  }
                  syncIndicatorHeadIndicadores();
                  $ind("#iAnalisis").value = "";
                  $ind("#v1").value = $ind("#v2").value = $ind("#v3").value = $ind("#v4").value = "";
                  const now = new Date();
                  $ind("#iAnio").value = now.getFullYear();
                  $ind("#iMes").value = months[now.getMonth()];
                  showModalIndicadores(dlgFormIndicadores);
                }

                function syncIndicatorHeadIndicadores(){
                  const cod = $ind("#iCodigo").value;
                  const ind = indicatorsCatalog.find(x => x.codigo===cod);
                  $ind("#iNombre").value = ind?.nombre || "";
                  $ind("#iMeta").value = ind?.meta ?? "";
                  $ind("#iUnidad").value = ind?.unidad || "";
                  $ind("#lblFormula").textContent = "F√≥rmula: " + (ind?.formula || "");
                  const [p1,p2,p3,p4] = ind?.variables ?? ["Variable 1","Variable 2","Variable 3","Variable 4"];
                  $ind("#v1").placeholder = p1 || "De acuerdo a la f√≥rmula";
                  $ind("#v2").placeholder = p2 || "De acuerdo a la f√≥rmula";
                  $ind("#v3").placeholder = p3 || "Opcional";
                  $ind("#v4").placeholder = p4 || "Opcional";
                }

                function computeResultIndicadores(form){
                  const cod = $ind("#iCodigo").value;
                  const ind = indicatorsCatalog.find(x => x.codigo===cod);
                  const get = id => parseFloat((form[id].value||"").replace(",","."));
                  const v1 = get("v1"), v2 = get("v2"), v3 = get("v3")||0, v4 = get("v4")||0;

                  const ctx = {v1, v2, v3, v4};
                  let result = NaN;
                  try{
                    const expr = ind.formula.replaceAll("v1",ctx.v1).replaceAll("v2",ctx.v2).replaceAll("v3",ctx.v3).replaceAll("v4",ctx.v4);
                    result = Function(`"use strict"; return (${expr});`)();
                  }catch{ result = NaN }
                  return {result, meta: ind.meta, unidad: ind.unidad, nombre: ind.nombre, proceso: ind.proceso, subproceso: ind.subproceso, frecuencia: ind.frecuencia};
                }

                function showModalIndicadores(el){ el.classList.add("open"); el.setAttribute("aria-hidden","false"); }
                function closeModalIndicadores(el){ el.classList.remove("open"); el.setAttribute("aria-hidden","true"); }

                /* ==========================
                   Event Listeners - Indicadores
                   ========================== */
                if ($ind("#iCodigo")) {
                  $ind("#iCodigo").addEventListener("change", syncIndicatorHeadIndicadores);
                  $ind("#xForm").onclick = () => closeModalIndicadores(dlgFormIndicadores);
                  $ind("#btnCancelForm").onclick = () => closeModalIndicadores(dlgFormIndicadores);
                  $ind("#btnAdd").onclick = () => openFormIndicadores($ind("#fCodigo").value || "");

                  $ind("#formInd").addEventListener("submit", e=>{
                    e.preventDefault();
                    const f = e.target;
                    if(!f.checkValidity()){ f.reportValidity(); return; }

                    const {result, meta, unidad, nombre, proceso, subproceso, frecuencia} = computeResultIndicadores(f);
                    if(!isFinite(result)){ alert("No se pudo calcular el resultado. Revise las variables."); return; }

                    const anio = parseInt($ind("#iAnio").value,10);
                    const mes = $ind("#iMes").value;
                    const fecha = formatDateIndicadores(new Date());
                    const cumple = (result <= meta) ? "Cumple" : "No cumple";
                    const codigo = $ind("#iCodigo").value;

                    rowsIndicadores.unshift({
                      proceso, subproceso, codigo, nombre, unidad, meta, frecuencia,
                      anio, mes, fecha, resultado: +Number(result).toFixed(3),
                      cumple, editado: 0, analisis: $ind("#iAnalisis").value.trim()
                    });

                    fillFilterOptionsIndicadores();
                    paintTableIndicadores();
                    closeModalIndicadores(dlgFormIndicadores);

                    splashOkIndicadores.hidden = !(cumple==="Cumple");
                    splashBadIndicadores.hidden = !(cumple!=="Cumple");
                    showModalIndicadores(dlgSplashIndicadores);
                  });

                  $ind("#xSplash").onclick = () => closeModalIndicadores(dlgSplashIndicadores);
                  $ind("#okSplash").onclick = () => closeModalIndicadores(dlgSplashIndicadores);

                  $ind("#btnDownload").onclick = () => {
                    const csv = toCsvIndicadores(rowsIndicadores);
                    downloadFileIndicadores("base_indicadores.csv", csv);
                  };

                  $ind("#btnEditToggle").onclick = () => {
                    editModeIndicadores = !editModeIndicadores;
                    $ind("#btnEditToggle").classList.toggle("primary", editModeIndicadores);
                    $ind("#btnEditToggle").innerHTML = `<span class="ico">‚úèÔ∏è</span><span>${editModeIndicadores?'Modo edici√≥n activo':'Editar reporte'}</span>`;
                    paintTableIndicadores();
                  };

                  $ind("#btnClear").onclick = () => {
                    ["#fProceso","#fSubproceso","#fCodigo","#fAnio","#fMes","#fCumple"].forEach(id => $ind(id).value="");
                    paintTableIndicadores();
                  };

                  ["#fProceso","#fSubproceso","#fCodigo","#fAnio","#fMes","#fCumple"].forEach(id => $ind(id).addEventListener("change", paintTableIndicadores));

                  // Charts
                  const dlgChartsIndicadores = $ind("#modalCharts");
                  const ctxCanvasIndicadores = $ind("#chartCanvas");
                  const chartCodigoIndicadores = $ind("#chartCodigo");

                  $ind("#btnCharts").onclick = () => {
                    chartCodigoIndicadores.innerHTML = [...new Set(rowsIndicadores.map(r=>r.codigo))].map(c=>`<option>${c}</option>`).join("");
                    chartCodigoIndicadores.onchange = drawChartIndicadores;
                    drawChartIndicadores();
                    showModalIndicadores(dlgChartsIndicadores);
                  };
                  $ind("#xChart").onclick = () => closeModalIndicadores(dlgChartsIndicadores);

                  function drawChartIndicadores(){
                    const code = chartCodigoIndicadores.value || [...new Set(rowsIndicadores.map(r=>r.codigo))][0];
                    const data = rowsIndicadores.filter(r=>r.codigo===code).slice().sort((a,b)=>{
                      const idxA = months.indexOf(a.mes), idxB = months.indexOf(b.mes);
                      if(a.anio===b.anio) return idxA-idxB; return a.anio-b.anio;
                    });
                    const labels = data.map(d => `${d.mes.slice(0,3)}-${String(d.anio).slice(-2)}`);
                    const results = data.map(d => d.resultado);
                    const meta = data.map(d => d.meta);

                    const cvs = ctxCanvasIndicadores;
                    const dpr = window.devicePixelRatio || 1;
                    const w = cvs.clientWidth, h = cvs.clientHeight;
                    cvs.width = w*dpr; cvs.height = h*dpr;
                    const g = cvs.getContext("2d");
                    g.setTransform(dpr,0,0,dpr,0,0);
                    g.clearRect(0,0,w,h);

                    const pad = 36, baseY = h - pad, baseX = pad;
                    g.strokeStyle="#cbd5e1"; g.lineWidth=1.2;
                    g.beginPath(); g.moveTo(baseX, 16); g.lineTo(baseX, baseY); g.lineTo(w-8, baseY); g.stroke();

                    const maxY = Math.max(...results, ...meta) * 1.25 || 1;
                    const scaleY = (v)=> baseY - (v/maxY)*(baseY-30);
                    const stepX = (w - baseX - 20) / Math.max(1,labels.length-1);

                    g.strokeStyle="#64748b";
                    g.beginPath();
                    meta.forEach((m,i)=>{
                      const x = baseX + i*stepX;
                      const y = scaleY(m);
                      if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
                    });
                    g.stroke();

                    g.strokeStyle="#0ea5e9"; g.fillStyle="#0ea5e9";
                    g.beginPath();
                    results.forEach((m,i)=>{
                      const x = baseX + i*stepX;
                      const y = scaleY(m);
                      if(i===0) g.moveTo(x,y); else g.lineTo(x,y);
                    });
                    g.stroke();
                    results.forEach((m,i)=>{
                      const x = baseX + i*stepX;
                      const y = scaleY(m);
                      g.beginPath(); g.arc(x,y,3.5,0,Math.PI*2); g.fill();
                    });

                    g.fillStyle="#475569"; g.font="12px system-ui";
                    labels.forEach((t,i)=> g.fillText(t, baseX + i*stepX - 12, baseY+14));

                    const ind = indicatorsCatalog.find(x=>x.codigo===code);
                    $ind("#chartTitle").textContent = `Gr√°fico de tendencia ‚Äî ${code} (${ind?.nombre || ""})`;
                  }

                  function editRowIndicadores(r){
                    if(!editModeIndicadores) return;
                    openFormIndicadores(r.codigo);
                    $ind("#iAnio").value = r.anio;
                    $ind("#iMes").value = r.mes;
                    $ind("#iAnalisis").value = r.analisis || "";
                  }

                  function deleteRowIndicadores(r){
                    if(!editModeIndicadores) return;
                    if(confirm(`¬øEliminar el registro ${r.codigo} ‚Äî ${r.mes} ${r.anio}?`)){
                      rowsIndicadores = rowsIndicadores.filter(x => x !== r);
                      paintTableIndicadores();
                    }
                  }

                  // Boot
                  fillFilterOptionsIndicadores();
                  paintTableIndicadores();
                }
                </script>
            </div>
        </div>
        <!-- Pesta√±a Auditor√≠a -->
        <div class="tab-pane fade" id="auditoria" role="tabpanel">
            <div class="container-fluid">
                <h4 class="mb-3" style="font-family: 'Century Gothic', sans-serif;">
                    <i class="bi bi-shield-check"></i> Auditor√≠a del Sistema
                </h4>

                <!-- Filtros de b√∫squeda -->
                <div class="pendientes-filters-container">
                    <div class="pendientes-filters" role="region" aria-label="Filtros de Auditor√≠a" style="grid-template-columns: repeat(7, minmax(120px, 1fr));">
                        <div>
                            <label>Fecha Desde</label>
                            <input type="date" id="filtroFechaDesdeAud">
                        </div>
                        <div>
                            <label>Fecha Hasta</label>
                            <input type="date" id="filtroFechaHastaAud">
                        </div>
                        <div>
                            <label>Usuario</label>
                            <input type="text" id="filtroUsuarioAud" placeholder="Buscar usuario...">
                        </div>
                        <div>
                            <label>Acci√≥n</label>
                            <select id="filtroAccionAud">
                                <option value="">Todas las acciones</option>
                                <option value="CREAR">‚ú® CREAR</option>
                                <option value="MODIFICAR">‚úèÔ∏è MODIFICAR</option>
                                <option value="ELIMINAR">üóëÔ∏è ELIMINAR</option>
                                <option value="CONSULTAR">üëÅÔ∏è CONSULTAR</option>
                                <option value="EXPORTAR">üìä EXPORTAR</option>
                                <option value="APROBAR">‚úÖ APROBAR</option>
                                <option value="RECHAZAR">‚ùå RECHAZAR</option>
                            </select>
                        </div>
                        <div>
                            <label>M√≥dulo</label>
                            <select id="filtroModuloAud">
                                <option value="">Todos los m√≥dulos</option>
                                <option value="PA">üìã Plan de Acci√≥n</option>
                                <option value="GC">üîÑ Gesti√≥n de Cambio</option>
                                <option value="RVD">üìä Revisi√≥n por Direcci√≥n</option>
                                <option value="SGI">üè¢ SGI</option>
                                <option value="AUDITORIA">üîç Auditor√≠a</option>
                            </select>
                        </div>
                        <div>
                            <label>Resultado</label>
                            <select id="filtroResultadoAud">
                                <option value="">Todos</option>
                                    <option value="exito">‚úÖ Exitoso</option>
                                    <option value="error">‚ùå Error</option>
                                    <option value="advertencia">‚ö†Ô∏è Advertencia</option>
                            </select>
                        </div>
                        <div>
                            <label>C√≥digo Registro</label>
                            <input type="text" id="filtroCodigoAud" placeholder="PA-2025-001...">
                        </div>
                    </div>
                </div>

                <!-- Botones de acci√≥n -->
                <div class="row mb-3">
                    <div class="col-12 d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-3">
                            <button class="btn btn-secondary btn-sm" onclick="limpiarFiltrosAud()">
                                <i class="bi bi-x-circle"></i> Limpiar
                            </button>

                            <!-- Badge de Filtros Activos Auditor√≠a -->
                            <div id="badgeFiltrosActivosAuditoria" class="filtros-activos-badge" style="display: none;">
                                <i class="bi bi-funnel-fill"></i>
                                <span class="count">0</span>
                                <span>filtros activos</span>
                            </div>

                            <!-- Mensaje informativo (igual que Pendientes) -->
                            <small class="text-muted fst-italic">
                                <i class="bi bi-info-circle"></i> Los filtros se aplican autom√°ticamente
                            </small>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-success btn-sm" onclick="exportarAuditoria('excel')">
                                <i class="bi bi-file-earmark-excel"></i> Excel
                            </button>
                            <button type="button" class="btn btn-info btn-sm" onclick="exportarAuditoria('csv')">
                                <i class="bi bi-file-earmark-text"></i> CSV
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Dashboard de estad√≠sticas -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card border-primary" style="border-width: 2px;">
                            <div class="card-body py-2 px-3">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.875rem;">Total Acciones</h6>
                                <h6 id="statTotalAcciones" class="text-primary mb-0">0</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-secondary" style="border-width: 2px;">
                            <div class="card-body py-2 px-3">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.875rem;">Usuarios Activos</h6>
                                <h6 id="statUsuariosActivos" class="text-secondary mb-0">0</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success" style="border-width: 2px;">
                            <div class="card-body py-2 px-3">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.875rem;">Tasa de √âxito</h6>
                                <h6 id="statTasaExito" class="text-success mb-0">0%</h6>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-dark" style="border-width: 2px;">
                            <div class="card-body py-2 px-3">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.875rem;">√öltima Actividad</h6>
                                <h6 id="statUltimaActividad" class="text-dark mb-0">-</h6>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabla de registros -->
                <div class="card" style="position: relative;">
                    <!-- Loading Overlay para Auditor√≠a -->
                    <div id="loadingOverlayAuditoria" class="table-loading-overlay" style="display: none;">
                        <div class="spinner-modern"></div>
                        <div class="loading-text">Cargando registros de auditor√≠a...</div>
                    </div>

                    <div class="card-header" style="background-color: #374151; color: white;">
                        <i class="bi bi-table"></i> Registros de Auditor√≠a
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover w-full" id="tablaAuditoria" style="table-layout: fixed;">
                                <thead class="bg-gray-800 text-white sticky top-0 z-10">
                                    <tr>
                                        <th style="width: 4%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">ID</th>
                                        <th style="width: 11%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">Fecha/Hora</th>
                                        <th style="width: 9%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">Usuario</th>
                                        <th style="width: 10%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">Acci√≥n</th>
                                        <th style="width: 8%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">M√≥dulo</th>
                                        <th style="width: 11%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">C√≥digo</th>
                                        <th style="width: 35%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">Detalle</th>
                                        <th style="width: 8%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">Resultado</th>
                                        <th style="width: 4%; text-align: center; white-space: nowrap;" class="px-2 py-3 text-sm font-semibold">ms</th>
                                    </tr>
                                </thead>
                                <tbody id="bodyTablaAuditoria">
                                    <tr>
                                        <td colspan="9" class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Cargando...</span>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Paginaci√≥n -->
                        <div class="d-flex justify-content-between align-items-center mt-3">
                            <div>
                                <label class="form-label me-2">Registros por p√°gina:</label>
                                <select id="registrosPorPaginaAud" class="form-select form-select-sm d-inline-block w-auto" onchange="cambiarRegistrosPorPagina()">
                                    <option value="25">25</option>
                                    <option value="50">50</option>
                                    <option value="100">100</option>
                                    <option value="200">200</option>
                                </select>
                            </div>
                            <nav>
                                <ul class="pagination pagination-sm mb-0" id="paginacionAuditoria">
                                    <!-- Paginaci√≥n generada din√°micamente -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Modal Administracion Registro -->
<div class="modal fade" id="modalAdminRegistroSgi" tabindex="-1" aria-labelledby="modalAdminRegistroSgiLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #111827; color: white;">
                <h5 class="modal-title" id="modalAdminRegistroSgiLabel">
                    <i class="bi bi-pencil"></i> Administrar registro
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detalleRegistroAdmin" class="text-muted mb-3"></div>

                <ul class="nav nav-tabs" id="adminRegistroTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="admin-tab-registro" data-bs-toggle="tab" data-bs-target="#adminRegistroTab" type="button" role="tab">Registro</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-tab-actividades" data-bs-toggle="tab" data-bs-target="#adminActividadesTab" type="button" role="tab">Actividades</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="admin-tab-evidencias" data-bs-toggle="tab" data-bs-target="#adminEvidenciasTab" type="button" role="tab">Evidencias</button>
                    </li>
                </ul>

                <div class="tab-content pt-3">
                    <div class="tab-pane fade show active" id="adminRegistroTab" role="tabpanel">
                        <form id="formAdminRegistro">
                            <div class="row g-3">
                                <div class="col-md-4 admin-campo" data-tipo="PA,GC,RVD">
                                    <label class="form-label">Proceso</label>
                                    <select id="adminRegistroProceso" class="form-select">
                                        <option value="">Seleccione</option>
                                    </select>
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="PA,GC,RVD">
                                    <label class="form-label">Subproceso</label>
                                    <select id="adminRegistroSubproceso" class="form-select">
                                        <option value="">Seleccione</option>
                                    </select>
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="PA,GC,RVD">
                                    <label class="form-label">COP</label>
                                    <select id="adminRegistroCop" class="form-select">
                                        <option value="">Seleccione</option>
                                    </select>
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="PA,GC,RVD">
                                    <label class="form-label">Estado</label>
                                    <select id="adminRegistroEstado" class="form-select">
                                        <option value="Pendiente">Pendiente</option>
                                        <option value="En proceso">En proceso</option>
                                        <option value="Abierta">Abierta</option>
                                        <option value="Cerrado">Cerrado</option>
                                    </select>
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="PA,GC,RVD">
                                    <label class="form-label">Fecha apertura</label>
                                    <input type="date" id="adminRegistroFechaApertura" class="form-control">
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="PA,GC,RVD">
                                    <label class="form-label">Fecha cierre</label>
                                    <input type="date" id="adminRegistroFechaCierre" class="form-control">
                                </div>

                                <div class="col-md-4 admin-campo" data-tipo="PA">
                                    <label class="form-label">Tipo de accion</label>
                                    <input type="text" id="adminRegistroTipoAccion" class="form-control">
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="PA">
                                    <label class="form-label">Fuente</label>
                                    <input type="text" id="adminRegistroFuente" class="form-control">
                                </div>
                                <div class="col-md-6 admin-campo" data-tipo="PA">
                                    <label class="form-label">Hallazgo</label>
                                    <textarea id="adminRegistroHallazgo" class="form-control" rows="2"></textarea>
                                </div>
                                <div class="col-md-6 admin-campo" data-tipo="PA">
                                    <label class="form-label">Causa raiz</label>
                                    <textarea id="adminRegistroCausaRaiz" class="form-control" rows="2"></textarea>
                                </div>

                                <div class="col-md-6 admin-campo" data-tipo="GC">
                                    <label class="form-label">Nombre del cambio</label>
                                    <input type="text" id="adminRegistroNombreCambio" class="form-control">
                                </div>
                                <div class="col-md-6 admin-campo" data-tipo="GC">
                                    <label class="form-label">Categoria</label>
                                    <input type="text" id="adminRegistroCategoriaGc" class="form-control">
                                </div>
                                <div class="col-12 admin-campo" data-tipo="GC">
                                    <label class="form-label">Descripcion del cambio</label>
                                    <textarea id="adminRegistroDescripcionCambio" class="form-control" rows="3"></textarea>
                                </div>

                                <div class="col-md-4 admin-campo" data-tipo="RVD">
                                    <label class="form-label">Ano RVD</label>
                                    <input type="number" id="adminRegistroAnoRvd" class="form-control">
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="PA,GC,RVD">
                                    <label class="form-label">Responsable</label>
                                    <input type="text" id="adminRegistroResponsable" class="form-control">
                                </div>
                                <div class="col-md-4 admin-campo" data-tipo="RVD">
                                    <label class="form-label">Categoria</label>
                                    <input type="text" id="adminRegistroCategoriaRvd" class="form-control">
                                </div>
                                <div class="col-12 admin-campo" data-tipo="RVD">
                                    <label class="form-label">Accion/Compromiso</label>
                                    <textarea id="adminRegistroActividad" class="form-control" rows="2"></textarea>
                                </div>
                            </div>
                        </form>
                        <div class="mt-3">
                            <div class="fw-semibold mb-2">Historial de cambios</div>
                            <div id="adminRegistroHistorialTabla" class="table-responsive">
                                <div class="text-muted small">No hay cambios registrados.</div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="adminActividadesTab" role="tabpanel">
                        <div class="mb-3 d-flex align-items-center gap-2">
                            <button type="button" class="btn btn-sm btn-outline-primary" onclick="mostrarFormularioActividadAdmin()">
                                <i class="bi bi-plus-circle"></i> Agregar actividad
                            </button>
                        </div>
                        <div id="adminFormularioActividad" class="card shadow-sm mb-3 d-none">
                            <div class="card-body">
                                <div class="row g-2">
                                    <div class="col-md-3">
                                        <label class="form-label">Etapa</label>
                                        <select id="adminActividadEtapaNueva" class="form-select">
                                            <option value="">Seleccione</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Nombre</label>
                                        <input type="text" id="adminActividadNombreNueva" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Fecha cierre</label>
                                        <input type="date" id="adminActividadFechaNueva" class="form-control">
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Responsable</label>
                                        <input type="text" id="adminActividadResponsableNueva" class="form-control">
                                    </div>
                                    <div class="col-md-3 d-none" id="adminActividadTipoNuevaWrapper">
                                        <label class="form-label">Tipo</label>
                                        <select id="adminActividadTipoNueva" class="form-select">
                                            <option value="">Seleccione</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Estado</label>
                                        <select id="adminActividadEstadoNueva" class="form-select">
                                            <option value="">Seleccione</option>
                                        </select>
                                    </div>
                                    <div class="col-md-9" id="adminActividadDescripcionNuevaWrapper">
                                        <label class="form-label">Descripcion</label>
                                        <input type="text" id="adminActividadDescripcionNueva" class="form-control">
                                    </div>
                                </div>
                                <div class="mt-3 d-flex gap-2">
                                    <button type="button" class="btn btn-sm btn-primary" onclick="crearActividadAdmin()">Guardar actividad</button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="ocultarFormularioActividadAdmin()">Cancelar</button>
                                </div>
                            </div>
                        </div>
                        <div id="adminActividadesLista" class="table-responsive"></div>
                    </div>

                    <div class="tab-pane fade" id="adminEvidenciasTab" role="tabpanel">
                        <div class="mb-4">
                            <div class="fw-semibold mb-2">Evidencias de actividades</div>
                            <div id="adminEvidenciasLista" class="table-responsive"></div>
                        </div>
                        <div>
                            <div class="fw-semibold mb-2">Adjuntos analisis de causas</div>
                            <div id="adminAdjuntosCausasLista" class="table-responsive"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" id="btnEliminarRegistroAdmin">
                    <i class="bi bi-trash"></i> Eliminar registro
                </button>
                <button type="button" class="btn btn-danger d-none" id="btnEliminarActividadesAdminFooter">
                    <i class="bi bi-trash"></i> Eliminar actividades
                </button>
                <button type="button" class="btn btn-danger d-none" id="btnEliminarEvidenciasAdminFooter">
                    <i class="bi bi-trash"></i> Eliminar evidencias
                </button>
                <button type="button" class="btn btn-primary" id="btnGuardarRegistroAdmin">
                    <i class="bi bi-save"></i> Guardar cambios
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Cerrar Registro -->
<div class="modal fade" id="modalCerrarRegistro" tabindex="-1" aria-labelledby="modalCerrarRegistroLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #b91c1c; color: white;">
                <h5 class="modal-title" id="modalCerrarRegistroLabel">
                    <i class="bi bi-lock"></i> Cerrar registro
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detalleRegistroCerrar" class="text-muted mb-3"></div>
                <div id="cierreResumenMensaje" class="alert alert-info py-2 mb-2 d-none"></div>
                <div class="border rounded bg-light p-2 mb-3">
                    <div class="small fw-semibold">Actividades</div>
                    <div class="small text-muted" id="cierreResumenActividades">--</div>
                    <div class="small fw-semibold mt-2">Evidencias</div>
                    <div class="small text-muted" id="cierreResumenEvidencias">--</div>
                </div>
                <form id="formCerrarRegistro">
                    <input type="hidden" id="cierreCodigo">
                    <input type="hidden" id="cierreTipo">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Fecha cierre</label>
                            <input type="date" id="cierreFecha" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Responsable cierre</label>
                            <input type="text" id="cierreResponsable" class="form-control" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Tipo cierre</label>
                            <select id="cierreTipoCierre" class="form-select" required>
                                <option value="">Seleccione</option>
                                <option value="Eficaz">Eficaz</option>
                                <option value="No eficaz">No eficaz</option>
                                <option value="No ejecutado">No ejecutado</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">Descripcion cierre</label>
                            <textarea id="cierreDescripcion" class="form-control" rows="3" required></textarea>
                        </div>
                    </div>
                </form>
                <div class="mt-3">
                    <div class="fw-semibold mb-2">Historial de cambios</div>
                    <div id="cierreHistorialTabla" class="table-responsive">
                        <div class="text-muted small">No hay cambios registrados.</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-outline-primary d-none" id="btnEditarCierreRegistro">
                    <i class="bi bi-pencil-square"></i> Editar cierre
                </button>
                <button type="button" class="btn btn-primary d-none" id="btnGuardarCierreRegistro">
                    <i class="bi bi-save"></i> Guardar cambios
                </button>
                <button type="button" class="btn btn-danger" id="btnConfirmarCierreRegistro">
                    <i class="bi bi-check-circle"></i> Confirmar cierre
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear PA -->
<div class="modal fade" id="modalCrearPA" tabindex="-1" aria-labelledby="modalCrearPALabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #1D4ED8; color: white;">
                <h5 class="modal-title" id="modalCrearPALabel">
                    <i class="fas fa-plus"></i> Crear Plan de Acci√≥n (PA)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearPA">
                    <!-- Fila principal con campos b√°sicos -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Proceso *</label>
                            <select class="form-control" id="procesoPa" required>
                                <option value="">‚Äî Seleccione Proceso ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Subproceso *</label>
                            <select class="form-control" id="subprocesoPa">
                                <option value="">‚Äî Seleccione Subproceso ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">COP *</label>
                            <select class="form-control" id="copPa" required>
                                <option value="">‚Äî Seleccione COP ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Tipo de acci√≥n *</label>
                            <select class="form-control" id="tipoAccionPa" required>
                                <option value="">‚Äî Seleccione ‚Äî</option>
                                <option value="Correctiva">Correctiva</option>
                                <option value="Preventiva">Preventiva</option>
                                <option value="Mejora">Mejora</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Estado *</label>
                            <select class="form-control" id="estadoPa" required>
                                <option value="">‚Äî Seleccione Estado ‚Äî</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="En proceso">En proceso</option>
                                <option value="Abierta">Abierta</option>
                                <option value="Cerrado">Cerrado</option>
                            </select>
                        </div>
                    </div>

                    <!-- Segunda fila -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fecha apertura *</label>
                            <input type="date" class="form-control" id="fechaAperturaPa" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fecha cierre objetivo *</label>
                            <input type="date" class="form-control" id="fechaCierrePa" required>
                            <small class="text-muted">Plazo m√°ximo: Correctivo ‚â§ 4 meses; Mejora/Preventivo ‚â§ 6.</small>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Responsable *</label>
                            <input type="text" class="form-control" id="responsablePa" placeholder="Responsable" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Fuente</label>
                            <input type="text" class="form-control" id="fuentePa" placeholder="Origen del plan de acci√≥n">
                        </div>
                    </div>

                    <!-- Tercera fila -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Hallazgo *</label>
                            <textarea class="form-control" id="hallazgoPa" rows="3" placeholder="Descripci√≥n del hallazgo encontrado" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Causa ra√≠z *</label>
                            <textarea class="form-control" id="causaRaizPa" rows="3" placeholder="An√°lisis de la causa ra√≠z" required></textarea>
                        </div>
                    </div>

                    <!-- Adjuntos an√°lisis de causas -->
                    <div class="row g-3 mb-4">
                        <div class="col-12">
                            <label class="form-label fw-bold">Adjuntos an√°lisis de causas (opcional)</label>
                            <input type="file" class="form-control" id="adjuntosCausas" multiple accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png">
                            <small class="text-muted">Tipos: pdf, xlsx, xls, docx, doc, jpg, jpeg, png.</small>
                        </div>
                    </div>

                    <!-- Secci√≥n Actividades Correctivas (solo visible cuando tipo = Correctiva) -->
                    <div class="card mb-4" id="seccionActividadesCorrectivas" style="display: none;">
                        <div class="card-header d-flex justify-content-between align-items-center" style="background-color: #dc3545; color: white;">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-exclamation-circle"></i> Actividades Correctivas
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="listaActividadesCorrectivas">
                                <!-- Las actividades correctivas se agregar√°n din√°micamente aqu√≠ -->
                            </div>

                            <!-- Formulario para nueva actividad correctiva -->
                            <div class="row g-3 align-items-end mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Nombre Actividad Correctiva</label>
                                    <input type="text" class="form-control" id="nombreActividadCorrectiva" placeholder="Ej: Contenci√≥n inmediata">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold">PHVA</label>
                                    <select class="form-control" id="phvaSelectCorrectiva">
                                        <option value="">Seleccione</option>
                                        <option value="P">Planear (P)</option>
                                        <option value="H">Hacer (H)</option>
                                        <option value="V">Verificar (V)</option>
                                        <option value="A">Actuar (A)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Descripci√≥n</label>
                                    <input type="text" class="form-control" id="descripcionActividadCorrectiva" placeholder="Descripci√≥n de la actividad">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Fecha cierre</label>
                                    <input type="date" class="form-control" id="fechaEjecucionCorrectiva">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Responsable</label>
                                    <input type="text" class="form-control" id="responsableActividadCorrectiva" placeholder="Responsable">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-danger btn-sm" onclick="agregarActividadCorrectiva()">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <strong><i class="fas fa-info-circle"></i> Actividades Correctivas:</strong> Son las acciones inmediatas para contener el problema (Ej: Contenci√≥n, An√°lisis de causas, Acciones correctivas, Verificaci√≥n).
                            </div>
                        </div>
                    </div>

                    <!-- Secci√≥n Actividades PHVA -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-tasks text-primary"></i> Actividades PHVA
                            </h5>
                        </div>
                        <div class="card-body" id="actividadesPHVA">
                            <div id="listaActividades">
                                <!-- Las actividades se agregar√°n din√°micamente aqu√≠ -->
                            </div>

                            <!-- Formulario para nueva actividad -->
                            <div class="row g-3 align-items-end mb-3" id="nuevaActividad">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Nombre Actividad</label>
                                    <input type="text" class="form-control" id="nombreActividad" placeholder="Nombre de la actividad">
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label fw-bold">PHVA</label>
                                    <select class="form-control" id="phvaSelect">
                                        <option value="">‚Äî</option>
                                        <option value="P">Planear (P)</option>
                                        <option value="H">Hacer (H)</option>
                                        <option value="V">Verificar (V)</option>
                                        <option value="A">Actuar (A)</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Descripci√≥n</label>
                                    <input type="text" class="form-control" id="descripcionActividad" placeholder="Descripci√≥n de la actividad">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Fecha cierre</label>
                                    <input type="date" class="form-control" id="fechaEjecucion">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Responsable</label>
                                    <input type="text" class="form-control" id="responsableActividad" placeholder="Responsable">
                                </div>
                                <div class="col-md-2">
                                    <button type="button" class="btn btn-success btn-sm" onclick="agregarActividad()">
                                        <i class="fas fa-plus"></i> Agregar
                                    </button>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <strong><i class="fas fa-exclamation-triangle"></i> Importante:</strong> Debe agregar al menos una actividad (correctiva o PHVA). Cada actividad requiere nombre, PHVA, descripci√≥n, fecha cierre y responsable.
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n autom√°tica -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <strong>C√≥digo autogenerado:</strong> <span id="codigoAutoPa">PA-PROC-SUBPROC-NNNN</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="limpiarFormularioPA()">
                    <i class="fas fa-trash"></i> Limpiar
                </button>
                <button type="button" class="btn btn-success" onclick="crearProcesoPA()">
                    <i class="fas fa-save"></i> Crear PA
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Gesti√≥n del Cambio (GC) -->
<div class="modal fade" id="modalGestionCambio" tabindex="-1" aria-labelledby="modalGestionCambioLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #059669; color: white;">
                <h5 class="modal-title" id="modalGestionCambioLabel">
                    <i class="bi bi-arrow-repeat"></i> Gesti√≥n del Cambio (GC)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formGestionCambio">
                    <!-- Fila 1: Informaci√≥n b√°sica -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Proceso *</label>
                            <select class="form-control" id="procesoGc" required>
                                <option value="">‚Äî Seleccione Proceso ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Subproceso *</label>
                            <select class="form-control" id="subprocesoGc">
                                <option value="">‚Äî Seleccione Subproceso ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">COP *</label>
                            <select class="form-control" id="copGc" required>
                                <option value="">‚Äî Seleccione COP ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Estado *</label>
                            <select class="form-control" id="estadoGc" required>
                                <option value="">‚Äî Seleccione Estado ‚Äî</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="En proceso">En proceso</option>
                                <option value="Abierta">Abierta</option>
                                <option value="Cerrado">Cerrado</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fila 2: Fechas apertura y cierre -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Fecha apertura *</label>
                            <input type="date" class="form-control" id="fechaAperturaGc" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Fecha cierre *</label>
                            <input type="date" class="form-control" id="fechaCierreGc" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Responsable *</label>
                            <input type="text" class="form-control" id="responsableGcGeneral" placeholder="Responsable" required>
                        </div>
                    </div>

                    <!-- Fila 3: Nombre del cambio y Descripci√≥n del cambio -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Nombre del cambio *</label>
                            <input type="text" class="form-control" id="nombreCambioGc" placeholder="Nombre del cambio (3-150 caracteres)" required maxlength="150">
                            <small class="text-muted">M√≠nimo 3 caracteres, m√°ximo 150</small>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Descripci√≥n del cambio *</label>
                            <textarea class="form-control" id="descripcionCambioGc" rows="3" placeholder="Descripci√≥n detallada del cambio" required></textarea>
                        </div>
                    </div>

                    <!-- Secci√≥n Actividades -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">
                                <i class="bi bi-list-task text-success"></i> Actividades
                            </h5>
                        </div>
                        <div class="card-body" id="actividadesGC">
                            <div id="listaActividadesGC">
                                <!-- Las actividades se agregar√°n din√°micamente aqu√≠ -->
                            </div>

                            <!-- Formulario para nueva actividad -->
                            <div class="row g-3 align-items-end mb-3" id="nuevaActividadGC">
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Etapa/Actividad *</label>
                                    <select class="form-control" id="etapaGc" required>
                                        <option value="">‚Äî Seleccione ‚Äî</option>
                                        <option value="Antes">Antes</option>
                                        <option value="Durante">Durante</option>
                                        <option value="Despu√©s">Despu√©s</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Nombre Actividad</label>
                                    <input type="text" class="form-control" id="nombreActividadGc" placeholder="Nombre de la actividad">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Descripci√≥n</label>
                                    <input type="text" class="form-control" id="descripcionActividadGc" placeholder="Descripci√≥n de la actividad">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Fecha cierre</label>
                                    <input type="date" class="form-control" id="fechaEjecucionGc">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Responsable</label>
                                    <input type="text" class="form-control" id="responsableGc" placeholder="Responsable">
                                </div>
                            </div>

                            <div class="row g-3 align-items-center mb-3">
                                <div class="col-12">
                                    <button type="button" class="btn btn-success btn-sm" onclick="agregarActividadGC()">
                                        <i class="bi bi-plus-circle"></i> Agregar
                                    </button>
                                </div>
                            </div>

                            <div class="alert alert-warning">
                                <strong><i class="bi bi-exclamation-triangle"></i> Importante:</strong> Debe agregar al menos una actividad. Cada actividad requiere Etapa, Nombre, Descripci√≥n, Fecha cierre y Responsable.
                            </div>
                        </div>
                    </div>

                    <!-- Informaci√≥n autom√°tica -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <strong>C√≥digo autogenerado:</strong> <span id="codigoAutoGc">GC-AAAA-PROC-NNNN</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="limpiarFormularioGC()">
                    <i class="bi bi-trash"></i> Limpiar
                </button>
                <button type="button" class="btn btn-success" onclick="crearGestionCambio()">
                    <i class="bi bi-check-circle"></i> Crear GC
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Crear RVD -->
<div class="modal fade" id="modalCrearRVD" tabindex="-1" aria-labelledby="modalCrearRVDLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #06B6D4; color: white;">
                <h5 class="modal-title" id="modalCrearRVDLabel">
                    <i class="bi bi-file-text"></i> Revisi√≥n por la Direcci√≥n (RVD)
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formCrearRVD">
                    <!-- Fila 1: Proceso, Subproceso, COP, A√±o RVD -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Proceso *</label>
                            <select class="form-control" id="procesoRvd" required>
                                <option value="">‚Äî Seleccione Proceso ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Subproceso *</label>
                            <select class="form-control" id="subprocesoRvd">
                                <option value="">‚Äî Seleccione Subproceso ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">COP *</label>
                            <select class="form-control" id="copRvd" required>
                                <option value="">‚Äî Seleccione COP ‚Äî</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">A√±o RVD *</label>
                            <input type="number" class="form-control" id="anoRvd" placeholder="2025" min="2020" max="2030" required>
                        </div>
                    </div>

                    <!-- Fila 2: Acci√≥n/compromiso, Responsable, Estado -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Acci√≥n/compromiso *</label>
                            <textarea class="form-control" id="accionCompromisoRvd" rows="3" placeholder="Describa la acci√≥n o compromiso" required></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Responsable *</label>
                            <input type="text" class="form-control" id="responsableRvd" placeholder="Nombre del responsable" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Estado *</label>
                            <select class="form-control" id="estadoRvd" required>
                                <option value="">‚Äî Seleccione Estado ‚Äî</option>
                                <option value="Pendiente">Pendiente</option>
                                <option value="En proceso">En proceso</option>
                                <option value="Abierta">Abierta</option>
                                <option value="Cerrado">Cerrado</option>
                            </select>
                        </div>
                    </div>

                    <!-- Fila 3: Fechas -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-4">
                            <label class="form-label fw-bold">Fecha apertura *</label>
                            <input type="date" class="form-control" id="fechaAperturaRvd" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha cierre</label>
                            <input type="date" class="form-control" id="fechaCierreRvd">
                        </div>
                    </div>

                    <!-- Informaci√≥n autom√°tica -->
                    <div class="row g-3 mb-3">
                        <div class="col-12">
                            <div class="alert alert-warning">
                                <strong>C√≥digo autogenerado:</strong> <span id="codigoAutoRvd">RVD-AAAA-PROC-NNNN</span>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-danger" onclick="limpiarFormularioRVD()">
                    <i class="bi bi-trash"></i> Limpiar
                </button>
                <button type="button" class="btn" style="background-color: #06B6D4; color: white;" onclick="crearRVD()">
                    <i class="bi bi-check-circle"></i> Crear RVD
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Evidencias Actividades -->
<div class="modal fade" id="modalEvidenciasActividades" tabindex="-1" aria-labelledby="modalEvidenciasActividadesLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header" style="background-color: #111827; color: white;">
                <h5 class="modal-title" id="modalEvidenciasActividadesLabel">
                    <i class="bi bi-eye"></i> Evidencias de actividades
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="detalleRegistroSgi" class="text-muted mb-3"></div>
                <div id="tablaActividadesModal" class="table-responsive mb-3"></div>

                <div class="row g-3">
                    <div class="col-lg-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title mb-2">Subir evidencias</h6>
                                <div class="text-muted small mb-2" id="actividadSeleccionadaInfo">
                                    Seleccione una actividad para subir evidencias.
                                </div>
                                <input type="file" id="inputEvidenciasActividad" class="form-control" multiple>
                                <div id="previewEvidenciasActividad" class="mt-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="card-title mb-2">Evidencias cargadas</h6>
                                <div id="accionesEvidenciasActividad" class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2 text-muted small">
                                    <label class="form-check d-flex align-items-center gap-2 mb-0">
                                        <input type="checkbox" id="checkTodasEvidencias" class="form-check-input">
                                        Seleccionar todas
                                    </label>
                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="btnDescargarSeleccionadas">
                                            Descargar seleccionadas
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-primary" id="btnDescargarTodas">
                                            Descargar todas
                                        </button>
                                    </div>
                                </div>
                                <div id="descargaEvidenciasProgress" class="mt-2 d-none">
                                    <div class="d-flex align-items-center justify-content-between small text-muted mb-1">
                                        <span id="descargaEvidenciasTexto">Preparando descarga...</span>
                                        <span id="descargaEvidenciasPorcentaje">0%</span>
                                    </div>
                                    <div class="progress" style="height: 6px;">
                                        <div id="descargaEvidenciasBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div id="listaEvidenciasActividad" class="text-muted small mb-3">
                                    Seleccione una actividad para ver evidencias.
                                </div>
                                <input type="file" id="inputReemplazoEvidencia" class="d-none">
                                <div class="border-top pt-3">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <h6 class="mb-0">Vista previa</h6>
                                        <a id="linkAbrirEvidencia" class="small text-decoration-none" target="_blank" rel="noopener">
                                            Abrir en nueva pesta√±a
                                        </a>
                                    </div>
                                    <div id="visorEvidenciaActividad" class="evidencia-visor text-muted small">
                                        Seleccione una evidencia para previsualizar.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row g-3 mt-2">
                    <div class="col-12">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex flex-wrap align-items-center justify-content-between mb-2">
                                    <h6 class="card-title mb-0">Adjuntos analisis de causas</h6>
                                    <span class="text-muted small">Reemplazo disponible una sola vez por archivo.</span>
                                </div>
                                <div id="listaAdjuntosCausas" class="text-muted small">
                                    No hay adjuntos registrados.
                                </div>
                                <input type="file" id="inputReemplazoAdjuntoCausa" class="d-none" accept=".pdf,.xlsx,.xls,.docx,.doc,.jpg,.jpeg,.png">
                                <div class="border-top pt-3 mt-3">
                                    <div class="d-flex align-items-center justify-content-between mb-2">
                                        <h6 class="mb-0">Vista previa</h6>
                                        <a id="linkAbrirAdjuntoCausa" class="small text-decoration-none" target="_blank" rel="noopener">
                                            Abrir en nueva pestana
                                        </a>
                                    </div>
                                    <div id="visorAdjuntoCausa" class="evidencia-visor text-muted small">
                                        Seleccione un adjunto para previsualizar.
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
                <button type="button" class="btn btn-primary" id="btnSubirEvidenciasActividad">
                    <i class="bi bi-cloud-arrow-up"></i> Subir evidencias
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Notificaciones -->
<div class="modal fade" id="modalNotificaciones" tabindex="-1" aria-labelledby="modalNotificacionesLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white;">
                <h5 class="modal-title" id="modalNotificacionesLabel">
                    <i class="fas fa-bell"></i> Notificaciones
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Filtros r√°pidos -->
                <div class="p-3 border-bottom bg-light">
                    <div class="d-flex gap-2 align-items-center flex-wrap">
                        <button class="btn btn-sm btn-outline-primary active" onclick="filtrarNotificaciones('todas')" id="btnTodasNotif">
                            <i class="fas fa-list"></i> Todas
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="filtrarNotificaciones('no-leidas')" id="btnNoLeidasNotif">
                            <i class="fas fa-envelope"></i> No le√≠das
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="filtrarNotificaciones('APROBACION')" id="btnAprobacionesNotif">
                            <i class="fas fa-check-circle"></i> Aprobaciones
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="filtrarNotificaciones('RECHAZO')" id="btnRechazosNotif">
                            <i class="fas fa-times-circle"></i> Rechazos
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="filtrarNotificaciones('CIERRE')" id="btnCierresNotif">
                            <i class="fas fa-lock"></i> Cierres
                        </button>
                        <div class="ms-auto">
                            <button class="btn btn-sm btn-outline-secondary" onclick="marcarTodasLeidas()" title="Marcar todas como le√≠das">
                                <i class="fas fa-check-double"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="cargarNotificaciones()" title="Recargar">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Contador -->
                <div class="px-3 py-2 bg-light border-bottom">
                    <small class="text-muted">
                        <i class="fas fa-info-circle"></i>
                        <span id="contadorNotificaciones">Cargando...</span>
                    </small>
                </div>

                <!-- Lista de notificaciones -->
                <div id="listaNotificaciones" class="p-3" style="max-height: 500px; overflow-y: auto;">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                        <p>Cargando notificaciones...</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cerrar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Estilos personalizados -->
<style>
    .table th {
        background-color: #343a40 !important;
        color: white !important;
        font-size: 14px;
        font-weight: 600;
        border: 1px solid #495057;
    }

    .table td {
        font-size: 13px;
        vertical-align: middle;
        border: 1px solid #dee2e6;
    }

    .tabla-actividades-admin th.accion-col,
    .tabla-actividades-admin td.accion-col {
        width: 96px;
        min-width: 96px;
        text-align: center;
        vertical-align: middle;
    }

    .tabla-actividades-admin td.accion-col .btn {
        padding: 2px 6px;
        font-size: 12px;
        line-height: 1.2;
    }

    .badge-pendiente {
        background-color: #ffc107;
        color: #000;
    }

    .badge-proceso {
        background-color: #17a2b8;
        color: #fff;
    }

    .badge-abierta {
        background-color: #28a745;
        color: #fff;
    }

    .nav-tabs .nav-link {
        color: #495057;
        font-weight: 500;
    }

    .nav-tabs .nav-link.active {
        background-color: #007bff;
        color: white;
        border-color: #007bff;
    }

    .form-label {
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }

    .btn {
        font-size: 14px;
        font-weight: 500;
    }

    /* Estilos espec√≠ficos del modal */
    .modal-xl {
        max-width: 1200px;
    }

    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    .modal-header {
        background-color: #007bff;
        color: white;
        border-bottom: none;
    }

    .modal-header .btn-close {
        filter: invert(1);
    }

    .modal-footer {
        border-top: 1px solid #e9ecef;
    }

    /* Mejoras para el formulario dentro del modal */
    #modalCrearPA .form-control {
        font-size: 13px;
    }

    #modalCrearPA .form-label {
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 4px;
    }

    #modalCrearPA .row {
        margin-left: 0;
        margin-right: 0;
    }

    #modalCrearPA .card {
        border: 1px solid #dee2e6;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }



    /* üöÄ Bot√≥n Crear PA - Dise√±o Material UI Moderno */
    .btn-crear-modern {
        /* Layout y estructura - Dimensiones EXACTAS */
        background: linear-gradient(135deg, #1D4ED8 0%, #1E40AF 50%, #1E3A8A 100%);
        border: none;
        border-radius: 6px;
        width: 120px !important;    /* Ancho EXACTO - Aumentado para acomodar texto */
        height: 38px !important;    /* Altura EXACTA */
        padding: 8px 10px !important;
        cursor: pointer;
        position: relative;
        overflow: hidden;

        /* Flexbox para centrado perfecto */
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        gap: 6px !important;
        box-sizing: border-box;
        text-decoration: none !important;

        /* Tipograf√≠a moderna */
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        font-weight: 600;
        letter-spacing: 0.025em;
        color: white;
        font-size: 12px;

        /* Sombras profesionales - Actualizadas para azul Tailwind */
        box-shadow:
            0 4px 14px 0 rgba(29, 78, 216, 0.25),
            0 2px 4px 0 rgba(29, 78, 216, 0.12);

        /* Transiciones suaves */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);

        /* Estados */
        user-select: none;
        -webkit-tap-highlight-color: transparent;
    }

    /* Efecto ripple sutil */
    .btn-crear-modern::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 50%);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    /* Estados hover - Material UI style */
    .btn-crear-modern:hover {
        background: linear-gradient(135deg, #3B82F6 0%, #1D4ED8 50%, #1E40AF 100%);
        transform: translateY(-2px);
        box-shadow:
            0 8px 25px 0 rgba(29, 78, 216, 0.35),
            0 4px 12px 0 rgba(29, 78, 216, 0.2);
    }

    .btn-crear-modern:hover::before {
        opacity: 1;
    }

    /* Estado activo/click */
    .btn-crear-modern:active {
        transform: translateY(-1px);
        transition: all 0.1s ease;
        box-shadow:
            0 4px 14px 0 rgba(29, 78, 216, 0.3),
            0 2px 6px 0 rgba(29, 78, 216, 0.15);
    }

    /* √çcono moderno - Dimensiones EXACTAS y centrado perfecto */
    .icon-modern {
        font-size: 16px !important;
        color: #ffffff !important;
        width: 16px !important;
        height: 16px !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        flex-shrink: 0;
        line-height: 1 !important;
        vertical-align: middle !important;
    }

    .btn-crear-modern:hover .icon-modern {
        transform: scale(1.1) rotate(90deg);
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    }

    /* Texto moderno - Tipograf√≠a EXACTA */
    .text-modern {
        color: #ffffff !important;
        font-size: 13px !important;
        font-weight: 600 !important;
        letter-spacing: 0.025em !important;
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        white-space: nowrap;
        line-height: 1 !important;
        display: flex !important;
        align-items: center !important;
        vertical-align: middle !important;
        margin: 0 !important;
        padding: 0 !important;
    }

    .btn-crear-modern:hover .text-modern {
        letter-spacing: 0.05em;
    }

    /* Estados de focus para accesibilidad */
    .btn-crear-modern:focus {
        outline: none;
        box-shadow:
            0 4px 14px 0 rgba(29, 78, 216, 0.25),
            0 2px 4px 0 rgba(29, 78, 216, 0.12),
            0 0 0 3px rgba(29, 78, 216, 0.2);
    }

    /* Responsive - adaptaci√≥n m√≥vil */
    @media (max-width: 768px) {
        .btn-crear-modern {
            padding: 4px 8px;
        }
    }

    /* Modo oscuro compatibility */
    @media (prefers-color-scheme: dark) {
        .btn-crear-modern {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 50%, #1565c0 100%);
            box-shadow:
                0 4px 14px 0 rgba(33, 150, 243, 0.3),
                0 2px 4px 0 rgba(33, 150, 243, 0.15);
        }

        .btn-crear-modern:hover {
            background: linear-gradient(135deg, #42a5f5 0%, #2196f3 50%, #1976d2 100%);
            box-shadow:
                0 8px 25px 0 rgba(33, 150, 243, 0.4),
                0 4px 12px 0 rgba(33, 150, 243, 0.25);
        }
    }

    /* Estilos espec√≠ficos para el bot√≥n verde (GC) - Tailwind emerald-500 */
    .btn-crear-green {
        background: linear-gradient(135deg, #059669 0%, #047857 50%, #064E3B 100%) !important;
        box-shadow:
            0 4px 14px 0 rgba(5, 150, 105, 0.25),
            0 2px 4px 0 rgba(5, 150, 105, 0.12);
    }

    .btn-crear-green:hover {
        background: linear-gradient(135deg, #10B981 0%, #059669 50%, #047857 100%) !important;
        box-shadow:
            0 8px 25px 0 rgba(5, 150, 105, 0.4),
            0 4px 12px 0 rgba(5, 150, 105, 0.25);
        transform: translateY(-1px);
    }

    .btn-crear-green:focus {
        box-shadow:
            0 4px 14px 0 rgba(5, 150, 105, 0.25),
            0 2px 4px 0 rgba(5, 150, 105, 0.12),
            0 0 0 3px rgba(5, 150, 105, 0.3);
    }

    .btn-crear-green:hover .icon-modern {
        transform: scale(1.1) rotate(180deg);
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    }

    .btn-crear-green:active {
        transform: translateY(0);
        box-shadow:
            0 2px 8px 0 rgba(5, 150, 105, 0.2),
            0 1px 2px 0 rgba(5, 150, 105, 0.1);
    }

    /* Estilos espec√≠ficos para el bot√≥n cyan (RVD) - Tailwind cyan-500 */
    .btn-crear-orange {
        background: linear-gradient(135deg, #06B6D4 0%, #0891B2 50%, #0E7490 100%) !important;
        box-shadow:
            0 4px 14px 0 rgba(6, 182, 212, 0.25),
            0 2px 4px 0 rgba(6, 182, 212, 0.12);
    }

    .btn-crear-orange:hover {
        background: linear-gradient(135deg, #22D3EE 0%, #06B6D4 50%, #0891B2 100%) !important;
        box-shadow:
            0 8px 25px 0 rgba(6, 182, 212, 0.4),
            0 4px 12px 0 rgba(6, 182, 212, 0.25);
        transform: translateY(-1px);
    }

    .btn-crear-orange:focus {
        box-shadow:
            0 4px 14px 0 rgba(6, 182, 212, 0.25),
            0 2px 4px 0 rgba(6, 182, 212, 0.12),
            0 0 0 3px rgba(6, 182, 212, 0.3);
    }

    .btn-crear-orange:hover .icon-modern {
        transform: scale(1.1) rotate(15deg);
        filter: drop-shadow(0 2px 4px rgba(0,0,0,0.15));
    }

    .btn-crear-orange:active {
        transform: translateY(0);
        box-shadow:
            0 2px 8px 0 rgba(6, 182, 212, 0.2),
            0 1px 2px 0 rgba(6, 182, 212, 0.1);
    }
</style>

<!-- JavaScript -->
<script>
// Variables globales (limpias - solo las necesarias)
let filtroVencimientoActivo = null; // Valores posibles: null, 'vencido', 'proximo', 'ok'

// Funci√≥n utilitaria para verificar existencia de elementos DOM
function verificarElementoDOM(id, descripcion = 'elemento') {
    const elemento = document.getElementById(id);
    if (!elemento) {
        console.warn(`‚ö†Ô∏è ${descripcion} con ID '${id}' no encontrado en el DOM`);
        return null;
    }
    return elemento;
}

// Funci√≥n utilitaria para verificar existencia de funciones
function verificarFuncion(nombreFuncion) {
    if (typeof window[nombreFuncion] !== 'function') {
        console.warn(`‚ö†Ô∏è Funci√≥n '${nombreFuncion}' no est√° definida`);
        return false;
    }
    return true;
}



// ================== FUNCIONES PARA C√ìDIGOS DE PLANES DE ACCI√ìN ==================

// Funci√≥n para cargar c√≥digos de planes de acci√≥n
async function cargarCodigosPlanesAccion(filtros = {}) {
    try {
        console.log('üîç Cargando c√≥digos con filtros:', filtros);

        const params = new URLSearchParams();

        // Agregar filtros a los par√°metros (jerarqu√≠a: tipo_gestion -> proceso -> subproceso)
        if (filtros.tipo_gestion) {
            params.append('tipo_gestion', filtros.tipo_gestion);
        }
        if (filtros.proceso) {
            params.append('proceso', filtros.proceso);
        }
        if (filtros.subproceso) {
            params.append('subproceso', filtros.subproceso);
        }

        const url = `/sgi/planes-accion/codigos?${params.toString()}`;
        console.log('üì° URL de llamada:', url);

        const response = await fetch(url);
        const data = await response.json();

        console.log('üì• Respuesta del servidor:', data);

        if (data.success) {
            const codigos = Array.isArray(data.datos) ? data.datos : [];
            console.log('‚úÖ C√≥digos obtenidos:', codigos.length);
            actualizarDropdownCodigos(codigos);
            actualizarCacheCodigosPorFiltro(codigos, filtros);
        } else {
            console.error('‚ùå Error al cargar c√≥digos:', data.mensaje);
        }
    } catch (error) {
        console.error('üí• Error de conexi√≥n:', error);
    }
}

// Funcion para actualizar el dropdown de codigos
let codigosCache = null;
const CODIGOS_CACHE_KEY = 'sgi_codigos_cache_v1';

function actualizarDropdownCodigos(codigos) {
    const dropdown = document.getElementById('filtroUsuario');
    if (!dropdown) {
        return;
    }

    const selectedValue = dropdown.value;
    dropdown.innerHTML = '<option value="">Todos los codigos</option>';

    codigos.forEach(codigo => {
        const option = document.createElement('option');
        option.value = codigo.codigo;
        // Mostrar tipo de gestion junto con el codigo para mayor claridad
        option.textContent = `${codigo.codigo} (${codigo.tipo_gestion}) - ${codigo.estado}`;
        dropdown.appendChild(option);
    });

    if (selectedValue) {
        const existe = Array.from(dropdown.options).some(option => option.value === selectedValue);
        if (existe) {
            dropdown.value = selectedValue;
        }
    }

    guardarCacheCodigos(codigos);
    console.log(`Dropdown actualizado con ${codigos.length} codigos`);
}

function leerCacheCodigos() {
    if (Array.isArray(codigosCache) && codigosCache.length > 0) {
        return codigosCache;
    }

    try {
        const raw = localStorage.getItem(CODIGOS_CACHE_KEY);
        if (!raw) {
            return null;
        }
        const payload = JSON.parse(raw);
        if (!payload || !Array.isArray(payload.codigos)) {
            return null;
        }
        codigosCache = payload.codigos;
        return codigosCache;
    } catch (error) {
        return null;
    }
}

function guardarCacheCodigos(codigos) {
    if (!Array.isArray(codigos) || codigos.length == 0) {
        return;
    }

    if (Array.isArray(codigosCache) && codigosCache.length > codigos.length) {
        return;
    }

    codigosCache = codigos;
    try {
        localStorage.setItem(
            CODIGOS_CACHE_KEY,
            JSON.stringify({ codigos: codigos, ts: Date.now() })
        );
    } catch (error) {
    }
}

function aplicarCodigosCacheSiVacio() {
    const dropdown = document.getElementById('filtroUsuario');
    if (!dropdown || dropdown.options.length > 1 || dropdown.value) {
        return;
    }

    const cache = leerCacheCodigos();
    if (cache && cache.length > 0) {
        actualizarDropdownCodigos(cache);
    }
}

function filtrarCodigosLocal(codigos, filtros) {
    if (!Array.isArray(codigos)) {
        return [];
    }

    const tipo = (filtros?.tipo_gestion || '').toLowerCase();
    const proceso = (filtros?.proceso || '').toLowerCase();
    const subproceso = (filtros?.subproceso || '').toLowerCase();

    return codigos.filter(codigo => {
        if (tipo && codigo.tipo_gestion && String(codigo.tipo_gestion).toLowerCase() !== tipo) {
            return false;
        }
        if (proceso && codigo.proceso && String(codigo.proceso).toLowerCase() !== proceso) {
            return false;
        }
        if (subproceso && codigo.subproceso && String(codigo.subproceso).toLowerCase() !== subproceso) {
            return false;
        }
        return true;
    });
}

function normalizarFiltroCodigo(valor) {
    return String(valor || '').trim().toLowerCase();
}

function coincideFiltroCodigo(codigo, filtros) {
    if (!codigo) {
        return false;
    }

    const tipoFiltro = normalizarFiltroCodigo(filtros?.tipo_gestion);
    const procesoFiltro = normalizarFiltroCodigo(filtros?.proceso);
    const subprocesoFiltro = normalizarFiltroCodigo(filtros?.subproceso);

    if (tipoFiltro && normalizarFiltroCodigo(codigo.tipo_gestion) !== tipoFiltro) {
        return false;
    }
    if (procesoFiltro && normalizarFiltroCodigo(codigo.proceso) !== procesoFiltro) {
        return false;
    }
    if (subprocesoFiltro && normalizarFiltroCodigo(codigo.subproceso) !== subprocesoFiltro) {
        return false;
    }
    return true;
}

function actualizarCacheCodigosPorFiltro(nuevosCodigos, filtros) {
    const listaNueva = Array.isArray(nuevosCodigos) ? nuevosCodigos : [];
    const tieneFiltros = !!(filtros?.tipo_gestion || filtros?.proceso || filtros?.subproceso);

    if (!tieneFiltros) {
        codigosCache = listaNueva;
        try {
            localStorage.setItem(
                CODIGOS_CACHE_KEY,
                JSON.stringify({ codigos: listaNueva, ts: Date.now() })
            );
        } catch (error) {
        }
        return;
    }

    const cacheActual = leerCacheCodigos() || [];
    const restantes = cacheActual.filter(codigo => !coincideFiltroCodigo(codigo, filtros));
    const combinados = restantes.concat(listaNueva);
    codigosCache = combinados;
    try {
        localStorage.setItem(
            CODIGOS_CACHE_KEY,
            JSON.stringify({ codigos: combinados, ts: Date.now() })
        );
    } catch (error) {
    }
}

function actualizarCodigosDesdeCache(filtros) {
    const cache = leerCacheCodigos();
    if (!cache || cache.length == 0) {
        return;
    }

    const codigos = filtrarCodigosLocal(cache, filtros);
    if (codigos.length > 0) {
        actualizarDropdownCodigos(codigos);
    }
}

function construirCodigosDesdeDatos(datos, tipoGestionFallback) {
    const codigos = [];
    const vistos = new Set();

    (datos || []).forEach(registro => {
        const codigo = registro.codigo;
        if (!codigo) {
            return;
        }

        const tipo = registro.tipo || tipoGestionFallback || '';
        const estado = registro.estado || '';
        const clave = `${codigo}|${tipo}|${estado}`;

        if (vistos.has(clave)) {
            return;
        }

        vistos.add(clave);
        codigos.push({
            codigo: codigo,
            tipo_gestion: tipo,
            estado: estado,
            proceso: registro.proceso || '',
            subproceso: registro.subproceso || ''
        });
    });

    codigos.sort((a, b) => a.codigo.localeCompare(b.codigo));
    return codigos;
}

function actualizarCodigosDesdeDatosSiVacio(datos, tipoGestionFallback) {
    const dropdown = document.getElementById('filtroUsuario');
    if (!dropdown) {
        return;
    }

    const codigos = construirCodigosDesdeDatos(datos, tipoGestionFallback);
    if (codigos.length > 0) {
        actualizarDropdownCodigos(codigos);
    }
}
// ================== FUNCIONES DE FILTRO POR VENCIMIENTO ==================

// Funci√≥n para configurar los filtros clickeables de la leyenda
function configurarFiltrosLeyenda() {
    const filtrosLeyenda = document.querySelectorAll('.filtro-leyenda');
    const labels = document.querySelectorAll('.filtro-label');

    // Event listeners para los c√≠rculos de colores
    filtrosLeyenda.forEach(filtro => {
        filtro.addEventListener('click', function() {
            const tipoFiltro = this.getAttribute('data-filtro');
            aplicarFiltroVencimiento(tipoFiltro);
        });
    });

    // Event listeners para los labels de texto
    labels.forEach(label => {
        label.addEventListener('click', function() {
            const tipoFiltro = this.getAttribute('data-filtro');
            aplicarFiltroVencimiento(tipoFiltro);
        });
    });
}

// Funci√≥n para aplicar filtro de vencimiento
function aplicarFiltroVencimiento(tipoFiltro) {
    console.log('üéØ Aplicando filtro de vencimiento:', tipoFiltro);

    // Si el filtro ya est√° activo, desactivarlo
    if (filtroVencimientoActivo === tipoFiltro) {
        console.log('üîÑ Desactivando filtro de vencimiento');
        filtroVencimientoActivo = null;
        actualizarEstadoVisualFiltros();
        // Recargar datos sin filtro de vencimiento
        aplicarTodosLosFiltros();
        return;
    }

    // Activar el nuevo filtro
    filtroVencimientoActivo = tipoFiltro;
    actualizarEstadoVisualFiltros();

    // Aplicar filtros con el nuevo filtro de vencimiento
    aplicarTodosLosFiltros();
}

// Funci√≥n para actualizar el estado visual de los filtros
function actualizarEstadoVisualFiltros() {
    const filtrosLeyenda = document.querySelectorAll('.filtro-leyenda');
    const labels = document.querySelectorAll('.filtro-label');
    const btnLimpiar = document.getElementById('btnLimpiarFiltroVencimiento');

    // Limpiar estados activos
    filtrosLeyenda.forEach(f => f.classList.remove('activo'));
    labels.forEach(l => l.classList.remove('activo'));

    // Activar el filtro seleccionado
    if (filtroVencimientoActivo) {
        const filtroActivo = document.querySelector(`.filtro-leyenda[data-filtro="${filtroVencimientoActivo}"]`);
        const labelActivo = document.querySelector(`.filtro-label[data-filtro="${filtroVencimientoActivo}"]`);

        if (filtroActivo) filtroActivo.classList.add('activo');
        if (labelActivo) labelActivo.classList.add('activo');

        // Mostrar bot√≥n de limpiar filtro
        if (btnLimpiar) btnLimpiar.style.display = 'block';

        console.log(`‚úÖ Filtro visual activado: ${filtroVencimientoActivo}`);
    } else {
        // Ocultar bot√≥n de limpiar filtro
        if (btnLimpiar) btnLimpiar.style.display = 'none';
    }
}

// Funci√≥n para limpiar el filtro de vencimiento
function limpiarFiltroVencimiento() {
    console.log('üóëÔ∏è Limpiando filtro de vencimiento');
    filtroVencimientoActivo = null;
    actualizarEstadoVisualFiltros();
    // Recargar datos sin filtro de vencimiento
    aplicarTodosLosFiltros();
}

// Funci√≥n para aplicar todos los filtros incluyendo el de vencimiento
async function aplicarTodosLosFiltros() {
    const filtros = obtenerTodosFiltrosActuales();

    // Agregar filtro de vencimiento si est√° activo
    if (filtroVencimientoActivo) {
        filtros.filtro_vencimiento = filtroVencimientoActivo;
    }

    console.log('üîç Aplicando todos los filtros (incluyendo vencimiento):', filtros);

    // Actualizar badge de filtros activos
    actualizarBadgeFiltrosActivos('Pendientes', filtros);

    // Cargar datos con todos los filtros
    if (filtros.tipo_gestion) {
        await cargarDatosPorTipoGestion(filtros.tipo_gestion);
    } else {
        await cargarDatosPorTipoGestion('');
    }
}

// ================== FIN FUNCIONES DE FILTRO POR VENCIMIENTO ==================

// Funci√≥n para obtener todos los filtros actuales (incluyendo fechas, estado y vencimiento)
function obtenerTodosFiltrosActuales() {
    const filtros = {
        tipo_gestion: document.getElementById('filtroTipoGestion')?.value || '',
        codigo: document.getElementById('filtroUsuario')?.value || '',
        proceso: document.getElementById('filtroProceso')?.value || '',
        subproceso: document.getElementById('filtroSubproceso')?.value || '',
        estado: document.getElementById('filtroEstado')?.value || '',
        fecha_desde: document.getElementById('filtroDesde')?.value || '',
        fecha_hasta: document.getElementById('filtroHasta')?.value || ''
    };

    // Agregar filtro de vencimiento si est√° activo
    if (filtroVencimientoActivo) {
        filtros.filtro_vencimiento = filtroVencimientoActivo;
    }

    // Actualizar badge de filtros activos
    actualizarBadgeFiltrosActivos('Pendientes', filtros);

    return filtros;
}

// ==================== ACTUALIZAR BADGE DE FILTROS ACTIVOS ====================

function esValorFiltroActivo(valor) {
    return valor && valor !== '' && valor !== 'null' && valor !== 'undefined';
}

function obtenerTextoSelect(id) {
    const el = document.getElementById(id);
    if (!el || !el.options || el.selectedIndex < 0) {
        return '';
    }
    const option = el.options[el.selectedIndex];
    const texto = option ? option.textContent.trim() : '';
    return texto || (el.value || '');
}

function construirTooltipFiltros(tab, filtros) {
    const detalles = [];
    const agregar = (label, value) => {
        if (esValorFiltroActivo(value)) {
            detalles.push(`${label}: ${value}`);
        }
    };

    if (tab === 'Pendientes') {
        const tipoTexto = obtenerTextoSelect('filtroTipoGestion');
        const codigoTexto = obtenerTextoSelect('filtroUsuario');
        const procesoTexto = obtenerTextoSelect('filtroProceso');
        const subprocesoTexto = obtenerTextoSelect('filtroSubproceso');
        const estadoTexto = obtenerTextoSelect('filtroEstado');
        const mapaVencimiento = {
            vencido: 'Vencidas',
            proximo: '<=10 dias',
            ok: '+10 dias'
        };

        agregar('Tipo gestion', esValorFiltroActivo(filtros.tipo_gestion) ? (tipoTexto || filtros.tipo_gestion) : '');
        agregar('Codigo', esValorFiltroActivo(filtros.codigo) ? (codigoTexto || filtros.codigo) : '');
        agregar('Proceso', esValorFiltroActivo(filtros.proceso) ? (procesoTexto || filtros.proceso) : '');
        agregar('Subproceso', esValorFiltroActivo(filtros.subproceso) ? (subprocesoTexto || filtros.subproceso) : '');
        agregar('Estado', esValorFiltroActivo(filtros.estado) ? (estadoTexto || filtros.estado) : '');
        agregar('Desde', filtros.fecha_desde);
        agregar('Hasta', filtros.fecha_hasta);
        if (esValorFiltroActivo(filtros.filtro_vencimiento)) {
            agregar('Vencimiento', mapaVencimiento[filtros.filtro_vencimiento] || filtros.filtro_vencimiento);
        }
    } else if (tab === 'Auditoria') {
        const accionTexto = obtenerTextoSelect('filtroAccionAud');
        const moduloTexto = obtenerTextoSelect('filtroModuloAud');
        const resultadoTexto = obtenerTextoSelect('filtroResultadoAud');

        agregar('Fecha desde', filtros.fecha_desde);
        agregar('Fecha hasta', filtros.fecha_hasta);
        agregar('Usuario', filtros.usuario);
        agregar('Accion', esValorFiltroActivo(filtros.accion) ? (accionTexto || filtros.accion) : '');
        agregar('Modulo', esValorFiltroActivo(filtros.modulo) ? (moduloTexto || filtros.modulo) : '');
        agregar('Resultado', esValorFiltroActivo(filtros.resultado) ? (resultadoTexto || filtros.resultado) : '');
        agregar('Codigo', filtros.codigo);
    }

    return detalles.join('\n');
}

function actualizarBadgeFiltrosActivos(tab, filtros) {
    let badgeId = '';

    if (tab === 'Pendientes') {
        badgeId = 'badgeFiltrosActivosPendientes';
    } else if (tab === 'Auditoria') {
        badgeId = 'badgeFiltrosActivosAuditoria';
    }

    const badge = document.getElementById(badgeId);
    if (!badge) return;

    // Contar filtros activos (excluir valores vac√≠os)
    let count = 0;
    for (const [key, value] of Object.entries(filtros)) {
        if (esValorFiltroActivo(value)) {
            count++;
        }
    }

    // Mostrar/ocultar badge seg√∫n cantidad de filtros
    if (count > 0) {
        badge.style.display = 'inline-flex';
        badge.querySelector('.count').textContent = count;
        const tooltip = construirTooltipFiltros(tab, filtros);
        if (tooltip) {
            badge.setAttribute('title', tooltip);
            badge.setAttribute('aria-label', tooltip);
        } else {
            badge.removeAttribute('title');
            badge.removeAttribute('aria-label');
        }
    } else {
        badge.style.display = 'none';
        badge.removeAttribute('title');
        badge.removeAttribute('aria-label');
    }
}

// Funci√≥n para aplicar todos los filtros y recargar la tabla
async function aplicarFiltrosYRecargarTabla() {
    const filtros = obtenerTodosFiltrosActuales();
    console.log('üîç Aplicando filtros:', filtros);
    // Actualizar codigos disponibles ANTES de cargar datos (para que esten listos)
    console.log('Actualizando codigos disponibles...');
    actualizarCodigosDesdeCache({
        tipo_gestion: filtros.tipo_gestion,
        proceso: filtros.proceso,
        subproceso: filtros.subproceso
    });
    cargarCodigosPlanesAccion({
        tipo_gestion: filtros.tipo_gestion,
        proceso: filtros.proceso,
        subproceso: filtros.subproceso
    });

    // Luego cargar datos de la tabla
    console.log('üìä Cargando datos de la tabla...');
    if (filtros.tipo_gestion) {
        await cargarDatosPorTipoGestion(filtros.tipo_gestion);
    } else {
        // Si no hay tipo de gesti√≥n, cargar todos los datos
        await cargarDatosPorTipoGestion('');
    }
}
async function refrescarPendientesDespuesDeCrear() {
    if (typeof aplicarFiltrosYRecargarTabla === 'function') {
        await aplicarFiltrosYRecargarTabla();
        return;
    }

    if (typeof cargarDatosPorTipoGestion === 'function') {
        const tipoGestion = document.getElementById('filtroTipoGestion')?.value || '';
        await cargarDatosPorTipoGestion(tipoGestion);
        return;
    }

    if (typeof cargarDatos === 'function') {
        cargarDatos();
    }
}

async function asegurarRegistroVisible(opts) {
    await refrescarPendientesDespuesDeCrear();

    // Tambi√©n refrescar auditor√≠a si est√° activa
    if (typeof refrescarAuditoria === 'function') {
        await refrescarAuditoria();
    }

    if (!opts || !opts.codigo) {
        return;
    }

    const codigo = String(opts.codigo).trim();
    if (!codigo) {
        return;
    }

    const celdasCodigo = document.querySelectorAll('#tablaProcesos tbody tr td:nth-child(2)');
    const existe = Array.from(celdasCodigo).some(td => td.textContent.trim() === codigo);
    if (existe) {
        return;
    }

    const filtroTipo = document.getElementById('filtroTipoGestion');
    if (filtroTipo && opts.tipoGestion) {
        filtroTipo.value = opts.tipoGestion;
    }

    const filtroCodigo = document.getElementById('filtroUsuario');
    if (filtroCodigo) {
        filtroCodigo.value = '';
    }

    const filtroProceso = document.getElementById('filtroProceso');
    if (filtroProceso) {
        filtroProceso.value = '';
    }

    const filtroSubproceso = document.getElementById('filtroSubproceso');
    if (filtroSubproceso) {
        filtroSubproceso.value = '';
    }

    const filtroEstado = document.getElementById('filtroEstado');
    if (filtroEstado) {
        filtroEstado.value = '';
    }

    const filtroDesde = document.getElementById('filtroDesde');
    if (filtroDesde) {
        filtroDesde.value = '';
    }

    const filtroHasta = document.getElementById('filtroHasta');
    if (filtroHasta) {
        filtroHasta.value = '';
    }

    filtroVencimientoActivo = null;
    if (typeof actualizarEstadoVisualFiltros === 'function') {
        actualizarEstadoVisualFiltros();
    }

    await refrescarPendientesDespuesDeCrear();
}
// Funci√≥n para manejar cambios en TODOS los filtros
function configurarFiltrosDinamicos() {
    const tipoGestionSelect = document.getElementById('filtroTipoGestion');
    const codigoSelect = document.getElementById('filtroUsuario');
    const procesoSelect = document.getElementById('filtroProceso');
    const subprocesoSelect = document.getElementById('filtroSubproceso');
    const estadoSelect = document.getElementById('filtroEstado');
    const fechaDesdeInput = document.getElementById('filtroDesde');
    const fechaHastaInput = document.getElementById('filtroHasta');

    // Funci√≥n helper para obtener filtros de c√≥digos
    function obtenerFiltrosActuales() {
        return {
            tipo_gestion: tipoGestionSelect?.value || '',
            proceso: procesoSelect?.value || '',
            subproceso: subprocesoSelect?.value || ''
        };
    }

    // TIPO DE GESTI√ìN - Recargar c√≥digos y tabla
    if (tipoGestionSelect) {
        tipoGestionSelect.addEventListener('change', function() {
            console.log('üîÑ Cambio en tipo de gesti√≥n:', this.value);
            // Limpiar filtro de c√≥digo ya que van a cambiar los c√≥digos disponibles
            if (codigoSelect) {
                codigoSelect.value = '';
            }
            aplicarFiltrosYRecargarTabla();
        });
    }

    // C√ìDIGO - Solo recargar tabla (no c√≥digos)
    if (codigoSelect) {
        codigoSelect.addEventListener('change', function() {
            console.log('üîÑ Cambio en c√≥digo:', this.value);
            // Solo aplicar filtros sin recargar c√≥digos
            const filtros = obtenerTodosFiltrosActuales();
            actualizarBadgeFiltrosActivos('Pendientes', filtros); // Forzar actualizaci√≥n del badge
            cargarDatosPorTipoGestion(filtros.tipo_gestion || '');
        });
    }

    // PROCESO - Recargar c√≥digos y tabla
    if (procesoSelect) {
        procesoSelect.addEventListener('change', function() {
            console.log('üîÑ Cambio en proceso:', this.value);
            // Limpiar filtro de c√≥digo ya que van a cambiar los c√≥digos disponibles
            if (codigoSelect) {
                codigoSelect.value = '';
            }
            aplicarFiltrosYRecargarTabla();
        });
    }

    // SUBPROCESO - Recargar c√≥digos y tabla
    if (subprocesoSelect) {
        subprocesoSelect.addEventListener('change', function() {
            console.log('üîÑ Cambio en subproceso:', this.value);
            // Limpiar filtro de c√≥digo ya que van a cambiar los c√≥digos disponibles
            if (codigoSelect) {
                codigoSelect.value = '';
            }
            aplicarFiltrosYRecargarTabla();
        });
    }

    // ESTADO - Solo recargar tabla
    if (estadoSelect) {
        estadoSelect.addEventListener('change', function() {
            console.log('üîÑ Cambio en estado:', this.value);
            const filtros = obtenerTodosFiltrosActuales();
            actualizarBadgeFiltrosActivos('Pendientes', filtros); // Forzar actualizaci√≥n del badge
            cargarDatosPorTipoGestion(filtros.tipo_gestion || '');
        });
    }

    // FECHA DESDE - Solo recargar tabla
    if (fechaDesdeInput) {
        fechaDesdeInput.addEventListener('change', function() {
            console.log('üîÑ Cambio en fecha desde:', this.value);
            const filtros = obtenerTodosFiltrosActuales();
            actualizarBadgeFiltrosActivos('Pendientes', filtros); // Forzar actualizaci√≥n del badge
            cargarDatosPorTipoGestion(filtros.tipo_gestion || '');
        });
    }

    // FECHA HASTA - Solo recargar tabla
    if (fechaHastaInput) {
        fechaHastaInput.addEventListener('change', function() {
            console.log('üîÑ Cambio en fecha hasta:', this.value);
            const filtros = obtenerTodosFiltrosActuales();
            actualizarBadgeFiltrosActivos('Pendientes', filtros); // Forzar actualizaci√≥n del badge
            cargarDatosPorTipoGestion(filtros.tipo_gestion || '');
        });
    }
}

// ================== FIN FUNCIONES C√ìDIGOS ==================

// Datos de procesos/subprocesos para tooltips en la tabla
let datosProcesos = [];
let datosSubprocesos = [];
let mapaProcesos = {};
let mapaSubprocesos = {};

function escapeHtmlAttr(valor) {
    return String(valor || '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}

function actualizarMapaProcesos() {
    mapaProcesos = {};
    datosProcesos.forEach(proceso => {
        if (proceso && proceso.codigo) {
            mapaProcesos[proceso.codigo] = proceso.nombre || '';
        }
    });
    actualizarTitulosProcesoSubproceso();
}

function actualizarMapaSubprocesos() {
    mapaSubprocesos = {};
    datosSubprocesos.forEach(subproceso => {
        if (subproceso && subproceso.codigo) {
            mapaSubprocesos[subproceso.codigo] = subproceso.nombre || '';
        }
    });
    actualizarTitulosProcesoSubproceso();
}

function obtenerEtiquetaProceso(codigo) {
    const clave = String(codigo || '').trim();
    const nombre = mapaProcesos[clave];
    if (nombre) {
        return `${clave} - ${nombre}`;
    }
    return clave || '-';
}

function obtenerEtiquetaSubproceso(codigo) {
    const clave = String(codigo || '').trim();
    if (!clave) {
        return '-';
    }
    if (clave === 'N/A') {
        return 'N/A - Sin subprocesos';
    }
    const nombre = mapaSubprocesos[clave];
    if (nombre) {
        return `${clave} - ${nombre}`;
    }
    return clave;
}

function actualizarTitulosProcesoSubproceso() {
    const tbody = document.querySelector('#tablaProcesos tbody');
    if (!tbody) {
        return;
    }

    const filas = tbody.querySelectorAll('tr');
    filas.forEach(fila => {
        const celdaProceso = fila.querySelector('td:nth-child(4)');
        if (celdaProceso) {
            const codigoProceso = celdaProceso.textContent.trim();
            if (codigoProceso && codigoProceso !== '-') {
                celdaProceso.setAttribute('title', obtenerEtiquetaProceso(codigoProceso));
            }
        }

        const celdaSubproceso = fila.querySelector('td:nth-child(5)');
        if (celdaSubproceso) {
            const codigoSubproceso = celdaSubproceso.textContent.trim();
            if (codigoSubproceso) {
                celdaSubproceso.setAttribute('title', obtenerEtiquetaSubproceso(codigoSubproceso));
            }
        }
    });
}

// Funci√≥n para cargar datos autom√°ticamente por tipo de gesti√≥n
async function cargarDatosPorTipoGestion(tipoGestion) {
    try {
        // Si tipoGestion es undefined o vac√≠o, obtener todos los datos
        const tipoParaMostrar = tipoGestion || "todos los tipos";
        console.log(`üîÑ Cargando datos para tipo de gesti√≥n: ${tipoParaMostrar}`);

        // Mostrar loading overlay
        const loadingOverlay = document.getElementById('loadingOverlayPendientes');
        if (loadingOverlay) loadingOverlay.style.display = 'flex';

        // Preparar filtros actuales (incluyendo filtro de vencimiento)
        const filtros = obtenerTodosFiltrosActuales();
        filtros.tipo_gestion = tipoGestion || ''; // Asegurar que el tipo de gesti√≥n est√© correcto

        // Enviar solicitud al servidor
        const response = await fetch('/sgi/filtrar_por_tipo', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(filtros)
        });

        const resultado = await response.json();

        if (resultado.success) {
            console.log(`‚úÖ Datos cargados exitosamente. Total: ${resultado.total}`);
            console.log('üìä DETALLE DE DATOS RECIBIDOS:');
            console.log('   - Total registros:', resultado.datos.length);
            console.log('   - Tipos:', resultado.datos.map(r => r.tipo).join(', '));
            console.log('   - Datos completos:', resultado.datos);

            // Cargar datos en la tabla con formato espec√≠fico seg√∫n el tipo
            cargarTablaPorTipoGestion(resultado.datos, resultado.tipo_gestion);

            // Actualizar contadores
            actualizarContadores(resultado.datos);

            actualizarCodigosDesdeDatosSiVacio(resultado.datos, tipoGestion);

            // Debug: An√°lisis detallado de fechas (visible en consola del navegador)
            analizarFechas(resultado.datos);
        } else {
            console.error('‚ùå Error al cargar datos:', resultado.mensaje);
            tbody.innerHTML = `<tr><td colspan="11" class="text-center py-8 text-red-600 bg-red-50">Error: ${resultado.mensaje}</td></tr>`;
        }

    } catch (error) {
        console.error('‚ùå Error de red al cargar datos:', error);
        const tbody = document.querySelector('#tablaProcesos tbody');
        tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-red-600 bg-red-50">Error de conexi√≥n. Intente de nuevo.</td></tr>';
    } finally {
        // Ocultar loading overlay
        const loadingOverlay = document.getElementById('loadingOverlayPendientes');
        if (loadingOverlay) loadingOverlay.style.display = 'none';
    }
}

// Funci√≥n para aplicar filtro de vencimiento a los datos
function aplicarFiltroVencimientoADatos(datos) {
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0); // Normalizar a medianoche

    return datos.filter(registro => {
        const fechaStr = registro.fecha_cierre_formato || registro.fechaCierre;
        if (!fechaStr || fechaStr.trim() === '') return false; // Sin fecha no se puede filtrar por vencimiento

        try {
            // Parsear fecha correctamente (igual que en actualizarContadores)
            let fecha;
            if (fechaStr.includes('/')) {
                // Formato DD/MM/YYYY
                const partes = fechaStr.split('/');
                fecha = new Date(partes[2], partes[1] - 1, partes[0]); // YYYY, MM-1, DD
            } else if (fechaStr.includes('-')) {
                // Formato YYYY-MM-DD
                fecha = new Date(fechaStr);
            } else {
                return false; // Formato no reconocido
            }

            fecha.setHours(0, 0, 0, 0); // Normalizar a medianoche

            if (isNaN(fecha.getTime())) {
                return false; // Fecha inv√°lida
            }

            const diff = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));

            // Aplicar filtro seg√∫n el tipo seleccionado
            switch (filtroVencimientoActivo) {
                case 'vencido':
                    return diff < 0; // Fecha pasada
                case 'proximo':
                    return diff >= 0 && diff <= 10; // 0 a 10 d√≠as inclusive
                case 'ok':
                    return diff > 10; // M√°s de 10 d√≠as
                default:
                    return true; // No deber√≠a llegar aqu√≠, pero por seguridad
            }
        } catch (error) {
            console.warn('Error al filtrar fecha:', fechaStr, error);
            return false; // Excluir registros con fechas problem√°ticas
        }
    });
}

// Funci√≥n para cargar datos en la tabla seg√∫n el tipo de gesti√≥n
function cargarTablaPorTipoGestion(datos, tipoGestion) {
    const tbody = document.querySelector('#tablaProcesos tbody');
    tbody.innerHTML = '';

    console.log('üì¶ Datos recibidos del backend:', datos);
    console.log('üîç Filtro de vencimiento activo:', filtroVencimientoActivo);

    // Referencias
    const bannerFiltro = document.getElementById('bannerFiltroActivo');
    const mensajeFiltro = document.getElementById('mensajeFiltroActivo');

    // Aplicar filtro de vencimiento si est√° activo
    let datosFiltrados = datos;
    if (filtroVencimientoActivo) {
        console.log('‚ö†Ô∏è APLICANDO FILTRO DE VENCIMIENTO - Antes:', datos.length, 'registros');
        datosFiltrados = aplicarFiltroVencimientoADatos(datos);
        console.log(`üéØ Filtro de vencimiento '${filtroVencimientoActivo}' aplicado: ${datos.length} ‚Üí ${datosFiltrados.length} registros`);
        console.log('üìã Registros despu√©s del filtro:', datosFiltrados);

        // ‚ö†Ô∏è ALERTA VISUAL: Mostrar cu√°ntos registros se ocultaron
        const registrosOcultos = datos.length - datosFiltrados.length;
        if (registrosOcultos > 0) {
            console.warn(`üö® ATENCI√ìN: Se ocultaron ${registrosOcultos} registros por el filtro de vencimiento activo`);
            console.warn(`   Para ver TODOS los registros, haz clic en el bot√≥n "Quitar filtro" o desactiva el filtro`);

            // Mostrar banner de advertencia
            if (bannerFiltro && mensajeFiltro) {
                bannerFiltro.style.display = 'block';
                mensajeFiltro.textContent = `Se est√°n ocultando ${registrosOcultos} de ${datos.length} registros por el filtro "${filtroVencimientoActivo}"`;
            }
        } else {
            if (bannerFiltro) bannerFiltro.style.display = 'none';
        }
    } else {
        console.log('‚úÖ Sin filtro de vencimiento - Mostrando todos los', datos.length, 'registros');
        if (bannerFiltro) bannerFiltro.style.display = 'none';
    }

    if (datosFiltrados.length === 0) {
        const mensaje = tipoGestion === 'TODOS' ? 'todos los tipos' : tipoGestion;
        const mensajeFiltro = filtroVencimientoActivo ? ` con filtro de vencimiento '${filtroVencimientoActivo}'` : '';

        // Mensaje especial si hay datos pero fueron filtrados
        if (datos.length > 0 && filtroVencimientoActivo) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="11" class="text-center py-8">
                        <div class="alert alert-warning mx-auto" style="max-width: 600px;">
                            <i class="fas fa-filter text-warning" style="font-size: 2em;"></i>
                            <h5 class="mt-3">Filtro activo: "${filtroVencimientoActivo}"</h5>
                            <p class="mb-2">Se encontraron <strong>${datos.length} registros</strong>, pero ninguno cumple el criterio del filtro.</p>
                            <p class="text-muted small mb-3">Haz clic en el bot√≥n "Quitar filtro" para ver todos los registros.</p>
                            <button class="btn btn-sm btn-primary" onclick="limpiarFiltroVencimiento()">
                                <i class="fas fa-times-circle me-1"></i> Quitar filtro y ver todos
                            </button>
                        </div>
                    </td>
                </tr>`;
        } else {
            tbody.innerHTML = `<tr><td colspan="11" class="text-center py-8 text-gray-500 bg-gray-50">No se encontraron registros de ${mensaje}${mensajeFiltro}</td></tr>`;
        }
        return;
    }

    datosFiltrados.forEach(registro => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors duration-150 border-b border-gray-200';

        // Determinar clase CSS para el estado con Tailwind chips
        let estadoClass = '';
        switch(registro.estado) {
            case 'Pendiente':
                estadoClass = 'estado-chip inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-200';
                break;
            case 'En proceso':
                estadoClass = 'estado-chip inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800 border border-blue-200';
                break;
            case 'Abierta':
                estadoClass = 'estado-chip inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-200';
                break;
            case 'Cerrado':
                estadoClass = 'estado-chip inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200';
                break;
        }

        // Formatear fecha
        const fechaApertura = registro.fecha_apertura_formato ||
                              (registro.fecha_apertura ? new Date(registro.fecha_apertura).toLocaleDateString('es-ES') : 'Sin fecha');
        const fechaCierre = registro.fecha_cierre_formato ||
                           (registro.fecha_cierre ? new Date(registro.fecha_cierre).toLocaleDateString('es-ES') : 'Sin fecha');

        // Obtener el tipo espec√≠fico del registro (si viene del backend) o usar el tipo general
        const tipoRegistro = registro.tipo || tipoGestion;

        // Generar contenido espec√≠fico seg√∫n tipo de gesti√≥n
        let actividad = '';
        if (tipoRegistro === 'PA') {
            actividad = registro.tipo_accion || registro.actividad || 'Plan de Acci√≥n';
        } else if (tipoRegistro === 'GC') {
            actividad = registro.nombre_cambio || registro.actividad || 'Gesti√≥n del Cambio';
        } else if (tipoRegistro === 'RVD') {
            actividad = registro.actividad || `RVD ${registro.ano_rvd || ''}`;
        } else {
            // Para casos donde viene actividad directamente del backend
            actividad = registro.actividad || 'Sin especificar';
        }

        const responsableRegistro = registro.responsable && String(registro.responsable).trim()
            ? registro.responsable
            : 'Sin asignar';


        const estadoRegistro = String(registro.estado || '').trim().toLowerCase();
        const esCerrado = estadoRegistro === 'cerrado';
        const botonCerrar = esCerrado
            ? `<button onclick="abrirModalCierre('${registro.codigo}', '${tipoRegistro}', true)" title="Ver cierre"
                    style="display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 34px; font-size: 15px; color: #334155 !important; background-color: #f1f5f9 !important; border: 1px solid #cbd5e1 !important; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.15s ease; cursor: pointer;"
                    onmouseover="this.style.backgroundColor='#e2e8f0'; this.style.borderColor='#94a3b8'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(-1px)'"
                    onmouseout="this.style.backgroundColor='#f1f5f9'; this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                <i class="bi bi-lock-fill"></i>
            </button>`
            : `<button onclick="abrirModalCierre('${registro.codigo}', '${tipoRegistro}', false)" title="Cerrar registro"
                    style="display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 34px; font-size: 15px; color: #b91c1c !important; background-color: #fef2f2 !important; border: 1px solid #fecaca !important; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.15s ease; cursor: pointer;"
                    onmouseover="this.style.backgroundColor='#fee2e2'; this.style.borderColor='#fca5a5'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(-1px)'"
                    onmouseout="this.style.backgroundColor='#fef2f2'; this.style.borderColor='#fecaca'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                <i class="bi bi-lock"></i>
            </button>`;
        // Generar bandera de alerta seg√∫n la fecha de cierre (con c√≥digo de registro para notificaciones)
        const banderaAlerta = generarBanderaAlerta(registro.fecha_cierre_formato || registro.fechaCierre, registro.codigo);

        row.innerHTML = `
            <td class="text-center px-4 py-3">${banderaAlerta}</td>
            <td class="px-4 py-3 text-sm font-medium text-gray-900">${registro.codigo}</td>
            <td class="px-4 py-3 text-sm text-gray-700">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${tipoRegistro === 'PA' ? 'bg-blue-50 text-blue-700' : tipoRegistro === 'GC' ? 'bg-green-50 text-green-700' : 'bg-orange-50 text-orange-700'}">
                    ${tipoRegistro}
                </span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-700" title="${escapeHtmlAttr(obtenerEtiquetaProceso(registro.proceso))}">${registro.proceso}</td>
            <td class="px-4 py-3 text-sm text-gray-500" title="${escapeHtmlAttr(obtenerEtiquetaSubproceso(registro.subproceso))}">
                <span class="celda-subproceso">${registro.subproceso || '-'}</span>
            </td>
            <td class="px-4 py-3 text-sm text-gray-700" title="${actividad}">${actividad.length > 50 ? actividad.substring(0, 50) + '...' : actividad}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${fechaApertura}</td>
            <td class="px-4 py-3 text-sm text-gray-500">${fechaCierre}</td>
            <td class="px-4 py-3"><span class="${estadoClass}">${registro.estado}</span></td>
            <td class="px-4 py-3 text-sm text-gray-600">${responsableRegistro}</td>
            <td class="px-4 py-3 text-center">
                <div style="display: flex; justify-content: center; gap: 6px;">
                    <button onclick="verDetalle('${registro.codigo}', '${tipoRegistro}')" title="Ver detalles"
                            style="display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 34px; font-size: 15px; color: #374151 !important; background-color: #f8fafc !important; border: 1px solid #e2e8f0 !important; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.15s ease; cursor: pointer;"
                            onmouseover="this.style.backgroundColor='#f1f5f9'; this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(-1px)'"
                            onmouseout="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                        üëÅÔ∏è
                    </button>
                    <button onclick="editarRegistro('${registro.codigo}', '${tipoRegistro}')" title="Editar registro"
                            style="display: inline-flex; align-items: center; justify-content: center; width: 34px; height: 34px; font-size: 15px; color: #374151 !important; background-color: #f8fafc !important; border: 1px solid #e2e8f0 !important; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: all 0.15s ease; cursor: pointer;"
                            onmouseover="this.style.backgroundColor='#f1f5f9'; this.style.borderColor='#cbd5e1'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'; this.style.transform='translateY(-1px)'"
                            onmouseout="this.style.backgroundColor='#f8fafc'; this.style.borderColor='#e2e8f0'; this.style.boxShadow='0 1px 2px rgba(0,0,0,0.05)'; this.style.transform='translateY(0)'">
                        ‚úèÔ∏è
                    </button>
                </div>
            </td>
        `;


        if (botonCerrar) {
            const acciones = row.querySelector('td:last-child > div');
            if (acciones) {
                acciones.insertAdjacentHTML('beforeend', botonCerrar);
            }
        }

        tbody.appendChild(row);
    });
}

// Funci√≥n para limpiar la tabla de pendientes
function limpiarTablaPendientes() {
    const tbody = document.querySelector('#tablaProcesos tbody');
    tbody.innerHTML = '<tr><td colspan="11" class="text-center py-8 text-gray-400 bg-gray-50">Seleccione un tipo de gesti√≥n para ver los datos</td></tr>';

    // Limpiar contadores
    document.getElementById('contadorEnProceso').textContent = '0';
    document.getElementById('contadorProximoVencer').textContent = '0';
    document.getElementById('contadorVencidas').textContent = '0';
    document.getElementById('contadorTotal').textContent = '0';
}

// Funci√≥n para ver detalles de un registro
let actividadSeleccionadaId = null;
let detalleRegistroEvidencias = { codigo: '', tipo: '' };
let evidenciaReemplazoId = null;
let adjuntoCausaReemplazoId = null;
let adminRegistroCodigo = '';
let adminRegistroTipo = '';
let adminModalRegistroInstance = null;

function verDetalle(codigo, tipoGestion) {
    detalleRegistroEvidencias = { codigo: codigo, tipo: tipoGestion };
    actividadSeleccionadaId = null;
    limpiarModalEvidencias();

    const detalle = document.getElementById('detalleRegistroSgi');
    if (detalle) {
        detalle.textContent = `Codigo: ${codigo} | Tipo: ${tipoGestion}`;
    }

    const modalEl = document.getElementById('modalEvidenciasActividades');
    if (modalEl) {
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }

    cargarActividadesModal(codigo, tipoGestion);
    cargarAdjuntosAnalisisCausas(codigo, tipoGestion);
}

async function cargarActividadesModal(codigo, tipoGestion) {
    const contenedor = document.getElementById('tablaActividadesModal');
    if (!contenedor) {
        return;
    }

    contenedor.innerHTML = '<div class="text-muted small">Cargando actividades...</div>';

    try {
        const response = await fetch(`/sgi/actividades?codigo=${encodeURIComponent(codigo)}&tipo=${encodeURIComponent(tipoGestion)}`);
        const resultado = await response.json();

        if (!resultado.success) {
            contenedor.innerHTML = `<div class="alert alert-danger">${resultado.mensaje || 'Error al cargar actividades'}</div>`;
            return;
        }

        renderActividadesModal(resultado.actividades || []);
    } catch (error) {
        contenedor.innerHTML = `<div class="alert alert-danger">Error al cargar actividades: ${error.message}</div>`;
    }
}

function renderActividadesModal(actividades) {
    const contenedor = document.getElementById('tablaActividadesModal');
    if (!contenedor) {
        return;
    }

    contenedor.innerHTML = '';

    if (!Array.isArray(actividades) || actividades.length === 0) {
        contenedor.innerHTML = '<div class="alert alert-warning">No hay actividades registradas para este codigo.</div>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'table table-sm table-bordered';
    table.innerHTML = `
        <thead class="table-light">
            <tr>
                <th style="width: 120px;">Etapa</th>
                <th style="width: 180px;">Nombre</th>
                <th>Descripcion</th>
                <th style="width: 120px;">Fecha cierre</th>
                <th style="width: 140px;">Responsable</th>
                <th style="width: 110px;">Evidencias</th>
                <th style="width: 160px;">Ultima evidencia</th>
                <th style="width: 110px;">Estado</th>
                <th style="width: 120px;">Accion</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;

    const tbody = table.querySelector('tbody');

    actividades.forEach((actividad) => {
        const row = document.createElement('tr');
        row.dataset.actividadId = actividad.id;

        const etapa = document.createElement('td');
        etapa.textContent = actividad.etapa_actividad || '-';
        row.appendChild(etapa);

        const nombre = document.createElement('td');
        nombre.textContent = actividad.nombre_actividad || '-';
        row.appendChild(nombre);

        const descripcion = document.createElement('td');
        descripcion.textContent = actividad.descripcion || '-';
        row.appendChild(descripcion);

        const fecha = document.createElement('td');
        fecha.textContent = actividad.fecha_cierre_formato || (actividad.fecha_cierre ? new Date(actividad.fecha_cierre).toLocaleDateString('es-ES') : 'Sin fecha');
        row.appendChild(fecha);

        const responsable = document.createElement('td');
        responsable.textContent = actividad.responsable || '-';
        row.appendChild(responsable);

        const evidencias = document.createElement('td');
        const totalEvidencias = actividad.evidencias_total ?? 0;
        evidencias.textContent = totalEvidencias;
        row.appendChild(evidencias);

        const ultimaEvidencia = document.createElement('td');
        ultimaEvidencia.textContent = actividad.evidencia_ultima_formato || '-';
        row.appendChild(ultimaEvidencia);

        const estado = document.createElement('td');
        estado.textContent = actividad.estado || '-';
        row.appendChild(estado);

        const accion = document.createElement('td');
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-outline-primary';
        btn.textContent = 'Seleccionar';
        const resumen = `${actividad.etapa_actividad || 'Actividad'} - ${actividad.nombre_actividad || 'Sin nombre'}`;
        btn.addEventListener('click', () => {
            seleccionarActividadEvidencia(actividad.id, resumen);
        });
        accion.appendChild(btn);
        row.appendChild(accion);

        tbody.appendChild(row);
    });

    contenedor.appendChild(table);

    if (actividadSeleccionadaId === null && actividades.length > 0) {
        const primera = actividades[0];
        const resumen = `${primera.etapa_actividad || 'Actividad'} - ${primera.nombre_actividad || 'Sin nombre'}`;
        seleccionarActividadEvidencia(primera.id, resumen);
    }
}

function seleccionarActividadEvidencia(actividadId, resumen) {
    actividadSeleccionadaId = actividadId;

    const info = document.getElementById('actividadSeleccionadaInfo');
    if (info) {
        info.textContent = `Actividad seleccionada: ${resumen}`;
    }

    document.querySelectorAll('#tablaActividadesModal tbody tr').forEach(row => {
        row.classList.remove('actividad-selected');
    });
    const fila = document.querySelector(`#tablaActividadesModal tr[data-actividad-id="${actividadId}"]`);
    if (fila) {
        fila.classList.add('actividad-selected');
    }

    cargarEvidenciasActividad(actividadId);
}

function obtenerExtensionArchivo(nombre) {
    if (!nombre) {
        return '';
    }
    const punto = nombre.lastIndexOf('.');
    if (punto === -1) {
        return '';
    }
    return nombre.substring(punto + 1).toLowerCase();
}

function formatearTamanoArchivo(bytes) {
    if (!bytes && bytes !== 0) {
        return '';
    }
    const unidades = ['B', 'KB', 'MB', 'GB'];
    let tamano = bytes;
    let unidad = 0;
    while (tamano >= 1024 && unidad < unidades.length - 1) {
        tamano /= 1024;
        unidad += 1;
    }
    return `${tamano.toFixed(tamano >= 10 ? 0 : 1)} ${unidades[unidad]}`;
}

function descargarArchivoDirecto(url, nombreArchivo) {
    if (!url) {
        return;
    }
    const link = document.createElement('a');
    link.href = url;
    if (nombreArchivo) {
        link.download = nombreArchivo;
    }
    link.rel = 'noopener';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function actualizarLinkAbrirEvidencia(url) {
    const link = document.getElementById('linkAbrirEvidencia');
    if (!link) {
        return;
    }
    if (url) {
        link.href = url;
        link.classList.remove('disabled');
    } else {
        link.removeAttribute('href');
        link.classList.add('disabled');
    }
}

function actualizarLinkAbrirAdjuntoCausa(url) {
    const link = document.getElementById('linkAbrirAdjuntoCausa');
    if (!link) {
        return;
    }
    if (url) {
        link.href = url;
        link.classList.remove('disabled');
    } else {
        link.removeAttribute('href');
        link.classList.add('disabled');
    }
}

function limpiarVisorEvidencia() {
    const visor = document.getElementById('visorEvidenciaActividad');
    if (visor) {
        visor.innerHTML = '<div class="text-muted small">Seleccione una evidencia para previsualizar.</div>';
    }
    actualizarLinkAbrirEvidencia('');
}

function limpiarVisorAdjuntoCausa() {
    const visor = document.getElementById('visorAdjuntoCausa');
    if (visor) {
        visor.innerHTML = '<div class="text-muted small">Seleccione un adjunto para previsualizar.</div>';
    }
    actualizarLinkAbrirAdjuntoCausa('');
}

function actualizarPrevisualizacionEvidencias(files) {
    const contenedor = document.getElementById('previewEvidenciasActividad');
    if (!contenedor) {
        return;
    }

    contenedor.innerHTML = '';

    if (!files || files.length === 0) {
        contenedor.innerHTML = '<div class="text-muted small">No hay archivos seleccionados.</div>';
        return;
    }

    Array.from(files).forEach(file => {
        const item = document.createElement('div');
        item.className = 'preview-evidencia-item';

        if (file.type && file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.className = 'preview-evidencia-thumb';
            const url = URL.createObjectURL(file);
            img.src = url;
            img.alt = file.name;
            img.onload = () => URL.revokeObjectURL(url);
            item.appendChild(img);
        } else {
            const icono = document.createElement('div');
            icono.className = 'preview-evidencia-thumb d-flex align-items-center justify-content-center';
            icono.innerHTML = '<i class="bi bi-file-earmark-text"></i>';
            item.appendChild(icono);
        }

        const meta = document.createElement('div');
        meta.className = 'preview-evidencia-meta';
        const nombre = document.createElement('div');
        nombre.textContent = file.name;
        const tamano = document.createElement('div');
        tamano.textContent = formatearTamanoArchivo(file.size);
        meta.appendChild(nombre);
        meta.appendChild(tamano);
        item.appendChild(meta);

        contenedor.appendChild(item);
    });
}

function mostrarVistaEvidencia(evidencia, itemSeleccionado) {
    const visor = document.getElementById('visorEvidenciaActividad');
    if (!visor) {
        return;
    }

    document.querySelectorAll('#listaEvidenciasActividad .preview-evidencia-item').forEach(item => {
        item.classList.remove('evidencia-item-selected');
    });
    if (itemSeleccionado) {
        itemSeleccionado.classList.add('evidencia-item-selected');
    }

    const url = evidencia.url_descarga || evidencia.url_publica;
    actualizarLinkAbrirEvidencia(url);

    visor.innerHTML = '';
    if (!url) {
        visor.innerHTML = '<div class="text-muted small">No hay URL disponible para esta evidencia.</div>';
        return;
    }

    const nombre = evidencia.nombre_archivo || evidencia.blob_path || '';
    const extension = obtenerExtensionArchivo(nombre);
    const contentType = (evidencia.content_type || '').toLowerCase();

    const esImagen = contentType.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension);
    const esPdf = contentType === 'application/pdf' || extension === 'pdf';
    const esVideo = contentType.startsWith('video/') || ['mp4', 'webm', 'ogg'].includes(extension);
    const esTexto = contentType.startsWith('text/') || ['txt', 'csv', 'log'].includes(extension);
    const esOffice = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(extension);

    if (esImagen) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = nombre || 'Evidencia';
        visor.appendChild(img);
        return;
    }

    if (esPdf) {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.title = nombre || 'Evidencia';
        visor.appendChild(iframe);
        return;
    }

    if (esVideo) {
        const video = document.createElement('video');
        video.controls = true;
        const source = document.createElement('source');
        source.src = url;
        if (contentType) {
            source.type = contentType;
        }
        video.appendChild(source);
        visor.appendChild(video);
        return;
    }

    if (esTexto) {
        const pre = document.createElement('pre');
        pre.className = 'evidencia-texto';
        pre.textContent = 'Cargando contenido...';
        visor.appendChild(pre);
        fetch(url)
            .then(respuesta => respuesta.text())
            .then(texto => {
                pre.textContent = texto;
            })
            .catch(() => {
                pre.textContent = 'No se pudo cargar la vista previa. Use "Abrir en nueva pesta√±a".';
            });
        return;
    }

    if (esOffice) {
        const iframe = document.createElement('iframe');
        iframe.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        iframe.title = nombre || 'Documento Office';
        visor.appendChild(iframe);

        const nota = document.createElement('div');
        nota.className = 'text-muted small mt-2';
        nota.textContent = 'Si no carga, use "Abrir en nueva pesta√±a".';
        visor.appendChild(nota);
        return;
    }

    visor.innerHTML = '<div class="text-muted small">Vista previa no disponible. Use "Abrir en nueva pesta√±a".</div>';
}

function mostrarVistaAdjuntoCausa(adjunto, itemSeleccionado) {
    const visor = document.getElementById('visorAdjuntoCausa');
    if (!visor) {
        return;
    }

    document.querySelectorAll('#listaAdjuntosCausas .preview-evidencia-item').forEach(item => {
        item.classList.remove('evidencia-item-selected');
    });
    if (itemSeleccionado) {
        itemSeleccionado.classList.add('evidencia-item-selected');
    }

    const url = adjunto.url_descarga || adjunto.url_publica;
    actualizarLinkAbrirAdjuntoCausa(url);

    visor.innerHTML = '';
    if (!url) {
        visor.innerHTML = '<div class="text-muted small">No hay URL disponible para este adjunto.</div>';
        return;
    }

    const nombre = adjunto.nombre_archivo || adjunto.blob_path || '';
    const extension = obtenerExtensionArchivo(nombre);
    const contentType = (adjunto.content_type || '').toLowerCase();

    const esImagen = contentType.startsWith('image/') || ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'].includes(extension);
    const esPdf = contentType === 'application/pdf' || extension === 'pdf';
    const esVideo = contentType.startsWith('video/') || ['mp4', 'webm', 'ogg'].includes(extension);
    const esTexto = contentType.startsWith('text/') || ['txt', 'csv', 'log'].includes(extension);
    const esOffice = ['doc', 'docx', 'xls', 'xlsx', 'ppt', 'pptx'].includes(extension);

    if (esImagen) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = nombre || 'Adjunto';
        visor.appendChild(img);
        return;
    }

    if (esPdf) {
        const iframe = document.createElement('iframe');
        iframe.src = url;
        iframe.title = nombre || 'Adjunto';
        visor.appendChild(iframe);
        return;
    }

    if (esVideo) {
        const video = document.createElement('video');
        video.controls = true;
        const source = document.createElement('source');
        source.src = url;
        if (contentType) {
            source.type = contentType;
        }
        video.appendChild(source);
        visor.appendChild(video);
        return;
    }

    if (esTexto) {
        const pre = document.createElement('pre');
        pre.className = 'evidencia-texto';
        pre.textContent = 'Cargando contenido...';
        visor.appendChild(pre);
        fetch(url)
            .then(respuesta => respuesta.text())
            .then(texto => {
                pre.textContent = texto;
            })
            .catch(() => {
                pre.textContent = 'No se pudo cargar la vista previa. Use "Abrir en nueva pestana".';
            });
        return;
    }

    if (esOffice) {
        const iframe = document.createElement('iframe');
        iframe.src = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(url)}`;
        iframe.title = nombre || 'Documento Office';
        visor.appendChild(iframe);

        const nota = document.createElement('div');
        nota.className = 'text-muted small mt-2';
        nota.textContent = 'Si no carga, use "Abrir en nueva pestana".';
        visor.appendChild(nota);
        return;
    }

    visor.innerHTML = '<div class="text-muted small">Vista previa no disponible. Use "Abrir en nueva pestana".</div>';
}

function renderAdjuntosAnalisisCausas(adjuntos) {
    const contenedor = document.getElementById('listaAdjuntosCausas');
    if (!contenedor) {
        return;
    }

    if (!adjuntos.length) {
        contenedor.innerHTML = '<div class="text-muted small">No hay adjuntos registrados.</div>';
        limpiarVisorAdjuntoCausa();
        return;
    }

    const lista = document.createElement('div');

    adjuntos.forEach(adjunto => {
        const item = document.createElement('div');
        item.className = 'preview-evidencia-item';
        item.addEventListener('click', () => {
            mostrarVistaAdjuntoCausa(adjunto, item);
        });

        const icono = document.createElement('div');
        icono.className = 'preview-evidencia-thumb d-flex align-items-center justify-content-center';
        icono.innerHTML = '<i class="bi bi-paperclip"></i>';
        item.appendChild(icono);

        const meta = document.createElement('div');
        meta.className = 'preview-evidencia-meta';
        const nombre = document.createElement('div');
        nombre.textContent = adjunto.nombre_archivo || adjunto.blob_path || 'Adjunto';
        const detalle = document.createElement('div');
        const fecha = adjunto.fecha_subida_formato || '';
        const tamano = formatearTamanoArchivo(adjunto.tamano_bytes);
        const reemplazo = adjunto.puede_reemplazar ? 'Reemplazo disponible' : 'Reemplazo usado';
        detalle.textContent = [fecha, tamano, reemplazo].filter(Boolean).join(' | ');
        meta.appendChild(nombre);
        meta.appendChild(detalle);
        item.appendChild(meta);

        const acciones = document.createElement('div');
        acciones.className = 'd-flex gap-2 ms-auto';

        const btnVer = document.createElement('button');
        btnVer.type = 'button';
        btnVer.className = 'btn btn-sm btn-outline-primary';
        btnVer.textContent = 'Ver';
        btnVer.addEventListener('click', (event) => {
            event.stopPropagation();
            mostrarVistaAdjuntoCausa(adjunto, item);
        });
        acciones.appendChild(btnVer);

        const url = adjunto.url_descarga || adjunto.url_publica;
        const btnDescargar = document.createElement('button');
        btnDescargar.type = 'button';
        btnDescargar.className = 'btn btn-sm btn-outline-secondary';
        btnDescargar.textContent = 'Descargar';
        btnDescargar.addEventListener('click', (event) => {
            event.stopPropagation();
            descargarArchivoDirecto(url, adjunto.nombre_archivo || adjunto.blob_path || 'adjunto');
        });
        acciones.appendChild(btnDescargar);

        const btnReemplazar = document.createElement('button');
        btnReemplazar.type = 'button';
        btnReemplazar.className = 'btn btn-sm btn-outline-dark';
        btnReemplazar.textContent = 'Reemplazar';
        btnReemplazar.disabled = !adjunto.puede_reemplazar;
        if (!adjunto.puede_reemplazar) {
            btnReemplazar.title = 'Reemplazo ya usado';
        }
        btnReemplazar.addEventListener('click', (event) => {
            event.stopPropagation();
            solicitarReemplazoAdjuntoCausa(adjunto.id);
        });
        acciones.appendChild(btnReemplazar);

        item.appendChild(acciones);
        lista.appendChild(item);
    });

    contenedor.innerHTML = '';
    contenedor.appendChild(lista);

    mostrarVistaAdjuntoCausa(adjuntos[0], lista.querySelector('.preview-evidencia-item'));
}

async function cargarAdjuntosAnalisisCausas(codigo, tipoGestion) {
    const contenedor = document.getElementById('listaAdjuntosCausas');
    if (!contenedor) {
        return;
    }

    if (!codigo) {
        contenedor.innerHTML = '';
        limpiarVisorAdjuntoCausa();
        return;
    }

    const tipo = String(tipoGestion || '').trim().toUpperCase();
    if (tipo !== 'PA') {
        contenedor.innerHTML = '<div class="text-muted small">No aplica para este tipo.</div>';
        limpiarVisorAdjuntoCausa();
        return;
    }

    contenedor.innerHTML = '<div class="text-muted small">Cargando adjuntos...</div>';

    try {
        const response = await fetch(`/sgi/analisis-causas?codigo=${encodeURIComponent(codigo)}&tipo=${encodeURIComponent(tipo)}`);
        const resultado = await response.json();
        if (!resultado.success) {
            contenedor.innerHTML = `<div class="text-danger small">${resultado.mensaje || 'No se pudieron cargar adjuntos.'}</div>`;
            limpiarVisorAdjuntoCausa();
            return;
        }
        renderAdjuntosAnalisisCausas(resultado.adjuntos || []);
    } catch (error) {
        contenedor.innerHTML = `<div class="text-danger small">Error al cargar adjuntos: ${error.message}</div>`;
        limpiarVisorAdjuntoCausa();
    }
}

function solicitarReemplazoAdjuntoCausa(adjuntoId) {
    adjuntoCausaReemplazoId = adjuntoId;
    const input = document.getElementById('inputReemplazoAdjuntoCausa');
    if (input) {
        input.value = '';
        input.click();
    }
}

async function subirReemplazoAdjuntoCausa(file) {
    if (!adjuntoCausaReemplazoId || !file) {
        return;
    }

    try {
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch(`/sgi/analisis-causas/${adjuntoCausaReemplazoId}/reemplazar`, {
            method: 'POST',
            body: formData
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo reemplazar el adjunto.');
        }
        Toast.success('Adjunto reemplazado correctamente');
        if (detalleRegistroEvidencias.codigo && detalleRegistroEvidencias.tipo) {
            await cargarAdjuntosAnalisisCausas(detalleRegistroEvidencias.codigo, detalleRegistroEvidencias.tipo);
        }
    } catch (error) {
        Toast.error(`Error al reemplazar adjunto: ${error.message}`);
    } finally {
        adjuntoCausaReemplazoId = null;
        const input = document.getElementById('inputReemplazoAdjuntoCausa');
        if (input) {
            input.value = '';
        }
    }
}

function obtenerEstadoEvidencia(estado) {
    const valor = (estado || 'pendiente').toLowerCase();
    if (valor === 'aprobada') return 'aprobada';
    if (valor === 'rechazada') return 'rechazada';
    return 'pendiente';
}

function solicitarReemplazoEvidencia(evidenciaId) {
    evidenciaReemplazoId = evidenciaId;
    const input = document.getElementById('inputReemplazoEvidencia');
    if (input) {
        input.value = '';
        input.click();
    }
}

async function subirReemplazoEvidencia(file) {
    if (!evidenciaReemplazoId || !file) {
        return;
    }

    try {
        const formData = new FormData();
        formData.append('file', file);
        const response = await fetch(`/sgi/evidencias/${evidenciaReemplazoId}/reemplazar`, {
            method: 'POST',
            body: formData
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo reemplazar la evidencia.');
        }
        Toast.success('‚úÖ Evidencia reemplazada. Queda nuevamente en estado pendiente');
        await cargarEvidenciasActividad(actividadSeleccionadaId);
    } catch (error) {
        Toast.error(`‚ùå Error al reemplazar evidencia: ${error.message}`);
    } finally {
        evidenciaReemplazoId = null;
        const input = document.getElementById('inputReemplazoEvidencia');
        if (input) {
            input.value = '';
        }
    }
}

function obtenerEvidenciasSeleccionadas() {
    return Array.from(document.querySelectorAll('.evidencia-select:checked'))
        .map(input => parseInt(input.value, 10))
        .filter(id => Number.isFinite(id));
}

function mostrarProgresoDescarga({ porcentaje = 0, texto = 'Descargando...', indeterminado = false } = {}) {
    const wrapper = document.getElementById('descargaEvidenciasProgress');
    const bar = document.getElementById('descargaEvidenciasBar');
    const textoEl = document.getElementById('descargaEvidenciasTexto');
    const porcentajeEl = document.getElementById('descargaEvidenciasPorcentaje');

    if (!wrapper || !bar || !textoEl || !porcentajeEl) {
        return;
    }

    wrapper.classList.remove('d-none');
    textoEl.textContent = texto;

    if (indeterminado) {
        bar.classList.add('progress-bar-striped', 'progress-bar-animated');
        bar.style.width = '100%';
        porcentajeEl.textContent = '';
    } else {
        bar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        const safePct = Math.max(0, Math.min(100, porcentaje));
        bar.style.width = `${safePct}%`;
        porcentajeEl.textContent = `${safePct}%`;
    }
}

function ocultarProgresoDescarga() {
    const wrapper = document.getElementById('descargaEvidenciasProgress');
    const bar = document.getElementById('descargaEvidenciasBar');
    const porcentajeEl = document.getElementById('descargaEvidenciasPorcentaje');
    if (wrapper) {
        wrapper.classList.add('d-none');
    }
    if (bar) {
        bar.classList.remove('progress-bar-striped', 'progress-bar-animated');
        bar.style.width = '0%';
    }
    if (porcentajeEl) {
        porcentajeEl.textContent = '0%';
    }
}

async function descargarZipEvidencias(idsSeleccionadas, descargarTodas) {
    if (!actividadSeleccionadaId) {
        alert('Seleccione una actividad primero.');
        return;
    }

    try {
        const btnSeleccionadas = document.getElementById('btnDescargarSeleccionadas');
        const btnTodas = document.getElementById('btnDescargarTodas');
        if (btnSeleccionadas) btnSeleccionadas.disabled = true;
        if (btnTodas) btnTodas.disabled = true;

        mostrarProgresoDescarga({ texto: 'Preparando descarga...', porcentaje: 0 });
        let response;
        if (descargarTodas) {
            response = await fetch(`/sgi/actividades/${actividadSeleccionadaId}/evidencias/descargar`);
        } else {
            response = await fetch(`/sgi/actividades/${actividadSeleccionadaId}/evidencias/descargar`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ evidencias: idsSeleccionadas })
            });
        }

        if (!response.ok) {
            let mensaje = 'No se pudo descargar el ZIP.';
            const contentType = response.headers.get('content-type') || '';
            if (contentType.includes('application/json')) {
                const data = await response.json().catch(() => ({}));
                if (data && data.mensaje) {
                    mensaje = data.mensaje;
                }
            } else {
                const text = await response.text().catch(() => '');
                if (text) {
                    mensaje = text;
                }
            }
            throw new Error(mensaje);
        }

        const totalHeader = response.headers.get('content-length');
        const total = totalHeader ? parseInt(totalHeader, 10) : 0;

        if (!response.body) {
            mostrarProgresoDescarga({ texto: 'Descargando...', indeterminado: true });
            const blob = await response.blob();
            ocultarProgresoDescarga();
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            const disposition = response.headers.get('content-disposition') || '';
            const match = disposition.match(/filename=\"?([^\";]+)\"?/i);
            const filename = match ? match[1] : 'evidencias.zip';

            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            link.remove();
            window.URL.revokeObjectURL(url);
            if (btnSeleccionadas) btnSeleccionadas.disabled = false;
            if (btnTodas) btnTodas.disabled = false;
            return;
        }

        if (!total) {
            mostrarProgresoDescarga({ texto: 'Descargando...', indeterminado: true });
        } else {
            mostrarProgresoDescarga({ texto: 'Descargando...', porcentaje: 0 });
        }

        const reader = response.body.getReader();
        const chunks = [];
        let received = 0;

        while (true) {
            const { done, value } = await reader.read();
            if (done) {
                break;
            }
            chunks.push(value);
            received += value.length;
            if (total) {
                const porcentaje = Math.round((received / total) * 100);
                mostrarProgresoDescarga({ texto: 'Descargando...', porcentaje });
            }
        }

        const blob = new Blob(chunks, { type: 'application/zip' });
        ocultarProgresoDescarga();
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        const disposition = response.headers.get('content-disposition') || '';
        const match = disposition.match(/filename=\"?([^\";]+)\"?/i);
        const filename = match ? match[1] : 'evidencias.zip';

        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        link.remove();
        window.URL.revokeObjectURL(url);
        if (btnSeleccionadas) btnSeleccionadas.disabled = false;
        if (btnTodas) btnTodas.disabled = false;
    } catch (error) {
        ocultarProgresoDescarga();
        alert(`Error al descargar evidencias: ${error.message}`);
        const btnSeleccionadas = document.getElementById('btnDescargarSeleccionadas');
        const btnTodas = document.getElementById('btnDescargarTodas');
        if (btnSeleccionadas) btnSeleccionadas.disabled = false;
        if (btnTodas) btnTodas.disabled = false;
    }
}

function descargarEvidenciasSeleccionadas() {
    const ids = obtenerEvidenciasSeleccionadas();
    if (!ids.length) {
        Toast.warning('‚ö†Ô∏è Seleccione al menos una evidencia');
        return;
    }
    descargarZipEvidencias(ids, false);
}

function descargarEvidenciasTodas() {
    descargarZipEvidencias([], true);
}

async function cargarEvidenciasActividad(actividadId) {
    const contenedor = document.getElementById('listaEvidenciasActividad');
    if (!contenedor) {
        return;
    }
    contenedor.innerHTML = '<div class="text-muted small">Cargando evidencias...</div>';

    try {
        const response = await fetch(`/sgi/actividades/${actividadId}/evidencias`);
        const resultado = await response.json();

        if (!resultado.success) {
            contenedor.innerHTML = `<div class="text-danger small">${resultado.mensaje || 'No se pudieron cargar evidencias.'}</div>`;
            return;
        }

        const evidencias = resultado.evidencias || [];
        if (evidencias.length === 0) {
            contenedor.innerHTML = '<div class="text-muted small">No hay evidencias registradas.</div>';
            limpiarVisorEvidencia();
            return;
        }

        const lista = document.createElement('div');
        evidencias.forEach(ev => {
            const item = document.createElement('div');
            item.className = 'preview-evidencia-item';

            const selector = document.createElement('div');
            selector.className = 'form-check me-2';
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input evidencia-select';
            checkbox.value = ev.id;
            checkbox.addEventListener('change', () => {
                const total = document.querySelectorAll('.evidencia-select').length;
                const seleccionadas = document.querySelectorAll('.evidencia-select:checked').length;
                const checkTodas = document.getElementById('checkTodasEvidencias');
                if (checkTodas) {
                    checkTodas.checked = total > 0 && total === seleccionadas;
                }
            });
            selector.appendChild(checkbox);
            item.appendChild(selector);

            const icono = document.createElement('div');
            icono.className = 'preview-evidencia-thumb d-flex align-items-center justify-content-center';
            icono.innerHTML = '<i class="bi bi-paperclip"></i>';
            item.appendChild(icono);

            const meta = document.createElement('div');
            meta.className = 'preview-evidencia-meta';
            const nombre = document.createElement('div');
            const urlDescarga = ev.url_descarga || ev.url_publica;
            if (urlDescarga) {
                const link = document.createElement('a');
                link.href = urlDescarga;
                link.target = '_blank';
                link.rel = 'noopener';
                link.textContent = ev.nombre_archivo || ev.blob_path;
                nombre.appendChild(link);
            } else {
                nombre.textContent = ev.nombre_archivo || ev.blob_path;
            }
            const fecha = document.createElement('div');
            fecha.textContent = ev.fecha_subida_formato || '';
            meta.appendChild(nombre);
            meta.appendChild(fecha);

            const estadoValor = obtenerEstadoEvidencia(ev.estado_validacion);
            const badge = document.createElement('span');
            badge.className = `estado-evidencia ${estadoValor}`;
            badge.textContent = estadoValor.charAt(0).toUpperCase() + estadoValor.slice(1);
            meta.appendChild(badge);

            if (estadoValor === 'rechazada' && ev.motivo_rechazo) {
                const motivo = document.createElement('div');
                motivo.className = 'text-danger small';
                motivo.textContent = `Motivo: ${ev.motivo_rechazo}`;
                meta.appendChild(motivo);
            }
            item.appendChild(meta);

            const acciones = document.createElement('div');
            acciones.className = 'ms-auto d-flex align-items-center gap-2';
            const btnVer = document.createElement('button');
            btnVer.type = 'button';
            btnVer.className = 'btn btn-sm btn-outline-primary';
            btnVer.textContent = 'Ver';
            btnVer.addEventListener('click', () => mostrarVistaEvidencia(ev, item));
            acciones.appendChild(btnVer);

            const btnDescargar = document.createElement('button');
            btnDescargar.type = 'button';
            btnDescargar.className = 'btn btn-sm btn-outline-secondary';
            btnDescargar.textContent = 'Descargar';
            btnDescargar.addEventListener('click', () => descargarZipEvidencias([ev.id], false));
            acciones.appendChild(btnDescargar);

            if (estadoValor === 'rechazada') {
                const btnReemplazar = document.createElement('button');
                btnReemplazar.type = 'button';
                btnReemplazar.className = 'btn btn-sm btn-outline-danger';
                btnReemplazar.textContent = 'Reemplazar';
                btnReemplazar.addEventListener('click', () => solicitarReemplazoEvidencia(ev.id));
                acciones.appendChild(btnReemplazar);
            }

            item.appendChild(acciones);

            lista.appendChild(item);
        });

        contenedor.innerHTML = '';
        contenedor.appendChild(lista);

        mostrarVistaEvidencia(evidencias[0], lista.querySelector('.preview-evidencia-item'));
        const checkTodas = document.getElementById('checkTodasEvidencias');
        if (checkTodas) {
            checkTodas.checked = false;
        }
    } catch (error) {
        contenedor.innerHTML = `<div class="text-danger small">Error al cargar evidencias: ${error.message}</div>`;
        limpiarVisorEvidencia();
    }
}

function limpiarModalEvidencias() {
    const contenedorActividades = document.getElementById('tablaActividadesModal');
    if (contenedorActividades) {
        contenedorActividades.innerHTML = '';
    }

    const preview = document.getElementById('previewEvidenciasActividad');
    if (preview) {
        preview.innerHTML = '<div class="text-muted small">No hay archivos seleccionados.</div>';
    }

    const listaEvidencias = document.getElementById('listaEvidenciasActividad');
    if (listaEvidencias) {
        listaEvidencias.innerHTML = '<div class="text-muted small">Seleccione una actividad para ver evidencias.</div>';
    }

    limpiarVisorEvidencia();
    limpiarVisorAdjuntoCausa();

    const listaAdjuntos = document.getElementById('listaAdjuntosCausas');
    if (listaAdjuntos) {
        listaAdjuntos.innerHTML = '<div class="text-muted small">No hay adjuntos registrados.</div>';
    }

    const checkTodas = document.getElementById('checkTodasEvidencias');
    if (checkTodas) {
        checkTodas.checked = false;
    }

    ocultarProgresoDescarga();

    const input = document.getElementById('inputEvidenciasActividad');
    if (input) {
        input.value = '';
    }

    const inputReemplazo = document.getElementById('inputReemplazoEvidencia');
    if (inputReemplazo) {
        inputReemplazo.value = '';
    }

    const inputReemplazoAdjunto = document.getElementById('inputReemplazoAdjuntoCausa');
    if (inputReemplazoAdjunto) {
        inputReemplazoAdjunto.value = '';
    }

    const info = document.getElementById('actividadSeleccionadaInfo');
    if (info) {
        info.textContent = 'Seleccione una actividad para subir evidencias.';
    }
}

async function subirEvidenciasActividad() {
    if (!actividadSeleccionadaId) {
        Toast.warning('‚ö†Ô∏è Seleccione una actividad para subir evidencias');
        return;
    }

    const input = document.getElementById('inputEvidenciasActividad');
    if (!input || !input.files || input.files.length === 0) {
        Toast.warning('‚ö†Ô∏è Seleccione uno o m√°s archivos');
        return;
    }

    const btn = document.getElementById('btnSubirEvidenciasActividad');
    const textoOriginal = btn ? btn.innerHTML : '';
    if (btn) {
        btn.innerHTML = '<i class="bi bi-hourglass-split"></i> Subiendo...';
        btn.disabled = true;
    }

    try {
        const formData = new FormData();
        Array.from(input.files).forEach(file => {
            formData.append('files', file);
        });

        const response = await fetch(`/sgi/actividades/${actividadSeleccionadaId}/evidencias`, {
            method: 'POST',
            body: formData
        });

        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudieron subir las evidencias.');
        }

        console.log('üéâ Evidencias subidas exitosamente');
        Toast.success('‚úÖ Evidencias cargadas correctamente');

        input.value = '';
        actualizarPrevisualizacionEvidencias([]);
        await cargarEvidenciasActividad(actividadSeleccionadaId);
        if (detalleRegistroEvidencias.codigo && detalleRegistroEvidencias.tipo) {
            await cargarActividadesModal(detalleRegistroEvidencias.codigo, detalleRegistroEvidencias.tipo);
        }
    } catch (error) {
        console.error('‚ùå Error al subir evidencias:', error);
        Toast.error(`Error al subir evidencias: ${error.message}`);
    } finally {
        if (btn) {
            btn.innerHTML = textoOriginal;
            btn.disabled = false;
        }
    }
}

function configurarModalEvidencias() {
    const input = document.getElementById('inputEvidenciasActividad');
    if (input && !input.dataset.listener) {
        input.addEventListener('change', (event) => {
            actualizarPrevisualizacionEvidencias(event.target.files);
        });
        input.dataset.listener = 'true';
    }

    const inputReemplazo = document.getElementById('inputReemplazoEvidencia');
    if (inputReemplazo && !inputReemplazo.dataset.listener) {
        inputReemplazo.addEventListener('change', (event) => {
            const file = event.target.files && event.target.files[0];
            if (file) {
                subirReemplazoEvidencia(file);
            }
        });
        inputReemplazo.dataset.listener = 'true';
    }

    const inputReemplazoAdjunto = document.getElementById('inputReemplazoAdjuntoCausa');
    if (inputReemplazoAdjunto && !inputReemplazoAdjunto.dataset.listener) {
        inputReemplazoAdjunto.addEventListener('change', (event) => {
            const file = event.target.files && event.target.files[0];
            if (file) {
                subirReemplazoAdjuntoCausa(file);
            }
        });
        inputReemplazoAdjunto.dataset.listener = 'true';
    }

    const btn = document.getElementById('btnSubirEvidenciasActividad');
    if (btn && !btn.dataset.listener) {
        btn.addEventListener('click', () => {
            subirEvidenciasActividad();
        });
        btn.dataset.listener = 'true';
    }

    const btnDescargarSeleccionadas = document.getElementById('btnDescargarSeleccionadas');
    if (btnDescargarSeleccionadas && !btnDescargarSeleccionadas.dataset.listener) {
        btnDescargarSeleccionadas.addEventListener('click', () => {
            descargarEvidenciasSeleccionadas();
        });
        btnDescargarSeleccionadas.dataset.listener = 'true';
    }

    const btnDescargarTodas = document.getElementById('btnDescargarTodas');
    if (btnDescargarTodas && !btnDescargarTodas.dataset.listener) {
        btnDescargarTodas.addEventListener('click', () => {
            descargarEvidenciasTodas();
        });
        btnDescargarTodas.dataset.listener = 'true';
    }

    const checkTodas = document.getElementById('checkTodasEvidencias');
    if (checkTodas && !checkTodas.dataset.listener) {
        checkTodas.addEventListener('change', (event) => {
            const checked = event.target.checked;
            document.querySelectorAll('.evidencia-select').forEach(input => {
                input.checked = checked;
            });
        });
        checkTodas.dataset.listener = 'true';
    }

    const modal = document.getElementById('modalEvidenciasActividades');
    if (modal && !modal.dataset.listener) {
        modal.addEventListener('hidden.bs.modal', () => {
            limpiarModalEvidencias();
            actividadSeleccionadaId = null;
        });
        modal.dataset.listener = 'true';
    }
}
function configurarModalAdminRegistro() {
    const modalEl = document.getElementById('modalAdminRegistroSgi');
    if (modalEl && !modalEl.dataset.listener) {
        modalEl.addEventListener('hidden.bs.modal', () => {
            limpiarModalAdminRegistro();
        });
        modalEl.dataset.listener = 'true';
    }

    const btnGuardar = document.getElementById('btnGuardarRegistroAdmin');
    if (btnGuardar && !btnGuardar.dataset.listener) {
        btnGuardar.addEventListener('click', () => {
            guardarRegistroAdmin();
        });
        btnGuardar.dataset.listener = 'true';
    }

    const btnEliminar = document.getElementById('btnEliminarRegistroAdmin');
    if (btnEliminar && !btnEliminar.dataset.listener) {
        btnEliminar.addEventListener('click', () => {
            eliminarRegistroAdmin();
        });
        btnEliminar.dataset.listener = 'true';
    }

    const btnEliminarActividades = document.getElementById('btnEliminarActividadesAdminFooter');
    if (btnEliminarActividades && !btnEliminarActividades.dataset.listener) {
        btnEliminarActividades.addEventListener('click', () => {
            eliminarActividadesAdmin();
        });
        btnEliminarActividades.dataset.listener = 'true';
    }

    const btnEliminarEvidencias = document.getElementById('btnEliminarEvidenciasAdminFooter');
    if (btnEliminarEvidencias && !btnEliminarEvidencias.dataset.listener) {
        btnEliminarEvidencias.addEventListener('click', () => {
            eliminarEvidenciasAdmin();
        });
        btnEliminarEvidencias.dataset.listener = 'true';
    }

    const tabButtons = document.querySelectorAll('#adminRegistroTabs button[data-bs-toggle="tab"]');
    tabButtons.forEach(btn => {
        if (!btn.dataset.listener) {
            btn.addEventListener('shown.bs.tab', event => {
                const target = event.target.getAttribute('data-bs-target') || '';
                actualizarBotonesAdminPorTab(target.replace('#', ''));
            });
            btn.dataset.listener = 'true';
        }
    });

    actualizarBotonesAdminPorTab('adminRegistroTab');
}

let cierreRegistroCodigo = '';
let cierreRegistroTipo = '';
let cierreModalRegistroInstance = null;
let cierrePuedeCerrar = false;
let cierreValidacion = null;
let cierreModoLectura = false;
let cierreModoEdicion = false;
let cierreDetalleActual = null;

function limpiarModalCierreRegistro() {
    cierreRegistroCodigo = '';
    cierreRegistroTipo = '';
    cierrePuedeCerrar = false;
    cierreValidacion = null;
    cierreModoLectura = false;
    cierreModoEdicion = false;
    cierreDetalleActual = null;

    const detalle = document.getElementById('detalleRegistroCerrar');
    if (detalle) {
        detalle.textContent = '';
    }

    const codigoEl = document.getElementById('cierreCodigo');
    if (codigoEl) {
        codigoEl.value = '';
    }
    const tipoEl = document.getElementById('cierreTipo');
    if (tipoEl) {
        tipoEl.value = '';
    }

    const form = document.getElementById('formCerrarRegistro');
    if (form) {
        form.reset();
    }

    limpiarResumenCierre();
    limpiarHistorialCierre();
    configurarModoLecturaCierre(false);
}

function limpiarResumenCierre() {
    const mensaje = document.getElementById('cierreResumenMensaje');
    if (mensaje) {
        mensaje.textContent = '';
        mensaje.classList.add('d-none');
        mensaje.classList.remove('alert-info', 'alert-success', 'alert-warning', 'alert-danger');
    }

    const resumenActividades = document.getElementById('cierreResumenActividades');
    if (resumenActividades) {
        resumenActividades.textContent = '--';
    }
    const resumenEvidencias = document.getElementById('cierreResumenEvidencias');
    if (resumenEvidencias) {
        resumenEvidencias.textContent = '--';
    }
}

function limpiarHistorialCierre() {
    const contenedor = document.getElementById('cierreHistorialTabla');
    if (contenedor) {
        contenedor.innerHTML = '<div class="text-muted small">No hay cambios registrados.</div>';
    }
}

function normalizarTextoHistorial(valor) {
    const texto = String(valor || '').trim();
    return texto ? texto : '-';
}

function crearCeldaCambioHistorial(antes, despues, marcarOriginal = false) {
    const celda = document.createElement('td');
    const antesTexto = normalizarTextoHistorial(antes);
    const despuesTexto = normalizarTextoHistorial(despues);
    if (antesTexto !== despuesTexto) {
        celda.classList.add('historial-cambio');
    }
    const antesEl = document.createElement('div');
    antesEl.className = 'text-muted small';
    if (marcarOriginal) {
        const badge = document.createElement('span');
        badge.className = 'badge bg-secondary me-1';
        badge.textContent = 'Original';
        antesEl.appendChild(badge);
    }
    antesEl.appendChild(document.createTextNode(`Antes: ${antesTexto}`));
    const despuesEl = document.createElement('div');
    despuesEl.className = 'fw-semibold';
    despuesEl.textContent = `Despues: ${despuesTexto}`;
    celda.appendChild(antesEl);
    celda.appendChild(despuesEl);
    return celda;
}

function crearCeldaVersionHistorial(versionAnterior, versionNueva) {
    const celda = document.createElement('td');
    const badgeAnterior = document.createElement('span');
    if (versionAnterior <= 0) {
        badgeAnterior.className = 'badge bg-secondary';
        badgeAnterior.textContent = 'Original';
    } else {
        badgeAnterior.className = 'badge bg-light text-dark';
        badgeAnterior.textContent = `V${versionAnterior}`;
    }

    const flecha = document.createElement('span');
    flecha.className = 'mx-1 text-muted';
    flecha.textContent = '->';

    const badgeNueva = document.createElement('span');
    badgeNueva.className = 'badge bg-primary';
    badgeNueva.textContent = `V${versionNueva}`;

    celda.appendChild(badgeAnterior);
    celda.appendChild(flecha);
    celda.appendChild(badgeNueva);
    return celda;
}

function renderHistorialCierre(historial) {
    const contenedor = document.getElementById('cierreHistorialTabla');
    if (!contenedor) {
        return;
    }

    if (!Array.isArray(historial) || historial.length === 0) {
        contenedor.innerHTML = '<div class="text-muted small">No hay cambios registrados.</div>';
        return;
    }

    const table = document.createElement('table');
    table.className = 'table table-sm table-bordered mb-0';
    table.innerHTML = `
        <thead class="table-light">
            <tr>
                <th style="width: 120px;">Version</th>
                <th style="width: 140px;">Fecha cambio</th>
                <th style="width: 120px;">Usuario</th>
                <th>Responsable</th>
                <th>Fecha cierre</th>
                <th>Tipo cierre</th>
                <th>Descripcion</th>
            </tr>
        </thead>
        <tbody></tbody>
    `;

    const tbody = table.querySelector('tbody');
    const total = historial.length;
    historial.forEach(item => {
        const row = document.createElement('tr');
        const versionNumero = total - tbody.children.length;
        const versionAnterior = versionNumero - 1;
        const marcarOriginal = versionAnterior <= 0;

        row.appendChild(crearCeldaVersionHistorial(versionAnterior, versionNumero));

        const fechaCambio = document.createElement('td');
        fechaCambio.textContent = item.fecha_modificacion_formato || item.fecha_modificacion || '-';
        row.appendChild(fechaCambio);

        const usuario = document.createElement('td');
        usuario.textContent = item.usuario_modificacion || '-';
        row.appendChild(usuario);

        row.appendChild(
            crearCeldaCambioHistorial(
                item.responsable_cierre_anterior,
                item.responsable_cierre_nuevo,
                marcarOriginal
            )
        );
        row.appendChild(
            crearCeldaCambioHistorial(
                item.fecha_cierre_anterior_formato || item.fecha_cierre_anterior,
                item.fecha_cierre_nuevo_formato || item.fecha_cierre_nuevo,
                marcarOriginal
            )
        );
        row.appendChild(
            crearCeldaCambioHistorial(
                item.tipo_cierre_anterior,
                item.tipo_cierre_nuevo,
                marcarOriginal
            )
        );
        row.appendChild(
            crearCeldaCambioHistorial(
                item.descripcion_cierre_anterior,
                item.descripcion_cierre_nuevo,
                marcarOriginal
            )
        );

        tbody.appendChild(row);
    });

    contenedor.innerHTML = '';
    contenedor.appendChild(table);
}

async function cargarHistorialCierreRegistro(codigo, tipoGestion) {
    const contenedor = document.getElementById('cierreHistorialTabla');
    if (!contenedor) {
        return;
    }

    contenedor.innerHTML = '<div class="text-muted small">Cargando historial...</div>';

    try {
        const response = await fetch(`/sgi/cierre/historial?codigo=${encodeURIComponent(codigo)}&tipo=${encodeURIComponent(tipoGestion)}`);
        const data = await response.json();
        if (!response.ok || !data.success) {
            throw new Error(data.mensaje || 'No se pudo cargar el historial');
        }
        renderHistorialCierre(data.historial || []);
    } catch (error) {
        contenedor.innerHTML = `<div class="text-danger small">No se pudo cargar el historial: ${error.message}</div>`;
    }
}

function establecerMensajeCierre(texto, tipo, usarHtml = false) {
    const mensaje = document.getElementById('cierreResumenMensaje');
    if (!mensaje) {
        return;
    }

    mensaje.classList.remove('d-none', 'alert-info', 'alert-success', 'alert-warning', 'alert-danger');
    mensaje.classList.add(`alert-${tipo}`);
    if (usarHtml) {
        mensaje.innerHTML = texto;
    } else {
        mensaje.textContent = texto;
    }
}

function actualizarEstadoBotonCierre(puedeCerrar) {
    const btn = document.getElementById('btnConfirmarCierreRegistro');
    if (!btn) {
        return;
    }
    btn.disabled = !puedeCerrar;
    btn.title = puedeCerrar ? '' : 'Cierre bloqueado por reglas de negocio';
}

function actualizarResumenCierre(validacion) {
    if (!validacion) {
        limpiarResumenCierre();
        return;
    }

    const detalle = validacion.detalle || {};
    const resumenActividades = document.getElementById('cierreResumenActividades');
    if (resumenActividades) {
        const total = detalle.total_actividades || 0;
        const cerradas = detalle.actividades_cerradas || 0;
        const noEjecutadas = detalle.actividades_no_ejecutadas || 0;
        const otros = detalle.actividades_otro_estado || 0;
        const sinEvidencias = detalle.actividades_sin_evidencias || 0;
        const evidNoAprobadas = detalle.actividades_con_evidencias_no_aprobadas || 0;
        resumenActividades.textContent = `Total: ${total} | Cerradas: ${cerradas} | No ejecutadas: ${noEjecutadas} | Otros: ${otros} | Sin evidencias: ${sinEvidencias} | Con evidencias no aprobadas: ${evidNoAprobadas}`;
    }

    const resumenEvidencias = document.getElementById('cierreResumenEvidencias');
    if (resumenEvidencias) {
        const totalEv = detalle.evidencias_total || 0;
        const aprobadas = detalle.evidencias_aprobadas || 0;
        const pendientes = detalle.evidencias_pendientes || 0;
        const rechazadas = detalle.evidencias_rechazadas || 0;
        const sinEstado = detalle.evidencias_sin_estado || 0;
        resumenEvidencias.textContent = `Total: ${totalEv} | Aprobadas: ${aprobadas} | Pendientes: ${pendientes} | Rechazadas: ${rechazadas} | Sin estado: ${sinEstado}`;
    }

    const puedeCerrar = Boolean(validacion.puede_cerrar);
    if (puedeCerrar) {
        establecerMensajeCierre(validacion.mensaje || 'Cierre habilitado', 'success');
    } else {
        const bloqueos = Array.isArray(validacion.bloqueos) ? validacion.bloqueos : [];
        if (bloqueos.length > 0) {
            const detalleBloqueo = bloqueos.map(item => `- ${item}`).join('<br>');
            const titulo = validacion.mensaje || 'Cierre bloqueado';
            establecerMensajeCierre(`<strong>${titulo}:</strong><br>${detalleBloqueo}`, 'warning', true);
        } else {
            establecerMensajeCierre(validacion.mensaje || 'Cierre bloqueado', 'warning');
        }
    }
}

function configurarModoLecturaCierre(esLectura) {
    cierreModoLectura = esLectura;
    cierreModoEdicion = false;

    const campos = ['cierreFecha', 'cierreResponsable', 'cierreTipoCierre', 'cierreDescripcion'];
    campos.forEach(id => {
        const campo = document.getElementById(id);
        if (!campo) {
            return;
        }
        const bloqueado = esLectura;
        campo.disabled = bloqueado;
        campo.style.backgroundColor = bloqueado ? '#f8fafc' : '';
        campo.style.cursor = bloqueado ? 'not-allowed' : '';
    });

    const titulo = document.getElementById('modalCerrarRegistroLabel');
    if (titulo) {
        titulo.innerHTML = esLectura
            ? '<i class="bi bi-lock-fill"></i> Detalle de cierre'
            : '<i class="bi bi-lock"></i> Cerrar registro';
    }

    const btnConfirmar = document.getElementById('btnConfirmarCierreRegistro');
    if (btnConfirmar) {
        if (!btnConfirmar.dataset.textoOriginal) {
            btnConfirmar.dataset.textoOriginal = btnConfirmar.innerHTML;
        }
        if (esLectura) {
            btnConfirmar.classList.add('d-none');
            btnConfirmar.disabled = true;
            btnConfirmar.innerHTML = '<i class="bi bi-lock-fill"></i> Registro cerrado';
            btnConfirmar.title = 'Este registro ya fue cerrado';
        } else {
            btnConfirmar.classList.remove('d-none');
            btnConfirmar.innerHTML = btnConfirmar.dataset.textoOriginal;
            btnConfirmar.title = '';
        }
    }

    const btnEditar = document.getElementById('btnEditarCierreRegistro');
    if (btnEditar) {
        btnEditar.classList.toggle('d-none', !esLectura);
        btnEditar.disabled = false;
    }

    const btnGuardar = document.getElementById('btnGuardarCierreRegistro');
    if (btnGuardar) {
        btnGuardar.classList.add('d-none');
        btnGuardar.disabled = false;
    }
}

function aplicarDetalleCierreEnModal(detalle) {
    if (!detalle) {
        return;
    }

    const fechaEl = document.getElementById('cierreFecha');
    if (fechaEl) {
        fechaEl.value = normalizarFechaParaInput(detalle.fecha_cierre || detalle.fecha_cierre_formato);
    }

    const responsableEl = document.getElementById('cierreResponsable');
    if (responsableEl) {
        responsableEl.value = detalle.responsable_cierre || '';
    }

    const tipoEl = document.getElementById('cierreTipoCierre');
    if (tipoEl) {
        tipoEl.value = detalle.tipo_cierre || '';
    }

    const descripcionEl = document.getElementById('cierreDescripcion');
    if (descripcionEl) {
        descripcionEl.value = detalle.descripcion_cierre || '';
    }
}

function actualizarDetalleCierreHeader(detalle) {
    const detalleEl = document.getElementById('detalleRegistroCerrar');
    if (!detalleEl) {
        return;
    }
    const fechaTexto = (detalle && (detalle.fecha_cierre_formato || detalle.fecha_cierre)) || '';
    const responsableTexto = (detalle && detalle.responsable_cierre) || 'Sin responsable';
    detalleEl.textContent = `Codigo: ${cierreRegistroCodigo} | Tipo: ${cierreRegistroTipo} | Responsable: ${responsableTexto} | Fecha: ${fechaTexto}`;
}

function activarEdicionCierre() {
    if (!cierreModoLectura) {
        return;
    }
    cierreModoEdicion = true;

    const campos = ['cierreFecha', 'cierreResponsable', 'cierreTipoCierre', 'cierreDescripcion'];
    campos.forEach(id => {
        const campo = document.getElementById(id);
        if (!campo) {
            return;
        }
        campo.disabled = false;
        campo.style.backgroundColor = '';
        campo.style.cursor = '';
    });

    const titulo = document.getElementById('modalCerrarRegistroLabel');
    if (titulo) {
        titulo.innerHTML = '<i class="bi bi-pencil-square"></i> Editar cierre';
    }

    const btnEditar = document.getElementById('btnEditarCierreRegistro');
    if (btnEditar) {
        btnEditar.classList.add('d-none');
    }

    const btnGuardar = document.getElementById('btnGuardarCierreRegistro');
    if (btnGuardar) {
        btnGuardar.classList.remove('d-none');
    }

    establecerMensajeCierre('Modo edicion habilitado. Puede actualizar los datos del cierre.', 'info');
}

async function cargarDetalleCierreRegistro(codigo, tipoGestion) {
    const response = await fetch(`/sgi/cierre/detalle?codigo=${encodeURIComponent(codigo)}&tipo=${encodeURIComponent(tipoGestion)}`);
    const data = await response.json();
    if (!response.ok || !data.success) {
        throw new Error(data.mensaje || 'No se pudo cargar el detalle del cierre');
    }
    return data.detalle || {};
}

async function validarCierreRegistro(codigo, tipoGestion) {
    const response = await fetch(`/sgi/cierre/validar?codigo=${encodeURIComponent(codigo)}&tipo=${encodeURIComponent(tipoGestion)}`);
    const data = await response.json();
    if (!response.ok || !data.success) {
        throw new Error(data.mensaje || 'No se pudo validar el cierre');
    }
    return data;
}

async function abrirModalCierre(codigo, tipoGestion, modoLectura = false) {
    cierreRegistroCodigo = String(codigo || '').trim();
    cierreRegistroTipo = String(tipoGestion || '').trim().toUpperCase();
    cierreDetalleActual = null;

    const detalle = document.getElementById('detalleRegistroCerrar');
    if (detalle) {
        detalle.textContent = `Codigo: ${cierreRegistroCodigo} | Tipo: ${cierreRegistroTipo}`;
    }

    const codigoEl = document.getElementById('cierreCodigo');
    if (codigoEl) {
        codigoEl.value = cierreRegistroCodigo;
    }
    const tipoEl = document.getElementById('cierreTipo');
    if (tipoEl) {
        tipoEl.value = cierreRegistroTipo;
    }

    limpiarResumenCierre();
    limpiarHistorialCierre();
    actualizarEstadoBotonCierre(false);
    configurarModoLecturaCierre(false);

    const modalEl = document.getElementById('modalCerrarRegistro');
    if (modalEl && typeof bootstrap !== 'undefined') {
        cierreModalRegistroInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
        cierreModalRegistroInstance.show();
    }

    if (modoLectura) {
        configurarModoLecturaCierre(true);
        establecerMensajeCierre('Cargando detalle de cierre...', 'info');

        try {
            const detalleCierre = await cargarDetalleCierreRegistro(cierreRegistroCodigo, cierreRegistroTipo);
            cierreDetalleActual = detalleCierre;
            aplicarDetalleCierreEnModal(detalleCierre);

            const resumenActividades = document.getElementById('cierreResumenActividades');
            if (resumenActividades) {
                resumenActividades.textContent = 'No disponible';
            }
            const resumenEvidencias = document.getElementById('cierreResumenEvidencias');
            if (resumenEvidencias) {
                resumenEvidencias.textContent = 'No disponible';
            }

            actualizarDetalleCierreHeader(detalleCierre);
            await cargarHistorialCierreRegistro(cierreRegistroCodigo, cierreRegistroTipo);

            establecerMensajeCierre('Registro cerrado. Detalle del cierre disponible.', 'info');
        } catch (error) {
            establecerMensajeCierre(`No se pudo cargar el detalle de cierre: ${error.message}`, 'warning');
        }
        return;
    }

    const fechaEl = document.getElementById('cierreFecha');
    if (fechaEl && !fechaEl.value) {
        fechaEl.value = obtenerFechaLocal();
    }

    establecerMensajeCierre('Validando condiciones de cierre...', 'info');

    try {
        const validacion = await validarCierreRegistro(cierreRegistroCodigo, cierreRegistroTipo);
        cierreValidacion = validacion;
        cierrePuedeCerrar = Boolean(validacion.puede_cerrar);
        actualizarResumenCierre(validacion);
        actualizarEstadoBotonCierre(cierrePuedeCerrar);
        if (detalle && validacion.detalle && validacion.detalle.estado_registro) {
            detalle.textContent = `Codigo: ${cierreRegistroCodigo} | Tipo: ${cierreRegistroTipo} | Estado: ${validacion.detalle.estado_registro}`;
        }
    } catch (error) {
        cierreValidacion = null;
        cierrePuedeCerrar = false;
        actualizarResumenCierre(null);
        establecerMensajeCierre(`No se pudo validar el cierre: ${error.message}`, 'danger');
        actualizarEstadoBotonCierre(false);
    }
}

async function actualizarCierreRegistro() {
    const codigo = cierreRegistroCodigo || document.getElementById('cierreCodigo')?.value;
    const tipo = cierreRegistroTipo || document.getElementById('cierreTipo')?.value;
    const fechaCierre = document.getElementById('cierreFecha')?.value;
    const responsable = document.getElementById('cierreResponsable')?.value?.trim();
    const tipoCierre = document.getElementById('cierreTipoCierre')?.value;
    const descripcion = document.getElementById('cierreDescripcion')?.value?.trim();

    if (!codigo || !tipo) {
        alert('No se encontro el registro de cierre.');
        return;
    }

    if (!fechaCierre || !responsable || !tipoCierre || !descripcion) {
        alert('Complete todos los campos requeridos para el cierre.');
        return;
    }

    const btn = document.getElementById('btnGuardarCierreRegistro');
    const textoOriginal = btn ? btn.innerHTML : '';

    try {
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = 'Guardando...';
        }

        const response = await fetch('/sgi/cierre', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                codigo: codigo,
                tipo: tipo,
                responsable_cierre: responsable,
                fecha_cierre: fechaCierre,
                tipo_cierre: tipoCierre,
                descripcion_cierre: descripcion
            })
        });

        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo actualizar el cierre');
        }

        const detalleCierre = resultado.detalle || {
            responsable_cierre: responsable,
            fecha_cierre: fechaCierre,
            tipo_cierre: tipoCierre,
            descripcion_cierre: descripcion
        };

        cierreDetalleActual = detalleCierre;
        aplicarDetalleCierreEnModal(detalleCierre);
        actualizarDetalleCierreHeader(detalleCierre);
        configurarModoLecturaCierre(true);
        establecerMensajeCierre(resultado.mensaje || 'Cierre actualizado.', 'success');
        await cargarHistorialCierreRegistro(codigo, tipo);

        if (typeof aplicarFiltrosYRecargarTabla === 'function') {
            await aplicarFiltrosYRecargarTabla();
        }
        if (typeof refrescarAuditoria === 'function') {
            await refrescarAuditoria();
        }
    } catch (error) {
        console.error('Error al actualizar cierre:', error);
        alert('Error al actualizar cierre: ' + error.message);
    } finally {
        if (btn) {
            btn.innerHTML = textoOriginal;
            btn.disabled = false;
        }
    }
}

async function confirmarCierreRegistro() {
    const codigo = cierreRegistroCodigo || document.getElementById('cierreCodigo')?.value;
    const tipo = cierreRegistroTipo || document.getElementById('cierreTipo')?.value;
    const fechaCierre = document.getElementById('cierreFecha')?.value;
    const responsable = document.getElementById('cierreResponsable')?.value?.trim();
    const tipoCierre = document.getElementById('cierreTipoCierre')?.value;
    const descripcion = document.getElementById('cierreDescripcion')?.value?.trim();

    if (!codigo || !tipo) {
        alert('No se encontro el registro a cerrar.');
        return;
    }

    if (!fechaCierre || !responsable || !tipoCierre || !descripcion) {
        alert('Complete todos los campos requeridos para el cierre.');
        return;
    }

    try {
        const validacion = await validarCierreRegistro(codigo, tipo);
        cierreValidacion = validacion;
        cierrePuedeCerrar = Boolean(validacion.puede_cerrar);
        actualizarResumenCierre(validacion);
        actualizarEstadoBotonCierre(cierrePuedeCerrar);
        if (!cierrePuedeCerrar) {
            alert(validacion.mensaje || 'Cierre bloqueado');
            return;
        }
    } catch (error) {
        alert('Error al validar cierre: ' + error.message);
        return;
    }

    const btn = document.getElementById('btnConfirmarCierreRegistro');
    const textoOriginal = btn ? btn.innerHTML : '';

    try {
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = 'Cerrando...';
        }

        const response = await fetch('/sgi/cierre', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                codigo: codigo,
                tipo: tipo,
                responsable_cierre: responsable,
                fecha_cierre: fechaCierre,
                tipo_cierre: tipoCierre,
                descripcion_cierre: descripcion
            })
        });

        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo cerrar el registro');
        }

        if (cierreModalRegistroInstance) {
            cierreModalRegistroInstance.hide();
        }
        limpiarModalCierreRegistro();

        if (typeof aplicarFiltrosYRecargarTabla === 'function') {
            await aplicarFiltrosYRecargarTabla();
        }
        if (typeof refrescarAuditoria === 'function') {
            await refrescarAuditoria();
        }

        alert(resultado.mensaje || 'Registro cerrado.');
    } catch (error) {
        console.error('Error al cerrar registro:', error);
        alert('Error al cerrar registro: ' + error.message);
    } finally {
        if (btn) {
            btn.innerHTML = textoOriginal;
            btn.disabled = !cierrePuedeCerrar;
        }
    }
}

function configurarModalCierreRegistro() {
    const modalEl = document.getElementById('modalCerrarRegistro');
    if (modalEl && !modalEl.dataset.listener) {
        modalEl.addEventListener('hidden.bs.modal', () => {
            limpiarModalCierreRegistro();
        });
        modalEl.dataset.listener = 'true';
    }

    const btnEditar = document.getElementById('btnEditarCierreRegistro');
    if (btnEditar && !btnEditar.dataset.listener) {
        btnEditar.addEventListener('click', () => {
            activarEdicionCierre();
        });
        btnEditar.dataset.listener = 'true';
    }

    const btnGuardar = document.getElementById('btnGuardarCierreRegistro');
    if (btnGuardar && !btnGuardar.dataset.listener) {
        btnGuardar.addEventListener('click', () => {
            actualizarCierreRegistro();
        });
        btnGuardar.dataset.listener = 'true';
    }

    const btn = document.getElementById('btnConfirmarCierreRegistro');
    if (btn && !btn.dataset.listener) {
        btn.addEventListener('click', () => {
            confirmarCierreRegistro();
        });
        btn.dataset.listener = 'true';
    }
}

function editarRegistro(codigo, tipoGestion) {
    adminRegistroCodigo = String(codigo || '').trim();
    adminRegistroTipo = String(tipoGestion || '').trim().toUpperCase();

    const detalle = document.getElementById('detalleRegistroAdmin');
    if (detalle) {
        detalle.textContent = `Codigo: ${adminRegistroCodigo} | Tipo: ${adminRegistroTipo}`;
    }

    mostrarCamposAdmin(adminRegistroTipo);
    configurarFormularioActividadAdmin();

    const modalEl = document.getElementById('modalAdminRegistroSgi');
    if (modalEl && typeof bootstrap !== 'undefined') {
        adminModalRegistroInstance = bootstrap.Modal.getOrCreateInstance(modalEl);
        adminModalRegistroInstance.show();
    }

    const tabRegistro = document.getElementById('admin-tab-registro');
    if (tabRegistro && typeof bootstrap !== 'undefined' && bootstrap.Tab) {
        bootstrap.Tab.getOrCreateInstance(tabRegistro).show();
    }

    cargarRegistroAdmin();
    cargarHistorialRegistroAdmin();
    cargarActividadesAdmin();
    cargarEvidenciasAdmin();
}

function limpiarModalAdminRegistro() {
    adminRegistroCodigo = '';
    adminRegistroTipo = '';

    const detalle = document.getElementById('detalleRegistroAdmin');
    if (detalle) {
        detalle.textContent = '';
    }

    // ‚úÖ REHABILITAR CAMPOS Y RESTAURAR ESTILO
    document.querySelectorAll('#formAdminRegistro input, #formAdminRegistro textarea, #formAdminRegistro select').forEach(input => {
        input.value = '';
        input.disabled = false;
        input.style.backgroundColor = '';
        input.style.cursor = '';
    });

    const estado = document.getElementById('adminRegistroEstado');
    if (estado) {
        estado.value = 'Pendiente';
    }

    const listaActividades = document.getElementById('adminActividadesLista');
    if (listaActividades) {
        listaActividades.innerHTML = '';
    }

    const listaEvidencias = document.getElementById('adminEvidenciasLista');
    if (listaEvidencias) {
        listaEvidencias.innerHTML = '';
    }
    const listaAdjuntos = document.getElementById('adminAdjuntosCausasLista');
    if (listaAdjuntos) {
        listaAdjuntos.innerHTML = '';
    }

    limpiarHistorialRegistroAdmin();

    // ‚úÖ MOSTRAR BOTONES NUEVAMENTE
    const btnGuardar = document.getElementById('btnGuardarRegistroAdmin');
    const btnEliminar = document.getElementById('btnEliminarRegistroAdmin');
    if (btnGuardar) btnGuardar.style.display = '';
    if (btnEliminar) btnEliminar.style.display = '';

    ocultarFormularioActividadAdmin();
}

function limpiarHistorialRegistroAdmin() {
    const contenedor = document.getElementById('adminRegistroHistorialTabla');
    if (contenedor) {
        contenedor.innerHTML = '<div class="text-muted small">No hay cambios registrados.</div>';
    }
}

function normalizarDatosHistorialAdmin(datos) {
    if (!datos) {
        return {};
    }
    if (typeof datos === 'string') {
        try {
            return JSON.parse(datos);
        } catch (error) {
            return {};
        }
    }
    if (typeof datos === 'object') {
        return datos;
    }
    return {};
}

function formatearFechaHistorialRegistro(valor) {
    const normalizada = normalizarFechaParaInput(valor);
    if (!normalizada) {
        return '-';
    }
    const partes = normalizada.split('-');
    if (partes.length === 3) {
        return `${partes[2]}/${partes[1]}/${partes[0]}`;
    }
    return normalizada;
}

function obtenerCamposHistorialRegistroAdmin(tipo) {
    const comunes = [
        { key: 'proceso', label: 'Proceso' },
        { key: 'subproceso', label: 'Subproceso' },
        { key: 'cop', label: 'COP' },
        { key: 'estado', label: 'Estado' },
        { key: 'fecha_apertura', label: 'Fecha apertura', tipo: 'fecha' },
        { key: 'fecha_cierre', label: 'Fecha cierre', tipo: 'fecha' },
        { key: 'responsable', label: 'Responsable' }
    ];

    if (tipo === 'PA') {
        return comunes.concat([
            { key: 'tipo_accion', label: 'Tipo accion' },
            { key: 'fuente', label: 'Fuente' },
            { key: 'hallazgo', label: 'Hallazgo' },
            { key: 'causa_raiz', label: 'Causa raiz' }
        ]);
    }
    if (tipo === 'GC') {
        return comunes.concat([
            { key: 'nombre_cambio', label: 'Nombre cambio' },
            { key: 'descripcion_cambio', label: 'Descripcion cambio' },
            { key: 'categoria', label: 'Categoria' }
        ]);
    }
    if (tipo === 'RVD') {
        return comunes.concat([
            { key: 'ano_rvd', label: 'Ano RVD', tipo: 'numero' },
            { key: 'actividad', label: 'Actividad' },
            { key: 'categoria', label: 'Categoria' }
        ]);
    }
    return comunes;
}

function formatearValorHistorialRegistroAdmin(campo, valor) {
    if (campo && campo.tipo === 'fecha') {
        return formatearFechaHistorialRegistro(valor);
    }
    return normalizarTextoHistorial(valor);
}

function crearCeldaCambioHistorialAdmin(antes, despues, marcarOriginal = false) {
    const antesTexto = normalizarTextoHistorial(antes);
    const despuesTexto = normalizarTextoHistorial(despues);
    if (antesTexto === '-' && despuesTexto === '-') {
        const celda = document.createElement('td');
        celda.className = 'text-muted small';
        celda.textContent = '-';
        return celda;
    }
    return crearCeldaCambioHistorial(antesTexto, despuesTexto, marcarOriginal);
}

function renderHistorialRegistroAdmin(historial, tipo) {
    const contenedor = document.getElementById('adminRegistroHistorialTabla');
    if (!contenedor) {
        return;
    }

    if (!Array.isArray(historial) || historial.length === 0) {
        contenedor.innerHTML = '<div class="text-muted small">No hay cambios registrados.</div>';
        return;
    }

    const campos = obtenerCamposHistorialRegistroAdmin(tipo);
    if (!campos.length) {
        contenedor.innerHTML = '<div class="text-muted small">No hay campos disponibles.</div>';
        return;
    }

    const estadoActual = {};
    const historialAsc = historial.slice().reverse();
    historialAsc.forEach(item => {
        const datosAntes = normalizarDatosHistorialAdmin(item.datos_antes);
        const datosDespues = normalizarDatosHistorialAdmin(item.datos_despues);
        const cambios = {};
        campos.forEach(campo => {
            const key = campo.key;
            const tieneAntes = Object.prototype.hasOwnProperty.call(datosAntes, key);
            const tieneDespues = Object.prototype.hasOwnProperty.call(datosDespues, key);
            const antes = tieneAntes ? datosAntes[key] : estadoActual[key];
            const despues = tieneDespues ? datosDespues[key] : antes;
            cambios[key] = { antes, despues };
            estadoActual[key] = despues;
        });
        item._cambios = cambios;
    });

    const table = document.createElement('table');
    table.className = 'table table-sm table-bordered mb-0';

    const thead = document.createElement('thead');
    thead.className = 'table-light';
    const headerRow = document.createElement('tr');
    const columnas = [
        { label: 'Version', width: '120px' },
        { label: 'Fecha cambio', width: '140px' },
        { label: 'Usuario', width: '120px' }
    ].concat(campos.map(campo => ({ label: campo.label })));

    columnas.forEach(col => {
        const th = document.createElement('th');
        if (col.width) {
            th.style.width = col.width;
        }
        th.textContent = col.label;
        headerRow.appendChild(th);
    });
    thead.appendChild(headerRow);
    table.appendChild(thead);

    const tbody = document.createElement('tbody');
    const total = historial.length;
    historial.forEach(item => {
        const row = document.createElement('tr');
        const versionNumero = total - tbody.children.length;
        const versionAnterior = versionNumero - 1;
        const marcarOriginal = versionAnterior <= 0;

        row.appendChild(crearCeldaVersionHistorial(versionAnterior, versionNumero));

        const fechaCambio = document.createElement('td');
        fechaCambio.textContent = item.fecha_formato || item.fecha_hora || '-';
        row.appendChild(fechaCambio);

        const usuario = document.createElement('td');
        usuario.textContent = item.usuario || '-';
        row.appendChild(usuario);

        campos.forEach(campo => {
            const cambio = (item._cambios && item._cambios[campo.key]) || {};
            const antes = formatearValorHistorialRegistroAdmin(campo, cambio.antes);
            const despues = formatearValorHistorialRegistroAdmin(campo, cambio.despues);
            row.appendChild(crearCeldaCambioHistorialAdmin(antes, despues, marcarOriginal));
        });

        tbody.appendChild(row);
    });

    table.appendChild(tbody);
    contenedor.innerHTML = '';
    contenedor.appendChild(table);
}

async function cargarHistorialRegistroAdmin() {
    if (!adminRegistroCodigo || !adminRegistroTipo) {
        limpiarHistorialRegistroAdmin();
        return;
    }

    const contenedor = document.getElementById('adminRegistroHistorialTabla');
    if (contenedor) {
        contenedor.innerHTML = '<div class="text-muted small">Cargando historial...</div>';
    }

    try {
        const response = await fetch(`/sgi/registro/historial?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(adminRegistroTipo)}`);
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo cargar el historial.');
        }
        renderHistorialRegistroAdmin(resultado.historial || [], adminRegistroTipo);
    } catch (error) {
        if (contenedor) {
            contenedor.innerHTML = `<div class="text-danger small">No se pudo cargar el historial: ${error.message}</div>`;
        }
    }
}

function mostrarCamposAdmin(tipoGestion) {
    const tipo = String(tipoGestion || '').toUpperCase();
    document.querySelectorAll('#formAdminRegistro .admin-campo').forEach(campo => {
        const tipos = (campo.dataset.tipo || '')
            .split(',')
            .map(item => item.trim().toUpperCase())
            .filter(Boolean);
        campo.classList.toggle('d-none', !tipos.includes(tipo));
    });
}

const opcionesEtapaPA = [
    { value: 'P', label: 'P - Planear' },
    { value: 'H', label: 'H - Hacer' },
    { value: 'V', label: 'V - Verificar' },
    { value: 'A', label: 'A - Actuar' }
];

const opcionesEtapaGC = [
    { value: 'Antes', label: 'Antes' },
    { value: 'Durante', label: 'Durante' },
    { value: 'Despues', label: 'Despues' }
];

const opcionesEstadoActividad = [
    { value: 'Pendiente', label: 'Pendiente' },
    { value: 'En proceso', label: 'En proceso' },
    { value: 'Abierta', label: 'Abierta' },
    { value: 'Cerrado', label: 'Cerrado' }
];

const opcionesTipoActividadPA = [
    { value: 'PLAN', label: 'Plan' },
    { value: 'CORRECTIVA', label: 'Correctiva' }
];

function obtenerOpcionesEtapaAdmin() {
    if (adminRegistroTipo === 'PA') {
        return opcionesEtapaPA;
    }
    if (adminRegistroTipo === 'GC') {
        return opcionesEtapaGC;
    }
    return [];
}

function llenarSelectOpciones(selectEl, opciones, valorActual, placeholder) {
    if (!selectEl || selectEl.tagName !== 'SELECT') {
        return;
    }
    selectEl.innerHTML = '';
    if (placeholder) {
        const option = document.createElement('option');
        option.value = '';
        option.textContent = placeholder;
        selectEl.appendChild(option);
    }
    opciones.forEach(opcion => {
        const option = document.createElement('option');
        option.value = opcion.value;
        option.textContent = opcion.label;
        selectEl.appendChild(option);
    });
    const actual = valorActual ?? '';
    if (actual && !opciones.some(op => op.value === actual)) {
        const option = document.createElement('option');
        option.value = actual;
        option.textContent = actual;
        selectEl.appendChild(option);
    }
    selectEl.value = actual;
}

function configurarFormularioActividadAdmin() {
    const etapaEl = document.getElementById('adminActividadEtapaNueva');
    const estadoEl = document.getElementById('adminActividadEstadoNueva');
    const tipoWrapper = document.getElementById('adminActividadTipoNuevaWrapper');
    const tipoEl = document.getElementById('adminActividadTipoNueva');
    const descripcionWrapper = document.getElementById('adminActividadDescripcionNuevaWrapper');
    const esPA = adminRegistroTipo === 'PA';

    if (adminRegistroTipo === 'RVD') {
        llenarSelectOpciones(etapaEl, [{ value: 'RVD', label: 'RVD' }], 'RVD', null);
        if (etapaEl) {
            etapaEl.disabled = true;
        }
    } else {
        llenarSelectOpciones(etapaEl, obtenerOpcionesEtapaAdmin(), etapaEl ? etapaEl.value : '', 'Seleccione');
        if (etapaEl) {
            etapaEl.disabled = false;
        }
    }

    llenarSelectOpciones(estadoEl, opcionesEstadoActividad, estadoEl ? estadoEl.value : '', 'Seleccione');
    if (estadoEl) {
        estadoEl.disabled = false;
    }

    if (tipoWrapper) {
        tipoWrapper.classList.toggle('d-none', !esPA);
    }
    if (descripcionWrapper) {
        descripcionWrapper.classList.toggle('col-md-9', !esPA);
        descripcionWrapper.classList.toggle('col-md-6', esPA);
    }
    if (esPA) {
        const valorTipo = tipoEl ? (tipoEl.value || 'PLAN') : 'PLAN';
        llenarSelectOpciones(tipoEl, opcionesTipoActividadPA, valorTipo, 'Seleccione');
    } else if (tipoEl) {
        tipoEl.value = '';
    }
}

function normalizarFechaParaInput(valor) {
    if (!valor) return '';
    const texto = String(valor).trim();
    if (!texto) return '';
    if (texto.includes('T')) {
        return texto.split('T')[0];
    }
    if (texto.includes(' ')) {
        return texto.split(' ')[0];
    }
    if (texto.includes('/')) {
        const partes = texto.split('/');
        if (partes.length === 3) {
            const dia = partes[0].padStart(2, '0');
            const mes = partes[1].padStart(2, '0');
            const anio = partes[2];
            return `${anio}-${mes}-${dia}`;
        }
    }
    return texto;
}

async function cargarRegistroAdmin() {
    if (!adminRegistroCodigo || !adminRegistroTipo) {
        return;
    }

    try {
        const response = await fetch(`/sgi/registro?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(adminRegistroTipo)}`);
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo cargar el registro.');
        }
        rellenarFormularioAdmin(resultado.registro || {});
    } catch (error) {
        alert(`Error al cargar registro: ${error.message}`);
    }
}

function rellenarFormularioAdmin(registro) {
    const setVal = (id, valor) => {
        const el = document.getElementById(id);
        if (el) {
            el.value = valor ?? '';
            // üîí DESHABILITAR CAMPO PARA SOLO LECTURA
            el.disabled = false;
            el.style.backgroundColor = '';
            el.style.cursor = '';
        }
    };

    setVal('adminRegistroProceso', registro.proceso || '');
    setVal('adminRegistroSubproceso', registro.subproceso || '');
    setVal('adminRegistroCop', registro.cop || '');
    setVal('adminRegistroEstado', registro.estado || 'Pendiente');
    setVal('adminRegistroFechaApertura', normalizarFechaParaInput(registro.fecha_apertura));
    setVal('adminRegistroFechaCierre', normalizarFechaParaInput(registro.fecha_cierre));

    setVal('adminRegistroTipoAccion', registro.tipo_accion || '');
    setVal('adminRegistroFuente', registro.fuente || '');
    setVal('adminRegistroHallazgo', registro.hallazgo || '');
    setVal('adminRegistroCausaRaiz', registro.causa_raiz || '');

    setVal('adminRegistroNombreCambio', registro.nombre_cambio || '');
    setVal('adminRegistroDescripcionCambio', registro.descripcion_cambio || '');
    setVal('adminRegistroCategoriaGc', registro.categoria || '');

    setVal('adminRegistroAnoRvd', registro.ano_rvd || '');
    setVal('adminRegistroActividad', registro.actividad || '');
    setVal('adminRegistroResponsable', registro.responsable || '');
    setVal('adminRegistroCategoriaRvd', registro.categoria || '');

    sincronizarSelectsAdminRegistro(registro);

    // üîí OCULTAR BOTONES DE GUARDAR Y ELIMINAR EN TAB REGISTRO
    const esCerrado = String(registro.estado || '').trim().toLowerCase() === 'cerrado';
    ocultarBotonesEdicionRegistro(esCerrado);
}

function asegurarOpcionSelect(select, value, label) {
    if (!select || !value) {
        return;
    }
    const existe = Array.from(select.options).some(option => option.value === value);
    if (!existe) {
        const option = document.createElement('option');
        option.value = value;
        option.textContent = label || value;
        select.appendChild(option);
    }
}

function obtenerProcesoIdPorCodigo(codigo) {
    if (!codigo || !Array.isArray(datosProcesos)) {
        return null;
    }
    const encontrado = datosProcesos.find(proceso => String(proceso.codigo) === String(codigo));
    return encontrado ? encontrado.id : null;
}

function sincronizarSelectsAdminRegistro(registro) {
    const procesoSelect = document.getElementById('adminRegistroProceso');
    const subprocesoSelect = document.getElementById('adminRegistroSubproceso');
    const copSelect = document.getElementById('adminRegistroCop');

    if (procesoSelect) {
        asegurarOpcionSelect(procesoSelect, registro.proceso, registro.proceso);
        procesoSelect.value = registro.proceso || '';
        const procesoId = obtenerProcesoIdPorCodigo(registro.proceso);
        if (procesoId) {
            if (typeof window.llenarSelectSubprocesos === 'function') {
                window.llenarSelectSubprocesos(procesoId, 'adminRegistroSubproceso');
            } else if (typeof llenarSelectSubprocesos === 'function') {
                llenarSelectSubprocesos(procesoId, 'adminRegistroSubproceso');
            }
        }
    }

    if (subprocesoSelect) {
        asegurarOpcionSelect(subprocesoSelect, registro.subproceso, registro.subproceso);
        subprocesoSelect.value = registro.subproceso || '';
    }

    if (copSelect) {
        asegurarOpcionSelect(copSelect, registro.cop, registro.cop);
        copSelect.value = registro.cop || '';
    }
}

// üîí FUNCI√ìN PARA OCULTAR BOTONES DE EDICI√ìN/ELIMINACI√ìN (SOLO LECTURA)
function ocultarBotonesEdicionRegistro(esSoloLectura) {
    document.querySelectorAll('#formAdminRegistro input, #formAdminRegistro textarea, #formAdminRegistro select').forEach(input => {
        input.disabled = esSoloLectura;
        input.style.backgroundColor = esSoloLectura ? '#f8f9fa' : '';
        input.style.cursor = esSoloLectura ? 'not-allowed' : '';
    });

    const btnGuardar = document.getElementById('btnGuardarRegistroAdmin');
    const btnEliminar = document.getElementById('btnEliminarRegistroAdmin');

    if (btnGuardar) {
        btnGuardar.disabled = esSoloLectura;
        btnGuardar.title = esSoloLectura ? 'Registro cerrado. No se permiten cambios.' : '';
    }

    if (btnEliminar) {
        btnEliminar.disabled = esSoloLectura;
        btnEliminar.title = esSoloLectura ? 'Registro cerrado. No se permite eliminar.' : '';
    }

}

function obtenerValorCampoAdmin(id) {
    const el = document.getElementById(id);
    if (!el) {
        return '';
    }
    return String(el.value || '').trim();
}

function construirDatosRegistroAdmin() {
    const datos = {
        proceso: obtenerValorCampoAdmin('adminRegistroProceso'),
        subproceso: obtenerValorCampoAdmin('adminRegistroSubproceso'),
        cop: obtenerValorCampoAdmin('adminRegistroCop'),
        estado: obtenerValorCampoAdmin('adminRegistroEstado'),
        fecha_apertura: obtenerValorCampoAdmin('adminRegistroFechaApertura'),
        fecha_cierre: obtenerValorCampoAdmin('adminRegistroFechaCierre')
    };

    if (adminRegistroTipo === 'PA') {
        datos.tipo_accion = obtenerValorCampoAdmin('adminRegistroTipoAccion');
        datos.fuente = obtenerValorCampoAdmin('adminRegistroFuente');
        datos.hallazgo = obtenerValorCampoAdmin('adminRegistroHallazgo');
        datos.causa_raiz = obtenerValorCampoAdmin('adminRegistroCausaRaiz');
        datos.responsable = obtenerValorCampoAdmin('adminRegistroResponsable');
    } else if (adminRegistroTipo === 'GC') {
        datos.nombre_cambio = obtenerValorCampoAdmin('adminRegistroNombreCambio');
        datos.descripcion_cambio = obtenerValorCampoAdmin('adminRegistroDescripcionCambio');
        datos.categoria = obtenerValorCampoAdmin('adminRegistroCategoriaGc');
        datos.responsable = obtenerValorCampoAdmin('adminRegistroResponsable');
    } else if (adminRegistroTipo === 'RVD') {
        const anoTexto = obtenerValorCampoAdmin('adminRegistroAnoRvd');
        const ano = parseInt(anoTexto, 10);
        if (Number.isFinite(ano)) {
            datos.ano_rvd = ano;
        } else if (anoTexto === '') {
            datos.ano_rvd = null;
        }
        datos.actividad = obtenerValorCampoAdmin('adminRegistroActividad');
        datos.responsable = obtenerValorCampoAdmin('adminRegistroResponsable');
        datos.categoria = obtenerValorCampoAdmin('adminRegistroCategoriaRvd');
    }

    return datos;
}

async function guardarRegistroAdmin() {
    if (!adminRegistroCodigo || !adminRegistroTipo) {
        return;
    }

    try {
        const payload = {
            codigo: adminRegistroCodigo,
            tipo: adminRegistroTipo,
            datos: construirDatosRegistroAdmin()
        };

        const response = await fetch('/sgi/registro', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo guardar el registro.');
        }
        alert('Registro actualizado.');
        if (typeof aplicarFiltrosYRecargarTabla === 'function') {
            await aplicarFiltrosYRecargarTabla();
        }
        // Refrescar auditor√≠a si est√° activa
        if (typeof refrescarAuditoria === 'function') {
            await refrescarAuditoria();
        }
        await cargarHistorialRegistroAdmin();
    } catch (error) {
        alert(`Error al guardar registro: ${error.message}`);
    }
}

async function eliminarRegistroAdmin() {
    if (!adminRegistroCodigo || !adminRegistroTipo) {
        return;
    }

    if (!confirm('Desea eliminar este registro? Se eliminaran sus actividades y evidencias.')) {
        return;
    }

    const textoConfirmacion = prompt(`Escriba ELIMINAR para confirmar la eliminacion definitiva de ${adminRegistroCodigo}.`);
    if (textoConfirmacion === null) {
        return;
    }
    if (textoConfirmacion.trim().toUpperCase() !== 'ELIMINAR') {
        alert('Confirmacion cancelada.');
        return;
    }

    try {
        const response = await fetch(`/sgi/registro?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(adminRegistroTipo)}`, {
            method: 'DELETE'
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo eliminar el registro.');
        }
        if (resultado.mensaje) {
            alert(resultado.mensaje);
        } else {
            alert('Registro eliminado.');
        }
        if (resultado.advertencias && resultado.advertencias.length) {
            console.warn('Advertencias al eliminar registro:', resultado.advertencias);
        }
        if (adminModalRegistroInstance) {
            adminModalRegistroInstance.hide();
        }
        if (typeof aplicarFiltrosYRecargarTabla === 'function') {
            await aplicarFiltrosYRecargarTabla();
        }
        // Refrescar auditor√≠a si est√° activa
        if (typeof refrescarAuditoria === 'function') {
            await refrescarAuditoria();
        }
    } catch (error) {
        alert(`Error al eliminar registro: ${error.message}`);
    }
}

function mostrarFormularioActividadAdmin() {
    const formulario = document.getElementById('adminFormularioActividad');
    if (formulario) {
        formulario.classList.remove('d-none');
    }
    configurarFormularioActividadAdmin();
}

function ocultarFormularioActividadAdmin() {
    const formulario = document.getElementById('adminFormularioActividad');
    if (formulario) {
        formulario.classList.add('d-none');
    }
    limpiarFormularioActividadAdmin();
}

function limpiarFormularioActividadAdmin() {
    const ids = [
        'adminActividadEtapaNueva',
        'adminActividadTipoNueva',
        'adminActividadNombreNueva',
        'adminActividadFechaNueva',
        'adminActividadResponsableNueva',
        'adminActividadEstadoNueva',
        'adminActividadDescripcionNueva'
    ];
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.value = '';
        }
    });
}

async function crearActividadAdmin() {
    if (!adminRegistroCodigo || !adminRegistroTipo) {
        return;
    }

    const datos = {
        codigo_referencia: adminRegistroCodigo,
        tipo_origen: adminRegistroTipo,
        etapa_actividad: obtenerValorCampoAdmin('adminActividadEtapaNueva'),
        nombre_actividad: obtenerValorCampoAdmin('adminActividadNombreNueva'),
        descripcion: obtenerValorCampoAdmin('adminActividadDescripcionNueva'),
        fecha_cierre: obtenerValorCampoAdmin('adminActividadFechaNueva'),
        responsable: obtenerValorCampoAdmin('adminActividadResponsableNueva'),
        estado: obtenerValorCampoAdmin('adminActividadEstadoNueva')
    };

    if (adminRegistroTipo === 'PA') {
        const tipoActividad = obtenerValorCampoAdmin('adminActividadTipoNueva') || 'PLAN';
        datos.tipo_actividad = tipoActividad;
    }

    if (adminRegistroTipo === 'RVD' && !datos.etapa_actividad) {
        datos.etapa_actividad = 'RVD';
    }

    try {
        const response = await fetch('/sgi/actividades', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo crear la actividad.');
        }
        ocultarFormularioActividadAdmin();
        await cargarActividadesAdmin();
    } catch (error) {
        alert(`Error al crear actividad: ${error.message}`);
    }
}

async function cargarActividadesAdmin() {
    const contenedor = document.getElementById('adminActividadesLista');
    if (!contenedor) {
        return;
    }
    contenedor.innerHTML = '<div class="text-muted small">Cargando actividades...</div>';

    if (!adminRegistroCodigo || !adminRegistroTipo) {
        contenedor.innerHTML = '';
        return;
    }

    try {
        const response = await fetch(`/sgi/actividades?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(adminRegistroTipo)}`);
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudieron cargar actividades.');
        }
        renderActividadesAdmin(resultado.actividades || []);
    } catch (error) {
        contenedor.innerHTML = `<div class="text-danger small">${error.message}</div>`;
    }
}

function renderActividadesAdmin(actividades) {
    const contenedor = document.getElementById('adminActividadesLista');
    if (!contenedor) {
        return;
    }

    if (!actividades.length) {
        contenedor.innerHTML = '<div class="text-muted small">No hay actividades registradas.</div>';
        return;
    }

    const tabla = document.createElement('table');
    tabla.className = 'table table-sm table-bordered align-middle tabla-actividades-admin';
    const esPA = adminRegistroTipo === 'PA';
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Etapa</th>
            ${esPA ? '<th>Tipo</th>' : ''}
            <th>Nombre</th>
            <th>Descripcion</th>
            <th>Fecha cierre</th>
            <th>Responsable</th>
            <th>Estado</th>
            <th class="accion-col">Accion</th>
        </tr>
    `;
    tabla.appendChild(thead);

    const tbody = document.createElement('tbody');
    actividades.forEach(actividad => {
        const row = document.createElement('tr');
        const etapaCell = document.createElement('td');
        const etapaId = `adminActEtapa-${actividad.id}`;
        if (adminRegistroTipo === 'RVD') {
            const etapaSelect = document.createElement('select');
            etapaSelect.className = 'form-select form-select-sm';
            etapaSelect.id = etapaId;
            const valorEtapa = actividad.etapa_actividad || 'RVD';
            const option = document.createElement('option');
            option.value = valorEtapa;
            option.textContent = valorEtapa;
            etapaSelect.appendChild(option);
            etapaSelect.value = valorEtapa;
            etapaSelect.disabled = true;
            etapaCell.appendChild(etapaSelect);
        } else {
            const opcionesEtapa = obtenerOpcionesEtapaAdmin();
            const etapaSelect = document.createElement('select');
            etapaSelect.className = 'form-select form-select-sm';
            etapaSelect.id = etapaId;
            llenarSelectOpciones(etapaSelect, opcionesEtapa, actividad.etapa_actividad || '', 'Seleccione');
            etapaCell.appendChild(etapaSelect);
        }
        row.appendChild(etapaCell);

        if (esPA) {
            const tipoCell = document.createElement('td');
            const tipoSelect = document.createElement('select');
            tipoSelect.className = 'form-select form-select-sm';
            tipoSelect.id = `adminActTipo-${actividad.id}`;
            const valorTipo = actividad.tipo_actividad || 'PLAN';
            llenarSelectOpciones(tipoSelect, opcionesTipoActividadPA, valorTipo, 'Seleccione');
            tipoCell.appendChild(tipoSelect);
            row.appendChild(tipoCell);
        }

        const nombreCell = document.createElement('td');
        const nombreInput = document.createElement('input');
        nombreInput.type = 'text';
        nombreInput.className = 'form-control form-control-sm';
        nombreInput.id = `adminActNombre-${actividad.id}`;
        nombreInput.value = actividad.nombre_actividad || '';
        nombreCell.appendChild(nombreInput);
        row.appendChild(nombreCell);

        const descripcionCell = document.createElement('td');
        const descripcionInput = document.createElement('input');
        descripcionInput.type = 'text';
        descripcionInput.className = 'form-control form-control-sm';
        descripcionInput.id = `adminActDescripcion-${actividad.id}`;
        descripcionInput.value = actividad.descripcion || '';
        descripcionCell.appendChild(descripcionInput);
        row.appendChild(descripcionCell);

        const fechaCell = document.createElement('td');
        const fechaInput = document.createElement('input');
        fechaInput.type = 'date';
        fechaInput.className = 'form-control form-control-sm';
        fechaInput.id = `adminActFecha-${actividad.id}`;
        fechaInput.value = normalizarFechaParaInput(actividad.fecha_cierre);
        fechaCell.appendChild(fechaInput);
        row.appendChild(fechaCell);

        const responsableCell = document.createElement('td');
        const responsableInput = document.createElement('input');
        responsableInput.type = 'text';
        responsableInput.className = 'form-control form-control-sm';
        responsableInput.id = `adminActResponsable-${actividad.id}`;
        responsableInput.value = actividad.responsable || '';
        responsableCell.appendChild(responsableInput);
        row.appendChild(responsableCell);

        const estadoCell = document.createElement('td');
        const estadoSelect = document.createElement('select');
        estadoSelect.className = 'form-select form-select-sm';
        estadoSelect.id = `adminActEstado-${actividad.id}`;
        llenarSelectOpciones(estadoSelect, opcionesEstadoActividad, actividad.estado || '', 'Seleccione');
        estadoCell.appendChild(estadoSelect);
        row.appendChild(estadoCell);

        const acciones = document.createElement('td');
        acciones.className = 'accion-col d-grid gap-1';
        const btnGuardar = document.createElement('button');
        btnGuardar.type = 'button';
        btnGuardar.className = 'btn btn-sm btn-outline-primary';
        btnGuardar.textContent = 'Guardar';
        btnGuardar.addEventListener('click', () => guardarActividadAdmin(actividad.id));
        acciones.appendChild(btnGuardar);

        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn btn-sm btn-outline-danger';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => eliminarActividadAdmin(actividad.id));
        acciones.appendChild(btnEliminar);

        row.appendChild(acciones);
        tbody.appendChild(row);
    });

    tabla.appendChild(tbody);
    contenedor.innerHTML = '';
    contenedor.appendChild(tabla);
}

async function cargarAdjuntosAnalisisAdmin() {
    const contenedor = document.getElementById('adminAdjuntosCausasLista');
    if (!contenedor) {
        return;
    }

    if (!adminRegistroCodigo || !adminRegistroTipo) {
        contenedor.innerHTML = '';
        return;
    }

    const tipo = String(adminRegistroTipo || '').trim().toUpperCase();
    if (tipo !== 'PA') {
        contenedor.innerHTML = '<div class="text-muted small">No aplica para este tipo.</div>';
        return;
    }

    contenedor.innerHTML = '<div class="text-muted small">Cargando adjuntos...</div>';

    try {
        const response = await fetch(`/sgi/analisis-causas?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(tipo)}`);
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudieron cargar adjuntos.');
        }
        renderAdjuntosAnalisisAdmin(resultado.adjuntos || []);
    } catch (error) {
        contenedor.innerHTML = `<div class="text-danger small">${error.message}</div>`;
    }
}

function renderAdjuntosAnalisisAdmin(adjuntos) {
    const contenedor = document.getElementById('adminAdjuntosCausasLista');
    if (!contenedor) {
        return;
    }

    if (!adjuntos.length) {
        contenedor.innerHTML = '<div class="text-muted small">No hay adjuntos registrados.</div>';
        return;
    }

    const tabla = document.createElement('table');
    tabla.className = 'table table-sm table-bordered align-middle';
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Archivo</th>
            <th>Fecha</th>
            <th>Tamano</th>
            <th>Reemplazos</th>
            <th>Accion</th>
        </tr>
    `;
    tabla.appendChild(thead);

    const tbody = document.createElement('tbody');
    adjuntos.forEach(adjunto => {
        const row = document.createElement('tr');

        const celdaArchivo = document.createElement('td');
        const url = adjunto.url_descarga || adjunto.url_publica;
        if (url) {
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = adjunto.nombre_archivo || adjunto.blob_path || 'Adjunto';
            celdaArchivo.appendChild(link);
        } else {
            celdaArchivo.textContent = adjunto.nombre_archivo || adjunto.blob_path || 'Adjunto';
        }
        row.appendChild(celdaArchivo);

        const celdaFecha = document.createElement('td');
        celdaFecha.textContent = adjunto.fecha_subida_formato || '';
        row.appendChild(celdaFecha);

        const celdaTamano = document.createElement('td');
        celdaTamano.textContent = formatearTamanoArchivo(adjunto.tamano_bytes);
        row.appendChild(celdaTamano);

        const celdaReemplazos = document.createElement('td');
        celdaReemplazos.textContent = `${adjunto.reemplazos || 0}`;
        row.appendChild(celdaReemplazos);

        const celdaAccion = document.createElement('td');
        const btnVer = document.createElement('button');
        btnVer.type = 'button';
        btnVer.className = 'btn btn-sm btn-outline-primary me-2';
        btnVer.textContent = 'Ver';
        btnVer.addEventListener('click', () => {
            if (url) {
                window.open(url, '_blank', 'noopener');
            }
        });
        celdaAccion.appendChild(btnVer);

        const btnDescargar = document.createElement('button');
        btnDescargar.type = 'button';
        btnDescargar.className = 'btn btn-sm btn-outline-secondary me-2';
        btnDescargar.textContent = 'Descargar';
        btnDescargar.addEventListener('click', () => {
            descargarArchivoDirecto(url, adjunto.nombre_archivo || adjunto.blob_path || 'adjunto');
        });
        celdaAccion.appendChild(btnDescargar);

        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn btn-sm btn-outline-dark';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => {
            const nombreArchivo = adjunto.nombre_archivo || adjunto.blob_path || '';
            eliminarAdjuntoAnalisisAdmin(adjunto.id, nombreArchivo);
        });
        celdaAccion.appendChild(btnEliminar);

        row.appendChild(celdaAccion);
        tbody.appendChild(row);
    });

    tabla.appendChild(tbody);
    contenedor.innerHTML = '';
    contenedor.appendChild(tabla);
}

async function eliminarAdjuntoAnalisisAdmin(adjuntoId, nombreArchivo) {
    if (!confirm('Desea eliminar este adjunto? Se eliminara del storage.')) {
        return;
    }

    const etiqueta = nombreArchivo ? nombreArchivo : `ID ${adjuntoId}`;
    const textoConfirmacion = prompt(`Escriba ELIMINAR para borrar el adjunto ${etiqueta}.`);
    if (textoConfirmacion === null) {
        return;
    }
    if (textoConfirmacion.trim().toUpperCase() !== 'ELIMINAR') {
        alert('Confirmacion cancelada.');
        return;
    }

    try {
        const response = await fetch(`/sgi/analisis-causas/${adjuntoId}`, {
            method: 'DELETE'
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo eliminar el adjunto.');
        }
        if (resultado.mensaje) {
            alert(resultado.mensaje);
        } else {
            alert('Adjunto eliminado.');
        }
        if (resultado.advertencias && resultado.advertencias.length) {
            console.warn('Advertencias al eliminar adjunto:', resultado.advertencias);
        }
        await cargarAdjuntosAnalisisAdmin();
    } catch (error) {
        alert(`Error al eliminar adjunto: ${error.message}`);
    }
}

async function guardarActividadAdmin(actividadId) {
    const datos = {
        etapa_actividad: obtenerValorCampoAdmin(`adminActEtapa-${actividadId}`),
        nombre_actividad: obtenerValorCampoAdmin(`adminActNombre-${actividadId}`),
        descripcion: obtenerValorCampoAdmin(`adminActDescripcion-${actividadId}`),
        fecha_cierre: obtenerValorCampoAdmin(`adminActFecha-${actividadId}`),
        responsable: obtenerValorCampoAdmin(`adminActResponsable-${actividadId}`),
        estado: obtenerValorCampoAdmin(`adminActEstado-${actividadId}`)
    };

    if (adminRegistroTipo === 'PA') {
        datos.tipo_actividad = obtenerValorCampoAdmin(`adminActTipo-${actividadId}`) || 'PLAN';
    }

    try {
        const response = await fetch(`/sgi/actividades/${actividadId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(datos)
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo actualizar la actividad.');
        }
        await cargarActividadesAdmin();
    } catch (error) {
        alert(`Error al actualizar actividad: ${error.message}`);
    }
}

async function eliminarActividadAdmin(actividadId) {
    if (!confirm('Desea eliminar esta actividad? Se eliminaran sus evidencias.')) {
        return;
    }

    try {
        const response = await fetch(`/sgi/actividades/${actividadId}`, {
            method: 'DELETE'
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo eliminar la actividad.');
        }
        await cargarActividadesAdmin();
        if (resultado.mensaje) {
            alert(resultado.mensaje);
        }
        if (resultado.advertencias && resultado.advertencias.length) {
            console.warn('Advertencias al eliminar actividad:', resultado.advertencias);
        }
    } catch (error) {
        alert(`Error al eliminar actividad: ${error.message}`);
    }
}

async function cargarEvidenciasAdmin() {
    const contenedor = document.getElementById('adminEvidenciasLista');
    if (!contenedor) {
        return;
    }
    contenedor.innerHTML = '<div class="text-muted small">Cargando evidencias...</div>';

    if (!adminRegistroCodigo || !adminRegistroTipo) {
        contenedor.innerHTML = '';
        return;
    }

    try {
        const response = await fetch(`/sgi/evidencias?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(adminRegistroTipo)}`);
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudieron cargar evidencias.');
        }
        renderEvidenciasAdmin(resultado.evidencias || []);
        await cargarAdjuntosAnalisisAdmin();
    } catch (error) {
        contenedor.innerHTML = `<div class="text-danger small">${error.message}</div>`;
    }
}

function renderEvidenciasAdmin(evidencias) {
    const contenedor = document.getElementById('adminEvidenciasLista');
    if (!contenedor) {
        return;
    }

    if (!evidencias.length) {
        contenedor.innerHTML = '<div class="text-muted small">No hay evidencias registradas.</div>';
        return;
    }

    const tabla = document.createElement('table');
    tabla.className = 'table table-sm table-bordered align-middle';
    const thead = document.createElement('thead');
    thead.innerHTML = `
        <tr>
            <th>Actividad</th>
            <th>Archivo</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th>Accion</th>
        </tr>
    `;
    tabla.appendChild(thead);

    const tbody = document.createElement('tbody');
    evidencias.forEach(ev => {
        const row = document.createElement('tr');

        const celdaActividad = document.createElement('td');
        const actividadTexto = `${ev.etapa_actividad || ''}${ev.nombre_actividad ? ' - ' + ev.nombre_actividad : ''}`.trim();
        celdaActividad.textContent = actividadTexto || '-';
        row.appendChild(celdaActividad);

        const celdaArchivo = document.createElement('td');
        const url = ev.url_descarga || ev.url_publica;
        if (url) {
            const link = document.createElement('a');
            link.href = url;
            link.target = '_blank';
            link.rel = 'noopener';
            link.textContent = ev.nombre_archivo || ev.blob_path || 'Evidencia';
            celdaArchivo.appendChild(link);
        } else {
            celdaArchivo.textContent = ev.nombre_archivo || ev.blob_path || 'Evidencia';
        }
        if (ev.motivo_rechazo) {
            const motivo = document.createElement('div');
            motivo.className = 'text-danger small';
            motivo.textContent = `Motivo: ${ev.motivo_rechazo}`;
            celdaArchivo.appendChild(motivo);
        }
        row.appendChild(celdaArchivo);

        const celdaFecha = document.createElement('td');
        celdaFecha.textContent = ev.fecha_subida_formato || '';
        row.appendChild(celdaFecha);

        const estadoValor = obtenerEstadoEvidencia(ev.estado_validacion);
        const celdaEstado = document.createElement('td');
        const badge = document.createElement('span');
        badge.className = `estado-evidencia ${estadoValor}`;
        badge.textContent = estadoValor.charAt(0).toUpperCase() + estadoValor.slice(1);
        celdaEstado.appendChild(badge);
        row.appendChild(celdaEstado);

        const celdaAccion = document.createElement('td');
        const btnAprobar = document.createElement('button');
        btnAprobar.type = 'button';
        btnAprobar.className = 'btn btn-sm btn-outline-success me-2';
        btnAprobar.textContent = 'Aprobar';
        btnAprobar.disabled = estadoValor === 'aprobada';
        btnAprobar.addEventListener('click', () => actualizarEstadoEvidenciaAdmin(ev.id, 'aprobada'));
        celdaAccion.appendChild(btnAprobar);

        const btnRechazar = document.createElement('button');
        btnRechazar.type = 'button';
        btnRechazar.className = 'btn btn-sm btn-outline-danger';
        btnRechazar.textContent = 'Rechazar';
        btnRechazar.addEventListener('click', () => {
            const motivo = prompt('Motivo de rechazo:');
            if (motivo === null) {
                return;
            }
            actualizarEstadoEvidenciaAdmin(ev.id, 'rechazada', motivo.trim());
        });
        celdaAccion.appendChild(btnRechazar);

        const btnEliminar = document.createElement('button');
        btnEliminar.type = 'button';
        btnEliminar.className = 'btn btn-sm btn-outline-dark ms-2';
        btnEliminar.textContent = 'Eliminar';
        btnEliminar.addEventListener('click', () => {
            const nombreArchivo = ev.nombre_archivo || ev.blob_path || '';
            eliminarEvidenciaAdmin(ev.id, nombreArchivo);
        });
        celdaAccion.appendChild(btnEliminar);

        row.appendChild(celdaAccion);
        tbody.appendChild(row);
    });

    tabla.appendChild(tbody);
    contenedor.innerHTML = '';
    contenedor.appendChild(tabla);
}

async function actualizarEstadoEvidenciaAdmin(evidenciaId, estado, motivo) {
    console.log('üîç actualizarEstadoEvidenciaAdmin:', { evidenciaId, estado, motivo });

    try {
        const payload = {
            estado: estado
        };
        if (estado === 'rechazada') {
            payload.motivo_rechazo = motivo || '';
        }

        const url = `/sgi/evidencias/${evidenciaId}/estado`;
        console.log('üì° URL completa:', url);

        const response = await fetch(url, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo actualizar la evidencia.');
        }
        await cargarEvidenciasAdmin();
        if (actividadSeleccionadaId) {
            await cargarEvidenciasActividad(actividadSeleccionadaId);
        }

        // ‚ö° ACTUALIZAR NOTIFICACIONES INMEDIATAMENTE
        console.log('‚ö° Actualizando badges de notificaciones inmediatamente...');
        setTimeout(() => {
            actualizarBadgesNotificaciones();
        }, 500); // Esperar 500ms para que el backend termine de crear la notificaci√≥n

    } catch (error) {
        alert(`Error al actualizar evidencia: ${error.message}`);
    }
}

function actualizarBotonesAdminPorTab(tabId) {
    const btnRegistro = document.getElementById('btnEliminarRegistroAdmin');
    const btnActividades = document.getElementById('btnEliminarActividadesAdminFooter');
    const btnEvidencias = document.getElementById('btnEliminarEvidenciasAdminFooter');

    if (btnRegistro) {
        btnRegistro.classList.toggle('d-none', tabId !== 'adminRegistroTab');
    }
    if (btnActividades) {
        btnActividades.classList.toggle('d-none', tabId !== 'adminActividadesTab');
    }
    if (btnEvidencias) {
        btnEvidencias.classList.toggle('d-none', tabId !== 'adminEvidenciasTab');
    }
}

async function eliminarActividadesAdmin() {
    if (!adminRegistroCodigo || !adminRegistroTipo) {
        return;
    }

    if (!confirm('Desea eliminar todas las actividades? Se eliminaran sus evidencias.')) {
        return;
    }

    const textoConfirmacion = prompt(`Escriba ELIMINAR para borrar todas las actividades de ${adminRegistroCodigo}.`);
    if (textoConfirmacion === null) {
        return;
    }
    if (textoConfirmacion.trim().toUpperCase() !== 'ELIMINAR') {
        alert('Confirmacion cancelada.');
        return;
    }

    try {
        const response = await fetch(`/sgi/actividades?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(adminRegistroTipo)}`, {
            method: 'DELETE'
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudieron eliminar las actividades.');
        }
        if (resultado.mensaje) {
            alert(resultado.mensaje);
        } else {
            alert('Actividades eliminadas.');
        }
        if (resultado.advertencias && resultado.advertencias.length) {
            console.warn('Advertencias al eliminar actividades:', resultado.advertencias);
        }
        await cargarActividadesAdmin();
        await cargarEvidenciasAdmin();
        if (typeof aplicarFiltrosYRecargarTabla === 'function') {
            await aplicarFiltrosYRecargarTabla();
        }
    } catch (error) {
        alert(`Error al eliminar actividades: ${error.message}`);
    }
}

async function eliminarEvidenciasAdmin() {
    if (!adminRegistroCodigo || !adminRegistroTipo) {
        return;
    }

    if (!confirm('Desea eliminar todas las evidencias?')) {
        return;
    }

    const textoConfirmacion = prompt(`Escriba ELIMINAR para borrar todas las evidencias de ${adminRegistroCodigo}.`);
    if (textoConfirmacion === null) {
        return;
    }
    if (textoConfirmacion.trim().toUpperCase() !== 'ELIMINAR') {
        alert('Confirmacion cancelada.');
        return;
    }

    try {
        const response = await fetch(`/sgi/evidencias?codigo=${encodeURIComponent(adminRegistroCodigo)}&tipo=${encodeURIComponent(adminRegistroTipo)}`, {
            method: 'DELETE'
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudieron eliminar las evidencias.');
        }
        if (resultado.mensaje) {
            alert(resultado.mensaje);
        } else {
            alert('Evidencias eliminadas.');
        }
        if (resultado.advertencias && resultado.advertencias.length) {
            console.warn('Advertencias al eliminar evidencias:', resultado.advertencias);
        }
        await cargarEvidenciasAdmin();
        await cargarActividadesAdmin();
        if (actividadSeleccionadaId) {
            await cargarEvidenciasActividad(actividadSeleccionadaId);
        }
    } catch (error) {
        alert(`Error al eliminar evidencias: ${error.message}`);
    }
}

async function eliminarEvidenciaAdmin(evidenciaId, nombreArchivo) {
    if (!confirm('Desea eliminar esta evidencia? Se eliminara del storage.')) {
        return;
    }

    const etiqueta = nombreArchivo ? nombreArchivo : `ID ${evidenciaId}`;
    const textoConfirmacion = prompt(`Escriba ELIMINAR para borrar la evidencia ${etiqueta}.`);
    if (textoConfirmacion === null) {
        return;
    }
    if (textoConfirmacion.trim().toUpperCase() !== 'ELIMINAR') {
        alert('Confirmacion cancelada.');
        return;
    }

    try {
        const response = await fetch(`/sgi/evidencias/${evidenciaId}`, {
            method: 'DELETE'
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudo eliminar la evidencia.');
        }
        if (resultado.mensaje) {
            alert(resultado.mensaje);
        } else {
            alert('Evidencia eliminada.');
        }
        if (resultado.advertencias && resultado.advertencias.length) {
            console.warn('Advertencias al eliminar evidencia:', resultado.advertencias);
        }
        await cargarEvidenciasAdmin();
        if (actividadSeleccionadaId) {
            await cargarEvidenciasActividad(actividadSeleccionadaId);
        }
        // Refrescar auditor√≠a si est√° activa
        if (typeof refrescarAuditoria === 'function') {
            await refrescarAuditoria();
        }
    } catch (error) {
        alert(`Error al eliminar evidencia: ${error.message}`);
    }
}






// Funci√≥n para actualizar contadores (fallback local)
function actualizarContadores(datos) {
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0); // Normalizar a medianoche para comparaci√≥n exacta

    let registrosVencidos = 0;
    let registrosProximosVencer = 0;
    let registrosEnPlazo = 0;
    let registrosSinFecha = 0;

    console.log(`üîç AN√ÅLISIS DETALLADO DE CONTEO - Fecha de hoy: ${hoy.toISOString().split('T')[0]}`);
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');

    // Clasificar cada registro de forma mutuamente excluyente
    datos.forEach((p, index) => {
        const fechaStr = p.fecha_cierre_formato || p.fechaCierre;

        if (!fechaStr || fechaStr.trim() === '') {
            console.log(`üìã Registro ${index + 1}: SIN FECHA - a√±adido a 'Sin fecha'`);
            registrosSinFecha++;
            return;
        }

        try {
            // Parsear fecha correctamente
            let fecha;
            if (fechaStr.includes('/')) {
                // Formato DD/MM/YYYY
                const partes = fechaStr.split('/');
                fecha = new Date(partes[2], partes[1] - 1, partes[0]); // YYYY, MM-1, DD
            } else if (fechaStr.includes('-')) {
                // Formato YYYY-MM-DD
                fecha = new Date(fechaStr);
            } else {
                throw new Error('Formato de fecha no reconocido');
            }

            fecha.setHours(0, 0, 0, 0); // Normalizar a medianoche

            if (isNaN(fecha.getTime())) {
                console.log(`‚ö†Ô∏è Registro ${index + 1}: FECHA INV√ÅLIDA '${fechaStr}' - a√±adido a 'Sin fecha'`);
                registrosSinFecha++;
                return;
            }

            // Calcular diferencia en d√≠as
            const diff = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));

            let categoria;
            let simbolo;

            if (diff < 0) {
                // Fecha ya pas√≥ = VENCIDO
                registrosVencidos++;
                categoria = 'VENCIDO';
                simbolo = 'üî¥';
            } else if (diff >= 0 && diff <= 10) {
                // Entre hoy (inclusive) y 10 d√≠as = PR√ìXIMO A VENCER
                registrosProximosVencer++;
                categoria = 'PR√ìXIMO A VENCER';
                simbolo = 'üü°';
            } else {
                // M√°s de 10 d√≠as = EN PLAZO
                registrosEnPlazo++;
                categoria = 'EN PLAZO';
                simbolo = 'üü¢';
            }

            console.log(`${simbolo} Registro ${index + 1}: ${fechaStr} (${fecha.toISOString().split('T')[0]}) - Diff: ${diff} d√≠as - ${categoria}`);

        } catch (error) {
            console.warn(`‚ùå Error procesando fecha en registro ${index + 1}: '${fechaStr}' - Error: ${error.message}`);
            registrosSinFecha++;
        }
    });

    // Los registros sin fecha se consideran "en plazo" para efectos del conteo
    registrosEnPlazo += registrosSinFecha;

    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`üìä RESUMEN FINAL DE CONTEO:`);
    console.log(`üî¥ Vencidos (diff < 0): ${registrosVencidos}`);
    console.log(`üü° Pr√≥ximos a vencer (0 ‚â§ diff ‚â§ 10): ${registrosProximosVencer}`);
    console.log(`üü¢ En plazo (diff > 10): ${registrosEnPlazo - registrosSinFecha}`);
    console.log(`Sin fecha (incluidos en plazo): ${registrosSinFecha}`);
    console.log(`üü¢ Total en plazo (incluye sin fecha): ${registrosEnPlazo}`);
    console.log('‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ');

    // Debug: Verificar que la suma sea correcta
    const sumaContadores = registrosVencidos + registrosProximosVencer + registrosEnPlazo;
    console.log(`‚úÖ Verificaci√≥n: ${registrosVencidos} + ${registrosProximosVencer} + ${registrosEnPlazo} = ${sumaContadores}`);
    console.log(`üìä Total registros procesados: ${datos.length}`);

    if (sumaContadores !== datos.length) {
        console.error(`‚ùå ERROR CR√çTICO: La suma de contadores (${sumaContadores}) no coincide con el total de datos (${datos.length})`);
        console.error('üö® Revise la l√≥gica de clasificaci√≥n de fechas');
    } else {
        console.log(`‚úÖ VERIFICACI√ìN EXITOSA: Todos los registros fueron clasificados correctamente`);
    }

    // Actualizar contadores en la interfaz
    document.getElementById('contadorVencidas').textContent = registrosVencidos;
    document.getElementById('contadorProximoVencer').textContent = registrosProximosVencer;
    document.getElementById('contadorEnProceso').textContent = registrosEnPlazo;
    document.getElementById('contadorTotal').textContent = datos.length;
}

// Funci√≥n para generar bandera de alerta seg√∫n d√≠as restantes
function generarBanderaAlerta(fechaStr, codigoRegistro = null) {
    if (!fechaStr || fechaStr.trim() === '') {
        return '<span class="text-muted">-</span>';
    }

    try {
        // Parsear fecha correctamente (igual que en actualizarContadores)
        let fecha;
        if (fechaStr.includes('/')) {
            // Formato DD/MM/YYYY
            const partes = fechaStr.split('/');
            fecha = new Date(partes[2], partes[1] - 1, partes[0]); // YYYY, MM-1, DD
        } else if (fechaStr.includes('-')) {
            // Formato YYYY-MM-DD
            fecha = new Date(fechaStr);
        } else {
            throw new Error('Formato de fecha no reconocido');
        }

        if (isNaN(fecha.getTime())) {
            return '<span class="text-muted">Fecha inv√°lida</span>';
        }

        const hoy = new Date();
        hoy.setHours(0, 0, 0, 0);
        fecha.setHours(0, 0, 0, 0);

        const diff = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));

        let icono = '';
        let clase = '';
        let titulo = '';

        if (diff < 0) {
            // ROJO - Vencido (fecha superada)
            icono = '<i class="fas fa-exclamation-triangle"></i>';
            clase = 'alerta-vencido';
            titulo = `Vencido hace ${Math.abs(diff)} d√≠a(s)`;
        } else if (diff >= 0 && diff <= 10) {
            // AMARILLO - Pr√≥ximo a vencer (0 a 10 d√≠as inclusive)
            icono = '<i class="fas fa-clock"></i>';
            clase = 'alerta-proximo';
            titulo = diff === 0 ? 'Vence hoy' : `Vence en ${diff} d√≠a(s)`;
        } else {
            // VERDE - En plazo (m√°s de 10 d√≠as)
            icono = '<i class="fas fa-check-circle"></i>';
            clase = 'alerta-ok';
            titulo = `Vence en ${diff} d√≠a(s) - En plazo`;
        }

        // üîî AGREGAR CAMPANA DE NOTIFICACIONES
        const campanaHTML = `
            <div class="campana-notificaciones" onclick="abrirModalNotificaciones(event, '${codigoRegistro || ''}')" title="Ver notificaciones">
                <i class="fas fa-bell"></i>
                <span class="badge-notificaciones" id="badge-${codigoRegistro}" style="display: none;">0</span>
            </div>
        `;

        return `
            <div class="contenedor-alerta-notificacion">
                <span class="bandera-alerta ${clase}" title="${titulo}">${icono}</span>
                ${campanaHTML}
            </div>
        `;
    } catch (error) {
        console.warn('Error al generar bandera de alerta para fecha:', fechaStr, error);
        return '<span class="text-muted">Error en fecha</span>';
    }
}

// Funci√≥n adicional para debug detallado de fechas
function analizarFechas(datos) {
    const hoy = new Date();
    console.log(`üìä An√°lisis de fechas (hoy: ${hoy.toLocaleDateString('es-ES')})`);
    console.log('‚ïê'.repeat(80));

    datos.forEach(registro => {
        const fechaStr = registro.fecha_cierre_formato || registro.fechaCierre;
        if (fechaStr) {
            const fecha = fechaStr.includes('/') ?
                new Date(fechaStr.split('/').reverse().join('-')) :
                new Date(fechaStr);
            const diff = Math.ceil((fecha - hoy) / (1000 * 60 * 60 * 24));

            let categoria = '';
            if (diff < 0) categoria = 'üî¥ VENCIDO';
            else if (diff === 0) categoria = 'üü° VENCE HOY';
            else if (diff <= 7) categoria = 'üü† PR√ìXIMO A VENCER';
            else categoria = 'üü¢ EN PLAZO';

            console.log(`${categoria} | ${registro.codigo} | ${fechaStr} | ${diff} d√≠as`);
        }
    });
    console.log('‚ïê'.repeat(80));
}



// Funci√≥n para limpiar filtros
async function limpiarFiltros() {
    document.getElementById('filtroUsuario').value = '';
    document.getElementById('filtroTipoGestion').value = '';
    document.getElementById('filtroProceso').value = '';
    document.getElementById('filtroSubproceso').value = '';
    document.getElementById('filtroEstado').value = '';
    document.getElementById('filtroDesde').value = '';
    document.getElementById('filtroHasta').value = '';

    // Limpiar filtro de vencimiento
    filtroVencimientoActivo = null;
    actualizarEstadoVisualFiltros();
    console.log('üßπ Filtro de vencimiento limpiado');

    // Ocultar badge de filtros activos
    const badge = document.getElementById('badgeFiltrosActivosPendientes');
    if (badge) {
        badge.style.display = 'none';
        badge.removeAttribute('title');
        badge.removeAttribute('aria-label');
    }

    // Cargar todos los c√≥digos disponibles
    console.log('üßπ Limpiando filtros - Cargando todos los c√≥digos...');
    await cargarCodigosPlanesAccion({});

    // Cargar autom√°ticamente todos los datos cuando se limpian los filtros
    console.log('üßπ Limpiando filtros - Cargando todos los datos...');
    await cargarDatosPorTipoGestion('');
}

// Funci√≥n para ver indicadores
function verIndicadores(codigo) {
    // TODO: Implementar modal para gesti√≥n de indicadores
    alert(`Ver indicadores para el proceso: ${codigo}`);
}

// Funci√≥n para cambiar estado
async function cambiarEstado(codigo, estadoActual) {
    const estados = ['Pendiente', 'En proceso', 'Abierta', 'Cerrado'];
    const estadoSeleccionado = prompt(`Estado actual: ${estadoActual}\nSeleccione nuevo estado:\n1. Pendiente\n2. En proceso\n3. Abierta\n4. Cerrado\n\nIngrese el n√∫mero:`, '');

    if (estadoSeleccionado && estadoSeleccionado >= 1 && estadoSeleccionado <= 4) {
        const nuevoEstado = estados[parseInt(estadoSeleccionado) - 1];
        const observacion = prompt('Observaci√≥n (opcional):', '');

        try {
            const response = await fetch('/sgi/procesos/estado', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    codigo: codigo,
                    nuevo_estado: nuevoEstado,
                    observacion: observacion
                })
            });

            const result = await response.json();

            if (result.success) {
                alert(result.mensaje);
                await refrescarPendientesDespuesDeCrear();
            } else {
                alert('Error: ' + result.mensaje);
            }
        } catch (error) {
            alert('Error de conexi√≥n: ' + error.message);
        }
    }
}

// Funci√≥n para descargar datos filtrados
async function descargarDatos(formato = 'xlsx') {
    try {
        console.log(`üîÑ Iniciando descarga en formato ${formato.toUpperCase()}`);

        // Obtener todos los filtros actuales
        const filtros = obtenerTodosFiltrosActuales();

        console.log('üìã Filtros aplicados para descarga:', filtros);

        // Validar que hay datos para descargar
        const tbody = document.querySelector('#tablaProcesos tbody');
        const filas = tbody.querySelectorAll('tr');

        // Verificar si hay datos (excluyendo mensajes de "sin datos" o "cargando")
        const hayDatos = Array.from(filas).some(fila => {
            const texto = fila.textContent.toLowerCase();
            return !texto.includes('sin registros') &&
                   !texto.includes('cargando') &&
                   !texto.includes('seleccione un tipo') &&
                   !texto.includes('error');
        });

        if (!hayDatos) {
            alert('‚ö†Ô∏è No hay datos para descargar. Aplique filtros y aseg√∫rese de que hay registros en la tabla.');
            return;
        }

        // Mostrar indicador de descarga
        const btnTextos = document.querySelectorAll('.dropdown-toggle');
        const btnOriginal = btnTextos[0] ? btnTextos[0].innerHTML : '';
        if (btnTextos[0]) {
            btnTextos[0].innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Descargando...';
            btnTextos[0].disabled = true;
        }

        // Preparar payload para el servidor
        const payload = {
            formato: formato,
            filtros: filtros
        };

        console.log('üì§ Enviando solicitud de descarga:', payload);

        // Realizar solicitud al servidor
        const response = await fetch('/sgi/exportar_pendientes', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.mensaje || `Error del servidor: ${response.status}`);
        }

        // Obtener el blob del archivo
        const blob = await response.blob();

        // Extraer nombre del archivo del header Content-Disposition
        let filename = `SGI_Pendientes_${new Date().toISOString().split('T')[0]}.${formato}`;
        const contentDisposition = response.headers.get('Content-Disposition');
        if (contentDisposition) {
            const matches = contentDisposition.match(/filename=([^;]+)/);
            if (matches && matches[1]) {
                filename = matches[1].replace(/"/g, '');
            }
        }

        // Crear enlace de descarga y hacer clic autom√°ticamente
        const url = window.URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();

        // Limpiar
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);

        console.log(`‚úÖ Descarga completada: ${filename}`);

        // Mostrar notificaci√≥n de √©xito
        const tipoGestion = filtros.tipo_gestion || 'todos los tipos';
        const mensaje = `üì• Archivo descargado exitosamente: ${filename}\nüìä Tipo de gesti√≥n: ${tipoGestion}`;

        // Crear notificaci√≥n temporal
        mostrarNotificacionDescarga(mensaje, 'success');

        // Refrescar Auditor√≠a despu√©s de 2 segundos (la descarga se registra en auditor√≠a)
        setTimeout(() => {
            console.log('üîÑ Refrescando Auditor√≠a despu√©s de descarga desde Pendientes...');
            if (typeof refrescarAuditoria === 'function') {
                refrescarAuditoria();
            }
        }, 2000);

    } catch (error) {
        console.error('‚ùå Error en descarga:', error);
        alert(`‚ùå Error al descargar: ${error.message}`);
    } finally {
        // Restaurar bot√≥n
        const btnTextos = document.querySelectorAll('.dropdown-toggle');
        if (btnTextos[0]) {
            btnTextos[0].innerHTML = 'üì• Descargar';
            btnTextos[0].disabled = false;
        }
    }
}

// Funci√≥n para mostrar notificaci√≥n de descarga
function mostrarNotificacionDescarga(mensaje, tipo = 'success') {
    // Crear elemento de notificaci√≥n
    const notificacion = document.createElement('div');
    notificacion.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notificacion.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        max-width: 400px;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;

    notificacion.innerHTML = `
        <strong>${tipo === 'success' ? '‚úÖ Descarga Exitosa' : '‚ùå Error'}</strong><br>
        ${mensaje.replace(/\n/g, '<br>')}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Agregar al body
    document.body.appendChild(notificacion);

    // Auto-remover despu√©s de 5 segundos
    setTimeout(() => {
        if (notificacion.parentNode) {
            notificacion.parentNode.removeChild(notificacion);
        }
    }, 5000);
}

// Funci√≥n para cambiar p√°gina
function cambiarPagina(pagina) {
    console.log(`Cambiar a p√°gina: ${pagina}`);
    // TODO: Implementar paginaci√≥n real
}

// Funci√≥n para crear proceso SGI
async function crearProcesoSGI(datos) {
    try {
        const response = await fetch('/sgi/procesos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(datos)
        });

        const result = await response.json();

        if (result.success) {
            return result;
        } else {
            throw new Error(result.mensaje);
        }
    } catch (error) {
        throw error;
    }
}

// Variables para actividades PHVA
let actividadesPHVA = [];
let actividadesCorrectivas = [];
let actividadesGC = [];

// NOTA: Las actividades son OBLIGATORIAS - No hay opci√≥n para desactivarlas

// üî¥ FUNCI√ìN PARA AGREGAR ACTIVIDAD CORRECTIVA
function agregarActividadCorrectiva() {
    const nombreActividad = document.getElementById('nombreActividadCorrectiva').value.trim();
    const phva = document.getElementById('phvaSelectCorrectiva').value;
    const descripcion = document.getElementById('descripcionActividadCorrectiva').value.trim();
    const fechaEjecucion = document.getElementById('fechaEjecucionCorrectiva').value;
    const responsable = document.getElementById('responsableActividadCorrectiva').value.trim();

    if (!nombreActividad || !phva || !descripcion || !fechaEjecucion || !responsable) {
        alert('Todos los campos son obligatorios para agregar una actividad correctiva');
        return;
    }

    // Validar que la fecha est√© dentro del periodo v√°lido del PA
    const fechaApertura = document.getElementById('fechaAperturaPa').value;
    const fechaCierre = document.getElementById('fechaCierrePa').value;

    if (fechaApertura && fechaEjecucion < fechaApertura) {
        alert(`La fecha cierre no puede ser anterior a la fecha de apertura del PA (${fechaApertura})`);
        return;
    }

    if (fechaCierre && fechaEjecucion > fechaCierre) {
        alert(`La fecha cierre no puede ser posterior a la fecha de cierre objetivo del PA (${fechaCierre})`);
        return;
    }

    const nuevaActividad = {
        id: Date.now(),
        nombre_actividad: nombreActividad,
        phva: phva,
        descripcion: descripcion,
        fecha_ejecucion: fechaEjecucion,
        responsable: responsable,
        tipo: 'correctiva' // Campo adicional para identificaci√≥n
    };

    actividadesCorrectivas.push(nuevaActividad);
    actualizarListaActividadesCorrectivas();

    // Limpiar campos
    document.getElementById('nombreActividadCorrectiva').value = '';
    document.getElementById('phvaSelectCorrectiva').value = '';
    document.getElementById('descripcionActividadCorrectiva').value = '';
    document.getElementById('fechaEjecucionCorrectiva').value = '';
    document.getElementById('responsableActividadCorrectiva').value = '';
}

// üî¥ FUNCI√ìN PARA ACTUALIZAR LA LISTA VISUAL DE ACTIVIDADES CORRECTIVAS
function actualizarListaActividadesCorrectivas() {
    const container = document.getElementById('listaActividadesCorrectivas');
    container.innerHTML = '';

    if (actividadesCorrectivas.length === 0) {
        return;
    }

    const table = document.createElement('table');
    table.className = 'table table-sm table-bordered mb-3';
    table.innerHTML = `
        <thead class="table-danger">
            <tr>
                <th>Nombre Actividad</th>
                <th>PHVA</th>
                <th>Descripci√≥n</th>
                <th>Fecha cierre</th>
                <th>Responsable</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;

    const tbody = table.querySelector('tbody');

    actividadesCorrectivas.forEach(actividad => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><strong>${actividad.nombre_actividad || '-'}</strong></td>
            <td><span class="badge bg-info">${actividad.phva || '-'}</span></td>
            <td>${actividad.descripcion}</td>
            <td>${new Date(actividad.fecha_ejecucion).toLocaleDateString('es-ES')}</td>
            <td>${actividad.responsable}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarActividadCorrectiva(${actividad.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    container.appendChild(table);
}

// üî¥ FUNCI√ìN PARA ELIMINAR ACTIVIDAD CORRECTIVA
function eliminarActividadCorrectiva(id) {
    actividadesCorrectivas = actividadesCorrectivas.filter(act => act.id !== id);
    actualizarListaActividadesCorrectivas();
}

// Funci√≥n para agregar actividad PHVA
function agregarActividad() {
    const nombreActividad = document.getElementById('nombreActividad').value;
    const phva = document.getElementById('phvaSelect').value;
    const descripcion = document.getElementById('descripcionActividad').value;
    const fechaEjecucion = document.getElementById('fechaEjecucion').value;
    const responsable = document.getElementById('responsableActividad').value;

    if (!nombreActividad || !phva || !descripcion || !fechaEjecucion || !responsable) {
        alert('Todos los campos son obligatorios para agregar una actividad (incluya Nombre de Actividad)');
        return;
    }

    // Validar que la fecha est√© dentro del periodo v√°lido del PA
    const fechaApertura = document.getElementById('fechaAperturaPa').value;
    const fechaCierre = document.getElementById('fechaCierrePa').value;

    if (fechaApertura && fechaEjecucion < fechaApertura) {
        alert(`La fecha cierre no puede ser anterior a la fecha de apertura del PA (${fechaApertura})`);
        return;
    }

    if (fechaCierre && fechaEjecucion > fechaCierre) {
        alert(`La fecha cierre no puede ser posterior a la fecha de cierre objetivo del PA (${fechaCierre})`);
        return;
    }

    const nuevaActividad = {
        id: Date.now(),
        nombre_actividad: nombreActividad,
        phva: phva,
        descripcion: descripcion,
        fecha_ejecucion: fechaEjecucion,
        responsable: responsable,
        tipo: 'phva' // Campo adicional para identificaci√≥n
    };

    actividadesPHVA.push(nuevaActividad);
    actualizarListaActividades();

    // Limpiar campos
    document.getElementById('nombreActividad').value = '';
    document.getElementById('phvaSelect').value = '';
    document.getElementById('descripcionActividad').value = '';
    document.getElementById('fechaEjecucion').value = '';
    document.getElementById('responsableActividad').value = '';

    // Reconfigurar l√≠mites para el campo limpio (verificar que la funci√≥n existe)
    if (typeof aplicarLimitesActividadesPHVA === 'function') {
        setTimeout(aplicarLimitesActividadesPHVA, 100);
    }
}

// Funci√≥n para actualizar la lista visual de actividades
function actualizarListaActividades() {
    const container = document.getElementById('listaActividades');
    container.innerHTML = '';

    if (actividadesPHVA.length === 0) {
        return;
    }

    const table = document.createElement('table');
    table.className = 'table table-sm table-bordered mb-3';
    table.innerHTML = `
        <thead class="table-light">
            <tr>
                <th>Nombre Actividad</th>
                <th>PHVA</th>
                <th>Descripci√≥n</th>
                <th>Fecha cierre</th>
                <th>Responsable</th>
                <th>Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;

    const tbody = table.querySelector('tbody');

    actividadesPHVA.forEach(actividad => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${actividad.nombre_actividad || '‚Äî'}</td>
            <td><span class="badge bg-info">${actividad.phva}</span></td>
            <td>${actividad.descripcion}</td>
            <td>${new Date(actividad.fecha_ejecucion).toLocaleDateString('es-ES')}</td>
            <td>${actividad.responsable}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarActividad(${actividad.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    container.appendChild(table);
}

// Funci√≥n para eliminar actividad
function eliminarActividad(id) {
    actividadesPHVA = actividadesPHVA.filter(act => act.id !== id);
    actualizarListaActividades();
}

// Funci√≥n para limpiar formulario PA
function limpiarFormularioPA() {
    document.getElementById('formCrearPA').reset();
    const adjuntosCausasInput = document.getElementById('adjuntosCausas');
    if (adjuntosCausasInput) {
        adjuntosCausasInput.value = '';
    }
    const responsablePaInput = document.getElementById('responsablePa');
    if (responsablePaInput) {
        responsablePaInput.value = '';
    }
    const phvaCorrectivaSelect = document.getElementById('phvaSelectCorrectiva');
    if (phvaCorrectivaSelect) {
        phvaCorrectivaSelect.value = '';
    }
    actividadesPHVA = [];
    actividadesCorrectivas = [];
    actualizarListaActividades();
    actualizarListaActividadesCorrectivas();

    // Ocultar secci√≥n de actividades correctivas si est√° visible
    const seccionCorrectivas = document.getElementById('seccionActividadesCorrectivas');
    if (seccionCorrectivas) {
        seccionCorrectivas.style.display = 'none';
    }

    // Restablecer selects de proceso y subproceso
    const procesoPaSelect = document.getElementById('procesoPa');
    const subprocesoPaSelect = document.getElementById('subprocesoPa');
    const estadoPaSelect = document.getElementById('estadoPa');

    if (procesoPaSelect) {
        procesoPaSelect.selectedIndex = 0;
    }

    if (subprocesoPaSelect) {
        // Limpiar subprocesos excepto la opci√≥n por defecto
        while (subprocesoPaSelect.options.length > 1) {
            subprocesoPaSelect.removeChild(subprocesoPaSelect.lastChild);
        }
        subprocesoPaSelect.selectedIndex = 0;
    }

    if (estadoPaSelect) {
        estadoPaSelect.selectedIndex = 0;
    }

    // Establecer fecha de apertura como hoy (usando fecha local, no UTC)
    const hoy = obtenerFechaLocal();
    document.getElementById('fechaAperturaPa').value = hoy;

    // Resetear c√≥digo autom√°tico
    const codigoAutoPa = document.getElementById('codigoAutoPa');
    if (codigoAutoPa) {
        codigoAutoPa.textContent = 'PA-PROC-SUBPROC-NNNN';
    }

    // Limpiar validaciones del calendario (fechas PA)
    const fechaCierreInput = document.getElementById('fechaCierrePa');
    if (fechaCierreInput) {
        fechaCierreInput.style.borderColor = '';
        fechaCierreInput.removeAttribute('min');
        fechaCierreInput.removeAttribute('max');
    }

    // Limpiar validaciones de actividades PHVA
    const fechaEjecucionInput = document.getElementById('fechaEjecucion');
    if (fechaEjecucionInput) {
        fechaEjecucionInput.style.borderColor = '';
        fechaEjecucionInput.style.borderWidth = '';
        fechaEjecucionInput.title = '';
        fechaEjecucionInput.removeAttribute('min');
        fechaEjecucionInput.removeAttribute('max');
    }
    const fechaEjecucionCorrectivaInput = document.getElementById('fechaEjecucionCorrectiva');
    if (fechaEjecucionCorrectivaInput) {
        fechaEjecucionCorrectivaInput.style.borderColor = '';
        fechaEjecucionCorrectivaInput.style.borderWidth = '';
        fechaEjecucionCorrectivaInput.title = '';
        fechaEjecucionCorrectivaInput.removeAttribute('min');
        fechaEjecucionCorrectivaInput.removeAttribute('max');
    }

    // Remover elementos de validaci√≥n
    document.querySelectorAll('.info-limite-calendario, .mensaje-validacion-calendario, .info-limite-actividad, .mensaje-validacion-actividad').forEach(el => el.remove());

    // Reconfigurar l√≠mites despu√©s de limpiar
    setTimeout(() => {
        if (typeof aplicarLimitesCalendario === 'function') {
            aplicarLimitesCalendario();
        }
        if (typeof aplicarLimitesActividadesPHVA === 'function') {
            aplicarLimitesActividadesPHVA();
        }
    }, 100);
}

// Funci√≥n para validar fechas del formulario
function validarFechas() {
    const fechaApertura = new Date(document.getElementById('fechaAperturaPa').value);
    const fechaCierre = new Date(document.getElementById('fechaCierrePa').value);
    const tipoAccion = document.getElementById('tipoAccionPa').value;

    if (fechaCierre <= fechaApertura) {
        alert('La fecha de cierre debe ser posterior a la fecha de apertura');
        return false;
    }

    // Validar plazos seg√∫n tipo de acci√≥n
    const diffMeses = (fechaCierre.getFullYear() - fechaApertura.getFullYear()) * 12 +
                      (fechaCierre.getMonth() - fechaApertura.getMonth());

    if (tipoAccion === 'Correctiva' && diffMeses > 3) {
        alert('Las acciones correctivas no pueden tener plazo mayor a 3 meses');
        return false;
    }

    if ((tipoAccion === 'Preventiva' || tipoAccion === 'Mejora') && diffMeses > 6) {
        alert('Las acciones preventivas y de mejora no pueden tener plazo mayor a 6 meses');
        return false;
    }

    return true;
}

async function subirAdjuntosAnalisisCausas(codigo, tipo, archivos) {
    if (!codigo || !tipo || !archivos || archivos.length === 0) {
        return;
    }

    try {
        const formData = new FormData();
        archivos.forEach(file => {
            formData.append('files', file);
        });

        const response = await fetch(`/sgi/analisis-causas?codigo=${encodeURIComponent(codigo)}&tipo=${encodeURIComponent(tipo)}`, {
            method: 'POST',
            body: formData
        });
        const resultado = await response.json();
        if (!resultado.success) {
            throw new Error(resultado.mensaje || 'No se pudieron subir los adjuntos.');
        }

        const resultados = resultado.resultados || [];
        const fallidos = resultados.filter(item => !item.ok);
        if (fallidos.length === resultados.length) {
            const mensaje = fallidos[0]?.mensaje || 'No se pudieron subir los adjuntos.';
            throw new Error(mensaje);
        }
        if (fallidos.length) {
            Toast.warning('Algunos adjuntos no se pudieron subir.');
        } else {
            Toast.success('Adjuntos de analisis de causas cargados correctamente');
        }
    } catch (error) {
        Toast.error(`Error al subir adjuntos: ${error.message}`);
    }
}

// Funci√≥n para crear proceso PA desde el modal
async function crearProcesoPA() {
    // Validar fechas b√°sicas
    if (!validarFechas()) {
        return;
    }

    // Validar l√≠mites del calendario
    const fechaCierreInput = document.getElementById('fechaCierrePa');
    if (fechaCierreInput) {
        const fechaMin = fechaCierreInput.getAttribute('min');
        const fechaMax = fechaCierreInput.getAttribute('max');
        const fechaSeleccionada = fechaCierreInput.value;

        if (fechaSeleccionada && fechaMin && fechaMax) {
            const fecha = new Date(fechaSeleccionada);
            const min = new Date(fechaMin);
            const max = new Date(fechaMax);

            if (fecha < min || fecha > max) {
                alert('Error: La fecha de cierre objetivo no cumple con los l√≠mites establecidos para este tipo de acci√≥n.');
                return;
            }
        }
    }

    // Validar campos obligatorios con verificaciones mejoradas
    const elementos = {
        procesoPa: verificarElementoDOM('procesoPa', 'Campo Proceso'),
        subprocesoPa: verificarElementoDOM('subprocesoPa', 'Campo Subproceso'),
        copPa: verificarElementoDOM('copPa', 'Campo COP'),
        tipoAccionPa: verificarElementoDOM('tipoAccionPa', 'Campo Tipo de acci√≥n'),
        estadoPa: verificarElementoDOM('estadoPa', 'Campo Estado'),
        fechaAperturaPa: verificarElementoDOM('fechaAperturaPa', 'Campo Fecha apertura'),
        fechaCierrePa: verificarElementoDOM('fechaCierrePa', 'Campo Fecha cierre'),
        responsablePa: verificarElementoDOM('responsablePa', 'Campo Responsable'),
        hallazgoPa: verificarElementoDOM('hallazgoPa', 'Campo Hallazgo'),
        causaRaizPa: verificarElementoDOM('causaRaizPa', 'Campo Causa ra√≠z')
    };

    // Verificar que todos los elementos existen
    const elementosFaltantes = Object.entries(elementos).filter(([key, elem]) => !elem);
    if (elementosFaltantes.length > 0) {
        console.error('‚ùå Elementos del formulario no encontrados:', elementosFaltantes.map(([key]) => key));
        alert('Error interno: No se pudieron encontrar todos los campos del formulario. Verifique que el modal est√© completamente cargado.');
        return;
    }

    console.log('‚úÖ Todos los elementos del formulario encontrados correctamente');

    // Obtener valores de los campos
    const procesoPaValue = elementos.procesoPa.value.trim();
    const subprocesoPaValue = elementos.subprocesoPa.value.trim();
    const copPaValue = elementos.copPa.value.trim();
    const tipoAccionPaValue = elementos.tipoAccionPa.value;
    const estadoPaValue = elementos.estadoPa.value;
    const fechaAperturaPaValue = elementos.fechaAperturaPa.value;
    const fechaCierrePaValue = elementos.fechaCierrePa.value;
    const responsablePaValue = elementos.responsablePa.value.trim();
    const hallazgoPaValue = elementos.hallazgoPa.value.trim();
    const causaRaizPaValue = elementos.causaRaizPa.value.trim();

    // Validar campos obligatorios
    // NOTA: subproceso es opcional si el proceso no tiene subprocesos (valor 'N/A')
    const subprocesoRequerido = subprocesoPaValue !== 'N/A';

    if (!procesoPaValue || !copPaValue || !tipoAccionPaValue ||
        !estadoPaValue || !fechaAperturaPaValue || !fechaCierrePaValue ||
        !responsablePaValue ||
        !hallazgoPaValue || !causaRaizPaValue) {
        alert('Por favor complete todos los campos obligatorios (marcados con *)');
        return;
    }

    // Validar subproceso solo si es requerido
    if (subprocesoRequerido && !subprocesoPaValue) {
        alert('Por favor seleccione un subproceso');
        return;
    }

    // üî¥ VALIDACI√ìN: Al menos una actividad (correctiva O PHVA) es OBLIGATORIA
    const totalActividades = actividadesCorrectivas.length + actividadesPHVA.length;

    if (totalActividades === 0) {
        alert('‚ö†Ô∏è Debe agregar al menos una actividad para crear el Plan de Acci√≥n.\n\n' +
              '‚Ä¢ Si seleccion√≥ "Correctiva", agregue actividades correctivas\n' +
              '‚Ä¢ Tambi√©n puede agregar actividades PHVA normales\n' +
              '‚Ä¢ Al menos un tipo de actividad es obligatorio.');
        return;
    }

    console.log(`‚úÖ Total de actividades: ${totalActividades} (Correctivas: ${actividadesCorrectivas.length}, PHVA: ${actividadesPHVA.length})`);

    // üî¥ COMBINAR ACTIVIDADES CORRECTIVAS Y PHVA EN UN SOLO ARRAY
    const todasLasActividades = [...actividadesCorrectivas, ...actividadesPHVA];

    // Validar fechas de TODAS las actividades
    const fechaApertura = new Date(fechaAperturaPaValue);
    const fechaCierre = new Date(fechaCierrePaValue);

    for (let i = 0; i < todasLasActividades.length; i++) {
        const actividad = todasLasActividades[i];
        const fechaActividad = new Date(actividad.fecha_ejecucion);

        if (fechaActividad < fechaApertura) {
            alert('Error: La actividad "' + actividad.descripcion + '" tiene una fecha cierre (' + actividad.fecha_ejecucion + ') anterior a la fecha de apertura del PA (' + fechaAperturaPaValue + ')');
            return;
        }

        if (fechaActividad > fechaCierre) {
            alert('Error: La actividad "' + actividad.descripcion + '" tiene una fecha cierre (' + actividad.fecha_ejecucion + ') posterior a la fecha de cierre objetivo del PA (' + fechaCierrePaValue + ')');
            return;
        }
    }

    // Recopilar datos del formulario
    const datos = {
        proceso: procesoPaValue,
        subproceso: subprocesoPaValue,
        cop: copPaValue,
        tipo_accion: tipoAccionPaValue,
        estado: estadoPaValue,
        fecha_apertura: fechaAperturaPaValue,
        fecha_cierre: fechaCierrePaValue,
        fuente: document.getElementById('fuentePa')?.value || null,
        hallazgo: hallazgoPaValue,
        causa_raiz: causaRaizPaValue,
        responsable: responsablePaValue,
        observaciones: null,
        actividades_phva: todasLasActividades // üî¥ ENVIAR TODAS LAS ACTIVIDADES (correctivas + PHVA)
    };

    // LOG DE DEPURACI√ìN
    console.log('=== DATOS A ENVIAR ===');
    console.log('Actividades Correctivas:', actividadesCorrectivas.length);
    console.log('Actividades PHVA:', actividadesPHVA.length);
    console.log('Total actividades combinadas:', todasLasActividades.length);
    console.log('Datos completos:', datos);

    try {
        console.log('üì§ Enviando solicitud para crear PA...');

        // Llamar al endpoint espec√≠fico para planes de acci√≥n
        const response = await fetch('/sgi/planes-accion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(datos)
        });

        console.log(`üì° Respuesta del servidor - Status: ${response.status} ${response.statusText}`);

        // Verificar si la respuesta es exitosa (status 200-299)
        if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Error del servidor:', errorText);
            throw new Error(`Error del servidor (${response.status}): ${errorText}`);
        }

        const resultado = await response.json();
        console.log('üì• Resultado parseado:', resultado);

        if (resultado.success) {
            console.log('‚úÖ PA creado exitosamente:', resultado.codigo);

            const adjuntosInput = document.getElementById('adjuntosCausas');
            const adjuntosSeleccionados = adjuntosInput ? Array.from(adjuntosInput.files || []) : [];

            // Cerrar modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalCrearPA'));
            modal.hide();

            // Construir mensaje de √©xito con detalles
            let mensaje = '‚úÖ Plan de Acci√≥n creado exitosamente!\n\n' +
                          'C√≥digo: ' + resultado.codigo + '\n' +
                          'Proceso: ' + datos.proceso + '\n' +
                          'Tipo de acci√≥n: ' + datos.tipo_accion + '\n';

            if (actividadesCorrectivas.length > 0) {
                mensaje += 'Actividades Correctivas: ' + actividadesCorrectivas.length + '\n';
            }

            if (actividadesPHVA.length > 0) {
                mensaje += 'Actividades PHVA: ' + actividadesPHVA.length + '\n';
            }

            mensaje += 'Total actividades: ' + todasLasActividades.length;

            // Mostrar mensaje de √©xito
            alert(mensaje);

            if (adjuntosSeleccionados.length) {
                await subirAdjuntosAnalisisCausas(resultado.codigo, 'PA', adjuntosSeleccionados);
            }

            // Limpiar formulario
            limpiarFormularioPA();

            await asegurarRegistroVisible({ codigo: resultado.codigo, tipoGestion: 'PA' });
        } else {
            // El servidor respondi√≥ pero con success: false
            console.error('‚ùå Error en la respuesta:', resultado);
            const mensajeError = resultado.mensaje || resultado.error || 'Error desconocido al crear el PA';
            alert('‚ùå ' + mensajeError);
        }
    } catch (error) {
        console.error('‚ùå Error al crear PA:', error);
        alert('‚ùå Error al crear PA: ' + error.message);
    }
}

// Configuraci√≥n inicial del modal (evitar duplicados)
document.addEventListener('DOMContentLoaded', function() {
    // Configurar eventos del modal una sola vez
    const modalCrearPA = document.getElementById('modalCrearPA');
    if (modalCrearPA && !modalCrearPA.hasAttribute('data-events-configured')) {
        modalCrearPA.addEventListener('shown.bs.modal', function () {
            // Establecer fecha de apertura como hoy cuando se abre el modal
            const fechaApertura = document.getElementById('fechaAperturaPa');
            if (fechaApertura && !fechaApertura.value) {
                const hoy = new Date().toISOString().split('T')[0];
                fechaApertura.value = hoy;
            }

            // NOTA: Las actividades son OBLIGATORIAS - No necesitan checkbox
        });

        modalCrearPA.addEventListener('hidden.bs.modal', function () {
            // Limpiar formulario cuando se cierra el modal
            limpiarFormularioPA();
        });

        // üî¥ EVENT LISTENER: Mostrar/Ocultar secci√≥n de actividades correctivas
        const tipoAccionSelect = document.getElementById('tipoAccionPa');
        if (tipoAccionSelect) {
            tipoAccionSelect.addEventListener('change', function() {
                const seccionCorrectivas = document.getElementById('seccionActividadesCorrectivas');

                if (this.value === 'Correctiva') {
                    // Mostrar secci√≥n de actividades correctivas
                    if (seccionCorrectivas) {
                        seccionCorrectivas.style.display = 'block';
                        console.log('‚úÖ Secci√≥n de actividades correctivas mostrada');
                    }
                } else {
                    // Ocultar secci√≥n de actividades correctivas
                    if (seccionCorrectivas) {
                        seccionCorrectivas.style.display = 'none';
                        console.log('‚ùå Secci√≥n de actividades correctivas ocultada');
                    }
                }
            });
        }

        // Marcar como configurado
        modalCrearPA.setAttribute('data-events-configured', 'true');
    }

    // Configurar eventos del modal GC una sola vez
    const modalGestionCambio = document.getElementById('modalGestionCambio');
    if (modalGestionCambio && !modalGestionCambio.hasAttribute('data-events-configured')) {
        modalGestionCambio.addEventListener('shown.bs.modal', function () {
            // Establecer fecha de apertura como hoy cuando se abre el modal (usando fecha local)
            const fechaAperturaGc = document.getElementById('fechaAperturaGc');
            if (fechaAperturaGc && !fechaAperturaGc.value) {
                const hoy = obtenerFechaLocal();
                fechaAperturaGc.value = hoy;
            }
        });

        modalGestionCambio.addEventListener('hidden.bs.modal', function () {
            // Limpiar formulario cuando se cierra el modal
            limpiarFormularioGC();
        });

        // Marcar como configurado
        modalGestionCambio.setAttribute('data-events-configured', 'true');
    }

    // Configurar eventos del modal RVD una sola vez
    const modalCrearRVD = document.getElementById('modalCrearRVD');
    if (modalCrearRVD && !modalCrearRVD.hasAttribute('data-events-configured')) {
        modalCrearRVD.addEventListener('shown.bs.modal', function () {
            // Establecer fecha de apertura como hoy cuando se abre el modal (usando fecha local)
            const fechaAperturaRvd = document.getElementById('fechaAperturaRvd');
            if (fechaAperturaRvd && !fechaAperturaRvd.value) {
                const hoy = obtenerFechaLocal();
                fechaAperturaRvd.value = hoy;
            }
        });

        modalCrearRVD.addEventListener('hidden.bs.modal', function () {
            // Limpiar formulario cuando se cierra el modal
            limpiarFormularioRVD();
        });

        // Marcar como configurado
        modalCrearRVD.setAttribute('data-events-configured', 'true');
    }
});// Cargar datos iniciales cuando se carga la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Cargar autom√°ticamente todos los datos al inicializar la p√°gina
    console.log('üöÄ P√°gina SGI cargada - Cargando todos los datos autom√°ticamente');

    // Cargar todos los datos inicialmente (sin filtro de tipo de gesti√≥n)
    setTimeout(() => {
        cargarDatosPorTipoGestion('');
    }, 500); // Peque√±o delay para asegurar que el DOM est√© completamente cargado

    // ==================== LIMITACI√ìN DE CALENDARIO FECHA CIERRE OBJETIVO ====================

    // Configuraci√≥n de plazos m√°ximos por tipo de acci√≥n (en d√≠as calendario)
    const PLAZOS_MAXIMOS = {
        'Correctiva': 120,  // 4 meses
        'Preventiva': 180,  // 6 meses
        'Mejora': 180       // 6 meses
    };

    // Funci√≥n para aplicar l√≠mites al calendario (con verificaciones adicionales)
    function aplicarLimitesCalendario() {
        // Buscar campos del modal Crear PA con verificaci√≥n adicional
        const tipoAccionSelect = document.getElementById('tipoAccionPa');
        const fechaAperturaInput = document.getElementById('fechaAperturaPa');
        const fechaCierreInput = document.getElementById('fechaCierrePa');

        if (!tipoAccionSelect || !fechaAperturaInput || !fechaCierreInput) {
            console.warn('Campos del modal PA no encontrados. Verificando estado del modal...');

            // Verificar si el modal existe
            const modal = document.getElementById('modalCrearPA');
            if (!modal) {
                console.warn('Modal modalCrearPA no encontrado en el DOM');
                return false;
            }

            // Si el modal existe pero los campos no, puede ser un problema de timing
            console.warn('Modal existe pero campos no encontrados, reintentando en 100ms...');
            setTimeout(aplicarLimitesCalendario, 100);
            return false;
        }

        console.log('Campos encontrados para limitaci√≥n de calendario');

        // Verificar que no se hayan agregado event listeners anteriormente
        if (tipoAccionSelect.hasAttribute('data-calendar-listeners')) {
            console.log('Event listeners de calendario ya configurados');
            return true;
        }

        // Funci√≥n interna para actualizar l√≠mites
        function actualizarLimitesFecha() {
            const tipoAccion = tipoAccionSelect.value;
            const fechaApertura = fechaAperturaInput.value;

            console.log('Actualizando l√≠mites - Tipo:', tipoAccion, 'Fecha apertura:', fechaApertura);

            // Limpiar l√≠mites previos
            fechaCierreInput.removeAttribute('min');
            fechaCierreInput.removeAttribute('max');

            if (!tipoAccion || !fechaApertura) {
                console.log('Faltan datos para establecer l√≠mites');
                return;
            }

            // Establecer fecha m√≠nima (fecha de apertura)
            fechaCierreInput.setAttribute('min', fechaApertura);

            // Calcular fecha m√°xima seg√∫n el tipo de acci√≥n
            const diasMaximos = PLAZOS_MAXIMOS[tipoAccion];
            if (diasMaximos) {
                const fechaInicio = new Date(fechaApertura);
                const fechaMaxima = new Date(fechaInicio);
                fechaMaxima.setDate(fechaMaxima.getDate() + diasMaximos);

                // Formatear para input date (YYYY-MM-DD)
                const fechaMaximaStr = fechaMaxima.toISOString().split('T')[0];
                fechaCierreInput.setAttribute('max', fechaMaximaStr);

                console.log(`L√≠mites aplicados: min=${fechaApertura}, max=${fechaMaximaStr} (${diasMaximos} d√≠as)`);

                // Mostrar informaci√≥n visual del l√≠mite
                mostrarInformacionLimite(fechaCierreInput, tipoAccion, fechaMaximaStr, diasMaximos);

                // Validar fecha actual si ya tiene valor
                if (fechaCierreInput.value) {
                    validarFechaSeleccionada(fechaCierreInput);
                }
            }
        }

        // Funci√≥n para mostrar informaci√≥n del l√≠mite
        function mostrarInformacionLimite(campo, tipo, fechaMax, dias) {
            // Remover informaci√≥n anterior
            const infoAnterior = campo.parentNode.querySelector('.info-limite-calendario');
            if (infoAnterior) {
                infoAnterior.remove();
            }

            // Crear elemento informativo
            const infoElement = document.createElement('small');
            infoElement.className = 'info-limite-calendario text-muted d-block mt-1';
            infoElement.style.fontSize = '11px';

            const meses = dias === 120 ? '4 meses' : '6 meses';
            infoElement.innerHTML = `
                üìÖ <strong>L√≠mite para ${tipo.toLowerCase()}s:</strong> ${fechaMax} (${meses} - ${dias} d√≠as m√°ximo)
            `;

            campo.parentNode.appendChild(infoElement);
        }

        // Funci√≥n para validar fecha seleccionada
        function validarFechaSeleccionada(campo) {
            const fechaSeleccionada = campo.value;
            const fechaMinima = campo.getAttribute('min');
            const fechaMaxima = campo.getAttribute('max');

            // Remover mensajes anteriores
            const mensajeAnterior = campo.parentNode.querySelector('.mensaje-validacion-calendario');
            if (mensajeAnterior) {
                mensajeAnterior.remove();
            }

            if (!fechaSeleccionada) {
                campo.style.borderColor = '';
                return true;
            }

            const fecha = new Date(fechaSeleccionada);
            const fechaMin = fechaMinima ? new Date(fechaMinima) : null;
            const fechaMax = fechaMaxima ? new Date(fechaMaxima) : null;

            // Crear elemento para mensaje
            const mensajeElement = document.createElement('div');
            mensajeElement.className = 'mensaje-validacion-calendario mt-1';
            mensajeElement.style.fontSize = '12px';
            mensajeElement.style.fontWeight = 'bold';

            let esValida = true;

            if (fechaMin && fecha < fechaMin) {
                mensajeElement.innerHTML = `
                    <span style="color: #dc3545;">
                        ‚ö†Ô∏è La fecha no puede ser anterior a la fecha de apertura
                    </span>
                `;
                campo.style.borderColor = '#dc3545';
                esValida = false;
            } else if (fechaMax && fecha > fechaMax) {
                const tipoAccion = tipoAccionSelect.value;
                mensajeElement.innerHTML = `
                    <span style="color: #dc3545;">
                        ‚ùå Excede el l√≠mite m√°ximo para acciones ${tipoAccion.toLowerCase()}s
                    </span>
                `;
                campo.style.borderColor = '#dc3545';
                esValida = false;
            } else {
                const diasUsados = fechaMin ? Math.ceil((fecha - fechaMin) / (1000 * 60 * 60 * 24)) : 0;
                const tipoAccion = tipoAccionSelect.value;
                const diasMaximos = PLAZOS_MAXIMOS[tipoAccion] || 0;

                mensajeElement.innerHTML = `
                    <span style="color: #28a745;">
                        ‚úÖ Fecha v√°lida: ${diasUsados} d√≠as de ${diasMaximos} d√≠as permitidos
                    </span>
                `;
                campo.style.borderColor = '#28a745';
            }

            campo.parentNode.appendChild(mensajeElement);
            return esValida;
        }

        // Agregar event listeners solo si no se han a√±adido antes
        if (!tipoAccionSelect.hasAttribute('data-calendar-listeners')) {
            tipoAccionSelect.addEventListener('change', actualizarLimitesFecha);
            fechaAperturaInput.addEventListener('change', actualizarLimitesFecha);
            fechaCierreInput.addEventListener('change', function() {
                validarFechaSeleccionada(this);
            });

            // Marcar como configurado
            tipoAccionSelect.setAttribute('data-calendar-listeners', 'true');
            console.log('Event listeners de calendario configurados');
        }

        // Aplicar l√≠mites inmediatamente si ya hay valores
        if (tipoAccionSelect.value && fechaAperturaInput.value) {
            actualizarLimitesFecha();
        }

        return true;
    }

    // Configurar cuando se abra el modal (con verificaci√≥n de duplicados)
    const modalCrearPACalendar = document.getElementById('modalCrearPA');
    if (modalCrearPACalendar && !modalCrearPACalendar.hasAttribute('data-calendar-configured')) {
        modalCrearPACalendar.addEventListener('shown.bs.modal', function() {
            console.log('Modal Crear PA abierto, configurando l√≠mites...');
            setTimeout(() => {
                if (typeof aplicarLimitesCalendario === 'function') {
                    aplicarLimitesCalendario();
                }
            }, 150);
        });
        modalCrearPACalendar.setAttribute('data-calendar-configured', 'true');
    }

    // Tambi√©n intentar configurar inmediatamente si el modal ya est√° en el DOM
    if (document.readyState === 'complete') {
        setTimeout(() => {
            if (typeof aplicarLimitesCalendario === 'function') {
                aplicarLimitesCalendario();
            }
        }, 500);
    }

    console.log('Sistema de limitaci√≥n de calendario inicializado ‚úÖ');

    // ==================== LIMITACI√ìN DE FECHAS PARA ACTIVIDADES PHVA ====================

    // Funci√≥n para aplicar l√≠mites a las fechas de actividades PHVA (con verificaciones)
    function aplicarLimitesActividadesPHVA() {
        const fechaAperturaInput = document.getElementById('fechaAperturaPa');
        const fechaCierreInput = document.getElementById('fechaCierrePa');
        const fechaEjecucionInput = document.getElementById('fechaEjecucion');
        const fechaEjecucionCorrectivaInput = document.getElementById('fechaEjecucionCorrectiva');
        const fechaEjecucionInputs = [fechaEjecucionInput, fechaEjecucionCorrectivaInput].filter(Boolean);

        if (!fechaAperturaInput || !fechaCierreInput || fechaEjecucionInputs.length === 0) {
            console.warn('Campos de actividades PHVA no encontrados completamente');

            // Verificar si el modal y las actividades est√°n visibles
            const modal = document.getElementById('modalCrearPA');
            const actividadesSection = document.getElementById('actividadesPHVA');

            if (!modal) {
                console.warn('Modal modalCrearPA no encontrado');
                return false;
            }

            if (!actividadesSection || actividadesSection.style.display === 'none') {
                console.log('Secci√≥n de actividades PHVA no visible, saltando configuraci√≥n');
                return false;
            }

            console.warn('Reintentando configuraci√≥n de l√≠mites de actividades en 100ms...');
            setTimeout(aplicarLimitesActividadesPHVA, 100);
            return false;
        }

        console.log('Campos de actividades PHVA encontrados');

        // Funci√≥n para actualizar l√≠mites de actividades
        function actualizarLimitesActividades() {
            const fechaApertura = fechaAperturaInput.value;
            const fechaCierre = fechaCierreInput.value;

            console.log('Actualizando l√≠mites actividades - Apertura:', fechaApertura, 'Cierre:', fechaCierre);

            // Limpiar l√≠mites previos
            fechaEjecucionInputs.forEach(campo => {
                campo.removeAttribute('min');
                campo.removeAttribute('max');
            });

            if (!fechaApertura) {
                console.log('Fecha de apertura no definida, no se pueden establecer l√≠mites para actividades');
                return;
            }

            // La fecha m√≠nima es la fecha de apertura del PA
            fechaEjecucionInputs.forEach(campo => {
                campo.setAttribute('min', fechaApertura);

            // La fecha m√°xima es la fecha de cierre objetivo (si est√° definida)
            if (fechaCierre) {
                campo.setAttribute('max', fechaCierre);
                console.log(`L√≠mites actividades aplicados: min=${fechaApertura}, max=${fechaCierre}`);

                // Mostrar informaci√≥n visual del l√≠mite
                mostrarInformacionLimiteActividad(campo, fechaApertura, fechaCierre);
            } else {
                console.log(`Solo l√≠mite m√≠nimo aplicado: min=${fechaApertura}`);
                mostrarInformacionLimiteActividad(campo, fechaApertura, null);
            }

            // Validar fecha actual si ya tiene valor
            if (campo.value) {
                validarFechaActividad(campo);
            }
            });
        }

        // Funci√≥n para mostrar informaci√≥n del l√≠mite de actividades
        function mostrarInformacionLimiteActividad(campo, fechaMin, fechaMax) {
            // NO agregar elementos visuales que afecten el layout
            // Solo establecer el t√≠tulo del campo para mostrar informaci√≥n
            if (fechaMax) {
                campo.title = `Periodo v√°lido: del ${fechaMin} al ${fechaMax}`;
            } else {
                campo.title = `Fecha m√≠nima: ${fechaMin} (fecha apertura PA)`;
            }
        }

        // Funci√≥n para validar fecha de actividad
        function validarFechaActividad(campo) {
            const fechaSeleccionada = campo.value;
            const fechaMinima = campo.getAttribute('min');
            const fechaMaxima = campo.getAttribute('max');

            // Limpiar cualquier elemento previo que pueda afectar el layout
            const elementosAnteriores = campo.parentNode.querySelectorAll('.mensaje-validacion-actividad, .info-limite-actividad');
            elementosAnteriores.forEach(el => el.remove());

            if (!fechaSeleccionada) {
                campo.style.borderColor = '';
                campo.title = '';
                return true;
            }

            const fecha = new Date(fechaSeleccionada);
            const fechaMin = fechaMinima ? new Date(fechaMinima) : null;
            const fechaMax = fechaMaxima ? new Date(fechaMaxima) : null;

            let esValida = true;

            if (fechaMin && fecha < fechaMin) {
                campo.style.borderColor = '#dc3545';
                campo.style.borderWidth = '2px';
                campo.title = `‚ö†Ô∏è La fecha no puede ser anterior a la apertura del PA (${fechaMinima})`;
                esValida = false;
            } else if (fechaMax && fecha > fechaMax) {
                campo.style.borderColor = '#dc3545';
                campo.style.borderWidth = '2px';
                campo.title = `‚ùå La fecha no puede ser posterior al cierre objetivo del PA (${fechaMaxima})`;
                esValida = false;
            } else {
                campo.style.borderColor = '#28a745';
                campo.style.borderWidth = '2px';
                campo.title = '‚úÖ Fecha v√°lida dentro del periodo del PA';
            }

            return esValida;
        }

        // Agregar event listeners solo si no se han a√±adido antes
        if (!fechaAperturaInput.hasAttribute('data-activity-limits')) {
            fechaAperturaInput.addEventListener('change', actualizarLimitesActividades);
            fechaCierreInput.addEventListener('change', actualizarLimitesActividades);
            fechaAperturaInput.setAttribute('data-activity-limits', 'true');
        }

        fechaEjecucionInputs.forEach(campo => {
            if (campo.hasAttribute('data-activity-listeners')) {
                return;
            }
            campo.addEventListener('change', function() {
                validarFechaActividad(this);
            });

            // Marcar como configurado
            campo.setAttribute('data-activity-listeners', 'true');
            console.log('Event listeners de actividades configurados');
        });

        // Aplicar l√≠mites inmediatamente si ya hay valores
        actualizarLimitesActividades();

        return true;
    }

    // Funci√≥n para aplicar l√≠mites a actividades din√°micamente agregadas
    function aplicarLimitesActividadDinamica(fechaEjecucionElement) {
        const fechaAperturaInput = document.getElementById('fechaAperturaPa');
        const fechaCierreInput = document.getElementById('fechaCierrePa');

        if (!fechaAperturaInput || !fechaEjecucionElement) {
            return;
        }

        const fechaApertura = fechaAperturaInput.value;
        const fechaCierre = fechaCierreInput.value;

        if (fechaApertura) {
            fechaEjecucionElement.setAttribute('min', fechaApertura);
        }

        if (fechaCierre) {
            fechaEjecucionElement.setAttribute('max', fechaCierre);
        }

        // Agregar validaci√≥n en tiempo real
        fechaEjecucionElement.addEventListener('change', function() {
            validarFechaActividadDinamica(this);
        });
    }

    // Funci√≥n de validaci√≥n para actividades din√°micas
    function validarFechaActividadDinamica(campo) {
        const fechaSeleccionada = campo.value;
        const fechaMinima = campo.getAttribute('min');
        const fechaMaxima = campo.getAttribute('max');

        if (!fechaSeleccionada) {
            campo.style.borderColor = '';
            return true;
        }

        const fecha = new Date(fechaSeleccionada);
        const fechaMin = fechaMinima ? new Date(fechaMinima) : null;
        const fechaMax = fechaMaxima ? new Date(fechaMaxima) : null;

        let esValida = true;

        if (fechaMin && fecha < fechaMin) {
            campo.style.borderColor = '#dc3545';
            campo.title = `No puede ser anterior a la apertura del PA (${fechaMinima})`;
            esValida = false;
        } else if (fechaMax && fecha > fechaMax) {
            campo.style.borderColor = '#dc3545';
            campo.title = `No puede ser posterior al cierre objetivo del PA (${fechaMaxima})`;
            esValida = false;
        } else {
            campo.style.borderColor = '#28a745';
            campo.title = 'Fecha v√°lida dentro del periodo del PA';
        }

        return esValida;
    }

    // Configurar cuando se abra el modal y se muestren las actividades (evitar duplicados)
    const modalCrearPAActividades = document.getElementById('modalCrearPA');
    if (modalCrearPAActividades && !modalCrearPAActividades.hasAttribute('data-activities-configured')) {
        modalCrearPAActividades.addEventListener('shown.bs.modal', function() {
            console.log('Modal Crear PA abierto, configurando l√≠mites de actividades...');
            setTimeout(() => {
                if (typeof aplicarLimitesActividadesPHVA === 'function') {
                    aplicarLimitesActividadesPHVA();
                }
            }, 200);
        });

        // NOTA: Las actividades son OBLIGATORIAS - Siempre est√°n activas
        // Se aplican l√≠mites autom√°ticamente cuando se abre el modal

        modalCrearPAActividades.setAttribute('data-activities-configured', 'true');
    }

    console.log('Sistema de limitaci√≥n de fechas para actividades PHVA inicializado ‚úÖ');

    // ==================== GESTI√ìN DE PROCESOS Y SUBPROCESOS ====================

    // Funci√≥n para cargar procesos desde el servidor
    async function cargarProcesos() {
        try {
            const response = await fetch('/sgi/procesos-lista');
            const data = await response.json();

            if (data.success) {
                datosProcesos = data.procesos;
                actualizarMapaProcesos();
                console.log('Procesos cargados:', datosProcesos.length);

                // Llenar los selectores de procesos
                llenarSelectProcesos();
            } else {
                console.error('Error al cargar procesos:', data.mensaje);
            }
        } catch (error) {
            console.error('Error al cargar procesos:', error);
        }
    }

    // Funci√≥n para cargar subprocesos desde el servidor
    async function cargarSubprocesos() {
        try {
            const response = await fetch('/sgi/subprocesos-lista');
            const data = await response.json();

            if (data.success) {
                datosSubprocesos = data.subprocesos;
                actualizarMapaSubprocesos();
                console.log('Subprocesos cargados:', datosSubprocesos.length);
            } else {
                console.error('Error al cargar subprocesos:', data.mensaje);
            }
        } catch (error) {
            console.error('Error al cargar subprocesos:', error);
        }
    }

    // Funci√≥n para cargar COPs √∫nicos desde el servidor
    async function cargarCOPs() {
        try {
            const response = await fetch('/sgi/cops-lista');
            const data = await response.json();

            if (data.success) {
                console.log('COPs cargados:', data.cops.length);

                // Llenar selector COP del modal crear PA
                llenarSelectCOPs(data.cops);
            } else {
                console.error('Error al cargar COPs:', data.mensaje);
            }
        } catch (error) {
            console.error('Error al cargar COPs:', error);
        }
    }

    // Funci√≥n para llenar el selector de COPs
    function llenarSelectCOPs(cops) {
        const selectores = [
            document.getElementById('copPa'),  // Modal crear PA
            document.getElementById('copGc'),  // Modal crear GC
            document.getElementById('copRvd'),  // Modal crear RVD
            document.getElementById('adminRegistroCop') // Admin registro
        ];

        selectores.forEach(select => {
            if (select) {
                const selectedValue = select.value;
                // Limpiar opciones existentes excepto la primera
                while (select.options.length > 1) {
                    select.removeChild(select.lastChild);
                }

                // Agregar opciones de COPs
                cops.forEach(cop => {
                    const option = document.createElement('option');
                    option.value = cop;
                    option.textContent = cop;
                    select.appendChild(option);
                });

                if (selectedValue) {
                    asegurarOpcionSelect(select, selectedValue, selectedValue);
                    select.value = selectedValue;
                }
            }
        });

        console.log('Selectores COP llenados con', cops.length, 'opciones');
    }

    // Funci√≥n para llenar los selectores de procesos
    function llenarSelectProcesos() {
        const selectores = [
            document.getElementById('procesoPa'), // Modal crear PA
            document.getElementById('procesoGc'), // Modal crear GC
            document.getElementById('procesoRvd'), // Modal crear RVD
            document.getElementById('filtroProceso'), // Filtros pendientes
            document.getElementById('fProceso'), // Filtros indicadores
            document.getElementById('adminRegistroProceso') // Admin registro
        ];

        selectores.forEach(select => {
            if (select) {
                const selectedValue = select.value;
                // Limpiar opciones existentes excepto la primera
                while (select.options.length > 1) {
                    select.removeChild(select.lastChild);
                }

                // Agregar opciones de procesos
                datosProcesos.forEach(proceso => {
                    const option = document.createElement('option');
                    option.value = proceso.codigo;
                    option.textContent = `${proceso.codigo} - ${proceso.nombre}`;
                    option.dataset.procesoId = proceso.id;
                    select.appendChild(option);
                });

                if (selectedValue) {
                    asegurarOpcionSelect(select, selectedValue, selectedValue);
                    select.value = selectedValue;
                }
            }
        });
    }

    // Funci√≥n para llenar los selectores de subprocesos seg√∫n el proceso seleccionado
    function llenarSelectSubprocesos(procesoId, targetSelectId) {
        const select = document.getElementById(targetSelectId);
        if (!select) return;

        // Limpiar opciones existentes excepto la primera
        while (select.options.length > 1) {
            select.removeChild(select.lastChild);
        }

        if (!procesoId) {
            // Si no hay proceso seleccionado, mantener subproceso como requerido
            select.required = true;
            const parentDiv = select.parentElement;
            const label = parentDiv.querySelector('label');
            if (label) {
                label.innerHTML = 'Subproceso *';
            }
            // Eliminar mensaje si existe
            const oldMessage = parentDiv.querySelector('.subproceso-na-message');
            if (oldMessage) {
                oldMessage.remove();
            }
            return;
        }

        // Filtrar subprocesos del proceso seleccionado
        const subprocesosFiltrados = datosSubprocesos.filter(sub => sub.proceso_id == procesoId);

        // Si no hay subprocesos, hacer el campo opcional
        if (subprocesosFiltrados.length === 0) {
            select.required = false;
            const parentDiv = select.parentElement;
            const label = parentDiv.querySelector('label');

            // Restaurar label original sin modificar el texto
            if (label) {
                label.innerHTML = 'Subproceso';  // Sin asterisco, solo texto simple
            }

            // Eliminar mensaje anterior si existe
            const oldMessage = parentDiv.querySelector('.subproceso-na-message');
            if (oldMessage) {
                oldMessage.remove();
            }

            // Agregar mensaje informativo debajo del select
            const message = document.createElement('small');
            message.className = 'text-muted subproceso-na-message';
            message.innerHTML = '<i class="fas fa-info-circle"></i> Este proceso no tiene subprocesos';
            select.parentNode.insertBefore(message, select.nextSibling);

            // Crear opci√≥n N/A y seleccionarla autom√°ticamente
            select.options[0].textContent = 'N/A - Sin subprocesos';
            select.options[0].value = 'N/A';
            select.value = 'N/A';  // ‚Üê SELECCIONAR AUTOM√ÅTICAMENTE
            select.selectedIndex = 0;
            select.disabled = false; // Asegurar que est√© habilitado
            console.log(`‚ö†Ô∏è Proceso ${procesoId} no tiene subprocesos - Campo opcional con valor N/A`);
        } else {
            // Si hay subprocesos, hacer el campo obligatorio
            select.required = true;
            const parentDiv = select.parentElement;
            const label = parentDiv.querySelector('label');

            // Restaurar label con asterisco
            if (label) {
                label.innerHTML = 'Subproceso *';
            }

            // Eliminar mensaje si existe
            const oldMessage = parentDiv.querySelector('.subproceso-na-message');
            if (oldMessage) {
                oldMessage.remove();
            }

            select.options[0].textContent = '-- Seleccione subproceso --';
            select.options[0].value = '';

            // Agregar opciones de subprocesos
            subprocesosFiltrados.forEach(subproceso => {
                const option = document.createElement('option');
                option.value = subproceso.codigo;
                option.textContent = `${subproceso.codigo} - ${subproceso.nombre}`;
                select.appendChild(option);
            });
        }

        console.log(`Subprocesos cargados para proceso ${procesoId}:`, subprocesosFiltrados.length);
    }

    if (!window.llenarSelectSubprocesos) {
        window.llenarSelectSubprocesos = llenarSelectSubprocesos;
    }

    // Event listener para cambio de proceso en modal crear PA
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'procesoPa') {
            const selectedOption = e.target.selectedOptions[0];
            const procesoId = selectedOption ? selectedOption.dataset.procesoId : null;
            console.log('üìå Proceso PA seleccionado, ID:', procesoId);
            llenarSelectSubprocesos(procesoId, 'subprocesoPa');
            actualizarCodigoPA(); // Actualizar c√≥digo cuando cambie proceso
        }
    });

    // Event listener para cambio de subproceso en modal crear PA
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'subprocesoPa') {
            actualizarCodigoPA(); // Actualizar c√≥digo cuando cambie subproceso
        }
    });

    // Event listener para cambio de proceso en modal crear GC
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'procesoGc') {
            const selectedOption = e.target.selectedOptions[0];
            const procesoId = selectedOption ? selectedOption.dataset.procesoId : null;
            llenarSelectSubprocesos(procesoId, 'subprocesoGc');
            actualizarCodigoGC(); // Actualizar c√≥digo cuando cambie proceso
        }
    });

    // Event listener para cambio de subproceso en modal crear GC
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'subprocesoGc') {
            actualizarCodigoGC(); // Actualizar c√≥digo cuando cambie subproceso
        }
    });

    // Event listeners para validar fecha cierre en GC (mismo patr√≥n que PA)
    document.addEventListener('change', function(e) {
        if (e.target && (e.target.id === 'fechaAperturaGc' || e.target.id === 'fechaCierreGc')) {
            actualizarLimitesFechaEjecucionGc();
        }
    });

    // Event listener para cambio de proceso en modal crear RVD
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'procesoRvd') {
            const selectedOption = e.target.selectedOptions[0];
            const procesoId = selectedOption ? selectedOption.dataset.procesoId : null;
            llenarSelectSubprocesos(procesoId, 'subprocesoRvd');
            actualizarCodigoRVD(); // Actualizar c√≥digo cuando cambie proceso
        }
    });

    // Event listener para cambio de subproceso en modal crear RVD
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'subprocesoRvd') {
            actualizarCodigoRVD(); // Actualizar c√≥digo cuando cambie subproceso
        }
    });

    // Event listener para cambio de proceso en filtros
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'filtroProceso') {
            const selectedOption = e.target.selectedOptions[0];
            const procesoId = selectedOption ? selectedOption.dataset.procesoId : null;
            llenarSelectSubprocesos(procesoId, 'filtroSubproceso');
        }
    });

    // Event listener para cambio de proceso en administrar registro
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'adminRegistroProceso') {
            const selectedOption = e.target.selectedOptions[0];
            const procesoId = selectedOption ? selectedOption.dataset.procesoId : null;
            llenarSelectSubprocesos(procesoId, 'adminRegistroSubproceso');
        }
    });

    // Event listener para cambio de proceso en filtros de indicadores
    document.addEventListener('change', function(e) {
        if (e.target && e.target.id === 'fProceso') {
            const selectedOption = e.target.selectedOptions[0];
            const procesoId = selectedOption ? selectedOption.dataset.procesoId : null;
            llenarSelectSubprocesos(procesoId, 'fSubproceso');
        }
    });

    // Cargar datos al inicializar
    setTimeout(async () => {
        await cargarProcesos();
        await cargarSubprocesos();
        await cargarCOPs();
        console.log('Sistema de procesos, subprocesos y COPs inicializado ‚úÖ');
    }, 500);

});

// Inicializar tooltips para botones modernos
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});

// Atajo de teclado para enfocar filtros
document.addEventListener('keydown', function(e) {
    if (e.key === 'f' && !e.ctrlKey && !e.altKey && !e.metaKey) {
        const activeElement = document.activeElement;
        if (activeElement.tagName !== 'INPUT' && activeElement.tagName !== 'TEXTAREA') {
            e.preventDefault();
            document.getElementById('filtroUsuario').focus();
        }
    }
});

// üîß Funciones para Gesti√≥n del Cambio (GC)

// Funci√≥n para agregar actividad en GC
function agregarActividadGC() {
    const etapa = document.getElementById('etapaGc').value;
    const nombreActividad = document.getElementById('nombreActividadGc').value;
    const descripcion = document.getElementById('descripcionActividadGc').value;
    const fechaEjecucion = document.getElementById('fechaEjecucionGc').value;
    const responsable = document.getElementById('responsableGc').value;

    if (!etapa || !nombreActividad || !descripcion || !fechaEjecucion || !responsable) {
        alert('Todos los campos son obligatorios para agregar una actividad');
        return;
    }

    // Validar que la fecha est√© dentro del periodo v√°lido del GC
    const fechaApertura = document.getElementById('fechaAperturaGc').value;
    const fechaCierre = document.getElementById('fechaCierreGc').value;

    if (fechaApertura && fechaEjecucion < fechaApertura) {
        alert(`La fecha cierre no puede ser anterior a la fecha de apertura del GC (${fechaApertura})`);
        return;
    }

    if (fechaCierre && fechaEjecucion > fechaCierre) {
        alert(`La fecha cierre no puede ser posterior a la fecha de cierre del GC (${fechaCierre})`);
        return;
    }

    const nuevaActividad = {
        id: Date.now(),
        etapa: etapa,
        nombre_actividad: nombreActividad,
        descripcion: descripcion,
        fecha_ejecucion: fechaEjecucion,
        responsable: responsable
    };

    actividadesGC.push(nuevaActividad);
    actualizarListaActividadesGC();

    // Limpiar campos (NO limpiar etapa para facilitar la entrada de m√∫ltiples actividades de la misma etapa)
    document.getElementById('nombreActividadGc').value = '';
    document.getElementById('descripcionActividadGc').value = '';
    document.getElementById('fechaEjecucionGc').value = '';
    document.getElementById('responsableGc').value = '';

    console.log('Actividad GC agregada:', nuevaActividad);
}

// Funci√≥n para actualizar la lista visual de actividades GC
function actualizarListaActividadesGC() {
    const container = document.getElementById('listaActividadesGC');
    container.innerHTML = '';

    if (actividadesGC.length === 0) {
        return;
    }

    const table = document.createElement('table');
    table.className = 'table table-sm table-bordered mb-3';
    table.innerHTML = `
        <thead class="table-light">
            <tr>
                <th style="width: 140px;">Etapa/Actividad</th>
                <th>Nombre Actividad</th>
                <th>Descripci√≥n</th>
                <th style="width: 130px;">Fecha cierre</th>
                <th style="width: 150px;">Responsable</th>
                <th style="width: 80px;">Acci√≥n</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;

    const tbody = table.querySelector('tbody');

    actividadesGC.forEach(actividad => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${actividad.etapa}</td>
            <td>${actividad.nombre_actividad}</td>
            <td>${actividad.descripcion}</td>
            <td>${new Date(actividad.fecha_ejecucion).toLocaleDateString('es-ES')}</td>
            <td>${actividad.responsable}</td>
            <td>
                <button type="button" class="btn btn-sm btn-danger" onclick="eliminarActividadGC(${actividad.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });

    container.appendChild(table);
}

// Funci√≥n para eliminar actividad GC
function eliminarActividadGC(id) {
    actividadesGC = actividadesGC.filter(act => act.id !== id);
    actualizarListaActividadesGC();
}

// Actualizar l√≠mites de fecha cierre en GC (mismo patr√≥n que PA)
function actualizarLimitesFechaEjecucionGc() {
    const fechaAperturaGc = document.getElementById('fechaAperturaGc').value;
    const fechaCierreGc = document.getElementById('fechaCierreGc').value;
    const responsableGcGeneral = document.getElementById('responsableGcGeneral').value.trim();
    const fechaEjecucionGc = document.getElementById('fechaEjecucionGc');

    if (!fechaEjecucionGc) return;

    // Establecer l√≠mites del datepicker
    if (fechaAperturaGc) {
        fechaEjecucionGc.min = fechaAperturaGc;
    }

    if (fechaCierreGc) {
        fechaEjecucionGc.max = fechaCierreGc;
    }

    // Validar si la fecha actual est√° fuera del rango
    if (fechaEjecucionGc.value) {
        const fechaEjec = fechaEjecucionGc.value;

        if (fechaAperturaGc && fechaEjec < fechaAperturaGc) {
            fechaEjecucionGc.value = '';
            alert('La fecha cierre debe ser igual o posterior a la fecha de apertura');
        }

        if (fechaCierreGc && fechaEjec > fechaCierreGc) {
            fechaEjecucionGc.value = '';
            alert('La fecha cierre debe ser igual o anterior a la fecha de cierre');
        }
    }
}

// Limpiar formulario GC
function limpiarFormularioGC() {
    document.getElementById('formGestionCambio').reset();
    document.getElementById('codigoAutoGc').textContent = 'GC-PROC-SUBPROC-NNNN';

    const responsableGcGeneral = document.getElementById('responsableGcGeneral');
    if (responsableGcGeneral) {
        responsableGcGeneral.value = '';
    }

    // Limpiar actividades
    actividadesGC = [];
    actualizarListaActividadesGC();

    // Establecer fecha de apertura como hoy (usando fecha local, no UTC)
    const hoy = obtenerFechaLocal();
    document.getElementById('fechaAperturaGc').value = hoy;

    // Reiniciar dropdowns
    const procesoGc = document.getElementById('procesoGc');
    const subprocesoGc = document.getElementById('subprocesoGc');
    const etapaGc = document.getElementById('etapaGc');
    const fechaEjecucionGc = document.getElementById('fechaEjecucionGc');

    if (procesoGc) {
        procesoGc.selectedIndex = 0;
    }

    if (subprocesoGc) {
        // Limpiar opciones excepto la primera
        while (subprocesoGc.options.length > 1) {
            subprocesoGc.removeChild(subprocesoGc.lastChild);
        }
        subprocesoGc.selectedIndex = 0;
    }

    if (etapaGc) {
        etapaGc.selectedIndex = 0;
    }

    // Limpiar restricciones de fecha cierre
    if (fechaEjecucionGc) {
        fechaEjecucionGc.removeAttribute('min');
        fechaEjecucionGc.removeAttribute('max');
    }

    console.log('Formulario GC limpiado ‚úÖ');
}

// ==================== FUNCIONES PARA GENERAR C√ìDIGOS AUTOM√ÅTICOS ====================

// Generar c√≥digo autom√°tico PA desde base de datos
async function generarCodigoPA(proceso, subproceso) {
    try {
        const response = await fetch(`/sgi/planes-accion/generar-codigo?proceso=${encodeURIComponent(proceso)}&subproceso=${encodeURIComponent(subproceso)}`);
        const result = await response.json();

        if (result.success) {
            return result.codigo;
        } else {
            console.error('Error al generar c√≥digo PA:', result.mensaje);
            return `PA-${proceso.substring(0, 2).toUpperCase()}-${subproceso.substring(0, 2).toUpperCase()}-0001`;
        }
    } catch (error) {
        console.error('Error al generar c√≥digo PA:', error);
        return `PA-${proceso.substring(0, 2).toUpperCase()}-${subproceso.substring(0, 2).toUpperCase()}-0001`;
    }
}

// Generar c√≥digo autom√°tico GC desde base de datos
async function generarCodigoGC(proceso, subproceso) {
    try {
        const response = await fetch(`/sgi/gestion-cambio/generar-codigo?proceso=${encodeURIComponent(proceso)}&subproceso=${encodeURIComponent(subproceso)}`);
        const result = await response.json();

        if (result.success) {
            return result.codigo;
        } else {
            console.error('Error al generar c√≥digo GC:', result.mensaje);
            return `GC-${proceso.substring(0, 2).toUpperCase()}-${subproceso.substring(0, 2).toUpperCase()}-0001`;
        }
    } catch (error) {
        console.error('Error al generar c√≥digo GC:', error);
        return `GC-${proceso.substring(0, 2).toUpperCase()}-${subproceso.substring(0, 2).toUpperCase()}-0001`;
    }
}

// Generar c√≥digo autom√°tico RVD desde base de datos
async function generarCodigoRVD(proceso, subproceso) {
    try {
        const response = await fetch(`/sgi/revision-direccion/generar-codigo?proceso=${encodeURIComponent(proceso)}&subproceso=${encodeURIComponent(subproceso)}`);
        const result = await response.json();

        if (result.success) {
            return result.codigo;
        } else {
            console.error('Error al generar c√≥digo RVD:', result.mensaje);
            return `RVD-${proceso.substring(0, 2).toUpperCase()}-${subproceso.substring(0, 2).toUpperCase()}-0001`;
        }
    } catch (error) {
        console.error('Error al generar c√≥digo RVD:', error);
        return `RVD-${proceso.substring(0, 2).toUpperCase()}-${subproceso.substring(0, 2).toUpperCase()}-0001`;
    }
}

// Actualizar c√≥digo autom√°tico PA cuando cambie proceso/subproceso
async function actualizarCodigoPA() {
    const proceso = document.getElementById('procesoPa')?.value;
    const subproceso = document.getElementById('subprocesoPa')?.value;

    if (proceso && subproceso) {
        const codigo = await generarCodigoPA(proceso, subproceso);
        const elemento = document.getElementById('codigoAutoPa');
        if (elemento) {
            elemento.textContent = codigo;
        }
    } else {
        const elemento = document.getElementById('codigoAutoPa');
        if (elemento) {
            elemento.textContent = 'PA-PROC-SUBPROC-NNNN';
        }
    }
}

// Actualizar c√≥digo autom√°tico GC cuando cambie proceso/subproceso
async function actualizarCodigoGC() {
    const proceso = document.getElementById('procesoGc')?.value;
    const subproceso = document.getElementById('subprocesoGc')?.value;

    if (proceso && subproceso) {
        const codigo = await generarCodigoGC(proceso, subproceso);
        const elemento = document.getElementById('codigoAutoGc');
        if (elemento) {
            elemento.textContent = codigo;
        }
    } else {
        const elemento = document.getElementById('codigoAutoGc');
        if (elemento) {
            elemento.textContent = 'GC-PROC-SUBPROC-NNNN';
        }
    }
}

// Actualizar c√≥digo autom√°tico RVD cuando cambie proceso/subproceso
async function actualizarCodigoRVD() {
    const proceso = document.getElementById('procesoRvd')?.value;
    const subproceso = document.getElementById('subprocesoRvd')?.value;

    if (proceso && subproceso) {
        const codigo = await generarCodigoRVD(proceso, subproceso);
        const elemento = document.getElementById('codigoAutoRvd');
        if (elemento) {
            elemento.textContent = codigo;
        }
    } else {
        const elemento = document.getElementById('codigoAutoRvd');
        if (elemento) {
            elemento.textContent = 'RVD-PROC-SUBPROC-NNNN';
        }
    }
}

// ==================== FIN FUNCIONES C√ìDIGOS AUTOM√ÅTICOS ====================

// Crear Gesti√≥n del Cambio
async function crearGestionCambio() {
    // Validar que haya al menos una actividad agregada
    if (actividadesGC.length === 0) {
        alert('Debe agregar al menos una actividad antes de crear el GC');
        return;
    }

    // Obtener valores del formulario en el ORDEN CORRECTO
    const procesoGc = document.getElementById('procesoGc').value.trim();
    const subprocesoGc = document.getElementById('subprocesoGc').value.trim();
    const copGc = document.getElementById('copGc').value.trim();
    const estadoGc = document.getElementById('estadoGc').value;
    const fechaAperturaGc = document.getElementById('fechaAperturaGc').value;
    const fechaCierreGc = document.getElementById('fechaCierreGc').value;
    const responsableGcGeneral = document.getElementById('responsableGcGeneral').value.trim();
    const nombreCambioGc = document.getElementById('nombreCambioGc').value.trim();
    const descripcionCambioGc = document.getElementById('descripcionCambioGc').value.trim();

    // Validaciones b√°sicas
    // NOTA: subproceso es opcional si el proceso no tiene subprocesos (valor 'N/A')
    const subprocesoRequerido = subprocesoGc !== 'N/A';

    if (!procesoGc || !copGc || !estadoGc || !fechaAperturaGc || !fechaCierreGc ||
        !nombreCambioGc || !descripcionCambioGc || !responsableGcGeneral) {
        alert('Por favor complete todos los campos obligatorios marcados con *');
        return;
    }

    // Validar subproceso solo si es requerido
    if (subprocesoRequerido && !subprocesoGc) {
        alert('Por favor seleccione un subproceso');
        return;
    }

    // Validar longitud de nombre del cambio
    if (nombreCambioGc.length < 3) {
        alert('El nombre del cambio debe tener al menos 3 caracteres');
        return;
    }
    if (nombreCambioGc.length > 150) {
        alert('El nombre del cambio no puede exceder 150 caracteres');
        return;
    }

    // Validar fechas de apertura/cierre
    if (fechaCierreGc && new Date(fechaCierreGc) < new Date(fechaAperturaGc)) {
        alert('La fecha de cierre no puede ser anterior a la fecha de apertura');
        return;
    }

    // Recopilar datos del formulario (etapa ahora est√° en cada actividad)
    const datos = {
        proceso: procesoGc,
        subproceso: subprocesoGc,
        cop: copGc,
        estado: estadoGc,
        fecha_apertura: fechaAperturaGc,
        fecha_cierre: fechaCierreGc,
        nombre_cambio: nombreCambioGc,
        descripcion_cambio: descripcionCambioGc,
        responsable: responsableGcGeneral,
        actividades: actividadesGC.map(act => ({
            etapa: act.etapa,
            nombre_actividad: act.nombre_actividad,
            descripcion: act.descripcion,
            fecha_ejecucion: act.fecha_ejecucion,
            responsable: act.responsable
        }))
    };

    try {
        // Mostrar mensaje de carga
        const btnCrear = document.querySelector('button[onclick="crearGestionCambio()"]');
        const textoOriginal = btnCrear.innerHTML;
        btnCrear.innerHTML = '<i class="bi bi-hourglass-split"></i> Creando...';
        btnCrear.disabled = true;

        // Enviar datos al servidor
        console.log('Datos GC a enviar:', datos);

        const response = await fetch('/sgi/gestion-cambio', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(datos)
        });

        const resultado = await response.json();

        if (resultado.success) {
            // Mostrar mensaje de √©xito con n√∫mero de actividades
            const numActividades = datos.actividades.length;
            alert('¬°Gesti√≥n del Cambio creada exitosamente!\n\n' +
                  `C√≥digo: ${resultado.codigo}\n` +
                  `Proceso: ${datos.proceso}\n` +
                  `Nombre: ${datos.nombre_cambio}\n` +
                  `Actividades registradas: ${numActividades}`);

            // Limpiar formulario y cerrar modal
            limpiarFormularioGC();
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalGestionCambio'));
            if (modal) {
                modal.hide();
            }

            await asegurarRegistroVisible({ codigo: resultado.codigo, tipoGestion: 'GC' });
        } else {
            throw new Error(resultado.mensaje || 'Error desconocido');
        }

        // Restaurar bot√≥n
        btnCrear.innerHTML = textoOriginal;
        btnCrear.disabled = false;
    } catch (error) {
        console.error('Error al crear GC:', error);
        alert(`Error al crear la Gesti√≥n del Cambio: ${error.message}`);

        // Restaurar bot√≥n en caso de error
        const btnCrear = document.querySelector('button[onclick="crearGestionCambio()"]');
        if (btnCrear) {
            btnCrear.innerHTML = '<i class="bi bi-check-circle"></i> Crear GC';
            btnCrear.disabled = false;
        }
    }
}

// üîß Funciones para Revisi√≥n y Validaci√≥n de Documentos (RVD)

// Limpiar formulario RVD
function limpiarFormularioRVD() {
    document.getElementById('formCrearRVD').reset();
    document.getElementById('codigoAutoRvd').textContent = 'RVD-PROC-SUBPROC-NNNN';

    // Reiniciar dropdowns
    const procesoRvd = document.getElementById('procesoRvd');
    const subprocesoRvd = document.getElementById('subprocesoRvd');

    if (procesoRvd) {
        procesoRvd.selectedIndex = 0;
    }

    if (subprocesoRvd) {
        // Limpiar opciones excepto la primera
        while (subprocesoRvd.options.length > 1) {
            subprocesoRvd.removeChild(subprocesoRvd.lastChild);
        }
        subprocesoRvd.selectedIndex = 0;
    }
}

// Funci√≥n legacy removida - ahora usa endpoint del servidor

// Crear RVD
async function crearRVD() {
    // Obtener valores del formulario
    const procesoRvd = document.getElementById('procesoRvd').value;
    const subprocesoRvd = document.getElementById('subprocesoRvd').value;
    const copRvd = document.getElementById('copRvd').value.trim();
    const estadoRvd = document.getElementById('estadoRvd').value;
    const anoRvd = document.getElementById('anoRvd').value;
    const accionCompromisoRvd = document.getElementById('accionCompromisoRvd').value.trim();
    const responsableRvd = document.getElementById('responsableRvd').value.trim();
    const fechaAperturaRvd = document.getElementById('fechaAperturaRvd').value;
    const fechaCierreRvd = document.getElementById('fechaCierreRvd').value;

    // Validaciones b√°sicas
    // NOTA: subproceso es opcional si el proceso no tiene subprocesos (valor 'N/A')
    const subprocesoRequerido = subprocesoRvd !== 'N/A';

    if (!procesoRvd || !copRvd || !estadoRvd || !anoRvd || !accionCompromisoRvd || !responsableRvd || !fechaAperturaRvd) {
        alert('Por favor complete todos los campos obligatorios marcados con *');
        return;
    }

    // Validar subproceso solo si es requerido
    if (subprocesoRequerido && !subprocesoRvd) {
        alert('Por favor seleccione un subproceso');
        return;
    }

    // Validar fechas
    if (fechaCierreRvd && new Date(fechaCierreRvd) < new Date(fechaAperturaRvd)) {
        alert('La fecha de cierre no puede ser anterior a la fecha de apertura');
        return;
    }

    // Validar a√±o
    const a√±oActual = new Date().getFullYear();
    if (parseInt(anoRvd) < 2020 || parseInt(anoRvd) > a√±oActual + 5) {
        alert('El a√±o debe estar entre 2020 y ' + (a√±oActual + 5));
        return;
    }

    // Recopilar datos del formulario
    const datos = {
        tipo: 'RVD',
        proceso: procesoRvd,
        subproceso: subprocesoRvd,
        cop: copRvd,
        estado: estadoRvd,
        ano_rvd: parseInt(anoRvd),
        actividad: accionCompromisoRvd,  // Mapear a 'actividad' para el backend
        accion_compromiso: accionCompromisoRvd,  // Mantener para compatibilidad
        responsable: responsableRvd,
        fecha_apertura: fechaAperturaRvd,
        fecha_cierre: fechaCierreRvd,
        categoria: 'RVD'  // Agregar categor√≠a
    };

    // Obtener referencia al bot√≥n antes del try/catch
    const btnCrear = document.querySelector('button[onclick="crearRVD()"]');
    if (!btnCrear) {
        console.error('No se encontr√≥ el bot√≥n crearRVD');
        return;
    }
    const textoOriginal = btnCrear.innerHTML;

    try {
        // Mostrar mensaje de carga
        btnCrear.innerHTML = '<i class="bi bi-hourglass-split"></i> Creando...';
        btnCrear.disabled = true;

        // Enviar datos al servidor
        console.log('Datos RVD a enviar:', datos);

        const response = await fetch('/sgi/revision-direccion', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(datos)
        });

        const resultado = await response.json();

        if (resultado.success) {
            // Mostrar mensaje de √©xito
            alert('¬°Revisi√≥n por la Direcci√≥n creada exitosamente!\n\n' +
                  `C√≥digo: ${resultado.codigo}\n` +
                  `Proceso: ${datos.proceso}\n` +
                  `Responsable: ${datos.responsable}`);
        } else {
            throw new Error(resultado.mensaje || 'Error al crear RVD');
        }

        // Limpiar formulario y cerrar modal
        limpiarFormularioRVD();
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalCrearRVD'));
        if (modal) {
            modal.hide();
        }
        await asegurarRegistroVisible({ codigo: resultado.codigo, tipoGestion: 'RVD' });

    } catch (error) {
        console.error('Error al crear RVD:', error);
        alert('Error al crear el RVD. Por favor intente nuevamente.');
    } finally {
        // Restaurar bot√≥n siempre
        if (btnCrear) {
            btnCrear.innerHTML = textoOriginal;
            btnCrear.disabled = false;
        }
    }
}

// Funciones auxiliares (por ahora solo mostrar alertas)

/**
 * Obtiene la fecha actual en formato YYYY-MM-DD usando la zona horaria local
 * (sin conversi√≥n a UTC que causa el problema de d√≠a adelantado)
 */
function obtenerFechaLocal() {
    const ahora = new Date();
    const year = ahora.getFullYear();
    const month = String(ahora.getMonth() + 1).padStart(2, '0');
    const day = String(ahora.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Inicializaci√≥n global para evitar errores
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando sistema SGI...');

    try {
        // Configurar filtros din√°micos de c√≥digos
        if (typeof configurarFiltrosDinamicos === 'function') {
            configurarFiltrosDinamicos();
        }

        // Configurar filtros clickeables de la leyenda
        if (typeof configurarFiltrosLeyenda === 'function') {
            configurarFiltrosLeyenda();
            console.log('‚úÖ Filtros de leyenda configurados');
        }
        if (typeof aplicarCodigosCacheSiVacio === 'function') {
            aplicarCodigosCacheSiVacio();
        }

        // Cargar c√≥digos iniciales
        if (typeof cargarCodigosPlanesAccion === 'function') {
            cargarCodigosPlanesAccion();
        }

        // Cargar autom√°ticamente todos los datos al inicializar
        setTimeout(() => {
            if (typeof cargarDatosPorTipoGestion === 'function') {
                cargarDatosPorTipoGestion('');
            }
        }, 100);

        // Verificar y configurar modal Crear PA
        const modalCrearPA = verificarElementoDOM('modalCrearPA', 'Modal Crear PA');
        if (modalCrearPA) {
            console.log('‚úÖ Modal Crear PA encontrado y listo');
        }

        if (typeof configurarModalEvidencias === 'function') {
            configurarModalEvidencias();
        }
        if (typeof configurarModalAdminRegistro === 'function') {
            configurarModalAdminRegistro();
        }

        if (typeof configurarModalCierreRegistro === 'function') {
            configurarModalCierreRegistro();
        }


        console.log('‚úÖ Sistema SGI inicializado correctamente');

    } catch (error) {
        console.error('‚ùå Error durante la inicializaci√≥n del sistema SGI:', error);
    }
});

// Funci√≥n de verificaci√≥n de estado del sistema
function verificarEstadoSistema() {
    const elementos = [
        'modalCrearPA',
        'procesoPa',
        'subprocesoPa',
        'tipoAccionPa',
        'fechaAperturaPa',
        'fechaCierrePa'
    ];

    const estadoElementos = {};
    elementos.forEach(id => {
        estadoElementos[id] = !!document.getElementById(id);
    });

    console.log('üìä Estado actual del sistema:', estadoElementos);
    return estadoElementos;
}

// =====================================================
// FUNCIONES DE AUDITOR√çA
// =====================================================

let paginaActualAud = 1;
let registrosPorPaginaAud = 25;

// Buscar logs de auditor√≠a
async function buscarAuditoria(pagina = 1) {
    try {
        paginaActualAud = pagina;

        // Mostrar loading overlay
        const loadingOverlay = document.getElementById('loadingOverlayAuditoria');
        if (loadingOverlay) loadingOverlay.style.display = 'flex';

        // Construir query string con filtros
        const params = new URLSearchParams();
        params.append('page', pagina);
        params.append('per_page', registrosPorPaginaAud);

        const fechaDesde = document.getElementById('filtroFechaDesdeAud').value;
        const fechaHasta = document.getElementById('filtroFechaHastaAud').value;
        const usuario = document.getElementById('filtroUsuarioAud').value;
        const accion = document.getElementById('filtroAccionAud').value;
        const modulo = document.getElementById('filtroModuloAud').value;
        const resultado = document.getElementById('filtroResultadoAud').value;
        const codigo = document.getElementById('filtroCodigoAud').value;

        if (fechaDesde) params.append('fecha_desde', fechaDesde);
        if (fechaHasta) params.append('fecha_hasta', fechaHasta);
        if (usuario) params.append('usuario', usuario);
        if (accion) params.append('accion', accion);
        if (modulo) params.append('modulo', modulo);
        if (resultado) params.append('resultado', resultado);
        if (codigo) params.append('codigo', codigo);

        // Actualizar badge de filtros activos
        const filtrosAuditoria = {
            fecha_desde: fechaDesde,
            fecha_hasta: fechaHasta,
            usuario: usuario,
            accion: accion,
            modulo: modulo,
            resultado: resultado,
            codigo: codigo
        };
        actualizarBadgeFiltrosActivos('Auditoria', filtrosAuditoria);

        const response = await fetch(`/sgi/auditoria/logs?${params.toString()}`);
        const data = await response.json();

        if (data.success) {
            renderizarTablaAuditoria(data.logs);
            renderizarPaginacionAud(data.total, registrosPorPaginaAud, pagina);
        } else {
            document.getElementById('bodyTablaAuditoria').innerHTML = `
                <tr>
                    <td colspan="9" class="text-center text-danger">
                        Error: ${data.mensaje}
                    </td>
                </tr>
            `;
        }

    } catch (error) {
        console.error('Error al buscar auditor√≠a:', error);
        document.getElementById('bodyTablaAuditoria').innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-danger">
                    Error al cargar datos: ${error.message}
                </td>
            </tr>
        `;
    } finally {
        // Ocultar loading overlay
        const loadingOverlay = document.getElementById('loadingOverlayAuditoria');
        if (loadingOverlay) loadingOverlay.style.display = 'none';
    }
}

// Renderizar tabla de auditor√≠a
function renderizarTablaAuditoria(logs) {
    const tbody = document.getElementById('bodyTablaAuditoria');

    if (!logs || logs.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="9" class="text-center text-muted" style="padding: 2rem;">
                    <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mb-0 mt-2">No se encontraron registros</p>
                </td>
            </tr>
        `;
        return;
    }

    const iconosAccion = {
        'CREAR': '‚ú®',
        'MODIFICAR': '‚úèÔ∏è',
        'ELIMINAR': 'üóëÔ∏è',
        'CONSULTAR': 'üëÅÔ∏è',
        'DESCARGAR': 'üì•',
        'EXPORTAR': 'üìä',
        'APROBAR': '‚úÖ',
        'RECHAZAR': '‚ùå',
        'CERRAR': 'üîí',
        'LOGIN': 'üîì',
        'LOGOUT': 'üîê'
    };

    const badgeResultado = {
        'exito': 'success',
        'error': 'danger',
        'advertencia': 'warning'
    };

    const badgeModulo = {
        'PA': 'primary',
        'GC': 'info',
        'RVD': 'secondary',
        'SGI': 'dark',
        'AUDITORIA': 'warning'
    };

    tbody.innerHTML = logs.map(log => {
        const icono = iconosAccion[log.accion] || 'üìù';
        const resultadoClass = badgeResultado[log.resultado] || 'secondary';
        const moduloClass = badgeModulo[log.modulo] || 'secondary';
        const detalle = log.detalle_registro ?
            (log.detalle_registro.length > 100 ? log.detalle_registro.substring(0, 100) + '...' : log.detalle_registro) :
            '-';

        return `
            <tr title="${log.detalle_registro || ''}">
                <td style="font-weight: 600; color: #64748b;">${log.id}</td>
                <td style="font-size: 11px; color: #64748b; white-space: nowrap;">${log.fecha_formateada}</td>
                <td style="font-weight: 500;" title="${log.usuario}">${log.usuario}</td>
                <td><span class="badge bg-light text-dark border" style="font-size: 11px; padding: 4px 8px; font-weight: 500;">${icono} ${log.accion}</span></td>
                <td><span class="badge bg-${moduloClass}" style="font-size: 11px; padding: 4px 8px; font-weight: 600;">${log.modulo}</span></td>
                <td>${log.codigo_registro ? `<code style="font-size: 11px; background: #f1f5f9; color: #e11d48; padding: 3px 8px; border-radius: 4px; font-weight: 600; white-space: nowrap; display: inline-block;">${log.codigo_registro}</code>` : '-'}</td>
                <td style="text-align: left; padding-left: 0.75rem !important;"><small style="color: #475569; line-height: 1.4;" title="${log.detalle_registro || ''}">${detalle}</small></td>
                <td><span class="badge bg-${resultadoClass}" style="font-size: 10px; padding: 4px 10px; font-weight: 700; letter-spacing: 0.5px;">${log.resultado.toUpperCase()}</span></td>
                <td style="white-space: nowrap; font-weight: 500;">${log.duracion_ms ? log.duracion_ms + ' ms' : '-'}</td>
            </tr>
        `;
    }).join('');
}

// Renderizar paginaci√≥n
function renderizarPaginacionAud(total, limite, paginaActual) {
    const totalPaginas = Math.ceil(total / limite);
    const paginacion = document.getElementById('paginacionAuditoria');

    if (totalPaginas <= 1) {
        paginacion.innerHTML = '';
        return;
    }

    let html = '';

    // Bot√≥n anterior
    html += `
        <li class="page-item ${paginaActual === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="buscarAuditoria(${paginaActual - 1}); return false;">Anterior</a>
        </li>
    `;

    // N√∫meros de p√°gina (mostrar m√°ximo 7 p√°ginas)
    let inicio = Math.max(1, paginaActual - 3);
    let fin = Math.min(totalPaginas, inicio + 6);

    if (fin - inicio < 6) {
        inicio = Math.max(1, fin - 6);
    }

    if (inicio > 1) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="buscarAuditoria(1); return false;">1</a></li>`;
        if (inicio > 2) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    for (let i = inicio; i <= fin; i++) {
        html += `
            <li class="page-item ${i === paginaActual ? 'active' : ''}">
                <a class="page-link" href="#" onclick="buscarAuditoria(${i}); return false;">${i}</a>
            </li>
        `;
    }

    if (fin < totalPaginas) {
        if (fin < totalPaginas - 1) {
            html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        html += `<li class="page-item"><a class="page-link" href="#" onclick="buscarAuditoria(${totalPaginas}); return false;">${totalPaginas}</a></li>`;
    }

    // Bot√≥n siguiente
    html += `
        <li class="page-item ${paginaActual === totalPaginas ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="buscarAuditoria(${paginaActual + 1}); return false;">Siguiente</a>
        </li>
    `;

    paginacion.innerHTML = html;
}

// Cambiar registros por p√°gina
function cambiarRegistrosPorPagina() {
    registrosPorPaginaAud = parseInt(document.getElementById('registrosPorPaginaAud').value);
    buscarAuditoria(1);
}

// Refrescar auditor√≠a despu√©s de cualquier acci√≥n
async function refrescarAuditoria() {
    // Si estamos en la pesta√±a de auditor√≠a, refrescar
    const auditoriaTab = document.getElementById('auditoria');
    const isActive = auditoriaTab && (auditoriaTab.classList.contains('active') || auditoriaTab.classList.contains('show'));

    console.log('üîÑ refrescarAuditoria() llamado');
    console.log('   - Pesta√±a existe:', !!auditoriaTab);
    console.log('   - Clases:', auditoriaTab?.className);
    console.log('   - Est√° activa:', isActive);

    if (isActive) {
        console.log('‚úÖ Refrescando datos de Auditor√≠a...');
        await buscarAuditoria(paginaActualAud);
        await cargarEstadisticasAud();
    } else {
        console.log('‚è≠Ô∏è Auditor√≠a no est√° activa, skip refresh');
    }
}

// Exportar auditor√≠a
async function exportarAuditoria(formato) {
    try {
        // Identificar bot√≥n clickeado y mostrar loading
        const btnExcel = event.target.closest('button');
        const textoOriginal = btnExcel.innerHTML;
        btnExcel.innerHTML = '<i class="bi bi-hourglass-split"></i> Descargando...';
        btnExcel.disabled = true;
        btnExcel.classList.add('btn-loading');

        // Construir query string con filtros
        const params = new URLSearchParams();
        params.append('formato', formato);

        const fechaDesde = document.getElementById('filtroFechaDesdeAud').value;
        const fechaHasta = document.getElementById('filtroFechaHastaAud').value;
        const usuario = document.getElementById('filtroUsuarioAud').value;
        const accion = document.getElementById('filtroAccionAud').value;
        const modulo = document.getElementById('filtroModuloAud').value;
        const resultado = document.getElementById('filtroResultadoAud').value;
        const codigo = document.getElementById('filtroCodigoAud').value;

        if (fechaDesde) params.append('fecha_desde', fechaDesde);
        if (fechaHasta) params.append('fecha_hasta', fechaHasta);
        if (usuario) params.append('usuario', usuario);
        if (accion) params.append('accion', accion);
        if (modulo) params.append('modulo', modulo);
        if (resultado) params.append('resultado', resultado);
        if (codigo) params.append('codigo', codigo);

        // Realizar descarga
        window.location.href = `/sgi/auditoria/exportar?${params.toString()}`;

        // Restaurar bot√≥n y refrescar despu√©s de 2.5 segundos
        setTimeout(() => {
            btnExcel.innerHTML = textoOriginal;
            btnExcel.disabled = false;
            btnExcel.classList.remove('btn-loading');

            // Refrescar tabla UNA SOLA VEZ despu√©s de exportar
            console.log('üîÑ Refrescando Auditor√≠a despu√©s de exportar...');
            buscarAuditoria(paginaActualAud);
            cargarEstadisticasAud();
        }, 2500);

    } catch (error) {
        console.error('Error al exportar:', error);
        alert('Error al exportar datos');
    }
}

// Cargar estad√≠sticas
async function cargarEstadisticasAud() {
    try {
        const params = new URLSearchParams();

        const fechaDesde = document.getElementById('filtroFechaDesdeAud').value;
        const fechaHasta = document.getElementById('filtroFechaHastaAud').value;

        if (fechaDesde) params.append('fecha_desde', fechaDesde);
        if (fechaHasta) params.append('fecha_hasta', fechaHasta);

        const response = await fetch(`/sgi/auditoria/estadisticas?${params.toString()}`);
        const data = await response.json();

        if (data.success && data.estadisticas) {
            const stats = data.estadisticas;

            document.getElementById('statTotalAcciones').textContent = stats.total_acciones || 0;
            document.getElementById('statUsuariosActivos').textContent = stats.total_usuarios || 0;

            // Calcular tasa de √©xito
            if (stats.total_acciones > 0) {
                const tasaExito = ((stats.acciones_exitosas / stats.total_acciones) * 100).toFixed(1);
                document.getElementById('statTasaExito').textContent = tasaExito + '%';
            } else {
                document.getElementById('statTasaExito').textContent = '0%';
            }

            // √öltima actividad
            if (stats.ultima_actividad) {
                const fecha = new Date(stats.ultima_actividad);
                const fechaFormateada = fecha.toLocaleString('es-CO');
                document.getElementById('statUltimaActividad').textContent = fechaFormateada;
            }
        }
    } catch (error) {
        console.error('Error al cargar estad√≠sticas:', error);
    }
}

// Limpiar filtros
function limpiarFiltrosAud() {
    document.getElementById('filtroFechaDesdeAud').value = '';
    document.getElementById('filtroFechaHastaAud').value = '';
    document.getElementById('filtroUsuarioAud').value = '';
    document.getElementById('filtroAccionAud').value = '';
    document.getElementById('filtroModuloAud').value = '';
    document.getElementById('filtroResultadoAud').value = '';
    document.getElementById('filtroCodigoAud').value = '';

    // Ocultar badge de filtros activos
    const badge = document.getElementById('badgeFiltrosActivosAuditoria');
    if (badge) {
        badge.style.display = 'none';
        badge.removeAttribute('title');
        badge.removeAttribute('aria-label');
    }

    buscarAuditoria(1);
    cargarEstadisticasAud();
}

// Inicializar al cargar pesta√±a de auditor√≠a
document.addEventListener('DOMContentLoaded', function() {
    // Configurar event listeners autom√°ticos para filtros de Auditor√≠a
    const filtroFechaDesdeAud = document.getElementById('filtroFechaDesdeAud');
    const filtroFechaHastaAud = document.getElementById('filtroFechaHastaAud');
    const filtroUsuarioAud = document.getElementById('filtroUsuarioAud');
    const filtroAccionAud = document.getElementById('filtroAccionAud');
    const filtroModuloAud = document.getElementById('filtroModuloAud');
    const filtroResultadoAud = document.getElementById('filtroResultadoAud');
    const filtroCodigoAud = document.getElementById('filtroCodigoAud');

    // Event listeners para aplicar filtros autom√°ticamente
    if (filtroFechaDesdeAud) {
        filtroFechaDesdeAud.addEventListener('change', function() {
            console.log('üîÑ Cambio en fecha desde (Auditor√≠a):', this.value);
            buscarAuditoria(1);
        });
    }

    if (filtroFechaHastaAud) {
        filtroFechaHastaAud.addEventListener('change', function() {
            console.log('üîÑ Cambio en fecha hasta (Auditor√≠a):', this.value);
            buscarAuditoria(1);
        });
    }

    if (filtroUsuarioAud) {
        // Usar input con debounce para b√∫squeda por texto
        let timeoutUsuario;
        filtroUsuarioAud.addEventListener('input', function() {
            clearTimeout(timeoutUsuario);
            timeoutUsuario = setTimeout(() => {
                console.log('üîÑ Cambio en usuario (Auditor√≠a):', this.value);
                buscarAuditoria(1);
            }, 500); // Esperar 500ms despu√©s de dejar de escribir
        });
    }

    if (filtroAccionAud) {
        filtroAccionAud.addEventListener('change', function() {
            console.log('üîÑ Cambio en acci√≥n (Auditor√≠a):', this.value);
            buscarAuditoria(1);
        });
    }

    if (filtroModuloAud) {
        filtroModuloAud.addEventListener('change', function() {
            console.log('üîÑ Cambio en m√≥dulo (Auditor√≠a):', this.value);
            buscarAuditoria(1);
        });
    }

    if (filtroResultadoAud) {
        filtroResultadoAud.addEventListener('change', function() {
            console.log('üîÑ Cambio en resultado (Auditor√≠a):', this.value);
            buscarAuditoria(1);
        });
    }

    if (filtroCodigoAud) {
        // Usar input con debounce para b√∫squeda por texto
        let timeoutCodigo;
        filtroCodigoAud.addEventListener('input', function() {
            clearTimeout(timeoutCodigo);
            timeoutCodigo = setTimeout(() => {
                console.log('üîÑ Cambio en c√≥digo (Auditor√≠a):', this.value);
                buscarAuditoria(1);
            }, 500); // Esperar 500ms despu√©s de dejar de escribir
        });
    }

    // Cargar datos al mostrar pesta√±a
    const auditoriaTab = document.getElementById('auditoria-tab');
    if (auditoriaTab) {
        auditoriaTab.addEventListener('shown.bs.tab', function() {
            console.log('üìä Pesta√±a de Auditor√≠a mostrada - Recargando datos...');
            buscarAuditoria(1);
            cargarEstadisticasAud();
        });
    } else {
        console.warn('‚ö†Ô∏è No se encontr√≥ la pesta√±a de Auditor√≠a');
    }
});

console.log('‚úÖ Sistema de Auditor√≠a SGI cargado correctamente');

// ========================================================================================
//                        SISTEMA DE NOTIFICACIONES
// ========================================================================================

// Variable global para almacenar notificaciones
let notificacionesCache = [];
let filtroActualNotif = 'todas';

// Funci√≥n para abrir el modal de notificaciones
// Variable para almacenar el c√≥digo de referencia del filtro activo
let codigoReferenciaFiltro = null;

async function abrirModalNotificaciones(event, codigo = null) {
    console.log('üîî abrirModalNotificaciones llamada con codigo:', codigo);

    if (event) {
        event.stopPropagation();
        event.preventDefault();
    }

    try {
        const modalElement = document.getElementById('modalNotificaciones');
        if (!modalElement) {
            console.error('‚ùå Modal #modalNotificaciones no encontrado en el DOM');
            return;
        }

        // Guardar el c√≥digo de referencia para filtrar
        codigoReferenciaFiltro = codigo && codigo.trim() !== '' ? codigo : null;
        console.log('üìå Filtro por c√≥digo:', codigoReferenciaFiltro);

        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('‚úÖ Modal abierto correctamente');

        // Cargar notificaciones
        await cargarNotificaciones();
    } catch (error) {
        console.error('‚ùå Error al abrir modal de notificaciones:', error);
        alert('Error al abrir notificaciones: ' + error.message);
    }
}

// Funci√≥n para cargar notificaciones del backend
async function cargarNotificaciones() {
    try {
        const response = await fetch('/sgi/notificaciones?solo_no_leidas=false&limite=50');
        const data = await response.json();

        if (data.success) {
            notificacionesCache = data.notificaciones || [];
            renderizarNotificaciones();
            actualizarContadorNotificaciones(data.total_no_leidas || 0);
            actualizarBadgesNotificaciones();
        } else {
            document.getElementById('listaNotificaciones').innerHTML = `
                <div class="alert alert-danger m-3">
                    <i class="fas fa-exclamation-triangle"></i> ${data.mensaje || 'Error al cargar notificaciones'}
                </div>
            `;
        }
    } catch (error) {
        console.error('Error al cargar notificaciones:', error);
        document.getElementById('listaNotificaciones').innerHTML = `
            <div class="alert alert-danger m-3">
                <i class="fas fa-exclamation-triangle"></i> Error de conexi√≥n al cargar notificaciones
            </div>
        `;
    }
}

// Funci√≥n para renderizar notificaciones en el modal
function renderizarNotificaciones() {
    const container = document.getElementById('listaNotificaciones');

    // Filtrar seg√∫n el filtro activo
    let notificacionesFiltradas = notificacionesCache;

    // FILTRO POR C√ìDIGO DE REFERENCIA (cuando se abre desde una campanita espec√≠fica)
    if (codigoReferenciaFiltro) {
        notificacionesFiltradas = notificacionesFiltradas.filter(n => n.codigo_referencia === codigoReferenciaFiltro);
        console.log(`üîç Filtrando por c√≥digo: ${codigoReferenciaFiltro}, encontradas: ${notificacionesFiltradas.length}`);
    }

    // Aplicar filtros de tipo
    if (filtroActualNotif === 'no-leidas') {
        notificacionesFiltradas = notificacionesFiltradas.filter(n => n.estado === 'NO_LEIDA');
    } else if (['APROBACION', 'RECHAZO', 'CIERRE'].includes(filtroActualNotif)) {
        notificacionesFiltradas = notificacionesFiltradas.filter(n => n.tipo === filtroActualNotif);
    }

    // Actualizar contador
    const contador = document.getElementById('contadorNotificaciones');
    const total = notificacionesFiltradas.length;
    const noLeidas = notificacionesFiltradas.filter(n => n.estado === 'NO_LEIDA').length;

    // Mostrar c√≥digo en el contador si est√° filtrado
    let textoContador = `${total} notificaciones (${noLeidas} no le√≠das)`;
    if (codigoReferenciaFiltro) {
        textoContador = `${total} notificaciones de ${codigoReferenciaFiltro} (${noLeidas} no le√≠das)`;
    }
    contador.textContent = textoContador;

    if (notificacionesFiltradas.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-5">
                <i class="fas fa-bell-slash fa-3x mb-3" style="opacity: 0.3;"></i>
                <p>No hay notificaciones</p>
            </div>
        `;
        return;
    }

    // Renderizar notificaciones
    container.innerHTML = notificacionesFiltradas.map(notif => {
        const fecha = new Date(notif.fecha_creacion);
        const fechaFormato = fecha.toLocaleDateString('es-ES', {
            day: '2-digit',
            month: 'short',
            hour: '2-digit',
            minute: '2-digit'
        });

        const estadoClass = notif.estado === 'NO_LEIDA' ? 'no-leida' : 'leida';
        const tipoClass = `notificacion-tipo-${notif.tipo}`;

        let iconoTipo = '';
        if (notif.tipo === 'APROBACION') {
            iconoTipo = '<i class="fas fa-check-circle text-success"></i>';
        } else if (notif.tipo === 'RECHAZO') {
            iconoTipo = '<i class="fas fa-times-circle text-danger"></i>';
        } else if (notif.tipo === 'CIERRE') {
            iconoTipo = '<i class="fas fa-lock text-secondary"></i>';
        }

        return `
            <div class="notificacion-item ${estadoClass} ${tipoClass}"
                 onclick="clickNotificacion(${notif.id})"
                 data-notif-id="${notif.id}">
                <div class="notificacion-header">
                    <div class="d-flex align-items-center gap-2">
                        ${iconoTipo}
                        <h6 class="notificacion-titulo mb-0">${notif.titulo}</h6>
                    </div>
                    <span class="notificacion-fecha">${fechaFormato}</span>
                </div>
                <p class="notificacion-mensaje">${notif.mensaje}</p>
                ${notif.codigo_referencia ? `<div class="notificacion-codigo">üìå ${notif.codigo_referencia}</div>` : ''}
                ${notif.estado === 'NO_LEIDA' ? '<span class="badge bg-primary" style="font-size: 9px;">NUEVA</span>' : ''}
            </div>
        `;
    }).join('');
}

// Funci√≥n al hacer clic en una notificaci√≥n
async function clickNotificacion(notifId) {
    const notif = notificacionesCache.find(n => n.id === notifId);
    if (!notif) return;

    // Marcar como le√≠da si no lo est√°
    if (notif.estado === 'NO_LEIDA') {
        await marcarComoLeida(notifId);
        // Recargar notificaciones para actualizar contadores
        await cargarNotificaciones();
    }

    // Si tiene c√≥digo de referencia, cerrar modal y abrir el registro
    if (notif.codigo_referencia && notif.tipo_entidad) {
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalNotificaciones'));
        if (modal) modal.hide();

        // Abrir modal correspondiente
        setTimeout(() => {
            editarRegistro(notif.codigo_referencia, notif.tipo_entidad);
        }, 300);
    }
}

// Funci√≥n para marcar una notificaci√≥n como le√≠da
async function marcarComoLeida(notifId) {
    try {
        const response = await fetch(`/sgi/notificaciones/${notifId}/marcar-leida`, {
            method: 'POST'
        });

        if (response.ok) {
            console.log(`‚úÖ Notificaci√≥n ${notifId} marcada como le√≠da`);

            // Actualizar cache local
            const notif = notificacionesCache.find(n => n.id === notifId);
            if (notif) {
                notif.estado = 'LEIDA';
                notif.fecha_lectura = new Date().toISOString();
            }

            // Re-renderizar con el filtro actual
            renderizarNotificaciones();

            // Actualizar badges
            actualizarBadgesNotificaciones();
        }
    } catch (error) {
        console.error('Error al marcar notificaci√≥n como le√≠da:', error);
    }
}

// Funci√≥n para marcar todas como le√≠das
async function marcarTodasLeidas() {
    try {
        const response = await fetch('/sgi/notificaciones/marcar-todas-leidas', {
            method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
            // Actualizar cache local
            notificacionesCache.forEach(n => {
                if (n.estado === 'NO_LEIDA') {
                    n.estado = 'LEIDA';
                    n.fecha_lectura = new Date().toISOString();
                }
            });

            // Re-renderizar
            renderizarNotificaciones();
            actualizarBadgesNotificaciones();

            Toast.success('‚úÖ Todas las notificaciones marcadas como le√≠das');
        }
    } catch (error) {
        console.error('Error al marcar todas como le√≠das:', error);
        Toast.error('‚ùå Error al marcar notificaciones como le√≠das');
    }
}

// Funci√≥n para filtrar notificaciones
function filtrarNotificaciones(tipo) {
    filtroActualNotif = tipo;

    // Actualizar botones activos
    document.querySelectorAll('#modalNotificaciones .btn-outline-primary, #modalNotificaciones .btn-outline-success, #modalNotificaciones .btn-outline-danger, #modalNotificaciones .btn-outline-secondary').forEach(btn => {
        btn.classList.remove('active');
    });

    if (tipo === 'todas') {
        document.getElementById('btnTodasNotif').classList.add('active');
    } else if (tipo === 'no-leidas') {
        document.getElementById('btnNoLeidasNotif').classList.add('active');
    } else if (tipo === 'APROBACION') {
        document.getElementById('btnAprobacionesNotif').classList.add('active');
    } else if (tipo === 'RECHAZO') {
        document.getElementById('btnRechazosNotif').classList.add('active');
    } else if (tipo === 'CIERRE') {
        document.getElementById('btnCierresNotif').classList.add('active');
    }

    renderizarNotificaciones();
}

// Funci√≥n para actualizar contador global de notificaciones
function actualizarContadorNotificaciones(total) {
    // Este contador podr√≠a usarse en el header si se necesita
    console.log(`üì¨ Total de notificaciones no le√≠das: ${total}`);
}

// Funci√≥n para actualizar badges en las campanas de la tabla
async function actualizarBadgesNotificaciones() {
    try {
        const response = await fetch('/sgi/notificaciones?solo_no_leidas=true&limite=100');

        if (!response.ok) {
            console.warn('‚ö†Ô∏è No se pudieron cargar notificaciones para badges (status ' + response.status + ')');
            return;
        }

        const data = await response.json();

        if (data.success) {
            const noLeidas = data.notificaciones || [];
            const totalNoLeidas = data.total_no_leidas || 0;

            // Agrupar por c√≥digo de referencia
            const notifPorCodigo = {};
            noLeidas.forEach(notif => {
                if (notif.codigo_referencia) {
                    if (!notifPorCodigo[notif.codigo_referencia]) {
                        notifPorCodigo[notif.codigo_referencia] = 0;
                    }
                    notifPorCodigo[notif.codigo_referencia]++;
                }
            });

            // Actualizar badges en la tabla
            Object.keys(notifPorCodigo).forEach(codigo => {
                const badge = document.getElementById(`badge-${codigo}`);
                if (badge) {
                    badge.textContent = notifPorCodigo[codigo];
                    badge.style.display = notifPorCodigo[codigo] > 0 ? 'flex' : 'none';
                }
            });
        }
    } catch (error) {
        // Error silencioso - no bloquear la UI
        console.debug('üîï Badges de notificaciones no disponibles:', error.message);
    }
}

// Actualizar badges peri√≥dicamente
// Actualizar badges peri√≥dicamente cada 5 segundos
setInterval(actualizarBadgesNotificaciones, 5000); // Cada 5 segundos para respuesta r√°pida

// Inicializar sistema de notificaciones al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    // Actualizar badges al cargar
    actualizarBadgesNotificaciones();
    console.log('‚úÖ Sistema de notificaciones inicializado');
});


// ========================================================================================
//                        SISTEMA DE NOTIFICACIONES TOAST
// ========================================================================================

const Toast = {
    container: null,

    // Inicializar contenedor de toasts
    init() {
        if (!this.container) {
            this.container = document.createElement('div');
            this.container.id = 'toast-container';
            this.container.className = 'toast-container';
            document.body.appendChild(this.container);
        }
    },

    // Crear toast
    show(message, type = 'info', duration = 4000) {
        this.init();

        const toast = document.createElement('div');
        toast.className = `toast toast-${type} toast-enter`;

        // Iconos por tipo
        const icons = {
            success: '<i class="bi bi-check-circle-fill"></i>',
            error: '<i class="bi bi-x-circle-fill"></i>',
            warning: '<i class="bi bi-exclamation-triangle-fill"></i>',
            info: '<i class="bi bi-info-circle-fill"></i>'
        };

        toast.innerHTML = `
            <div class="toast-icon">${icons[type] || icons.info}</div>
            <div class="toast-message">${message}</div>
            <button class="toast-close">
                <i class="bi bi-x"></i>
            </button>
        `;

        // Event listener para el bot√≥n de cerrar (sin onclick inline)
        const closeBtn = toast.querySelector('.toast-close');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.close(toast));
        }

        this.container.appendChild(toast);

        // Animaci√≥n de entrada
        setTimeout(() => toast.classList.add('toast-show'), 10);

        // Auto-cerrar
        if (duration > 0) {
            setTimeout(() => this.close(toast), duration);
        }

        return toast;
    },

    // Cerrar toast
    close(toast) {
        if (!toast) return;

        toast.classList.remove('toast-show');
        toast.classList.add('toast-exit');

        setTimeout(() => {
            if (toast.parentElement) {
                toast.parentElement.removeChild(toast);
            }
        }, 300);
    },

    // Atajos
    success(message, duration) {
        return this.show(message, 'success', duration);
    },

    error(message, duration) {
        return this.show(message, 'error', duration);
    },

    warning(message, duration) {
        return this.show(message, 'warning', duration);
    },

    info(message, duration) {
        return this.show(message, 'info', duration);
    },

    // Toast de carga (sin auto-cerrar)
    loading(message) {
        const toast = this.show(`
            <span class="spinner-border spinner-border-sm me-2"></span>
            ${message}
        `, 'info', 0);
        toast.classList.add('toast-loading');
        return toast;
    }
};

// Inicializar al cargar la p√°gina
document.addEventListener('DOMContentLoaded', function() {
    Toast.init();
    console.log('‚úÖ Sistema de Toast inicializado');
    console.log('üìç Contenedor Toast:', Toast.container);
});

console.log('‚úÖ Sistema de Toast cargado correctamente');

// ========================================================================================
//                        DEMO Y TESTING DE TOAST (Temporal - Remover en producci√≥n)
// ========================================================================================

// Funci√≥n para mostrar ejemplos de Toast (ll√°mala desde la consola con: mostrarDemoToast())
window.mostrarDemoToast = function() {
    console.log('üé® Mostrando ejemplos de Toast...');

    // Toast de √©xito
    setTimeout(() => {
        Toast.success('‚úÖ Registro creado exitosamente');
    }, 500);

    // Toast de error
    setTimeout(() => {
        Toast.error('‚ùå Error al procesar la solicitud');
    }, 1500);

    // Toast de advertencia
    setTimeout(() => {
        Toast.warning('‚ö†Ô∏è Campos obligatorios sin completar');
    }, 2500);

    // Toast de informaci√≥n
    setTimeout(() => {
        Toast.info('‚ÑπÔ∏è Filtros aplicados correctamente');
    }, 3500);

    // Toast de carga
    setTimeout(() => {
        const loadingToast = Toast.loading('Cargando datos...');
        // Simular carga de 3 segundos
        setTimeout(() => {
            Toast.close(loadingToast);
            Toast.success('‚úÖ Datos cargados');
        }, 3000);
    }, 4500);

    console.log('‚úÖ Demo completada. Los toasts aparecer√°n en 8 segundos.');
};

// Para probar en consola: mostrarDemoToast()

</script>

<!-- Estilos para Toast Notifications -->
<style>
/* Contenedor de toasts */
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 99999;
    display: flex;
    flex-direction: column;
    gap: 12px;
    max-width: 400px;
    pointer-events: none;
}

/* Toast base */
.toast {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 14px 16px;
    background: white;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 0, 0, 0.05);
    min-width: 300px;
    max-width: 400px;
    pointer-events: auto;
    transform: translateX(400px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
}

/* Barra de progreso */
.toast::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    height: 3px;
    width: 100%;
    background: currentColor;
    opacity: 0.3;
    transform-origin: left;
    animation: toast-progress 4s linear forwards;
}

@keyframes toast-progress {
    from { transform: scaleX(1); }
    to { transform: scaleX(0); }
}

.toast-loading::before {
    animation: none;
}

/* Animaciones de entrada/salida */
.toast-show {
    transform: translateX(0);
    opacity: 1;
}

.toast-exit {
    transform: translateX(400px);
    opacity: 0;
}

/* Icono del toast */
.toast-icon {
    font-size: 20px;
    flex-shrink: 0;
    display: flex;
    align-items: center;
}

/* Mensaje del toast */
.toast-message {
    flex: 1;
    font-size: 14px;
    line-height: 1.4;
    color: #333;
    font-weight: 500;
}

/* Bot√≥n de cerrar */
.toast-close {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    padding: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
    flex-shrink: 0;
}

.toast-close:hover {
    background: rgba(0, 0, 0, 0.05);
    color: #333;
}

/* Tipos de toast */
.toast-success {
    border-left: 4px solid #10b981;
    color: #10b981;
}

.toast-error {
    border-left: 4px solid #ef4444;
    color: #ef4444;
}

.toast-warning {
    border-left: 4px solid #f59e0b;
    color: #f59e0b;
}

.toast-info {
    border-left: 4px solid #3b82f6;
    color: #3b82f6;
}

/* Responsive */
@media (max-width: 768px) {
    .toast-container {
        right: 12px;
        left: 12px;
        max-width: none;
    }

    .toast {
        min-width: auto;
        max-width: none;
    }
}

/* Hover en toast */
.toast:hover {
    box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
}

/* Loading spinner en toast */
.toast-loading .spinner-border {
    color: currentColor;
}
</style>

{% endblock %}
