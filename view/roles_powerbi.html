{% extends "components/layout.html" %}
{% block title %}Gestión de Roles Power BI{% endblock %}

{% block head %}
<style>
    .toolbar-select {
        display: flex;
        gap: .5rem;
        align-items: center;
        margin-bottom: .5rem;
        flex-wrap: wrap;
    }
    .contador-seleccion {
        font-size: 12px;
        color: #555;
    }

    /* Tabla: evitar saltos en acciones y compactar botones */
    .tabla-roles th, .tabla-roles td {
        word-wrap: break-word;
        overflow-wrap: anywhere;
    }
    .col-acciones { white-space: nowrap; }
    .col-acciones .btn {
        padding: .2rem .45rem;
        font-size: .75rem;
        line-height: 1.1;
    }
    .col-acciones .d-inline-flex > * { margin-right: .25rem; }
    .col-acciones .d-inline-flex > *:last-child { margin-right: 0; }

    /* Colores por defecto para herramientas de selección */
    .btn-seleccionar {
        background-color: #198754;  /* Bootstrap success */
        color: #fff;
        border-color: #198754;
    }
    .btn-seleccionar:hover {
        background-color: #157347;
        border-color: #146c43;
        color: #fff;
    }
    .btn-limpiar {
        background-color: #6c757d; /* Bootstrap secondary */
        color: #fff;
        border-color: #6c757d;
    }
    .btn-limpiar:hover {
        background-color: #5c636a;
        border-color: #565e64;
        color: #fff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid d-flex flex-column" style="min-height: 100vh;">
    <div class="row justify-content-between align-items-center mb-4">
        <h1 class="col-auto" style="font-size: 22px; font-family: 'Century Gothic', sans-serif;">Gestión de Roles de Acceso Power BI - Azure</h1>
        <h1 class="col-auto" style="font-size: 14px; font-family: 'Century Gothic', sans-serif;">¡Hola, {{ user_session.nombres }} {{ user_session.apellidos }}!</h1>
        <img src="/static/Consorcio.png" alt="Consorcio Icon" class="col-auto" style="max-width: 100px; height: auto;">
    </div>

    {% if success_message %}
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            {{ success_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    {% endif %}

    {% if error_message %}
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            {{ error_message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
        </div>
    {% endif %}

    <div class="row flex-grow-1">
        <!-- Formulario Crear Rol -->
        <div class="col-lg-5 d-flex flex-column" style="height: 80vh;">
        <div class="card shadow-sm flex-grow-1 d-flex flex-column">
            <div class="card-header bg-primary text-white">
            <h4 class="mb-0" style="font-size: 18px; font-family: 'Century Gothic', sans-serif; color: #ffffff; font-weight: bold;">Crear Nuevo Rol Power BI</h4>
            </div>
            <div class="card-body flex-grow-1 d-flex flex-column" style="overflow-y: auto; height: 70vh;">
            <form id="formCrearRolPowerBI" action="/roles_powerbi" method="post">
                <div class="mb-3">
                <label for="nombreRol" class="form-label">Nombre del Rol</label>
                <input type="text" class="form-control" id="nombreRol" name="nombre_rol" placeholder="Ingrese el nombre del rol" required>
                </div>

                <div class="mb-1 d-flex justify-content-between align-items-center">
                <label for="idPowerBI" class="form-label mb-0">Reportes (Workspacename - Itemname)</label>
                <span id="contadorCrear" class="contador-seleccion">0 seleccionados</span>
                </div>

                <div class="toolbar-select">
                <input type="text" class="form-control form-control-sm" id="filtroCrear" placeholder="Filtrar reportes...">
                <button type="button" class="btn btn-sm btn-success" id="btnSeleccionarTodoCrear">Seleccionar todo</button>
                <button type="button" class="btn btn-sm btn-secondary" id="btnLimpiarCrear">Limpiar</button>
                </div>

                <select multiple class="form-select" id="idPowerBI" name="id_powerbi" style="height: 35vh;" required>
                {% for r in opciones_reportes %}
                    <option value="{{ r.id }}">{{ r.etiqueta }}</option>
                {% endfor %}
                </select>

                <small class="form-text text-muted">Mantenga presionado Ctrl o Cmd para seleccionar varios reportes.</small>
                <button type="submit" class="btn btn-success w-100 mt-3">Guardar</button>
            </form>
            </div>
        </div>
    </div>

    <!-- Tabla Roles -->
    <div class="col-lg-7 d-flex flex-column" style="height: 80vh;">
        <div class="card shadow-sm flex-grow-1 d-flex flex-column">
            <div class="card-header bg-dark text-white" style="margin-bottom: 0;">
            <h4 class="mb-0" style="font-size: 18px; font-family: 'Century Gothic', sans-serif; color: #ffffff; font-weight: bold;">Roles Power BI Existentes</h4>
            </div>
            <div class="card-body flex-grow-1 d-flex flex-column card-body-alta" style="padding-top: 0;">
            <table class="table table-hover table-striped tabla-roles" style="font-size: 12px; table-layout: fixed; width: 100%;">
                <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
                <tr>
                    <th style="width: 6%;">ID</th>
                    <th style="width: 18%;">Nombre</th>
                    <th style="width: 48%;">Reportes Asignados</th>
                    <th style="width: 10%;">Estado</th>
                    <th style="width: 25%; text-align:center;">Acciones</th>
                </tr>
                </thead>
                <tbody>
                {% for rol in roles %}
                <tr>
                    <td>{{ rol.id }}</td>
                    <td>{{ rol.nombre }}</td>
                    <td>
                    {% if rol.nombres_reportes and rol.nombres_reportes|length > 0 %}
                        {% set texto = rol.nombres_reportes|join(', ') %}
                        <span title="{{ texto }}">{{ texto|truncate(120, True, '...') }}</span>
                        <div><small class="text-muted">{{ rol.nombres_reportes|length }} reporte(s)</small></div>
                    {% else %}
                        <em>—</em>
                    {% endif %}
                    </td>
                    <td>
                    {% if rol.estado == 1 %}
                        <span class="badge bg-success">Activo</span>
                    {% else %}
                        <span class="badge bg-secondary">Inactivo</span>
                    {% endif %}
                    </td>
                    <td class="text-center col-acciones">
                        <div class="d-inline-flex align-items-center flex-nowrap">
                            <button type="button" class="btn btn-primary btn-sm px-2 py-1"
                                    data-bs-toggle="modal" data-bs-target="#modalEditarRolPowerBI"
                                    data-rol-id="{{ rol.id }}">
                            Editar
                            </button>
                            {% if rol.estado == 1 %}
                            <form action="/roles_powerbi/{{ rol.id }}/inactivar" method="post" class="d-inline m-0 p-0">
                                <button type="submit" class="btn btn-warning btn-sm px-2 py-1">Inactivar</button>
                            </form>
                            {% else %}
                            <form action="/roles_powerbi/{{ rol.id }}/activar" method="post" class="d-inline m-0 p-0">
                                <button type="submit" class="btn btn-success btn-sm px-2 py-1">Activar</button>
                            </form>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        </div>
    </div>
</div>

<!-- Modal Editar Rol -->
<div class="modal fade" id="modalEditarRolPowerBI" tabindex="-1" aria-labelledby="modalEditarRolPowerBILabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
        <form id="formEditarRolPowerBI" method="post">
            <input type="hidden" id="idRolOculto" name="id_rol" value="">
            <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="modalEditarRolPowerBILabel">Editar Rol Power BI</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body modal-body-alta">
            <div class="mb-3">
                <label for="idRolLectura" class="form-label">ID del Rol</label>
                <input type="text" class="form-control" id="idRolLectura" disabled>
            </div>
            <div class="mb-3">
                <label for="nombreRolEditar" class="form-label">Nombre del Rol</label>
                <input type="text" class="form-control" id="nombreRolEditar" name="nombre_rol" required>
            </div>

            <div class="mb-1 d-flex justify-content-between align-items-center">
                <label for="idPowerBIEd" class="form-label mb-0">Reportes</label>
                <span id="contadorEditar" class="contador-seleccion">0 seleccionados</span>
            </div>

            <div class="toolbar-select">
                <input type="text" class="form-control form-control-sm" id="filtroEditar" placeholder="Filtrar reportes...">
                <button type="button" class="btn btn-sm btn-success" id="btnSeleccionarTodoEditar">Seleccionar todo</button>
                <button type="button" class="btn btn-sm btn-secondary" id="btnLimpiarEditar">Limpiar</button>
            </div>

            <select multiple class="form-select select-responsivo select-expand" id="idPowerBIEd" name="id_powerbi" required>
                {% for r in opciones_reportes %}
                <option value="{{ r.id }}">{{ r.etiqueta }}</option>
                {% endfor %}
            </select>
            </div>
            <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="submit" class="btn btn-primary">Guardar Cambios</button>
            </div>
        </form>
        </div>
    </div>
</div>

<script>
  // Utilidades de filtrado y contadores
    function filtrarOpciones(inputEl, selectEl) {
        const term = (inputEl.value || '').toLowerCase();
        Array.from(selectEl.options).forEach(opt => {
        const visible = opt.text.toLowerCase().includes(term);
        opt.hidden = !visible; // oculta/mostrar opciones
        });
    }

    function seleccionarTodo(selectEl) {
        Array.from(selectEl.options).forEach(opt => { if (!opt.hidden) opt.selected = true; });
        actualizarContador(selectEl);
    }

    function limpiarSeleccion(selectEl) {
        Array.from(selectEl.options).forEach(opt => opt.selected = false);
        actualizarContador(selectEl);
    }

    function actualizarContador(selectEl) {
        const total = Array.from(selectEl.options).filter(o => o.selected).length;
        const spanId = selectEl.id === 'idPowerBI' ? 'contadorCrear' : 'contadorEditar';
        const span = document.getElementById(spanId);
        if (span) span.textContent = `${total} seleccionados`;
    }

  // Crear: wiring
    const selectCrear = document.getElementById('idPowerBI');
    const filtroCrear = document.getElementById('filtroCrear');
    const btnSelTodoCrear = document.getElementById('btnSeleccionarTodoCrear');
    const btnLimpiarCrear = document.getElementById('btnLimpiarCrear');

    if (selectCrear) {
        selectCrear.addEventListener('change', () => actualizarContador(selectCrear));
        window.addEventListener('load', () => actualizarContador(selectCrear));
    }
    if (filtroCrear && selectCrear) {
        filtroCrear.addEventListener('input', () => filtrarOpciones(filtroCrear, selectCrear));
    }
    if (btnSelTodoCrear && selectCrear) {
        btnSelTodoCrear.addEventListener('click', () => seleccionarTodo(selectCrear));
    }
    if (btnLimpiarCrear && selectCrear) {
        btnLimpiarCrear.addEventListener('click', () => limpiarSeleccion(selectCrear));
    }

  // Editar: abrir modal, cargar datos y wiring
    const modalEditar = document.getElementById('modalEditarRolPowerBI');
    modalEditar.addEventListener('show.bs.modal', function (evento) {
        const boton = evento.relatedTarget;
        const idRol = boton.getAttribute('data-rol-id');

    // Reset campos
    document.getElementById('idRolLectura').value = '';
    document.getElementById('nombreRolEditar').value = '';
    const selectEd = document.getElementById('idPowerBIEd');
    Array.from(selectEd.options).forEach(opt => { opt.selected = false; opt.hidden = false; });

    // Fetch datos
        fetch(`/roles_powerbi/${idRol}/datos`)
        .then(resp => {
            if (!resp.ok) throw new Error('No se pudo cargar el rol');
            return resp.json();
        })
        .then(data => {
            document.getElementById('idRolLectura').value = data.id;
            document.getElementById('nombreRolEditar').value = data.nombre_rol_powerbi;

            // Seleccionar reportes
            const ids = data.id_powerbi || [];
            const setIds = new Set(ids.map(Number));
            Array.from(selectEd.options).forEach(opt => {
            opt.selected = setIds.has(parseInt(opt.value));
            });

            // Apuntar el form a la ruta correcta
            document.getElementById('formEditarRolPowerBI').action = `/roles_powerbi/${idRol}/editar`;

            actualizarContador(selectEd);
        })
        .catch(err => {
            console.error(err);
            alert('No se pudo cargar la información del rol.');
        });
    });

  // Editar: filtrado y botones
    const selectEditar = document.getElementById('idPowerBIEd');
    const filtroEditar = document.getElementById('filtroEditar');
    const btnSelTodoEditar = document.getElementById('btnSeleccionarTodoEditar');
    const btnLimpiarEditar = document.getElementById('btnLimpiarEditar');

    if (selectEditar) {
        selectEditar.addEventListener('change', () => actualizarContador(selectEditar));
    }
    if (filtroEditar && selectEditar) {
        filtroEditar.addEventListener('input', () => filtrarOpciones(filtroEditar, selectEditar));
    }
    if (btnSelTodoEditar && selectEditar) {
        btnSelTodoEditar.addEventListener('click', () => seleccionarTodo(selectEditar));
    }
    if (btnLimpiarEditar && selectEditar) {
        btnLimpiarEditar.addEventListener('click', () => limpiarSeleccion(selectEditar));
    }
</script>
{% endblock %}
