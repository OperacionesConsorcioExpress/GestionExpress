{% extends "components/layout.html" %}
{% block title %}Configuración Buses · Consorcio Express{% endblock %}

{% block head %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
  .contenedor-ancho{ width:min(96vw,1920px); margin:0 auto; padding:0 16px; }
  .btn-action{ padding:.50rem .8rem; font-size:24px; line-height:1.1; }
  .btn-action i{ font-size:1.2rem; }
  .overlay-proceso{ position:fixed; inset:0; background:rgba(255,255,255,.70); z-index:2000; display:flex; align-items:center; justify-content:center; }
  .overlay-proceso[hidden]{ display:none!important; }
  .upper{ text-transform:uppercase; }

  /* Encabezado pegajoso y oscuro */
  .tabla-buses thead th{
    position: sticky;
    top: 0;
    z-index: 2;
    background: #0a0f3d !important;   /* más oscuro */
    color: #ffffff !important;
    border-bottom: 1px solid #e5e7eb;
    white-space: nowrap;
  }

  /* >>> Fila en una sola línea con puntos suspensivos si no cabe */
  .tabla-buses td, .tabla-buses th{
    white-space: nowrap;        /* no permitir saltos de línea */
    vertical-align: middle;
  }
  .tabla-buses td{
    max-width: 220px;           /* ajusta si necesitas */
    overflow: hidden;
    text-overflow: ellipsis;    /* … cuando no quepa */
  }

  /* Que la caja de tabla pueda scrollear en X si es necesario */
  .tabla-scroll{
    max-height:55vh;
    overflow:auto;
    overflow-x:auto;
  }

  /* Paginación que no se desborde */
  .paginador{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; border-top:1px solid #e5e7eb; background:rgb(203,207,231);
    border-radius:0 0 12px 12px; gap:10px;
  }
  .paginacion-wrap{ overflow-x:auto; max-width:100%; }
  .pagination{ flex-wrap:nowrap; margin:0; }
</style>
{% endblock %}

{% block content %}
<div style="font-size:12px; font-family:'Century Gothic', sans-serif; color:#111827; background:#ffffff; padding:16px 0;">
  <div class="container-fluid contenedor-ancho">
    <!-- HERO -->
    <div style="position:relative; border:1px solid #e5e7eb; background:#fff; border-radius:14px; padding:16px; margin-bottom:14px; box-shadow:0 6px 16px rgba(17,24,39,.06);">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <h1 style="margin:0; font-size:18px; font-weight:700; letter-spacing:.2px;">Configuración · Buses CEXP</h1>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#modalCarga">
            <i class="fa-solid fa-file-arrow-up me-1"></i> Carga masiva
          </button>
          <button id="btn-nuevo-bus" class="btn btn-sm" data-bs-toggle="modal" data-bs-target="#modalBus"
            style="background:#0d6efd; color:#fff; border:1px solid #0b5ed7; border-radius:8px; padding:.35rem .7rem;">
            <i class="fa-solid fa-plus me-1"></i> Nuevo Bus
          </button>
        </div>
      </div>
    </div>

    <!-- FILTROS -->
    <div style="border:1px solid #e5e7eb; background:rgb(220, 222, 236); border-radius:12px; padding:12px; margin-bottom:10px; box-shadow:0 6px 16px rgba(17,24,39,.06);">
      <div style="background:#ffffff; border:1px dashed #e5e7eb; border-radius:10px; padding:10px;">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-1">
            <label class="form-label mb-1">Placa/Interno</label>
            <input id="f-q" type="text" class="form-control upper" placeholder="Ej: TZX123 / 019" style="font-size:12px; height:34px;">
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label mb-1">Estado</label>
            <select id="f-estado" class="form-select" style="font-size:12px; height:34px;">
              <option value="">Todos</option>
              <option value="1">Activos</option>
              <option value="0">Inactivos</option>
            </select>
          </div>
          <!-- Filtros encadenados -->
          <div class="col-6 col-md-1">
            <label class="form-label mb-1">Componente</label>
            <select id="f-componente" class="form-select" style="font-size:12px; height:34px;">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-6 col-md-1">
            <label class="form-label mb-1">Zona</label>
            <select id="f-zona" class="form-select" style="font-size:12px; height:34px;">
              <option value="">Todas</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1">Centro Operación</label>
            <select id="f-cop" class="form-select" style="font-size:12px; height:34px;">
              <option value="">Todos</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1">Combustible</label>
            <select id="f-combustible" class="form-select" style="font-size:12px; height:34px;">
              <option value="">Todos</option>
              <option value="ACPM">ACPM</option>
              <option value="GNV">GNV</option>
              <option value="ELECTRICO">ELECTRICO</option>
            </select>
          </div>
          <div class="col-6 col-md-2">
            <label class="form-label mb-1">Tipología</label>
            <input id="f-tipologia" type="text" class="form-control upper" placeholder="PADRON / ARTICULADO" style="font-size:12px; height:34px;">
          </div>
          <div class="col-3 col-md-1">
            <label class="form-label mb-1">Modelo ≥</label>
            <input id="f-modelo-desde" type="number" class="form-control" min="1990" max="2100" style="font-size:12px; height:34px;">
          </div>
          <div class="col-3 col-md-1">
            <label class="form-label mb-1">Modelo ≤</label>
            <input id="f-modelo-hasta" type="number" class="form-control" min="1990" max="2100" style="font-size:12px; height:34px;">
          </div>
        </div>
      </div>
    </div>

    <!-- TABLA -->
    <div style="border:1px solid #e5e7eb; background:#fff; border-radius:12px; box-shadow:0 6px 16px rgba(17,24,39,.06);">
      <div class="table-responsive tabla-scroll" style="max-height:55vh; overflow:auto;">
        <table class="table table-hover align-middle mb-0 tabla-buses">
          <thead>
            <tr>
              <th>ID</th>
              <th>Placa</th>
              <th>Interno</th>
              <th>Tipología</th>
              <th>Modelo</th>
              <th>Marca</th>
              <th>Línea</th>
              <th>Carrocería</th>
              <th>Combustible</th>
              <th>Tecnología</th>
              <th>Componente</th>
              <th>Zona</th>
              <th>COP</th>
              <th style="text-align:center;">Estado</th>
              <th>Creado</th>
              <th>Actualizado</th>
              <th style="text-align:right;">Acciones</th>
            </tr>
          </thead>
          <tbody id="tbody-buses"></tbody>
        </table>
      </div>
      <div class="paginador">
      <div id="txt-total" style="color:#6b7280;">0 de 0 registros</div>
      <div class="paginacion-wrap">
        <ul class="pagination pagination-sm" id="paginacion-buses">
          <li class="page-item active"><a class="page-link" href="#">1</a></li>
        </ul>
      </div>
    </div>
    </div>
  </div>
</div>

<!-- MODAL: Bus -->
<div class="modal fade" id="modalBus" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 20px 60px rgba(17,24,39,.16);">
      <div class="modal-header" style="border-bottom:1px solid #e5e7eb;">
        <h5 class="modal-title" style="font-weight:700; font-size:14px; color:#111827;">
          <i class="fa-solid fa-bus me-2"></i> Crear / Ediar Bus
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" style="padding:12px;">
        <div class="row g-2">
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Placa</label>
            <input id="bus-placa" type="text" class="form-control upper" placeholder="ABC123" style="font-size:12px; height:34px;">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">No Interno</label>
            <input id="bus-interno" type="text" class="form-control upper" placeholder="019" style="font-size:12px; height:34px;">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Tipología</label>
            <input id="bus-tipologia" type="text" class="form-control upper" placeholder="PADRON / ARTICULADO" style="font-size:12px; height:34px;">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label mb-1">Modelo</label>
            <input id="bus-modelo" type="number" min="1990" max="2100" class="form-control" style="font-size:12px; height:34px;">
          </div>

          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Marca</label>
            <input id="bus-marca" type="text" class="form-control upper" style="font-size:12px; height:34px;">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Línea</label>
            <input id="bus-linea" type="text" class="form-control upper" style="font-size:12px; height:34px;">
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Carrocería</label>
            <input id="bus-carroceria" type="text" class="form-control upper" style="font-size:12px; height:34px;">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label mb-1">Combustible</label>
            <select id="bus-combustible" class="form-select" style="font-size:12px; height:34px;">
              <option value="">-- Selecciona --</option>
              <option value="ACPM">ACPM</option>
              <option value="GNV">GNV</option>
              <option value="ELECTRICO">ELECTRICO</option>
            </select>
          </div>

          <div class="col-6 col-md-3">
            <label class="form-label mb-1">Tecnología</label>
            <input id="bus-tecnologia" type="text" class="form-control upper" placeholder="EURO V / ELÉCTRICO" style="font-size:12px; height:34px;">
          </div>

          <!-- Encadenados -->
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Componente</label>
            <select id="bus-componente" class="form-select" style="font-size:12px; height:34px;">
              <option value="">-- Selecciona --</option>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Zona</label>
            <select id="bus-zona" class="form-select" style="font-size:12px; height:34px;">
              <option value="">-- Selecciona --</option>
            </select>
          </div>
          <div class="col-12 col-md-3">
            <label class="form-label mb-1">Centro Operación</label>
            <select id="bus-cop" class="form-select" style="font-size:12px; height:34px;">
              <option value="">-- Selecciona --</option>
            </select>
          </div>

          <div class="col-12">
            <div class="form-check form-switch" style="padding-left:2.2rem;">
              <input class="form-check-input" type="checkbox" id="bus-estado" checked>
              <label class="form-check-label" for="bus-estado">Activo</label>
            </div>
          </div>
          <input type="hidden" id="bus-id">
        </div>
      </div>
      <div class="modal-footer" style="border-top:1px solid #e5e7eb; padding:10px 12px;">
        <button type="button" class="btn btn-sm" data-bs-dismiss="modal" style="border:1px solid #e5e7eb; background:#fff;">Cancelar</button>
        <button id="btn-guardar-bus" type="button" class="btn btn-sm" style="background:#0d6efd; color:#fff; border:1px solid #0b5ed7;">Guardar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL: Carga Masiva -->
<div class="modal fade" id="modalCarga" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="background:#ffffff; border:1px solid #e5e7eb; border-radius:12px;">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i> Carga masiva de Buses</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p class="mb-2">Formatos soportados: <strong>.xlsx</strong> o <strong>.csv</strong></p>
        <ul class="mb-3">
          <li>Cabeceras: <em>Placa, No Interno, Tipologia, Modelo, Marca, Linea, Carroceria, Combustible, Tecnologia, Centro Operacion</em></li>
          <li><strong>Centro Operacion</strong> puede ser <em>Nombre</em> o <em>ID</em> (híbrido).</li>
        </ul>
        <input id="archivo-carga" type="file" class="form-control">
        <div class="small text-muted mt-2" id="resultado-carga"></div>

        <!-- Área de previsualización -->
        <div id="area-preview" class="mt-3" style="display:none;">
          <div class="fw-bold mb-1">Previsualización (máx. 50 filas):</div>
          <div class="table-responsive" style="max-height:40vh; overflow:auto;">
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Fila</th><th>Placa</th><th>Acción</th><th>ID COP</th><th>Combustible</th><th>Tipología</th><th>Modelo</th>
                </tr>
              </thead>
              <tbody id="preview-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="btn-previsualizar" class="btn btn-outline-primary btn-sm">
          <i class="fa-solid fa-eye me-1"></i> Previsualizar
        </button>
        <button id="btn-cargar" class="btn btn-primary btn-sm">
          <i class="fa-solid fa-upload me-1"></i> Confirmar carga
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Overlay de proceso (bloquea la UI mientras procesa) -->
<div id="overlay-proceso" class="overlay-proceso" hidden aria-hidden="true">
  <div class="text-center">
    <div class="spinner-border mb-2" role="status" aria-hidden="true"></div>
    <div class="fw-bold">Procesando archivo, por favor espera…</div>
  </div>
</div>

<!-- Toasts -->
<div aria-live="polite" aria-atomic="true" class="position-fixed top-0 end-0 p-3" style="z-index:1080;">
  <div id="pila-toasts"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  /* ===== Utilidades de modal/backdrop ===== */
  function limpiarBackdrops(){
    document.querySelectorAll('.modal-backdrop').forEach(el=>el.remove());
    document.body.classList.remove('modal-open');
    document.body.style.removeProperty('overflow');
    document.body.style.removeProperty('padding-right');
  }
  function cerrarModal(id){
    const el = document.getElementById(id);
    if(!el) return;
    const inst = bootstrap.Modal.getOrCreateInstance(el);
    const onHidden = () => { el.removeEventListener('hidden.bs.modal', onHidden); setTimeout(limpiarBackdrops,0); };
    el.addEventListener('hidden.bs.modal', onHidden, { once:true });
    inst.hide();
    setTimeout(()=>{ if(!document.querySelector('.modal.show')) limpiarBackdrops(); }, 300);
  }
  document.addEventListener('hidden.bs.modal', ()=>{ if(!document.querySelector('.modal.show')) limpiarBackdrops(); });

  /* ===== Toasts ===== */
  function mostrarToast({titulo="Aviso", cuerpo="", tipo="success"}){
    const id = `t_${Date.now()}`;
    const color = tipo==="success" ? "#198754" : tipo==="warning" ? "#ffc107" : "#dc3545";
    const html = `
      <div id="${id}" class="toast align-items-center border-0 show" role="alert" aria-live="assertive" aria-atomic="true"
          style="min-width:260px; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,.1); border-left:4px solid ${color}">
        <div class="d-flex">
          <div class="toast-body">
            <div class="fw-bold" style="color:${color}">${titulo}</div>
            <div style="color:#111827">${cuerpo}</div>
          </div>
          <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      </div>`;
    const pila = document.getElementById('pila-toasts');
    const wrap = document.createElement('div'); wrap.innerHTML = html;
    const el = wrap.firstElementChild; pila.appendChild(el);
    setTimeout(()=>{ try { bootstrap.Toast.getOrCreateInstance(el).hide(); } catch{} }, 3200);
    el.addEventListener('hidden.bs.toast', ()=> el.remove());
  }

  /* ===== Helpers HTTP ===== */
  function normalizarError(status, payload){
    if(payload && Array.isArray(payload.detail)){
      const msgs = payload.detail.map(d => d.msg || JSON.stringify(d)).join(' | ');
      return {status, detail: msgs};
    }
    const det = payload?.detail || payload?.message || JSON.stringify(payload) || `HTTP ${status}`;
    return {status, detail: det};
  }
  async function getJSON(url, params = {}) {
    const limpio = {};
    for(const k in params){ const v = params[k]; if(v===''||v===null||v===undefined) continue; limpio[k]=v; }
    const q = new URLSearchParams(limpio); const full = q.toString()?`${url}?${q}`:url;
    const res = await fetch(full, { credentials:'same-origin' });
    let data = null; try{ data = await res.json(); }catch{}
    if(!res.ok) throw normalizarError(res.status, data);
    return data;
  }
  async function sendJSON(url, method, body) {
    const res = await fetch(url, { method, headers:{'Content-Type':'application/json'}, credentials:'same-origin', body:JSON.stringify(body) });
    let data = null; try{ data = await res.json(); }catch{}
    if(!res.ok) throw normalizarError(res.status, data);
    return data;
  }
  function esc(s){ return (s??'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
  function badgeEstado(estado){
    return `<span class="badge ${estado==1?'bg-success-subtle text-success border border-success-subtle':'bg-danger-subtle text-danger border border-danger-subtle'}" style="font-size:11px;">${estado==1?'ACTIVO':'INACTIVO'}</span>`;
  }

  /* ===== API ===== */
  const API = {
    buses: {
      listar: (p={})         => getJSON(`/api/config/buses_cexp`, p),
      crear:  (cuerpo)        => sendJSON(`/api/config/buses_cexp`, 'POST', cuerpo),
      actualizar: (id,cuerpo) => sendJSON(`/api/config/buses_cexp/${id}`, 'PUT', cuerpo),
      estado: (id, estado)    => sendJSON(`/api/config/buses_cexp/${id}/estado`, 'PATCH', {estado}),
      cop:     (p={})         => getJSON(`/api/config/buses_cexp/cop`, p)
    },
    filtros: {
      componentes: () => getJSON(`/api/config/buses_cexp/filtros/componentes`),
      zonas: (p={})   => getJSON(`/api/config/buses_cexp/filtros/zonas`, p),
    },
    carga: {
      preview: (fd)  => fetch(`/api/config/buses_cexp/upload/preview`, { method:'POST', body: fd, credentials:'same-origin' }).then(async r=>{const j=await r.json(); if(!r.ok) throw j; return j;}),
      subir:   (fd)  => fetch(`/api/config/buses_cexp/upload`,         { method:'POST', body: fd, credentials:'same-origin' }).then(async r=>{const j=await r.json(); if(!r.ok) throw j; return j;})
    }
  };

  /* ===== Estado ===== */
  const estado = { pagina:1, tamano:10, q:'', es:'', comp:'', zona:'', cop:'', comb:'', tip:'', modD:'', modH:'' };
  let cache = { filas:[], cop:[], componentes:[], zonas:[] };

  /* ===== Paginación ===== */
  function dibujarPaginacion(idContenedor, actual, total, onChange){
    const ul = document.getElementById(idContenedor);
    if(!ul) return;

    // Ventana de páginas (5 visibles alrededor)
    const windowSize = 5;
    const start = Math.max(1, actual - Math.floor(windowSize/2));
    const end   = Math.min(total, start + windowSize - 1);
    const realStart = Math.max(1, end - windowSize + 1);

    const btn = (p, label = null, disabled = false, active = false) => {
      const l = label ?? p;
      const dis = disabled ? ' disabled' : '';
      const act = active   ? ' active'   : '';
      return `<li class="page-item${dis}${act}"><a class="page-link" href="#" data-page="${p}">${l}</a></li>`;
    };

    let html = '';
    // Primero y anterior
    html += btn(1, '«', actual===1);
    html += btn(Math.max(1, actual-1), '‹', actual===1);

    // Elipsis izquierda si aplica
    if(realStart > 1){
      html += btn(1, '1', false, actual===1);
      if(realStart > 2) html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
    }

    // Ventana central
    for(let p = realStart; p <= end; p++){
      html += btn(p, String(p), false, p===actual);
    }

    // Elipsis derecha si aplica
    if(end < total){
      if(end < total-1) html += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
      html += btn(total, String(total), false, actual===total);
    }

    // Siguiente y último
    html += btn(Math.min(total, actual+1), '›', actual===total);
    html += btn(total, '»', actual===total);

    ul.innerHTML = html;

    // Delegación segura de eventos
    ul.querySelectorAll('a[data-page]').forEach(a=>{
      a.onclick = (e)=>{
        e.preventDefault();
        const np = Number(a.dataset.page);
        if(Number.isFinite(np) && np>=1 && np<=total && np!==actual){
          onChange(np);
        }
      };
    });
  }

  /* ===== Uppercase forzado en inputs ===== */
  function forzarMayusculas(selector){
    document.querySelectorAll(selector).forEach(el=>{
      el.addEventListener('input', ()=>{ el.value = (el.value||'').toUpperCase(); });
      el.addEventListener('blur',  ()=>{ el.value = (el.value||'').toUpperCase(); });
    });
  }

  /* ===== Carga de listas encadenadas (componentes → zonas → cop) ===== */
  async function cargarCOPs(componente='', zona=''){
    const rs = await API.buses.cop({ componente, zona, estado:1 });
    cache.cop = rs.data || [];
    // Filtro principal
    const selFiltro = document.getElementById('f-cop');
    selFiltro.innerHTML = `<option value="">Todos</option>`;
    cache.cop.forEach(c => selFiltro.insertAdjacentHTML('beforeend', `<option value="${c.id}">${esc(c.cop)}</option>`));
    // Modal
    const selModal = document.getElementById('bus-cop');
    selModal.innerHTML = `<option value="">-- Selecciona --</option>`;
    cache.cop.forEach(c => selModal.insertAdjacentHTML('beforeend', `<option value="${c.id}">${esc(c.cop)}</option>`));
  }

  async function cargarComponentes(){
    const rs = await API.filtros.componentes();
    cache.componentes = rs.data || [];
    const selF = document.getElementById('f-componente');
    const selM = document.getElementById('bus-componente');
    selF.innerHTML = `<option value="">Todos</option>`;
    selM.innerHTML = `<option value="">-- Selecciona --</option>`;
    cache.componentes.forEach(c=>{
      selF.insertAdjacentHTML('beforeend', `<option value="${esc(c)}">${esc(c)}</option>`);
      selM.insertAdjacentHTML('beforeend', `<option value="${esc(c)}">${esc(c)}</option>`);
    });
  }

  async function cargarZonas(componente=''){
    const rs = await API.filtros.zonas({ componente });
    cache.zonas = rs.data || [];
    const selF = document.getElementById('f-zona');
    const selM = document.getElementById('bus-zona');
    selF.innerHTML = `<option value="">Todas</option>`;
    selM.innerHTML = `<option value="">-- Selecciona --</option>`;
    cache.zonas.forEach(z=>{
      selF.insertAdjacentHTML('beforeend', `<option value="${esc(z)}">${esc(z)}</option>`);
      selM.insertAdjacentHTML('beforeend', `<option value="${esc(z)}">${esc(z)}</option>`);
    });
    // También recargar COP filtrados por el par (componente, zona)
    await cargarCOPs(componente, '');
  }

  // Encadenamiento en filtros
  document.getElementById('f-componente')?.addEventListener('change', async e=>{
    estado.comp = e.target.value; estado.zona=''; estado.cop='';
    await cargarZonas(estado.comp);
    await cargarCOPs(estado.comp, '');
    document.getElementById('f-cop').value = '';
    document.getElementById('f-zona').value = '';
    estado.pagina=1; cargarBuses();
  });
  document.getElementById('f-zona')?.addEventListener('change', async e=>{
    estado.zona = e.target.value; estado.cop='';
    await cargarCOPs(estado.comp, estado.zona);
    document.getElementById('f-cop').value = '';
    estado.pagina=1; cargarBuses();
  });
  document.getElementById('f-cop')?.addEventListener('change', e=>{ estado.cop = e.target.value; estado.pagina=1; cargarBuses(); });

  /* ===== Cargar Buses ===== */
  async function cargarBuses(){
    const p = {
      pagina: estado.pagina,
      tamano: estado.tamano,
      q: estado.q,
      ...(estado.es  !== '' ? { estado: estado.es } : {}),
      ...(estado.cop !== '' ? { id_cop: estado.cop } : {}),
      ...(estado.comb!== '' ? { combustible: estado.comb } : {}),
      ...(estado.tip !== '' ? { tipologia: estado.tip } : {}),
      ...(estado.modD!== '' ? { modelo_desde: estado.modD } : {}),
      ...(estado.modH!== '' ? { modelo_hasta: estado.modH } : {})
    };
    const resp = await API.buses.listar(p);
    cache.filas = resp.data || [];
    const tb = document.getElementById('tbody-buses');
    tb.innerHTML = cache.filas.map(r=>`
      <tr>
        <td>${r.id}</td>
        <td>${esc(r.placa)}</td>
        <td>${esc(r.no_interno||'')}</td>
        <td>${esc(r.tipologia||'')}</td>
        <td>${esc(r.modelo||'')}</td>
        <td>${esc(r.marca||'')}</td>
        <td>${esc(r.linea||'')}</td>
        <td>${esc(r.carroceria||'')}</td>
        <td>${esc(r.combustible||'')}</td>
        <td>${esc(r.tecnologia||'')}</td>
        <td>${esc(r.componente||'')}</td>
        <td>${esc(r.zona||'')}</td>
        <td>${esc(r.cop||'')}</td>
        <td style="text-align:center;">${badgeEstado(r.estado)}</td>
        <td>${esc(r.created_at||'')}</td>
        <td>${esc(r.updated_at||'')}</td>
        <td style="text-align:right;">
          <div class="btn-group">
            <button class="btn btn-outline-secondary btn-action" title="Editar" onclick="abrirEdicion(${Number(r.id)})">
              <i class="fa-solid fa-pen"></i>
            </button>
            <button class="btn btn-outline-${r.estado==1?'warning':'success'} btn-action" title="${r.estado==1?'Inactivar':'Activar'}"
                    onclick="cambiarEstado(${Number(r.id)}, ${r.estado==1?0:1})">
              <i class="fa-solid ${r.estado==1?'fa-power-off':'fa-check'}"></i>
            </button>
          </div>
        </td>
      </tr>
    `).join('');
    document.getElementById('txt-total').textContent = `${cache.filas.length} de ${resp.total} registros`;
    dibujarPaginacion('paginacion-buses', estado.pagina, Math.max(1, Math.ceil(resp.total / estado.tamano)), (np)=>{ estado.pagina=np; cargarBuses(); });
  }

  /* ===== CRUD ===== */
  function abrirEdicion(id){
    const r = cache.filas.find(x=> Number(x.id)===Number(id));
    if(!r) return mostrarToast({titulo:'Bus', cuerpo:'Registro no encontrado', tipo:'danger'});
    document.getElementById('bus-id').value = r.id;
    document.getElementById('bus-placa').value = r.placa || '';
    document.getElementById('bus-interno').value = r.no_interno || '';
    document.getElementById('bus-tipologia').value = r.tipologia || '';
    document.getElementById('bus-modelo').value = r.modelo || '';
    document.getElementById('bus-marca').value = r.marca || '';
    document.getElementById('bus-linea').value = r.linea || '';
    document.getElementById('bus-carroceria').value = r.carroceria || '';
    document.getElementById('bus-combustible').value = r.combustible || '';
    document.getElementById('bus-tecnologia').value = r.tecnologia || '';
    // Encadenados: establecer componente/zona y cargar cop
    document.getElementById('bus-componente').value = r.componente || '';
    (async ()=>{
      await cargarZonas(r.componente || '');
      document.getElementById('bus-zona').value = r.zona || '';
      await cargarCOPs(r.componente || '', r.zona || '');
      document.getElementById('bus-cop').value = r.id_cop || '';
    })();
    document.getElementById('bus-estado').checked = Number(r.estado)===1;
    bootstrap.Modal.getOrCreateInstance(document.getElementById('modalBus')).show();
  }

  async function cambiarEstado(id, estadoNuevo){
    try{
      await API.buses.estado(id, estadoNuevo);
      await cargarBuses();
      mostrarToast({titulo:'Bus', cuerpo:'Estado actualizado', tipo:'success'});
    }catch(err){ mostrarToast({titulo:'Error', cuerpo:esc(err.detail), tipo:'danger'}); }
  }

  // Guardado
  document.getElementById('btn-guardar-bus')?.addEventListener('click', async ()=>{
    const id = document.getElementById('bus-id').value || null;
    const cuerpo = {
      placa: (document.getElementById('bus-placa').value||'').toUpperCase().trim(),
      no_interno: (document.getElementById('bus-interno').value||'').toUpperCase().trim() || null,
      tipologia: (document.getElementById('bus-tipologia').value||'').toUpperCase().trim() || null,
      modelo: Number(document.getElementById('bus-modelo').value||'') || null,
      marca: (document.getElementById('bus-marca').value||'').toUpperCase().trim() || null,
      linea: (document.getElementById('bus-linea').value||'').toUpperCase().trim() || null,
      carroceria: (document.getElementById('bus-carroceria').value||'').toUpperCase().trim() || null,
      combustible: (document.getElementById('bus-combustible').value||'').toUpperCase(),
      tecnologia: (document.getElementById('bus-tecnologia').value||'').toUpperCase().trim() || null,
      id_cop: parseInt(document.getElementById('bus-cop').value||0) || null,
      estado: document.getElementById('bus-estado').checked ? 1 : 0
    };
    if(!cuerpo.placa || !cuerpo.combustible || !cuerpo.id_cop){
      return mostrarToast({titulo:'Validación', cuerpo:'Placa, Combustible y Centro de Operación son obligatorios', tipo:'danger'});
    }
    try{
      if(id){ await API.buses.actualizar(id, cuerpo); mostrarToast({titulo:'Bus', cuerpo:'Actualizado correctamente', tipo:'success'}); }
      else  { await API.buses.crear(cuerpo);          mostrarToast({titulo:'Bus', cuerpo:'Creado correctamente',    tipo:'success'}); }
      cerrarModal('modalBus'); document.getElementById('bus-id').value = '';
      await cargarBuses();
    }catch(err){ mostrarToast({titulo:'Error', cuerpo:esc(err.detail), tipo:'danger'}); }
  });

  document.getElementById('btn-nuevo-bus')?.addEventListener('click', async ()=>{
    document.getElementById('bus-id').value='';
    ['placa','interno','tipologia','modelo','marca','linea','carroceria','combustible','tecnologia'].forEach(n=>{
      const el = document.getElementById(`bus-${n}`); if(!el) return; el.value='';
    });
    document.getElementById('bus-estado').checked = true;
    // Reset encadenados
    document.getElementById('bus-componente').value = '';
    await cargarZonas('');
    document.getElementById('bus-zona').value = '';
    await cargarCOPs('', '');
    document.getElementById('bus-cop').value = '';
  });

  /* ===== Filtros básicos ===== */
  document.getElementById('f-q')?.addEventListener('input', e=>{ e.target.value = (e.target.value||'').toUpperCase(); estado.q = e.target.value; estado.pagina=1; cargarBuses(); });
  document.getElementById('f-estado')?.addEventListener('change', e=>{ estado.es = e.target.value; estado.pagina=1; cargarBuses(); });
  document.getElementById('f-combustible')?.addEventListener('change', e=>{ estado.comb = e.target.value; estado.pagina=1; cargarBuses(); });
  document.getElementById('f-tipologia')?.addEventListener('input', e=>{ e.target.value = (e.target.value||'').toUpperCase(); estado.tip = e.target.value; estado.pagina=1; cargarBuses(); });
  document.getElementById('f-modelo-desde')?.addEventListener('input', e=>{ estado.modD = e.target.value; estado.pagina=1; cargarBuses(); });
  document.getElementById('f-modelo-hasta')?.addEventListener('input', e=>{ estado.modH = e.target.value; estado.pagina=1; cargarBuses(); });

  /* ===== Carga masiva con previsualización ===== */
  function bloquearUI(bloquear = true){
    const overlay = document.getElementById('overlay-proceso');
    if(!overlay) return;
    overlay.toggleAttribute('hidden', !bloquear);
    overlay.setAttribute('aria-hidden', bloquear ? 'false' : 'true');
    const inp = document.getElementById('archivo-carga');
    const btnP = document.getElementById('btn-previsualizar');
    const btnC = document.getElementById('btn-cargar');
    if(inp) inp.disabled = bloquear;
    if(btnP) btnP.disabled = bloquear;
    if(btnC) btnC.disabled = bloquear;
  }

  function renderPreview(muestra){
    const tb = document.getElementById('preview-tbody');
    tb.innerHTML = (muestra||[]).map(r=>`
      <tr><td>${r.fila}</td><td>${esc(r.placa||'')}</td><td>${esc(r.accion||'')}</td><td>${esc(r.cop_id||'')}</td><td>${esc(r.combustible||'')}</td><td>${esc(r.tipologia||'')}</td><td>${esc(r.modelo||'')}</td></tr>
    `).join('');
    document.getElementById('area-preview').style.display = 'block';
  }

  document.getElementById('btn-previsualizar')?.addEventListener('click', async ()=>{
    const inp = document.getElementById('archivo-carga'); const textoResultado = document.getElementById('resultado-carga');
    if(!inp.files || !inp.files.length) return mostrarToast({titulo:'Carga masiva', cuerpo:'Selecciona un archivo', tipo:'warning'});
    const f = inp.files[0]; const fd = new FormData(); fd.append('file', f);
    try{
      bloquearUI(true);
      textoResultado.innerHTML = `<span class="text-muted">Analizando <strong>${esc(f.name)}</strong>…</span>`;
      const data = await API.carga.preview(fd);
      textoResultado.innerHTML = `<div class="text-primary">Previsualización → Insertados: ${data.insertados} · Actualizados: ${data.actualizados} · Errores: ${data.errores.length}</div>`;
      renderPreview(data.muestra);
      mostrarToast({titulo:'Previsualización', cuerpo:'Análisis completado', tipo:'success'});
    }catch(err){
      const msg = err?.detail || JSON.stringify(err);
      textoResultado.innerText = msg;
      mostrarToast({titulo:'Error previsualización', cuerpo:esc(msg), tipo:'danger'});
    }finally{
      bloquearUI(false);
    }
  });

  document.getElementById('btn-cargar')?.addEventListener('click', async ()=>{
    const inp = document.getElementById('archivo-carga'); const textoResultado = document.getElementById('resultado-carga');
    if(!inp.files || !inp.files.length) return mostrarToast({titulo:'Carga masiva', cuerpo:'Selecciona un archivo', tipo:'warning'});
    const f = inp.files[0]; const fd = new FormData(); fd.append('file', f);
    try{
      bloquearUI(true);
      textoResultado.innerHTML = `<span class="text-muted">Subiendo y procesando <strong>${esc(f.name)}</strong>…</span>`;
      const data = await API.carga.subir(fd);
      textoResultado.innerHTML = `
        <div class="text-success">Insertados: ${data.insertados} · Actualizados: ${data.actualizados}</div>
        ${data.errores && data.errores.length ? `<div class="mt-2 text-danger small">Errores: ${data.errores.length}<br>${data.errores.slice(0,10).map(e=>`Fila ${e.row}: ${esc(e.error)}`).join('<br>')} ${data.errores.length>10?'...':''}</div>` : '' }
      `;
      mostrarToast({titulo:'Carga masiva', cuerpo:'Archivo procesado', tipo:'success'});
      cerrarModal('modalCarga'); await cargarBuses();
      document.getElementById('area-preview').style.display = 'none';
      document.getElementById('preview-tbody').innerHTML = '';
    }catch(err){
      const msg = err?.detail || JSON.stringify(err);
      textoResultado.innerText = msg;
      mostrarToast({titulo:'Error carga', cuerpo:esc(msg), tipo:'danger'});
    }finally{
      bloquearUI(false);
    }
  });

  /* ===== Inicio ===== */
  (async function boot(){
    try{
      forzarMayusculas('.upper');
      await cargarComponentes();
      await cargarZonas('');
      await cargarCOPs('', '');
      await cargarBuses();
    }catch(err){ mostrarToast({titulo:'Error inicial', cuerpo:esc(err.detail||err), tipo:'danger'}); }
  })();
</script>
{% endblock %}
