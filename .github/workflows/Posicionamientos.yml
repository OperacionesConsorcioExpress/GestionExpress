name: Proceso Posicionamientos (Blob -> PostgreSQL)

on:
  schedule:
    # 5:00 AM BogotÃ¡ (UTC-5) = 10:00 UTC
    - cron: "0 10 * * *"
  
  # Permite ejecuciÃ³n manual desde GitHub UI
  workflow_dispatch:
    inputs:
      dias_procesar:
        description: 'DÃ­as pendientes a procesar'
        required: false
        default: '2'
        type: string
      modo_verbose:
        description: 'Modo verbose (0=no, 1=sÃ­)'
        required: false
        default: '0'
        type: choice
        options:
          - '0'
          - '1'

jobs:
  posicionamientos:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # Permisos necesarios
    permissions:
      contents: read
    
    steps:
      # ==========================================
      # 1. CHECKOUT DEL REPOSITORIO
      # ==========================================
      - name: ðŸ“¦ Checkout repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Solo Ãºltimo commit (mÃ¡s rÃ¡pido)
      
      # ==========================================
      # 2. CONFIGURAR PYTHON 3.12 (CRÃTICO)
      # ==========================================
      - name: ðŸ Setup Python 3.12.4
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.4"  # âš ï¸ CAMBIADO de 3.9 a 3.12.4
          cache: 'pip'  # âš¡ Cache de dependencias
      
      # ==========================================
      # 3. VERIFICAR VERSIÃ“N DE PYTHON
      # ==========================================
      - name: ðŸ” Verificar Python
        run: |
          python --version
          python -c "import sys; print(f'Python {sys.version}')"
          if [[ "$(python -c 'import sys; print(sys.version_info[:2])')" != "(3, 12)" ]]; then
            echo "âŒ ERROR: Se requiere Python 3.12"
            exit 1
          fi
          echo "âœ… Python 3.12 confirmado"
      
      # ==========================================
      # 4. ACTUALIZAR PIP
      # ==========================================
      - name: â¬†ï¸ Actualizar pip
        run: |
          python -m pip install --upgrade pip
          pip --version
      
      # ==========================================
      # 5. INSTALAR DEPENDENCIAS CRÃTICAS PRIMERO
      # ==========================================
      - name: ðŸ“¦ Instalar dependencias crÃ­ticas
        run: |
          echo "ðŸ“¦ Instalando dependencias crÃ­ticas para posicionamientos..."
          
          # Instalar en orden especÃ­fico para evitar conflictos
          pip install numpy==2.0.2
          pip install pyarrow==21.0.0
          pip install polars==1.32.3
          pip install psycopg2-binary==2.9.10
          pip install azure-storage-blob==12.28.0
          
          echo "âœ… Dependencias crÃ­ticas instaladas"
      
      # ==========================================
      # 6. INSTALAR RESTO DE DEPENDENCIAS
      # ==========================================
      - name: ðŸ“š Instalar requirements.txt
        run: |
          echo "ðŸ“¦ Instalando resto de dependencias..."
          
          # Crear requirements temporal sin las ya instaladas
          grep -v "^numpy==" requirements.txt | \
          grep -v "^pyarrow==" | \
          grep -v "^polars==" | \
          grep -v "^psycopg2-binary==" | \
          grep -v "^azure-storage-blob" > requirements_temp.txt
          
          pip install -r requirements_temp.txt
          
          echo "âœ… Todas las dependencias instaladas"
      
      # ==========================================
      # 7. VERIFICAR INSTALACIÃ“N
      # ==========================================
      - name: ðŸ” Verificar paquetes crÃ­ticos
        run: |
          echo "ðŸ” Verificando paquetes instalados..."
          
          python -c "import polars as pl; print(f'âœ… Polars: {pl.__version__}')"
          python -c "import pyarrow as pa; print(f'âœ… PyArrow: {pa.__version__}')"
          python -c "import pandas as pd; print(f'âœ… Pandas: {pd.__version__}')"
          python -c "import numpy as np; print(f'âœ… NumPy: {np.__version__}')"
          python -c "import psycopg2; print(f'âœ… psycopg2: {psycopg2.__version__}')"
          python -c "from azure.storage.blob import BlobServiceClient; print('âœ… Azure Blob Storage')"
          
          echo ""
          echo "ðŸ“¦ Paquetes instalados:"
          pip list | grep -E "(polars|pyarrow|pandas|numpy|psycopg2|azure)"
      
      # ==========================================
      # 8. EJECUTAR PROCESO POSICIONAMIENTOS
      # ==========================================
      - name: ðŸš€ Ejecutar job posicionamientos
        env:
          # Credenciales desde GitHub Secrets
          DATABASE_PATH: ${{ secrets.DATABASE_PATH }}
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          
          # ParÃ¡metros configurables
          POS_LIMITE_DIAS: ${{ github.event.inputs.dias_procesar || '2' }}
          POS_VERBOSE: ${{ github.event.inputs.modo_verbose || '0' }}
          
          # InformaciÃ³n del workflow
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          WORKFLOW_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”„ Iniciando proceso de posicionamientos"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“… DÃ­as a procesar: ${POS_LIMITE_DIAS}"
          echo "ðŸ”Š Modo verbose: ${POS_VERBOSE}"
          echo "ðŸ‘¤ Ejecutado por: ${GITHUB_ACTOR}"
          echo "ðŸ Python: $(python --version)"
          echo "ðŸ“¦ Polars: $(python -c 'import polars; print(polars.__version__)')"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          python lib/posicionamientos.py
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Proceso completado exitosamente"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ==========================================
      # 9. NOTIFICACIÃ“N EN CASO DE ERROR
      # ==========================================
      - name: ðŸ“§ Notificar error
        if: failure()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âŒ ERROR: El proceso de posicionamientos fallÃ³"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ”— Ver detalles en:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      
      # ==========================================
      # 10. GUARDAR LOGS (OPCIONAL)
      # ==========================================
      - name: ðŸ’¾ Guardar logs de ejecuciÃ³n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-posicionamientos-${{ github.run_number }}
          path: |
            *.log
            logs/*.log
          retention-days: 7
          if-no-files-found: ignore
      
      # ==========================================
      # 11. RESUMEN DE EJECUCIÃ“N
      # ==========================================
      - name: ðŸ“Š Resumen de ejecuciÃ³n
        if: success()
        run: |
          echo "### âœ… EjecuciÃ³n Exitosa - Posicionamientos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ConfiguraciÃ³n:**" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ Polars: $(python -c 'import polars; print(polars.__version__)')" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ PyArrow: $(python -c 'import pyarrow; print(pyarrow.__version__)')" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“… DÃ­as procesados: ${POS_LIMITE_DIAS}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”Š Modo verbose: ${POS_VERBOSE}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ‘¤ Ejecutado por: ${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ• Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY