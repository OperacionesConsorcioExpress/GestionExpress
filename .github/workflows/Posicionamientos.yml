name: Proceso Posicionamientos (Blob -> PostgreSQL)

on:
  schedule:
    # 5:00 AM Bogot√° (UTC-5) = 10:00 UTC
    - cron: "0 10 * * *"
  
  # Permite ejecuci√≥n manual desde GitHub UI
  workflow_dispatch:
    inputs:
      dias_procesar:
        description: 'D√≠as pendientes a procesar'
        required: false
        default: '2'
        type: string
      modo_verbose:
        description: 'Modo verbose (0=no, 1=s√≠)'
        required: false
        default: '0'
        type: choice
        options:
          - '0'
          - '1'

jobs:
  posicionamientos:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # Permisos necesarios
    permissions:
      contents: read
    
    steps:
      # ==========================================
      # 1. CHECKOUT DEL REPOSITORIO
      # ==========================================
      - name: üì¶ Checkout repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Solo √∫ltimo commit (m√°s r√°pido)
      
      # ==========================================
      # 2. CONFIGURAR PYTHON 3.12 (CR√çTICO)
      # ==========================================
      - name: üêç Setup Python 3.12.4
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.4"
          cache: 'pip'  # ‚ö° Cache de dependencias
      
      # ==========================================
      # 3. VERIFICAR VERSI√ìN DE PYTHON
      # ==========================================
      - name: üîç Verificar Python
        run: |
          python --version
          python -c "import sys; print(f'Python {sys.version}')"
          if [[ "$(python -c 'import sys; print(sys.version_info[:2])')" != "(3, 12)" ]]; then
            echo "‚ùå ERROR: Se requiere Python 3.12"
            exit 1
          fi
          echo "‚úÖ Python 3.12 confirmado"
      
      # ==========================================
      # 4. ACTUALIZAR PIP
      # ==========================================
      - name: ‚¨ÜÔ∏è Actualizar pip
        run: |
          python -m pip install --upgrade pip
          pip --version
      
      # ==========================================
      # 5. INSTALAR DEPENDENCIAS CR√çTICAS PRIMERO
      # ==========================================
      - name: üì¶ Instalar dependencias cr√≠ticas
        run: |
          echo "üì¶ Instalando dependencias cr√≠ticas para posicionamientos..."
          
          # Instalar en orden espec√≠fico para evitar conflictos
          pip install numpy==2.0.2
          pip install pyarrow==21.0.0
          pip install polars==1.32.3
          pip install psycopg2-binary==2.9.10
          pip install azure-storage-blob==12.28.0
          
          echo "‚úÖ Dependencias cr√≠ticas instaladas"
      
      # ==========================================
      # 6. INSTALAR RESTO DE DEPENDENCIAS
      # ==========================================
      - name: üìö Instalar requirements.txt
        run: |
          echo "üì¶ Instalando resto de dependencias..."
          echo ""
          
          # Usar script Python para procesar requirements.txt con cualquier encoding
          python3 << 'PYTHON_SCRIPT'
          import sys
          
          def detectar_y_convertir_encoding():
              """Detecta el encoding y convierte a UTF-8 si es necesario."""
              encodings_a_probar = [
                  'utf-8',
                  'utf-16',
                  'utf-16-le',
                  'utf-16-be',
                  'latin-1',
                  'cp1252',
                  'iso-8859-1',
              ]
              
              for encoding in encodings_a_probar:
                  try:
                      with open('requirements.txt', 'r', encoding=encoding) as f:
                          contenido = f.read()
                      print(f"‚úÖ Detectado encoding: {encoding}")
                      return contenido
                  except (UnicodeDecodeError, LookupError):
                      continue
              
              print("‚ö†Ô∏è  Usando fallback UTF-16LE con errors='replace'")
              with open('requirements.txt', 'rb') as f:
                  raw = f.read()
              return raw.decode('utf-16-le', errors='replace')
          
          def limpiar_linea(linea: str) -> str:
              """Limpia una l√≠nea de caracteres especiales y espacios."""
              linea = ''.join(char for char in linea if ord(char) >= 32 or char in '\n\t\r')
              return linea.strip()
          
          def extraer_nombre_paquete(linea: str) -> str:
              """Extrae el nombre del paquete de una l√≠nea de requirement."""
              for sep in ['==', '>=', '<=', '!=', '<', '>', '[']:
                  if sep in linea:
                      linea = linea.split(sep)[0]
              return linea.strip().lower()
          
          # Paquetes ya instalados
          instalados = {
              'numpy', 'pyarrow', 'polars', 
              'psycopg2-binary', 'psycopg2',
              'azure-storage-blob'
          }
          
          try:
              # 1. Detectar y convertir encoding
              print("üîç Detectando encoding de requirements.txt...")
              contenido = detectar_y_convertir_encoding()
              
              # 2. Convertir el archivo a UTF-8
              print("üìù Convirtiendo requirements.txt a UTF-8...")
              with open('requirements.txt', 'w', encoding='utf-8') as f:
                  f.write(contenido)
              print("‚úÖ requirements.txt convertido a UTF-8")
              
              # 3. Leer l√≠nea por l√≠nea y filtrar
              print("üîÑ Filtrando dependencias duplicadas...")
              with open('requirements.txt', 'r', encoding='utf-8') as f:
                  lineas = f.readlines()
              
              lineas_filtradas = []
              lineas_descartadas = []
              
              for i, linea in enumerate(lineas, 1):
                  linea_limpia = limpiar_linea(linea)
                  
                  if not linea_limpia or linea_limpia.startswith('#'):
                      if linea_limpia.startswith('#'):
                          lineas_filtradas.append(linea_limpia)
                      continue
                  
                  pkg_name = extraer_nombre_paquete(linea_limpia)
                  
                  if pkg_name in instalados:
                      lineas_descartadas.append(f"  ‚äò {linea_limpia}")
                      continue
                  
                  lineas_filtradas.append(linea_limpia)
              
              # 4. Escribir archivo temporal
              print(f"üìù Escribiendo requirements_temp.txt...")
              with open('requirements_temp.txt', 'w', encoding='utf-8') as out:
                  for linea in lineas_filtradas:
                      if linea.strip() and not linea.startswith('#'):
                          out.write(linea + '\n')
              
              # 5. Resumen
              count_temp = len([l for l in lineas_filtradas if l.strip() and not l.startswith('#')])
              count_descartadas = len(lineas_descartadas)
              
              print(f"\nüìä Resumen:")
              print(f"  Total de l√≠neas: {len(lineas)}")
              print(f"  Paquetes a instalar: {count_temp}")
              print(f"  Paquetes descartados: {count_descartadas}")
              
              if lineas_descartadas and count_descartadas <= 10:
                  print(f"\nüîï Paquetes descartados:")
                  for desc in lineas_descartadas:
                      print(desc)
              
              print(f"\n‚úÖ requirements_temp.txt generado correctamente")
              
          except Exception as e:
              print(f"‚ùå Error: {e}")
              import traceback
              traceback.print_exc()
              sys.exit(1)
          
          PYTHON_SCRIPT
          
          echo ""
          
          # Instalar paquetes del archivo temporal
          if [ -f requirements_temp.txt ]; then
              num_lineas=$(wc -l < requirements_temp.txt)
              if [ "$num_lineas" -gt 0 ]; then
                  echo "üì¶ Instalando ${num_lineas} paquetes adicionales..."
                  pip install -r requirements_temp.txt --no-cache-dir
                  echo "‚úÖ Paquetes instalados exitosamente"
              else
                  echo "‚ÑπÔ∏è  No hay paquetes adicionales para instalar"
              fi
          else
              echo "‚ùå Error: requirements_temp.txt no se gener√≥"
              exit 1
          fi
      
      # ==========================================
      # 7. VERIFICAR INSTALACI√ìN
      # ==========================================
      - name: üîç Verificar paquetes cr√≠ticos
        run: |
          echo "üîç Verificando paquetes instalados..."
          
          python -c "import polars as pl; print(f'‚úÖ Polars: {pl.__version__}')"
          python -c "import pyarrow as pa; print(f'‚úÖ PyArrow: {pa.__version__}')"
          python -c "import pandas as pd; print(f'‚úÖ Pandas: {pd.__version__}')"
          python -c "import numpy as np; print(f'‚úÖ NumPy: {np.__version__}')"
          python -c "import psycopg2; print(f'‚úÖ psycopg2: {psycopg2.__version__}')"
          python -c "from azure.storage.blob import BlobServiceClient; print('‚úÖ Azure Blob Storage')"
          
          echo ""
          echo "üì¶ Paquetes instalados (resumen):"
          pip list | grep -E "(polars|pyarrow|pandas|numpy|psycopg2|azure)" || echo "No hay coincidencias"
      
      # ==========================================
      # 8. EJECUTAR PROCESO POSICIONAMIENTOS
      # ==========================================
      - name: üöÄ Ejecutar job posicionamientos
        env:
          # Credenciales desde GitHub Secrets
          DATABASE_PATH: ${{ secrets.DATABASE_PATH }}
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          
          # Par√°metros configurables
          POS_LIMITE_DIAS: ${{ github.event.inputs.dias_procesar || '2' }}
          POS_VERBOSE: ${{ github.event.inputs.modo_verbose || '0' }}
          
          # Informaci√≥n del workflow
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          WORKFLOW_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîÑ Iniciando proceso de posicionamientos"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìÖ D√≠as a procesar: ${POS_LIMITE_DIAS}"
          echo "üîä Modo verbose: ${POS_VERBOSE}"
          echo "üë§ Ejecutado por: ${GITHUB_ACTOR}"
          echo "üêç Python: $(python --version)"
          echo "üì¶ Polars: $(python -c 'import polars; print(polars.__version__)')"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Ejecutar como m√≥dulo importable
          python -c "
          import os
          from model.posicionamientos import ejecutar_job_posicionamientos
          
          # Obtener par√°metros desde variables de entorno
          limite_dias = int(os.getenv('POS_LIMITE_DIAS', '2'))
          modo_verbose = os.getenv('POS_VERBOSE', '0') == '1'
          
          print(f'‚úÖ M√≥dulo importado correctamente')
          print(f'   D√≠as a procesar: {limite_dias}')
          print(f'   Modo verbose: {modo_verbose}')
          print()
          
          # Ejecutar la funci√≥n
          ejecutar_job_posicionamientos(limite_dias_por_ejecucion=limite_dias, verbose=modo_verbose)
          "
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ Proceso completado exitosamente"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      # ==========================================
      # 9. NOTIFICACI√ìN EN CASO DE ERROR
      # ==========================================
      - name: üìß Notificar error
        if: failure()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ùå ERROR: El proceso de posicionamientos fall√≥"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîó Ver detalles en:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      # ==========================================
      # 10. GUARDAR LOGS (OPCIONAL)
      # ==========================================
      - name: üíæ Guardar logs de ejecuci√≥n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-posicionamientos-${{ github.run_number }}
          path: |
            *.log
            logs/*.log
          retention-days: 7
          if-no-files-found: ignore
      
      # ==========================================
      # 11. RESUMEN DE EJECUCI√ìN
      # ==========================================
      - name: üìä Resumen de ejecuci√≥n
        if: success()
        run: |
          echo "### ‚úÖ Ejecuci√≥n Exitosa - Posicionamientos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuraci√≥n:**" >> $GITHUB_STEP_SUMMARY
          echo "- üêç Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ Polars: $(python -c 'import polars; print(polars.__version__)')" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ PyArrow: $(python -c 'import pyarrow; print(pyarrow.__version__)')" >> $GITHUB_STEP_SUMMARY
          echo "- üìÖ D√≠as procesados: ${POS_LIMITE_DIAS}" >> $GITHUB_STEP_SUMMARY
          echo "- üîä Modo verbose: ${POS_VERBOSE}" >> $GITHUB_STEP_SUMMARY
          echo "- üë§ Ejecutado por: ${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
          echo "- üïê Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY