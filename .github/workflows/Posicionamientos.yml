name: Proceso Posicionamientos (Blob -> PostgreSQL)

on:
  schedule:
    # 5:00 AM Bogot√° (UTC-5) = 10:00 UTC
    - cron: "0 10 * * *"
  
  # Permite ejecuci√≥n manual desde GitHub UI
  workflow_dispatch:
    inputs:
      dias_procesar:
        description: 'D√≠as pendientes a procesar'
        required: false
        default: '2'
        type: string
      modo_verbose:
        description: 'Modo verbose (0=no, 1=s√≠)'
        required: false
        default: '0'
        type: choice
        options:
          - '0'
          - '1'

jobs:
  posicionamientos:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    # Permisos necesarios
    permissions:
      contents: read
    
    steps:
      # ==========================================
      # 1. CHECKOUT DEL REPOSITORIO
      # ==========================================
      - name: üì¶ Checkout repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Solo √∫ltimo commit (m√°s r√°pido)
      
      # ==========================================
      # 2. CONFIGURAR PYTHON 3.12 (CR√çTICO)
      # ==========================================
      - name: üêç Setup Python 3.12.4
        uses: actions/setup-python@v5
        with:
          python-version: "3.12.4"  # ‚ö†Ô∏è CAMBIADO de 3.9 a 3.12.4
          cache: 'pip'  # ‚ö° Cache de dependencias
      
      # ==========================================
      # 3. VERIFICAR VERSI√ìN DE PYTHON
      # ==========================================
      - name: üîç Verificar Python
        run: |
          python --version
          python -c "import sys; print(f'Python {sys.version}')"
          if [[ "$(python -c 'import sys; print(sys.version_info[:2])')" != "(3, 12)" ]]; then
            echo "‚ùå ERROR: Se requiere Python 3.12"
            exit 1
          fi
          echo "‚úÖ Python 3.12 confirmado"
      
      # ==========================================
      # 4. ACTUALIZAR PIP
      # ==========================================
      - name: ‚¨ÜÔ∏è Actualizar pip
        run: |
          python -m pip install --upgrade pip
          pip --version
      
      # ==========================================
      # 5. INSTALAR DEPENDENCIAS CR√çTICAS PRIMERO
      # ==========================================
      - name: üì¶ Instalar dependencias cr√≠ticas
        run: |
          echo "üì¶ Instalando dependencias cr√≠ticas para posicionamientos..."
          
          # Instalar en orden espec√≠fico para evitar conflictos
          pip install numpy==2.0.2
          pip install pyarrow==21.0.0
          pip install polars==1.32.3
          pip install psycopg2-binary==2.9.10
          pip install azure-storage-blob==12.28.0
          
          echo "‚úÖ Dependencias cr√≠ticas instaladas"
      
      # ==========================================
      # 6. INSTALAR RESTO DE DEPENDENCIAS
      # ==========================================
      - name: üìö Instalar requirements.txt
        run: |
          echo "üì¶ Instalando resto de dependencias..."
          
          # Convertir a UTF-8 si es necesario y crear requirements temporal
          file -i requirements.txt || echo "No se pudo verificar encoding"
          
          # Opci√≥n m√°s robusta: usar Python para filtrar
          python3 << 'EOF'
          import sys
          
          # Paquetes ya instalados
          instalados = {
              'numpy', 'pyarrow', 'polars', 
              'psycopg2-binary', 'azure-storage-blob'
          }
          
          try:
              with open('requirements.txt', 'r', encoding='utf-8', errors='replace') as f:
                  lineas = f.readlines()
          except Exception as e:
              print(f"Error al leer requirements.txt: {e}", file=sys.stderr)
              sys.exit(1)
          
          with open('requirements_temp.txt', 'w', encoding='utf-8') as out:
              for linea in lineas:
                  linea = linea.strip()
                  if not linea or linea.startswith('#'):
                      continue
                  
                  # Obtener nombre del paquete
                  pkg_name = linea.split('==')[0].split('>=')[0].split('<=')[0].split('!=')[0].split('<')[0].split('>')[0].split('[')[0].strip()
                  
                  if pkg_name.lower() not in instalados:
                      out.write(linea + '\n')
          
          print("‚úÖ requirements_temp.txt creado correctamente")
          EOF
          
          # Contar l√≠neas del archivo temporal
          lineas=$(wc -l < requirements_temp.txt)
          echo "üì¶ Instalando ${lineas} paquetes adicionales..."
          
          if [ ${lineas} -gt 0 ]; then
              pip install -r requirements_temp.txt --no-cache-dir
          else
              echo "‚ÑπÔ∏è  No hay dependencias adicionales para instalar"
          fi
          
          echo "‚úÖ Todas las dependencias instaladas"
      
      # ==========================================
      # 7. VERIFICAR INSTALACI√ìN
      # ==========================================
      - name: üîç Verificar paquetes cr√≠ticos
        run: |
          echo "üîç Verificando paquetes instalados..."
          
          python -c "import polars as pl; print(f'‚úÖ Polars: {pl.__version__}')"
          python -c "import pyarrow as pa; print(f'‚úÖ PyArrow: {pa.__version__}')"
          python -c "import pandas as pd; print(f'‚úÖ Pandas: {pd.__version__}')"
          python -c "import numpy as np; print(f'‚úÖ NumPy: {np.__version__}')"
          python -c "import psycopg2; print(f'‚úÖ psycopg2: {psycopg2.__version__}')"
          python -c "from azure.storage.blob import BlobServiceClient; print('‚úÖ Azure Blob Storage')"
          
          echo ""
          echo "üì¶ Paquetes instalados:"
          pip list | grep -E "(polars|pyarrow|pandas|numpy|psycopg2|azure)"
      
      # ==========================================
      # 8. EJECUTAR PROCESO POSICIONAMIENTOS
      # ==========================================
      - name: üöÄ Ejecutar job posicionamientos
        env:
          # Credenciales desde GitHub Secrets
          DATABASE_PATH: ${{ secrets.DATABASE_PATH }}
          AZURE_STORAGE_CONNECTION_STRING: ${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}
          
          # Par√°metros configurables
          POS_LIMITE_DIAS: ${{ github.event.inputs.dias_procesar || '2' }}
          POS_VERBOSE: ${{ github.event.inputs.modo_verbose || '0' }}
          
          # Informaci√≥n del workflow
          WORKFLOW_RUN_ID: ${{ github.run_id }}
          WORKFLOW_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_ACTOR: ${{ github.actor }}
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîÑ Iniciando proceso de posicionamientos"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üìÖ D√≠as a procesar: ${POS_LIMITE_DIAS}"
          echo "üîä Modo verbose: ${POS_VERBOSE}"
          echo "üë§ Ejecutado por: ${GITHUB_ACTOR}"
          echo "üêç Python: $(python --version)"
          echo "üì¶ Polars: $(python -c 'import polars; print(polars.__version__)')"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          python lib/posicionamientos.py
          
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚úÖ Proceso completado exitosamente"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      # ==========================================
      # 9. NOTIFICACI√ìN EN CASO DE ERROR
      # ==========================================
      - name: üìß Notificar error
        if: failure()
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "‚ùå ERROR: El proceso de posicionamientos fall√≥"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üîó Ver detalles en:"
          echo "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      
      # ==========================================
      # 10. GUARDAR LOGS (OPCIONAL)
      # ==========================================
      - name: üíæ Guardar logs de ejecuci√≥n
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-posicionamientos-${{ github.run_number }}
          path: |
            *.log
            logs/*.log
          retention-days: 7
          if-no-files-found: ignore
      
      # ==========================================
      # 11. RESUMEN DE EJECUCI√ìN
      # ==========================================
      - name: üìä Resumen de ejecuci√≥n
        if: success()
        run: |
          echo "### ‚úÖ Ejecuci√≥n Exitosa - Posicionamientos" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Configuraci√≥n:**" >> $GITHUB_STEP_SUMMARY
          echo "- üêç Python: $(python --version)" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ Polars: $(python -c 'import polars; print(polars.__version__)')" >> $GITHUB_STEP_SUMMARY
          echo "- üì¶ PyArrow: $(python -c 'import pyarrow; print(pyarrow.__version__)')" >> $GITHUB_STEP_SUMMARY
          echo "- üìÖ D√≠as procesados: ${POS_LIMITE_DIAS}" >> $GITHUB_STEP_SUMMARY
          echo "- üîä Modo verbose: ${POS_VERBOSE}" >> $GITHUB_STEP_SUMMARY
          echo "- üë§ Ejecutado por: ${GITHUB_ACTOR}" >> $GITHUB_STEP_SUMMARY
          echo "- üïê Fecha: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY